<script>
let deferredPrompt,currentIndex=0,defaults=["Tôi muốn ăn cơm","Tôi muốn uống nước","Tôi muốn đi vệ sinh","Tôi muốn đi ngủ"],installState = 'before_install';
const controlArea=document.getElementById('controlArea'),
      installButton=document.getElementById('installButton'),
      addBtnMove=document.getElementById('add-btn-move'),
      popupElement=document.getElementById('popup'),
      buttonContainer=document.getElementById('buttonContainer'),
      settingsArea=document.getElementById('settingsArea');

function speak(text){
    if(!text||!('speechSynthesis' in window)) return;
    speechSynthesis.cancel();
    let u=new SpeechSynthesisUtterance(text);
    u.lang='vi-VN';
    speechSynthesis.speak(u);
    showPopup(text); 
}

function showPopup(text){
    popupElement.textContent=text;
    popupElement.style.display='block';
    popupElement.style.opacity='1';
    setTimeout(()=>{
        popupElement.style.opacity='0'; 
        setTimeout(()=>popupElement.style.display='none', 500);
    },3500);
}

function addButton(v=''){
    let c=document.createElement('div');
    c.className='card';
    let i=document.createElement('input');
    i.value=v;
    i.placeholder="Nhập văn bản...";
    i.onchange=saveAll;
    let p=document.createElement('button');
    p.className='btn play-btn';
    p.textContent='🔊 Phát âm';
    p.onclick=()=>speak(i.value.trim()); 
    let d=document.createElement('button');
    d.className='delete-btn';
    d.textContent='❌';
    d.onclick=()=>{c.remove();saveAll();currentIndex=Math.min(currentIndex,getCards().length-1)};
    c.append(i,p,d);
    buttonContainer.appendChild(c);
    saveAll();
}

function saveAll(){localStorage.setItem('voiceButtons',JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim())))}
function loadButtons(){let s=JSON.parse(localStorage.getItem('voiceButtons')||"[]");(s.length?s:defaults).forEach(t=>addButton(t));currentIndex=0}
function resetDefaults(){if(confirm("Đặt lại mặc định?")){localStorage.removeItem('voiceButtons');buttonContainer.innerHTML='';loadButtons();currentIndex=0}}
function getCards(){return document.querySelectorAll('.card input')}
function cleanupEmptyCards(){let c=document.querySelectorAll('.card'),save=false;for(let i=c.length-1;i>=0;i--){let inp=c[i].querySelector('input');if(!inp||inp.value.trim()===''){c[i].remove();save=true}}if(save){saveAll();currentIndex=Math.min(currentIndex,getCards().length-1)}}

function moveSpeak(dir){
    cleanupEmptyCards();
    const c=getCards();
    if(c.length===0) return;
    if(dir===0) speak(c[currentIndex].value.trim());
    else{currentIndex=(currentIndex+dir+c.length)%c.length;speak(c[currentIndex].value.trim());}
}

// ---- CHỈNH SỬA CHO CLICK VÀ TOUCH ----
document.querySelectorAll('.navigation-group button').forEach(btn=>{
    btn.addEventListener('click',()=>moveSpeak(parseInt(btn.getAttribute('ontouchend')?.match(/-?\d+/))));
    btn.addEventListener('touchend',()=>moveSpeak(parseInt(btn.getAttribute('ontouchend')?.match(/-?\d+/))));
});

document.getElementById('add-btn-move').addEventListener('click', addButton);
document.getElementById('unlock-btn').addEventListener('click', ()=>toggleLock(false));
settingsArea.querySelector('.settings-btn').addEventListener('click', ()=>toggleLock(true));
settingsArea.querySelector('.reset-btn').addEventListener('click', resetDefaults);

function toggleLock(lock){
    const u=document.getElementById('unlock-btn');
    if(lock){
        buttonContainer.style.display='none';
        addBtnMove.style.display='none';
        settingsArea.style.display='none';
        
        controlArea.classList.add('locked');
        document.body.classList.add('locked');
        document.getElementById('mainTitle').classList.add('locked-h1');
        u.style.display='flex';
    } else {
        buttonContainer.style.display='grid';
        addBtnMove.style.display='block';
        settingsArea.style.display='block';
        
        controlArea.classList.remove('locked');
        document.body.classList.remove('locked');
        document.getElementById('mainTitle').classList.remove('locked-h1');
        u.style.display='none';
    }
}

window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();
    deferredPrompt=e;
    if (installState === 'before_install') {
        installButton.style.display='flex';
        installButton.onclick=installApp;
    }
});

function installApp(){
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult)=>{
            installState = (choiceResult.outcome==='accepted')?'installed':'rejected';
            deferredPrompt=null;
            installButton.style.display='none';
        });
    }
}

window.addEventListener('appinstalled',()=>{
    installState = 'installed';
    installButton.style.display='none';
});

if (installState === 'before_install') installButton.style.display='none'; 

function warmUpTTS(){if(!('speechSynthesis' in window))return;let u=new SpeechSynthesisUtterance(" ");u.lang='vi-VN';u.volume=0;u.rate=10;speechSynthesis.speak(u);setTimeout(()=>speechSynthesis.cancel(),500);}
window.onload=()=>{loadButtons();warmUpTTS();}
</script>
