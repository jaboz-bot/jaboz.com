let deferredPrompt;
let currentIndex = 0;
const defaults = ["TÃ´i muá»‘n Äƒn cÆ¡m", "TÃ´i muá»‘n uá»‘ng nÆ°á»›c", "TÃ´i muá»‘n Ä‘i vá»‡ sinh", "TÃ´i muá»‘n Ä‘i ngá»§"];
const controlArea = document.getElementById('controlArea');
const installButton = document.getElementById('installButton');
const settingsArea = document.getElementById('settingsArea');
const buttonContainer = document.getElementById('buttonContainer');
const unlockBtn = document.getElementById('unlock-btn');
const popup = document.getElementById('popup');
const navGroup = document.querySelector('.navigation-group');

// Láº¥y táº¥t cáº£ cÃ¡c tháº» input trong container
const getInputs = () => [...document.querySelectorAll('#buttonContainer input')];

// --- NÃºt phÃ¡t Ã¢m ---
const speak = (text) => {
    if (!text || !('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'vi-VN';
    speechSynthesis.speak(utter);
    showPopup(text);
};

// --- Popup trÆ°á»£t ---
const showPopup = (text) => {
    popup.textContent = text;
    const isLocked = controlArea.classList.contains('locked');
    
    // Äáº·t láº¡i vá»‹ trÃ­ ban Ä‘áº§u (áº©n)
    let startTransform = 'translateX(-50%) translateY(20px)';
    if (isLocked) {
        startTransform = 'translateX(-50%) translateY(30px)';
    }

    popup.style.transform = startTransform;
    popup.style.display = 'block';
    popup.style.opacity = '1';

    // Vá»‹ trÃ­ káº¿t thÃºc (hiá»‡n) - Cáº§n requestAnimationFrame Ä‘á»ƒ Ä‘áº£m báº£o animation hoáº¡t Ä‘á»™ng
    requestAnimationFrame(() => {
        popup.style.transform = 'translateX(-50%) translateY(0)';
    });

    // Tá»± Ä‘á»™ng áº©n
    setTimeout(() => {
        popup.style.opacity = '0';
        // Vá»‹ trÃ­ trÆ°á»£t Ä‘i
        popup.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => popup.style.display = 'none', 500);
    }, 2000);
};

// --- Quáº£n lÃ½ dá»¯ liá»‡u ---
const saveAll = () => {
    const texts = getInputs().map(i => i.value.trim());
    localStorage.setItem('voiceButtons', JSON.stringify(texts));
};

const addButton = (value = '') => {
    const card = document.createElement('div');
    card.className = 'card';
    
    const input = document.createElement('input');
    input.value = value;
    input.placeholder = "Nháº­p vÄƒn báº£n...";
    input.onchange = saveAll;
    
    const play = document.createElement('button');
    play.className = 'btn play-btn';
    play.textContent = 'ðŸ”Š PhÃ¡t Ã¢m';
    play.onclick = () => speak(input.value.trim());
    
    const del = document.createElement('button');
    del.className = 'delete-btn';
    del.textContent = 'âŒ';
    del.onclick = () => {
        const cards = getInputs();
        const idx = cards.indexOf(input);
        card.remove();
        saveAll();
        // Cáº­p nháº­t currentIndex náº¿u cáº§n
        if (currentIndex >= getInputs().length) currentIndex = getInputs().length - 1;
        if (currentIndex < 0) currentIndex = 0;
    };
    
    card.append(input, play, del);
    buttonContainer.appendChild(card);
    saveAll();
};

const loadButtons = () => {
    const saved = JSON.parse(localStorage.getItem('voiceButtons') || "[]");
    const list = saved.length ? saved : defaults;
    buttonContainer.innerHTML = '';
    list.forEach(text => addButton(text));
    currentIndex = 0;
};

const resetDefaults = () => {
    if (confirm("Báº¡n cÃ³ muá»‘n Ä‘áº·t láº¡i vá» máº·c Ä‘á»‹nh?")) {
        localStorage.removeItem('voiceButtons');
        buttonContainer.innerHTML = '';
        loadButtons();
        currentIndex = 0;
    }
};

// --- Bá»” SUNG: HÃ€M XÃ“A CÃC THáºº Rá»–NG VÃ€ Cáº¬P NHáº¬T TRáº NG THÃI ---
const cleanupEmptyCards = () => {
    let cards = document.querySelectorAll('.card');
    let shouldSave = false;
    
    for (let i = cards.length - 1; i >= 0; i--) {
        const input = cards[i].querySelector('input');
        if (!input || input.value.trim() === '') {
            cards[i].remove();
            shouldSave = true;
        }
    }
    
    if (shouldSave) {
        saveAll();
        const newInputs = getInputs();
        if (currentIndex >= newInputs.length) {
            currentIndex = newInputs.length > 0 ? newInputs.length - 1 : 0;
        }
    }
};

// --- 3 nÃºt Ä‘iá»u khiá»ƒn ---
const prevSpeak = () => {
    cleanupEmptyCards();
    const inputs = getInputs();
    if (inputs.length === 0) return;
    currentIndex = (currentIndex - 1 + inputs.length) % inputs.length;
    speak(inputs[currentIndex].value.trim());
};

const nextSpeak = () => {
    cleanupEmptyCards();
    const inputs = getInputs();
    if (inputs.length === 0) return;
    currentIndex = (currentIndex + 1) % inputs.length;
    speak(inputs[currentIndex].value.trim());
};

const currentSpeak = () => {
    cleanupEmptyCards();
    const inputs = getInputs();
    if (inputs.length === 0) return;
    speak(inputs[currentIndex].value.trim());
};

// --- KhÃ³a / Má»Ÿ khÃ³a ---
const toggleLock = (lock) => {
    if (lock) {
        settingsArea.style.display = 'none';
        buttonContainer.style.display = 'none';
        controlArea.classList.add('locked');
        unlockBtn.style.display = 'block';
    } else {
        settingsArea.style.display = 'block';
        buttonContainer.style.display = 'grid';
        controlArea.classList.remove('locked');
        // Äáº·t láº¡i style vá»‹ trÃ­ máº·c Ä‘á»‹nh cá»§a Popup khi Má»Ÿ khÃ³a (quan trá»ng cho CSS Ä‘Ã£ chá»‰nh sá»­a)
        popup.style.position = 'absolute';
        popup.style.top = 'auto';
        popup.style.bottom = '100%';
        unlockBtn.style.display = 'none';
    }
};

// Gáº¯n cÃ¡c hÃ m tá»‘i Æ°u hÃ³a vÃ o window Ä‘á»ƒ HTML váº«n hoáº¡t Ä‘á»™ng
window.addButton = addButton;
window.resetDefaults = resetDefaults;
window.prevSpeak = prevSpeak;
window.nextSpeak = nextSpeak;
window.currentSpeak = currentSpeak;
window.toggleLock = toggleLock;

// ==========================================================
// ** PHáº¦N CODE PWA/TTS - Giá»¯ nguyÃªn logic **
// ==========================================================

// PWA: 1. LÆ°u láº¡i sá»± kiá»‡n trÆ°á»›c khi trÃ¬nh duyá»‡t hiá»ƒn thá»‹ lá»i nháº¯c cÃ i Ä‘áº·t
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installButton.style.display = 'block';
    installButton.addEventListener('click', installApp);
});

// PWA: 2. HÃ m kÃ­ch hoáº¡t lá»i nháº¯c cÃ i Ä‘áº·t
const installApp = () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            console.log(choiceResult.outcome === 'accepted' ? 'NgÆ°á»i dÃ¹ng Ä‘Ã£ cháº¥p nháº­n cÃ i Ä‘áº·t.' : 'NgÆ°á»i dÃ¹ng Ä‘Ã£ tá»« chá»‘i cÃ i Ä‘áº·t.');
            deferredPrompt = null;
            installButton.style.display = 'none';
        });
    }
};

// PWA: 3. Xá»­ lÃ½ sau khi ngÆ°á»i dÃ¹ng Ä‘Ã£ cÃ i Ä‘áº·t (thÆ°á»ng áº©n nÃºt)
window.addEventListener('appinstalled', () => {
    installButton.style.display = 'none';
});

// TTS Warm-up
const warmUpTTS = () => {
    if (!('speechSynthesis' in window)) return;
    const utter = new SpeechSynthesisUtterance(" ");
    utter.lang = 'vi-VN';
    utter.volume = 0;
    utter.rate = 10;
    
    if (speechSynthesis.getVoices().length === 0 || speechSynthesis.speaking === false) {
        speechSynthesis.speak(utter);
        setTimeout(() => {
            speechSynthesis.cancel();
        }, 500);
    }
};

window.onload = () => {
    loadButtons();
    warmUpTTS();
};
