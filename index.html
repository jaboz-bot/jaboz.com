<script>
let deferredPrompt, currentIndex = 0, defaults = ["T√¥i mu·ªën ƒÉn c∆°m", "T√¥i mu·ªën u·ªëng n∆∞·ªõc", "T√¥i mu·ªën ƒëi v·ªá sinh", "T√¥i mu·ªën ƒëi ng·ªß"], installState = 'before_install';
const controlArea = document.getElementById('controlArea'),
¬† ¬† ¬† installButton = document.getElementById('installButton'),
¬† ¬† ¬† addBtnMove = document.getElementById('add-btn-move'),
¬† ¬† ¬† popupElement = document.getElementById('popup'),
¬† ¬† ¬† buttonContainer = document.getElementById('buttonContainer'),
¬† ¬† ¬† settingsArea = document.getElementById('settingsArea');

let isSpeaking = false; // Bi·∫øn flag ƒë·ªÉ ki·ªÉm tra xem ƒëang ph√°t hay kh√¥ng

function speak(text, targetElement) {
¬† ¬† if (!text || !('speechSynthesis' in window) || isSpeaking) return; // N·∫øu ƒëang ph√°t th√¨ kh√¥ng l√†m g√¨ c·∫£

¬† ¬† isSpeaking = true; // ƒê√°nh d·∫•u l√† ƒëang ph√°t

¬† ¬† speechSynthesis.cancel();
¬† ¬† let u = new SpeechSynthesisUtterance(text);
¬† ¬† u.lang = 'vi-VN';
¬† ¬† u.onend = () => {
¬† ¬† ¬† ¬† isSpeaking = false; // Sau khi ph√°t xong, cho ph√©p nh·∫•n l·∫°i
¬† ¬† };
¬† ¬† speechSynthesis.speak(u);
¬† ¬† showPopup(text);
}

function showPopup(text) {
¬† ¬† popupElement.textContent = text;
¬† ¬† popupElement.style.display = 'block';
¬† ¬† popupElement.style.opacity = '1';

¬† ¬† setTimeout(() => {¬†
¬† ¬† ¬† ¬† popupElement.style.opacity = '0';¬†
¬† ¬† ¬† ¬† setTimeout(() => popupElement.style.display = 'none', 500);¬†
¬† ¬† }, 3500);
}

function addButton(v = '') {
¬† ¬† let c = document.createElement('div');
¬† ¬† c.className = 'card';
¬† ¬† let i = document.createElement('input');
¬† ¬† i.value = v;
¬† ¬† i.placeholder = "Nh·∫≠p vƒÉn b·∫£n...";
¬† ¬† i.onchange = saveAll;
¬† ¬† let p = document.createElement('button');
¬† ¬† p.className = 'btn play-btn';
¬† ¬† p.textContent = 'üîä Ph√°t √¢m';
¬† ¬† p.onclick = () => speak(i.value.trim(), p);
¬† ¬† let d = document.createElement('button');
¬† ¬† d.className = 'delete-btn';
¬† ¬† d.textContent = '‚ùå';
¬† ¬† d.onclick = () => { c.remove(); saveAll(); currentIndex = Math.min(currentIndex, getCards().length - 1); };
¬† ¬† c.append(i, p, d);
¬† ¬† document.getElementById('buttonContainer').appendChild(c);
¬† ¬† saveAll();
}

function saveAll() {
¬† ¬† localStorage.setItem('voiceButtons', JSON.stringify([...document.querySelectorAll('.card input')].map(i => i.value.trim())));
}

function loadButtons() {
¬† ¬† let s = JSON.parse(localStorage.getItem('voiceButtons') || "[]");
¬† ¬† (s.length ? s : defaults).forEach(t => addButton(t));
¬† ¬† currentIndex = 0;
}

function resetDefaults() {
¬† ¬† if (confirm("ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh?")) {
¬† ¬† ¬† ¬† localStorage.removeItem('voiceButtons');
¬† ¬† ¬† ¬† document.getElementById('buttonContainer').innerHTML = '';
¬† ¬† ¬† ¬† loadButtons();
¬† ¬† ¬† ¬† currentIndex = 0;
¬† ¬† }
}

function getCards() {
¬† ¬† return document.querySelectorAll('.card input');
}

function cleanupEmptyCards() {
¬† ¬† let c = document.querySelectorAll('.card'), save = false;
¬† ¬† for (let i = c.length - 1; i >= 0; i--) {
¬† ¬† ¬† ¬† let inp = c[i].querySelector('input');
¬† ¬† ¬† ¬† // C·∫ßn t√¨m input trong th·∫ª card, ch·ª© kh√¥ng ph·∫£i th·∫ª card
        let inputElement = c[i].querySelector('input'); 
¬† ¬† ¬† ¬† if (!inputElement || inputElement.value.trim() === '') {
¬† ¬† ¬† ¬† ¬† ¬† c[i].remove();
¬† ¬† ¬† ¬† ¬† ¬† save = true;
¬† ¬† ¬† ¬† }
¬† ¬† }
¬† ¬† if (save) {
¬† ¬† ¬† ¬† saveAll();
¬† ¬† ¬† ¬† currentIndex = Math.min(currentIndex, getCards().length - 1);
¬† ¬† }
}

function moveSpeak(dir) {
¬† ¬† cleanupEmptyCards();
¬† ¬† const c = getCards();
¬† ¬† if (c.length === 0) {
        showPopup("Kh√¥ng c√≥ c√¢u ƒë·ªÉ ph√°t!");
        return;
    }

¬† ¬† if (dir === 0) {
¬† ¬† ¬† ¬† speak(c[currentIndex].value.trim());
¬† ¬† } else {
¬† ¬† ¬† ¬† currentIndex = (currentIndex + dir + c.length) % c.length;
¬† ¬† ¬† ¬† speak(c[currentIndex].value.trim());
¬† ¬† }
}

function toggleLock(lock) {
¬† ¬† const u = document.getElementById('unlock-btn');
¬† ¬† if (lock) {
¬† ¬† ¬† ¬† buttonContainer.style.display = 'none';
¬† ¬† ¬† ¬† addBtnMove.style.display = 'none';
¬† ¬† ¬† ¬† settingsArea.style.display = 'none';

¬† ¬† ¬† ¬† controlArea.classList.add('locked');
¬† ¬† ¬† ¬† document.body.classList.add('locked');
¬† ¬† ¬† ¬† document.getElementById('mainTitle').classList.add('locked-h1');
¬† ¬† ¬† ¬† u.style.display = 'flex';
¬† ¬† } else {
¬† ¬† ¬† ¬† buttonContainer.style.display = 'grid';
¬† ¬† ¬† ¬† addBtnMove.style.display = 'block';
¬† ¬† ¬† ¬† settingsArea.style.display = 'block';

¬† ¬† ¬† ¬† controlArea.classList.remove('locked');
¬† ¬† ¬† ¬† document.body.classList.remove('locked');
¬† ¬† ¬† ¬† document.getElementById('mainTitle').classList.remove('locked-h1');
¬† ¬† ¬† ¬† u.style.display = 'none';
¬† ¬† }
}

window.addEventListener('beforeinstallprompt', e => {
¬† ¬† e.preventDefault();
¬† ¬† deferredPrompt = e;
¬† ¬† if (installState === 'before_install') {
¬† ¬† ¬† ¬† installButton.style.display = 'flex';
¬† ¬† ¬† ¬† installButton.onclick = installApp;
¬† ¬† }
});

function installApp() {
¬† ¬† if (deferredPrompt) {
¬† ¬† ¬† ¬† deferredPrompt.prompt();
¬† ¬† ¬† ¬† deferredPrompt.userChoice.then((choiceResult) => {
¬† ¬† ¬† ¬† ¬† ¬† if (choiceResult.outcome === 'accepted') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† installState = 'installed';
¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† installState = 'rejected';
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† deferredPrompt = null;
¬† ¬† ¬† ¬† ¬† ¬† installButton.style.display = 'none';
¬† ¬† ¬† ¬† });
¬† ¬† }
}

window.addEventListener('appinstalled', () => {
¬† ¬† installState = 'installed';
¬† ¬† installButton.style.display = 'none';
});

if (installState === 'before_install') {
¬† ¬† installButton.style.display = 'none';
}

function warmUpTTS() {
¬† ¬† if (!('speechSynthesis' in window)) return;
¬† ¬† let u = new SpeechSynthesisUtterance(" ");
¬† ¬† u.lang = 'vi-VN';
¬† ¬† u.volume = 0;
¬† ¬† u.rate = 10;
¬† ¬† speechSynthesis.speak(u);
¬† ¬† setTimeout(() => speechSynthesis.cancel(), 500);
}

window.onload = () => {
¬† ¬† loadButtons();
¬† ¬† warmUpTTS();
    // TH√äM: G·∫Øn s·ª± ki·ªán click cho c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng
    document.querySelectorAll('.navigation-group .control-btn').forEach(button => {
        button.addEventListener('click', function() {
            // L·∫•y gi√° tr·ªã 'data-direction' v√† chuy·ªÉn sang s·ªë nguy√™n
            const direction = parseInt(this.getAttribute('data-direction'));
            moveSpeak(direction);
        });
    });
};
</script>
