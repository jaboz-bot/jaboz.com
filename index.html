<div id="settingsArea">
<button class="btn settings-btn" onclick="toggleLock(true)">Khóa giao diện</button>
<button class="btn install-btn large-control-btn" id="installButton">📲 Cài đặt app</button>
<button class="btn reset-btn" onclick="resetDefaults()">♻️ Reset mặc định</button>
</div>

<script>
let deferredPrompt,currentIndex=0,defaults=["Tôi muốn ăn cơm","Tôi muốn uống nước","Tôi muốn đi vệ sinh","Tôi muốn đi ngủ"],installState = 'before_install';
const controlArea=document.getElementById('controlArea'),
      installButton=document.getElementById('installButton'),
      addBtnMove=document.getElementById('add-btn-move');

// ... (Giữ nguyên các hàm speak, showPopup, addButton, saveAll, loadButtons, resetDefaults, getCards, cleanupEmptyCards, moveSpeak, toggleLock) ...

function toggleLock(lock){const s=document.getElementById('settingsArea'),c=document.getElementById('buttonContainer'),u=document.getElementById('unlock-btn');if(lock){s.style.display='none';c.style.display='none';addBtnMove.style.display='none';controlArea.classList.add('locked');document.getElementById('mainTitle').classList.add('locked-h1');u.style.display='flex'}else{s.style.display='block';c.style.display='grid';addBtnMove.style.display='block';controlArea.classList.remove('locked');document.getElementById('mainTitle').classList.remove('locked-h1');u.style.display='none'}}


// --- Logic PWA đã sửa đổi nhẹ ---

window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();
    deferredPrompt=e;
    // Chỉ hiện nút nếu chưa cài đặt và trình duyệt kích hoạt sự kiện
    if (installState === 'before_install') {
        installButton.style.display='flex'; // Hiện nút cài đặt
        installButton.onclick=installApp;
    }
});

function installApp(){
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult)=>{
            if (choiceResult.outcome === 'accepted') {
                installState = 'installed';
            } else {
                installState = 'rejected';
            }
            deferredPrompt=null;
            installButton.style.display='none'; // Ẩn nút sau khi người dùng tương tác
        });
    }
}

window.addEventListener('appinstalled',()=>{
    installState = 'installed';
    installButton.style.display='none'; // Ẩn nút sau khi ứng dụng được cài đặt
});

// Thêm hàm này để ẩn nút nếu không có sự kiện PWA
if (installState === 'before_install') {
    // Ẩn nút khi tải trang, nó sẽ được beforeinstallprompt hiện lên sau (nếu có)
    installButton.style.display='none'; 
}

// --- Kết thúc Logic PWA đã sửa đổi nhẹ ---

function warmUpTTS(){if(!('speechSynthesis'in window))return;let u=new SpeechSynthesisUtterance(" ");u.lang='vi-VN';u.volume=0;u.rate=10;speechSynthesis.speak(u);setTimeout(()=>speechSynthesis.cancel(),500)}
window.onload=()=>{loadButtons();warmUpTTS();}
</script>
</body>
</html>
