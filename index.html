<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√°y h·ªó tr·ª£ gi·ªçng n√≥i</title>
<link rel="manifest" href="manifest.json">
<style>
/* ƒê√É S·ª¨A: PH·∫¶N CSS */
body {
    font-family:'Segoe UI',sans-serif; background:#e3f2fd;
    margin:0; padding:0; text-align:center;
}
.main-wrapper {max-width:700px; margin:auto; padding:20px 10px;}
h1{margin-bottom:20px;}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px;}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,0.15);display:flex;flex-direction:column;gap:10px;position:relative;}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%;}
.btn{
    padding:12px;border:none;border-radius:8px;color:white;font-size:16px;
    cursor:pointer;transition:0.3s;display:flex;justify-content:center;align-items:center;
}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047);}
.play-btn:hover,.add-btn:hover,.reset-btn:hover,.install-btn:hover{transform:scale(1.05);}
.delete-btn{position:absolute;top:6px;right:8px;border:none;background:transparent;color:#e53935;font-size:18px;cursor:pointer;}
.add-btn,.reset-btn,.install-btn{background:linear-gradient(45deg,#2196F3,#1976D2);width:200px;margin:8px auto;display:block;}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7);}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:0.3s;}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin-top:25px;}
.control-btn{width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:0.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;}
.control-btn:hover{transform:scale(1.1);}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047);}
.current-btn-color{background:#ff9800;}
#settingsArea{margin-top:30px;}
/* NH√ìM N√öT ƒê·ªé (N√öT KH√ìA V√Ä N√öT M·ªû KH√ìA) */
#settingsArea .btn:first-child,#unlock-btn{
    background:linear-gradient(45deg,#f44336,#d32f2f);
    width:200px;margin:20px auto;display:block;
}
.control-container.locked{
    position:fixed;top:0;left:0;width:100%;height:100%;
    /* Quan tr·ªçng: D√πng Flexbox ƒë·ªÉ cƒÉn gi·ªØa v√† ƒë·∫©y n√∫t unlock xu·ªëng ƒë√°y */
    display:flex;flex-direction:column;justify-content:center;align-items:center;
}
/* S·ª¨A 1: ƒê·∫©y n√∫t M·ªü Kh√≥a xu·ªëng ƒë√°y khi b·ªã Kh√≥a */
.control-container.locked #unlock-btn {
    width:160px; /* Gi·ªØ nguy√™n k√≠ch th∆∞·ªõc nh·ªè h∆°n */
    margin-top: auto; /* D√πng ƒë·ªÉ ƒë·∫©y n√∫t xu·ªëng */
    margin-bottom: 50px; /* T·∫°o kho·∫£ng c√°ch v·ªõi ƒë√°y trang */
}
#popup{
    position:absolute;bottom:100%;left:50%;
    transform:translateX(-50%) translateY(20px);
    background:rgba(0,0,0,0.8);color:#fff;padding:15px 20px;
    border-radius:12px;font-size:18px;display:none;z-index:101;
    max-width:90%;white-space:pre-wrap;text-align:center;transition:0.5s;
}
/* S·ª¨A 2: H·∫° th·∫•p Popup xu·ªëng (t·ª´ 20% xu·ªëng 40%) */
.control-container.locked #popup{position:fixed;top:40%;transform:translateX(-50%);z-index:1000;}

#tts-info{margin-top:40px;padding-top:20px;border-top:1px solid #ddd;color:#616161;}
</style>
</head>
<body>
<div class="main-wrapper">
    <h1>M√°y h·ªó tr·ª£ gi·ªçng n√≥i</h1>
    <div class="container" id="buttonContainer"></div>
    <div class="control-container" id="controlArea">
        <div id="popup"></div>
        <div class="navigation-group">
            <button class="control-btn play-control-btn" onclick="navigateSpeak(-1)">C√¢u tr∆∞·ªõc</button>
            <button class="control-btn current-btn-color" onclick="navigateSpeak(0)">Ph√°t l·∫°i</button>
            <button class="control-btn play-control-btn" onclick="navigateSpeak(1)">C√¢u sau</button>
        </div>
        <button class="btn" id="unlock-btn" onclick="toggleLock(false)" style="display:none;">M·ªü kh√≥a giao di·ªán</button>
    </div>
    <div id="settingsArea">
        <button class="btn" onclick="toggleLock(true)">Kh√≥a giao di·ªán</button>
        <button class="btn install-btn" id="installButton" style="display:none;">üì≤ T·∫°o L·ªëi t·∫Øt (C√†i ƒë·∫∑t App)</button>
        <button class="btn add-btn" onclick="addButton()">‚ûï Th√™m c√¢u m·ªõi</button>
        <button class="btn reset-btn" onclick="resetDefaults()">‚ôªÔ∏è Reset m·∫∑c ƒë·ªãnh</button>
    </div>
    <div id="tts-info">
        N·∫øu kh√¥ng th·∫•y √¢m thanh, vui l√≤ng t·∫£i gi·ªçng n√≥i t·∫°i
        <a href="market://details?id=com.google.android.tts"
           onclick="window.open('https://play.google.com/store/apps/details?id=com.google.android.tts','_blank'); return false;">
            Google Play
        </a>
    </div>
</div>

<script>
let deferredPrompt;
const defaults=["T√¥i mu·ªën ƒÉn c∆°m","T√¥i mu·ªën u·ªëng n∆∞·ªõc","T√¥i mu·ªën ƒëi v·ªá sinh","T√¥i mu·ªën ƒëi ng·ªß"];
let currentIndex=0;
const controlArea=document.getElementById('controlArea');
const installButton=document.getElementById('installButton');

// --- Ph√°t √¢m ---
function speak(text){
    if(!text||!('speechSynthesis'in window))return;
    window.speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text);
    u.lang='vi-VN';
    speechSynthesis.speak(u);
    showPopup(text);
}

// --- Hi·ªÉn th·ªã popup ---
function showPopup(text){
    const popup=document.getElementById('popup');
    popup.textContent=text;
    const isLocked=controlArea.classList.contains('locked');
    // ƒê√£ thay ƒë·ªïi gi√° tr·ªã Y ban ƒë·∫ßu ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng tr∆∞·ª£t m∆∞·ª£t m√† h∆°n
    popup.style.transform=isLocked?'translateX(-50%) translateY(30px)':'translateX(-50%) translateY(20px)';
    popup.style.display='block';popup.style.opacity='1';
    popup.style.transform='translateX(-50%) translateY(0)';
    setTimeout(()=>{popup.style.opacity='0';popup.style.transform='translateX(-50%) translateY(-20px)';
        setTimeout(()=>popup.style.display='none',500);
    },2000);
}

// --- Qu·∫£n l√Ω n√∫t ---
function addButton(value=''){
    const card=document.createElement('div');card.className='card';
    const input=document.createElement('input');input.value=value;input.placeholder="Nh·∫≠p vƒÉn b·∫£n...";input.onchange=saveAll;
    const play=document.createElement('button');play.className='btn play-btn';play.textContent='üîä Ph√°t √¢m';play.onclick=()=>speak(input.value.trim());
    const del=document.createElement('button');del.className='delete-btn';del.textContent='‚ùå';
    del.onclick=()=>{card.remove();saveAll();adjustIndex();};
    card.append(input,play,del);
    document.getElementById('buttonContainer').appendChild(card);
    saveAll();
}

function saveAll(){
    const texts=[...document.querySelectorAll('.card input')].map(i=>i.value.trim());
    localStorage.setItem('voiceButtons',JSON.stringify(texts));
}
function loadButtons(){
    const saved=JSON.parse(localStorage.getItem('voiceButtons')||"[]");
    document.getElementById('buttonContainer').innerHTML='';
    (saved.length?saved:defaults).forEach(addButton);
    currentIndex=0;
}
function resetDefaults(){
    if(confirm("B·∫°n c√≥ mu·ªën ƒë·∫∑t l·∫°i v·ªÅ m·∫∑c ƒë·ªãnh?")){
        localStorage.removeItem('voiceButtons');
        loadButtons();
    }
}
function getCards(){return document.querySelectorAll('.card input');}
function cleanupEmptyCards(){
    let cards=document.querySelectorAll('.card'),changed=false;
    // S·ª≠ d·ª•ng for...of ƒë·ªÉ l·∫∑p qua cards
    for(let c of cards) {
        let i=c.querySelector('input');
        if(!i||!i.value.trim()){c.remove();changed=true;}
    }
    if(changed){saveAll();adjustIndex();}
}
function adjustIndex(){
    const n=getCards().length;
    if(currentIndex>=n)currentIndex=n>0?n-1:0;
}

// --- 3 n√∫t ƒëi·ªÅu h∆∞·ªõng ---
function navigateSpeak(dir=0){
    cleanupEmptyCards();
    const cards=getCards();
    if(!cards.length)return;
    if(dir===-1)currentIndex=(currentIndex-1+cards.length)%cards.length;
    else if(dir===1)currentIndex=(currentIndex+1)%cards.length;
    speak(cards[currentIndex].value.trim());
}

// --- Kh√≥a / M·ªü kh√≥a ---
function toggleLock(lock){
    const s=document.getElementById('settingsArea');
    const c=document.getElementById('buttonContainer');
    const u=document.getElementById('unlock-btn');
    controlArea.classList.toggle('locked',lock);
    s.style.display=c.style.display=lock?'none':'';
    u.style.display=lock?'block':'none';
    
    // ƒê·∫£m b·∫£o cleanup khi kh√≥a ƒë·ªÉ ch·ªâ m·ª•c kh√¥ng tr·ªè ƒë·∫øn th·∫ª r·ªóng
    if (lock) {
        cleanupEmptyCards();
    }
}

// --- PWA c√†i ƒë·∫∑t ---
installButton.addEventListener('click',()=>installApp());
window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();
    deferredPrompt=e;
    installButton.style.display='block';
});
function installApp(){
    if(!deferredPrompt)return;
    deferredPrompt.prompt();
    deferredPrompt.userChoice.finally(()=>{
        deferredPrompt=null;
        installButton.style.display='none';
    });
}
window.addEventListener('appinstalled',()=>installButton.style.display='none');

// --- Warm-up TTS ---
function warmUpTTS(){
    if(!('speechSynthesis'in window))return;
    const u=new SpeechSynthesisUtterance(" ");
    u.lang='vi-VN';u.volume=0;
    speechSynthesis.speak(u);
    setTimeout(()=>speechSynthesis.cancel(),400);
}

window.onload=()=>{loadButtons();warmUpTTS();};
</script>
</body>
</html>
