<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√°y h·ªó tr·ª£ gi·ªçng n√≥i</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
/* Ch·ªëng ng∆∞·ªùi d√πng vu·ªët m√†n h√¨nh khi kh√≥a */
body.locked {
    overflow: hidden; 
    overscroll-behavior-y: contain; 
    touch-action: none;
}

.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
/* S·ª¨A ƒê·ªîI: Ch·ªânh l·∫°i padding c·ªßa card v√† th√™m box-sizing */
.card {
    background: #fff;
    padding: 12px; /* Gi·∫£m padding t·ª´ 18px xu·ªëng 12px */
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,.15);
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
    box-sizing: border-box; /* B·ªî SUNG QUAN TR·ªåNG */
}
/* ƒê·ªÇ NGUY√äN (ho·∫∑c ch·ªâ c·∫ßn ƒë·∫£m b·∫£o n√≥ l√† 100%) */
input {
    padding: 10px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: 100%;
    box-sizing: border-box; /* B·ªî SUNG QUAN TR·ªåNG: ƒë·ªÉ padding kh√¥ng l√†m tr√†n */
}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn {
    background:linear-gradient(45deg,#4CAF50,#43A047);
    width: 100%; 
    box-sizing: border-box; /* B·ªî SUNG QUAN TR·ªåNG */
}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{
    width:220px;
    height:50px;
    font-size:18px;
    margin:8px auto;
    display:flex;
    justify-content:center;
    align-items:center;
}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)} 
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
/* THAY ƒê·ªîI: S·ª≠ d·ª•ng touch-action: manipulation; ƒë·ªÉ ∆∞u ti√™n c√°c s·ª± ki·ªán nh·∫•n/ch·∫°m */
.control-btn{
    width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;
    touch-action: manipulation; 
}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}

/* CSS cho ch·∫ø ƒë·ªô kh√≥a */
.control-container.locked{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    overflow:hidden;
    z-index:99;
    background:#e3f2fd;
    justify-content: center; 
}
.control-container.locked #add-btn-move,
.control-container.locked #settingsArea {
    display: none !important;
}
.control-container.locked .navigation-group{
    margin:0;
}
.control-container.locked #unlock-btn{
    position:fixed;
    bottom: 80px; 
    left:50%;
    transform:translateX(-50%);
    display:flex;
    z-index:100;
}

/* C·∫≠p nh·∫≠t CSS cho Popup: Lu√¥n fixed v√† cƒÉn gi·ªØa */
#popup{
    position: fixed;
    top: 200px;
    left: 50%;
    transform: translateX(-50%);
    
    background:rgba(0,0,0,.8);
    color:#fff;
    padding:15px 20px;
    border-radius:12px;
    font-size:18px;
    display:none;
    z-index:1000;
    max-width:90%;
    min-width:100px;
    text-align:center;
    transition: opacity 0.5s ease-out; 
}

/* B·∫ÆT ƒê·∫¶U PH·∫¶N CSS ƒê√É S·ª¨A: M·∫∑c ƒë·ªãnh S·ªî L√äN */
.suggestion-box {
    position: absolute;
    bottom: calc(100% - 10px); /* THAY ƒê·ªîI: M·∫∑c ƒë·ªãnh S·ªî L√äN tr√™n input */
    left: 0;
    right: 0;
    z-index: 10;
    background: #fff;
    border: 1px solid #ddd;
    border-bottom: none; /* B·ªè vi·ªÅn d∆∞·ªõi */
    border-radius: 8px 8px 0 0; /* Bo g√≥c tr√™n */
    box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1); /* ƒê·ªï b√≥ng l√™n tr√™n */
    max-height: 150px;
    overflow-y: auto;
    text-align: left;
    display: none;
}

/* TH√äM CLASS M·ªöI CHO TR∆Ø·ªúNG H·ª¢P NGO·∫†I L·ªÜ (S·ªï XU·ªêNG) */
.suggestion-box.align-bottom { /* ƒê·∫∑t t√™n class m·ªõi ƒë·ªÉ d·ªÖ hi·ªÉu h∆°n */
    bottom: auto; /* X√≥a thu·ªôc t√≠nh bottom */
    top: calc(100% - 10px); /* ƒê·∫∑t ngay ph√≠a d∆∞·ªõi input */
    border-top: none; /* B·ªè vi·ªÅn tr√™n */
    border-bottom: 1px solid #ddd; /* Kh√¥i ph·ª•c vi·ªÅn d∆∞·ªõi */
    border-radius: 0 0 8px 8px; /* Bo g√≥c d∆∞·ªõi */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* ƒê·ªï b√≥ng xu·ªëng d∆∞·ªõi */
}

.suggestion-item {
    padding: 10px;
    cursor: pointer;
    font-size: 16px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}
.suggestion-item:last-child {
    border-bottom: none;
}
.suggestion-item:hover {
    background-color: #f0f0f0;
}
    
/* K·∫æT TH√öC B·ªî SUNG CSS */


#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">M√°y h·ªó tr·ª£ gi·ªçng n√≥i</h1>
<div class="container" id="buttonContainer"></div>

<div id="popup"></div>

<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">‚ûï Th√™m c√¢u m·ªõi</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">C√¢u tr∆∞·ªõc</button>
<button class="control-btn current-btn-color" data-direction="0">Ph√°t l·∫°i</button>
<button class="control-btn play-control-btn" data-direction="1">C√¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">M·ªü kh√≥a giao di·ªán</button>
</div>

<div id="settingsArea">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: #fff;">
        <label for="rate-slider" style="font-weight: bold; color: #333;">T·ªëc ƒë·ªô ƒë·ªçc (<span id="rate-value">1.0</span>)</label>
        <input type="range" id="rate-slider" min="0.5" max="2.0" step="0.1" value="1.0" style="width: 90%; cursor: pointer;">
    </div>
    <button class="btn settings-btn" onclick="toggleLock(true)">Kh√≥a giao di·ªán</button>
    <button class="btn install-btn large-control-btn" id="installButton">üì≤ C√†i ƒë·∫∑t app</button>
    <button class="btn reset-btn" onclick="resetDefaults()">‚ôªÔ∏è Reset m·∫∑c ƒë·ªãnh</button>
</div>
</div>

<div id="tts-info">N·∫øu kh√¥ng th·∫•y √¢m thanh, t·∫£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>

// H√ÄM M·ªöI: Tr√≠ch xu·∫•t d·∫•u thanh cho m·ª•c ƒë√≠ch s·∫Øp x·∫øp ∆∞u ti√™n
function getTonePriority(word) {
    // 1: Thanh B·∫±ng/Ngang (c√≥ th·ªÉ kh√¥ng d·∫•u) - ∆Øu ti√™n cao nh·∫•t
    // 2: Thanh S·∫Øc, H·ªèi
    // 3: Thanh Huy·ªÅn, Ng√£, N·∫∑ng
    
    const lowerWord = word.toLowerCase();

    // Thanh S·∫Øc v√† H·ªèi (Priority 2)
    if (/[√°√©√≠√≥√∫√Ω·∫£·∫ª·ªâ·ªè·ªß·ª∑]/.test(lowerWord)) {
        return 2;
    }

    // Thanh Huy·ªÅn, Ng√£ v√† N·∫∑ng (Priority 3)
    if (/[√†√®√¨√≤√π·ª≥√£·∫Ωƒ©√µ≈©·ªπ·∫°·∫π·ªã·ªç·ª•·ªµ]/.test(lowerWord)) {
        return 3;
    }
    
    // M·∫∑c ƒë·ªãnh l√† Thanh B·∫±ng (Priority 1)
    return 1;
}
    
// H√ÄM B·ªî SUNG: Chuy·ªÉn ƒë·ªïi chu·ªói c√≥ d·∫•u th√†nh kh√¥ng d·∫•u
function removeDiacritics(str) {
    if (typeof str !== 'string') return '';
    return str.toLowerCase()
        .replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, "a")
        .replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, "e")
        .replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, "i")
        .replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, "o")
        .replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, "u")
        .replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, "y")
        .replace(/ƒë/g, "d");
}
    

// H√ÄM M·ªöI: T·∫£i d·ªØ li·ªáu g·ª£i √Ω v√† l∆∞u v√†o wordSuggestions
const SUGGESTION_URL = 'goi-y-tu.txt'; // ‚¨ÖÔ∏è QUAN TR·ªåNG: ƒê·ªïi ƒë∆∞·ªùng d·∫´n file
const LOCAL_SUGGESTION_KEY = 'userSuggestions'; 
let serverSuggestions = []; 
let userSuggestions = []; 
let wordSuggestions = []; 

// H√ÄM S·ª¨A ƒê·ªîI: T·∫£i v√† x·ª≠ l√Ω file TXT
async function loadSuggestions() {
    // 1. T·∫£i t·ª´ Server
    try {
        const response = await fetch(SUGGESTION_URL);
        if (response.ok) {
            const textContent = await response.text(); 
            serverSuggestions = textContent
                .split('\n')
                .map(line => line.trim()) // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a ·ªü ƒë·∫ßu/cu·ªëi m·ªói t·ª´
                .filter(line => line.length > 0); // Lo·∫°i b·ªè c√°c d√≤ng tr·ªëng
            
        } else {
            console.error('L·ªói t·∫£i file g·ª£i √Ω server (ki·ªÉm tra file goi-y-tu.txt):', response.statusText);
        }
    } catch (error) {
        console.error('L·ªói khi t·∫£i ho·∫∑c x·ª≠ l√Ω file TXT:', error);
    }

    // 2. T·∫£i t·ª´ LocalStorage
    try {
        const saved = localStorage.getItem(LOCAL_SUGGESTION_KEY);
        userSuggestions = saved ? JSON.parse(saved) : []; 
    } catch(e) {
        console.error('L·ªói t·∫£i g·ª£i √Ω ng∆∞·ªùi d√πng:', e);
        userSuggestions = [];
    }

    // 3. H·ª£p nh·∫•t, lo·∫°i b·ªè tr√πng l·∫∑p v√† s·∫Øp x·∫øp
    wordSuggestions = [...new Set([...serverSuggestions, ...userSuggestions])].sort();
    console.log(`ƒê√£ t·∫£i t·ªïng c·ªông ${wordSuggestions.length} g·ª£i √Ω t·ª´ file TXT v√† LocalStorage.`);
}

// H√ÄM M·ªöI (C·∫£i ti·∫øn): Tr√≠ch xu·∫•t t·ª´ ngay tr∆∞·ªõc con tr·ªè
function extractWordBeforeCursor(inputElement) {
    const fullText = inputElement.value;
    const cursorPosition = inputElement.selectionStart;

    // L·∫•y ph·∫ßn vƒÉn b·∫£n t·ª´ ƒë·∫ßu ƒë·∫øn v·ªã tr√≠ con tr·ªè
    const textBeforeCursor = fullText.substring(0, cursorPosition);
    
    // S·ª≠ d·ª•ng bi·ªÉu th·ª©c ch√≠nh quy ƒë·ªÉ t√¨m t·ª´ cu·ªëi c√πng (kh√¥ng ph·∫£i kho·∫£ng tr·∫Øng)
    // $ l√† cu·ªëi chu·ªói (textBeforeCursor), \S+ l√† m·ªôt ho·∫∑c nhi·ªÅu k√Ω t·ª± KH√îNG ph·∫£i kho·∫£ng tr·∫Øng
    const match = textBeforeCursor.match(/(\S+)$/);

    if (match) {
        // match[0] l√† t·ª´ ƒë√≥, match.index l√† v·ªã tr√≠ b·∫Øt ƒë·∫ßu c·ªßa t·ª´ ƒë√≥
        return {
            word: match[0],
            startIndex: match.index
        };
    }
    
    return { word: '', startIndex: -1 };
}

// H√ÄM S·ª¨A ƒê·ªîI: S·ª≠ d·ª•ng logic tr√≠ch xu·∫•t m·ªõi, s·∫Øp x·∫øp ∆∞u ti√™n v√† GI·ªöI H·∫†N K√ù T·ª∞
function showSuggestions(inputElement, boxElement) {
    const fullText = inputElement.value;
    const { word: lastWord, startIndex: lastWordStart } = extractWordBeforeCursor(inputElement);
    
    const cursorPosition = inputElement.selectionStart;
    const charBeforeCursor = fullText.charAt(cursorPosition - 1);
    // T·∫Øt g·ª£i √Ω n·∫øu ngay sau kho·∫£ng tr·∫Øng ho·∫∑c ·ªü ƒë·∫ßu chu·ªói (kh√¥ng c√≥ t·ª´ ƒë·ªÉ g·ª£i √Ω)
    const isAfterSpace = cursorPosition === 0 || /\s/.test(charBeforeCursor);

    // 1. T·∫ÆT G·ª¢I √ù
    if (lastWord.length === 0 || isAfterSpace) {
        boxElement.style.display = 'none';
        return;
    }

    const lastWordNoDiacritics = removeDiacritics(lastWord).toLowerCase();
    
    boxElement.innerHTML = '';
    
    // 1. L·ªçc
    let filteredSuggestions = wordSuggestions
        .filter(phrase => removeDiacritics(phrase).toLowerCase().startsWith(lastWordNoDiacritics));

    // 2. S·∫Øp x·∫øp: ∆Øu ti√™n Thanh B·∫±ng (1), S·∫Øc/H·ªèi (2), Huy·ªÅn/Ng√£/N·∫∑ng (3)
    filteredSuggestions.sort((a, b) => {
        const toneA = getTonePriority(a);
        const toneB = getTonePriority(b);
        
        if (toneA !== toneB) {
            return toneA - toneB; 
        }
        
        if (a < b) return -1;
        if (a > b) return 1;
        return 0;
    });

    // 3. THAY ƒê·ªîI: C·∫Øt (Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng hi·ªÉn th·ªã b·∫±ng ƒë·ªô d√†i t·ª´ ƒëang g√µ - kh√¥ng d·∫•u)
    const limit = lastWordNoDiacritics.length; 
    filteredSuggestions = filteredSuggestions.slice(0, limit);
    // K·∫æT TH√öC THAY ƒê·ªîI

    // B·∫ÆT ƒê·∫¶U LOGIC ƒêI·ªÄU CH·ªàNH V·ªä TR√ç (M·∫∑c ƒë·ªãnh S·ªî L√äN)
    if (filteredSuggestions.length > 0) {
        const rect = inputElement.getBoundingClientRect();
        const suggestionHeight = 150; // max-height trong CSS
        const spaceAbove = rect.top;

        const TOP_THRESHOLD = window.innerHeight * 0.15; 
        
        let shouldAlignBottom = false; 

        // N·∫øu kh√¥ng ƒë·ªß ch·ªó tr√™n v√† ƒë·ªß ch·ªó d∆∞·ªõi, s·ªï xu·ªëng
        if (spaceAbove < suggestionHeight + 50 && (window.innerHeight - rect.bottom) > suggestionHeight) {
            shouldAlignBottom = true;
        } 
        
        // N·∫øu Input S√ÅT M√âP TR√äN (ƒë·ªÉ tr√°nh b·ªã thanh tr√¨nh duy·ªát che)
        if (rect.top < TOP_THRESHOLD) { 
            shouldAlignBottom = true;
        }

        // √Åp d·ª•ng class m·ªõi
        if (shouldAlignBottom) {
            boxElement.classList.add('align-bottom');
        } else {
            boxElement.classList.remove('align-bottom');
        }
        // K·∫æT TH√öC LOGIC ƒêI·ªÄU CH·ªàNH V·ªä TR√ç

        filteredSuggestions.forEach(phrase => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = phrase;
            
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                
                const currentFullText = inputElement.value;
                const currentCursorPosition = inputElement.selectionStart;

                // Thay th·∫ø t·ª´ ƒë∆∞·ª£c g√µ b·∫±ng c·ª•m t·ª´ g·ª£i √Ω (s·ª≠ d·ª•ng lastWordStart)
                let newText = currentFullText.substring(0, lastWordStart) + phrase;
                
                // Gi·ªØ l·∫°i ph·∫ßn vƒÉn b·∫£n sau t·ª´ ƒë√£ thay th·∫ø (t·ª´ v·ªã tr√≠ con tr·ªè tr·ªü ƒëi)
                newText += currentFullText.substring(currentCursorPosition);

                // Th√™m m·ªôt kho·∫£ng tr·∫Øng sau t·ª´ n·∫øu n√≥ kh√¥ng ph·∫£i ·ªü cu·ªëi chu·ªói
                if (currentCursorPosition === currentFullText.length) {
                    newText += ' ';
                } else if (!newText.endsWith(' ')) {
                     // N·∫øu t·ª´ g·ª£i √Ω kh√¥ng ph·∫£i cu·ªëi chu·ªói v√† kh√¥ng c√≥ kho·∫£ng tr·∫Øng, th√™m m·ªôt kho·∫£ng tr·∫Øng
                     const nextChar = newText.charAt(lastWordStart + phrase.length);
                     if (/\S/.test(nextChar) && nextChar.length > 0) {
                        newText = newText.substring(0, lastWordStart + phrase.length) + ' ' + newText.substring(lastWordStart + phrase.length);
                     }
                }
                
                // C·∫≠p nh·∫≠t gi√° tr·ªã input
                inputElement.value = newText;
                
                boxElement.style.display = 'none';
                saveAll(); 
                inputElement.focus();
                
                // ƒê·∫∑t con tr·ªè ·ªü cu·ªëi t·ª´ v·ª´a thay th·∫ø (+1 cho kho·∫£ng tr·∫Øng n·∫øu c√≥)
                inputElement.selectionStart = inputElement.selectionEnd = lastWordStart + phrase.length + (newText.charAt(lastWordStart + phrase.length) === ' ' ? 1 : 0);
            });

            boxElement.appendChild(item);
        });
        boxElement.style.display = 'block';
    } else {
        boxElement.style.display = 'none';
    }
}
    
let deferredPrompt,currentIndex=0,defaults=["T√¥i mu·ªën ƒÉn c∆°m","T√¥i mu·ªën u·ªëng n∆∞·ªõc","T√¥i mu·ªën ƒëi v·ªá sinh","T√¥i mu·ªën ƒëi ng·ªß"],installState = 'before_install';
const controlArea=document.getElementById('controlArea'),
      installButton=document.getElementById('installButton'),
      addBtnMove=document.getElementById('add-btn-move'),
      popupElement=document.getElementById('popup'),
      buttonContainer=document.getElementById('buttonContainer'),
      settingsArea=document.getElementById('settingsArea');

let currentRate = 1.0; 
const rateSlider = document.getElementById('rate-slider');
const rateValueSpan = document.getElementById('rate-value');
    
function speak(text, targetElement){
    if(!text||!('speechSynthesis'in window))return;
    speechSynthesis.cancel();
    let u=new SpeechSynthesisUtterance(text);
    u.lang='vi-VN';
    u.rate = currentRate; 
    speechSynthesis.speak(u);
    showPopup(text); 
}

function showPopup(text){
    popupElement.textContent=text;
    popupElement.style.display='block';
    popupElement.style.opacity='1';

    setTimeout(()=>{ 
        popupElement.style.opacity='0'; 
        setTimeout(()=>popupElement.style.display='none', 500) 
    },3500) 
}

function getCards(){return document.querySelectorAll('.card input')}

function updateCurrentIndexAfterChange() {
    const c = getCards();
    currentIndex = Math.min(currentIndex, c.length - 1);
    if (currentIndex < 0) currentIndex = 0;
}

// H√ÄM S·ª¨A ƒê·ªîI: Th√™m suggestion-box v√† s·ª± ki·ªán input/blur
function addButton(v=''){
    let c=document.createElement('div');
    c.className='card';
    
    let i=document.createElement('input');
    i.value=v;
    i.placeholder="Nh·∫≠p vƒÉn b·∫£n...";
    i.onchange=saveAll;
    
    let sBox = document.createElement('div'); // H·ªôp g·ª£i √Ω
    sBox.className = 'suggestion-box';

    // G·∫Øn s·ª± ki·ªán khi g√µ
    i.addEventListener('input', (e) => showSuggestions(e.target, sBox));
    
    // ·∫®n h·ªôp g·ª£i √Ω khi m·∫•t focus (d√πng setTimeout ƒë·ªÉ cho ph√©p click v√†o g·ª£i √Ω)
    i.addEventListener('blur', () => {
        setTimeout(() => sBox.style.display = 'none', 150);
    });
    // K·∫æT TH√öC S·ª¨A ƒê·ªîI INPUT
    
    let p=document.createElement('button');
    p.className='btn play-btn';
    p.textContent='üîä Ph√°t √¢m';
    p.onclick=()=>speak(i.value.trim(), p); 
    let d=document.createElement('button');
    d.className='delete-btn';
    d.textContent='‚ùå';
    d.onclick=()=>{
        c.remove();
        saveAll();
        updateCurrentIndexAfterChange(); // C·∫≠p nh·∫≠t sau khi x√≥a
    };
    // ƒê√≠nh k√®m suggestion box v√†o card
    c.append(i, sBox, p, d); 
    document.getElementById('buttonContainer').appendChild(c);
    saveAll();
    // ƒê·∫∑t currentIndex v√†o th·∫ª m·ªõi (th·∫ª cu·ªëi c√πng)
    currentIndex = getCards().length - 1; 
}

function saveAll(){localStorage.setItem('voiceButtons',JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim())))}
function loadButtons(){let s=JSON.parse(localStorage.getItem('voiceButtons')||"[]");(s.length?s:defaults).forEach(t=>addButton(t));currentIndex=0; cleanupEmptyCards();}
function resetDefaults(){if(confirm("ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh?")){localStorage.removeItem('voiceButtons');document.getElementById('buttonContainer').innerHTML='';loadButtons();currentIndex=0;}}

function cleanupEmptyCards(){
    let c=document.querySelectorAll('.card'),save=false;
    for(let i=c.length-1;i>=0;i--){
        let inp=c[i].querySelector('input');
        // Ch·ªâ x√≥a th·∫ª n·∫øu n√≥ ho√†n to√†n tr·ªëng
        if(!inp||inp.value.trim()===''){
            c[i].remove();
            save=true;
        }
    }
    if(save){
        saveAll();
        updateCurrentIndexAfterChange();
    }
}

function moveSpeak(dir){
    const c=getCards();
    if(c.length===0)return;
    
    if(dir===0){
        // Ph√°t l·∫°i c√¢u hi·ªán t·∫°i, ki·ªÉm tra tr·ªëng
        const text = c[currentIndex].value.trim();
        if (text) {
            speak(text);
        } else {
            showPopup("C√¢u tr·ªëng! Vui l√≤ng s·ª≠a ho·∫∑c x√≥a.");
        }
    } else {
        // Di chuy·ªÉn c√¢u tr∆∞·ªõc/sau
        currentIndex=(currentIndex+dir+c.length)%c.length;
        
        // V√≤ng l·∫∑p t√¨m c√¢u kh√¥ng tr·ªëng (ƒë·ªÉ tr√°nh l·∫∑p v√¥ t·∫≠n n·∫øu T·∫§T C·∫¢ tr·ªëng)
        let count = 0;
        while(c[currentIndex].value.trim() === '' && count < c.length) {
            currentIndex=(currentIndex+dir+c.length)%c.length;
            count++;
        }
        
        // N·∫øu t√¨m th·∫•y c√¢u ƒë·ªÉ ƒë·ªçc
        const text = c[currentIndex].value.trim();
        if (text) {
            speak(text);
        } else {
             // Ch·ªâ x·∫£y ra n·∫øu t·∫•t c·∫£ c√°c c√¢u ƒë·ªÅu tr·ªëng
            showPopup("Kh√¥ng c√≥ c√¢u n√†o ƒë·ªÉ ƒë·ªçc.");
        }
    }
}

function toggleLock(lock){
    const u=document.getElementById('unlock-btn');
    // Khi tho√°t kh·ªèi ch·∫ø ƒë·ªô kh√≥a, d·ªçn d·∫πp th·∫ª tr·ªëng
    if (!lock) {
        cleanupEmptyCards();
    }
    
    if(lock){
        buttonContainer.style.display='none';
        addBtnMove.style.display='none';
        settingsArea.style.display='none';
        
        controlArea.classList.add('locked');
        document.body.classList.add('locked');
        document.getElementById('mainTitle').classList.add('locked-h1');
        u.style.display='flex';
    } else {
        buttonContainer.style.display='grid';
        addBtnMove.style.display='block';
        settingsArea.style.display='block';
        
        controlArea.classList.remove('locked');
        document.body.classList.remove('locked');
        document.getElementById('mainTitle').classList.remove('locked-h1');
        u.style.display='none';
    }
}

// G·∫Øn s·ª± ki·ªán cho c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng
document.querySelectorAll('.control-btn').forEach(button => {
    // Gi·ªØ c·∫£ click v√† touchend ƒë·ªÉ t·ªëi ∆∞u ph·∫£n h·ªìi tr√™n di ƒë·ªông
    ['click', 'touchend'].forEach(event => {
        button.addEventListener(event, function(e) {
            // NgƒÉn ch·∫∑n s·ª± ki·ªán ch·∫°m k√≠ch ho·∫°t click hai l·∫ßn
            e.preventDefault(); 
            // D√πng currentTarget ƒë·ªÉ l·∫•y data-direction c·ªßa n√∫t
            moveSpeak(parseInt(e.currentTarget.dataset.direction)); 
        }, { passive: false });
    });
});

window.addEventListener('beforeinstallprompt',e=>{ 
    e.preventDefault(); 
    deferredPrompt=e; 
    if (installState === 'before_install') {
        installButton.style.display='flex';
        installButton.onclick=installApp;
    }
});

function installApp(){
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult)=>{
            if (choiceResult.outcome === 'accepted') {
                installState = 'installed';
            } else {
                installState = 'rejected';
            }
            deferredPrompt=null;
            installButton.style.display='none';
        });
    }
}

window.addEventListener('appinstalled',()=>{ 
    installState = 'installed'; 
    installButton.style.display='none'; 
});

if (installState === 'before_install') { 
    installButton.style.display='none'; 
}

function warmUpTTS(){
    if(!('speechSynthesis'in window))return;
    let u=new SpeechSynthesisUtterance(" ");
    u.lang='vi-VN';
    u.volume=0;
    u.rate=10;
    speechSynthesis.speak(u);
    setTimeout(()=>speechSynthesis.cancel(),500)
}
// H√ÄM M·ªöI: T·∫£i t·ªëc ƒë·ªô ƒë·ªçc t·ª´ LocalStorage
function loadRate() {
    const savedRate = localStorage.getItem('ttsRate');
    if (savedRate !== null) {
        currentRate = parseFloat(savedRate);
    }
    // C·∫≠p nh·∫≠t giao di·ªán
    if (rateSlider) {
        rateSlider.value = currentRate.toFixed(1);
        rateValueSpan.textContent = currentRate.toFixed(1);
    }
}

// H√ÄM M·ªöI: L∆∞u t·ªëc ƒë·ªô ƒë·ªçc
function saveRate(rate) {
    currentRate = rate;
    localStorage.setItem('ttsRate', rate.toFixed(1));
    rateValueSpan.textContent = rate.toFixed(1);
}

// LOGIC THANH TR∆Ø·ª¢T
window.addEventListener('DOMContentLoaded', () => {
    // Ch·ªâ ch·∫°y n·∫øu thanh tr∆∞·ª£t t·ªìn t·∫°i
    if (rateSlider) {
        rateSlider.addEventListener('input', (e) => {
            const newRate = parseFloat(e.target.value);
            // C·∫≠p nh·∫≠t ngay khi k√©o
            rateValueSpan.textContent = newRate.toFixed(1);
            currentRate = newRate; // C·∫≠p nh·∫≠t bi·∫øn ƒë·ªÉ d√πng ngay
        });

        rateSlider.addEventListener('change', (e) => {
            // L∆∞u v√†o LocalStorage khi ng∆∞·ªùi d√πng nh·∫•c tay ra kh·ªèi thanh tr∆∞·ª£t
            saveRate(parseFloat(e.target.value)); 
        });
    }
});
    
// S·ª¨A ƒê·ªîI: G·ªçi h√†m t·∫£i g·ª£i √Ω m·ªõi v√† t·∫£i t·ªëc ƒë·ªô ƒë·ªçc
window.onload=()=>{loadButtons();warmUpTTS();loadSuggestions();loadRate();}
    
</script>

</body>
</html>
