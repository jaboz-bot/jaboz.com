<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√°y h·ªó tr·ª£ gi·ªçng n√≥i</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{
    width:220px;
    height:50px;
    font-size:18px;
    margin:8px auto;
    display:flex;
    justify-content:center;
    align-items:center;
}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)} 
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
.control-btn{width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}

/* CSS cho ch·∫ø ƒë·ªô kh√≥a (ƒê√£ s·ª≠a l·ªói) */
.control-container.locked{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    overflow:hidden;
    z-index:99;
    background:#e3f2fd;
    /* CƒÉn gi·ªØa to√†n b·ªô control-container ƒë·ªÉ c√°c n√∫t nav hi·ªán ·ªü gi·ªØa */
    justify-content: center; 
}
.control-container.locked #add-btn-move,
.control-container.locked #settingsArea {
    display: none !important; /* ƒê·∫£m b·∫£o c√°c n√∫t th√™m v√† c√†i ƒë·∫∑t b·ªã ·∫©n */
}
.control-container.locked .navigation-group{
    margin:0; /* Lo·∫°i b·ªè margin ƒë·ªÉ cƒÉn gi·ªØa tuy·ªát ƒë·ªëi */
}

/* C·∫≠p nh·∫≠t CSS cho Popup */
#popup{
    position: absolute; /* M·∫∑c ƒë·ªãnh l√† absolute ƒë·ªÉ n·∫±m g·∫ßn n√∫t */
    background:rgba(0,0,0,.8);
    color:#fff;
    padding:15px 20px;
    border-radius:12px;
    font-size:18px;
    display:none;
    z-index:1000;
    max-width:90%;
    min-width:100px;
    text-align:center;
    transition:.5s;
    /* X√≥a c√°c thu·ªôc t√≠nh c·ªë ƒë·ªãnh c≈© */
    transform: none; 
    left: auto;
    top: auto;
}
#popup.locked-mode { /* Th√™m class khi kh√≥a giao di·ªán */
    position: fixed;
    top: 150px;
    left: 50%;
    transform: translateX(-50%);
}

#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">M√°y h·ªó tr·ª£ gi·ªçng n√≥i</h1>
<div class="container" id="buttonContainer"></div>

<div id="popup"></div>

<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">‚ûï Th√™m c√¢u m·ªõi</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" onclick="moveSpeak(-1)">C√¢u tr∆∞·ªõc</button>
<button class="control-btn current-btn-color" onclick="moveSpeak(0)">Ph√°t l·∫°i</button>
<button class="control-btn play-control-btn" onclick="moveSpeak(1)">C√¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">M·ªü kh√≥a giao di·ªán</button>
</div>

<div id="settingsArea">
<button class="btn settings-btn" onclick="toggleLock(true)">Kh√≥a giao di·ªán</button>
<button class="btn install-btn large-control-btn" id="installButton">üì≤ C√†i ƒë·∫∑t app</button>
<button class="btn reset-btn" onclick="resetDefaults()">‚ôªÔ∏è Reset m·∫∑c ƒë·ªãnh</button>
</div>
</div>

<div id="tts-info">N·∫øu kh√¥ng th·∫•y √¢m thanh, t·∫£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>
let deferredPrompt,currentIndex=0,defaults=["T√¥i mu·ªën ƒÉn c∆°m","T√¥i mu·ªën u·ªëng n∆∞·ªõc","T√¥i mu·ªën ƒëi v·ªá sinh","T√¥i mu·ªën ƒëi ng·ªß"],installState = 'before_install';
const controlArea=document.getElementById('controlArea'),
¬† ¬† ¬† installButton=document.getElementById('installButton'),
¬† ¬† ¬† addBtnMove=document.getElementById('add-btn-move'),
      popupElement=document.getElementById('popup'),
      buttonContainer=document.getElementById('buttonContainer'),
      settingsArea=document.getElementById('settingsArea'); // L·∫•y th√™m settingsArea

function speak(text, targetElement){
    if(!text||!('speechSynthesis'in window))return;
    speechSynthesis.cancel();
    let u=new SpeechSynthesisUtterance(text);
    u.lang='vi-VN';
    speechSynthesis.speak(u);
    showPopup(text, targetElement);
}

function showPopup(text, targetElement){
    popupElement.textContent=text;
    popupElement.style.display='block';
    popupElement.style.opacity='1';

    if (!document.body.classList.contains('locked')) {
        // Ch·∫ø ƒë·ªô m·ªü kh√≥a: ƒê·ªãnh v·ªã ngay tr√™n n√∫t
        const rect = targetElement.getBoundingClientRect();

        popupElement.style.position = 'absolute';
        
        // ƒê·∫∑t popup ngay ph√≠a tr√™n n√∫t + cu·ªôn trang
        popupElement.style.top = (rect.top + window.scrollY - popupElement.offsetHeight - 10) + 'px'; 
        
        // CƒÉn gi·ªØa ngang v·ªõi n√∫t
        popupElement.style.left = (rect.left + rect.width / 2 - popupElement.offsetWidth / 2) + 'px';

        // X·ª≠ l√Ω tr√†n l·ªÅ (ƒê∆°n gi·∫£n h√≥a)
        const leftLimit = 10;
        const rightLimit = window.innerWidth - popupElement.offsetWidth - 10;
        
        if (parseFloat(popupElement.style.left) < leftLimit) {
             popupElement.style.left = leftLimit + 'px';
        } else if (parseFloat(popupElement.style.left) > rightLimit) {
            popupElement.style.left = rightLimit + 'px';
        }
        
        popupElement.classList.remove('locked-mode');

    } else {
        // Ch·∫ø ƒë·ªô kh√≥a: C·ªë ƒë·ªãnh v·ªã tr√≠
        popupElement.style.position = 'fixed';
        popupElement.style.top = '150px';
        popupElement.style.left = '50%';
        popupElement.style.transform = 'translateX(-50%)';
        popupElement.classList.add('locked-mode');
    }

    setTimeout(()=>{
        popupElement.style.opacity='0';
        setTimeout(()=>popupElement.style.display='none',500)
    },2000)
}

function addButton(v=''){
    let c=document.createElement('div');
    c.className='card';
    let i=document.createElement('input');
    i.value=v;
    i.placeholder="Nh·∫≠p vƒÉn b·∫£n...";
    i.onchange=saveAll;
    let p=document.createElement('button');
    p.className='btn play-btn';
    p.textContent='üîä Ph√°t √¢m';
    p.onclick=()=>speak(i.value.trim(), p); 
    let d=document.createElement('button');
    d.className='delete-btn';
    d.textContent='‚ùå';
    d.onclick=()=>{c.remove();saveAll();currentIndex=Math.min(currentIndex,getCards().length-1)};
    c.append(i,p,d);
    document.getElementById('buttonContainer').appendChild(c);
    saveAll()
}

function saveAll(){localStorage.setItem('voiceButtons',JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim())))}
function loadButtons(){let s=JSON.parse(localStorage.getItem('voiceButtons')||"[]");(s.length?s:defaults).forEach(t=>addButton(t));currentIndex=0}
function resetDefaults(){if(confirm("ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh?")){localStorage.removeItem('voiceButtons');document.getElementById('buttonContainer').innerHTML='';loadButtons();currentIndex=0}}
function getCards(){return document.querySelectorAll('.card input')}
function cleanupEmptyCards(){let c=document.querySelectorAll('.card'),save=false;for(let i=c.length-1;i>=0;i--){let inp=c[i].querySelector('input');if(!inp||inp.value.trim()===''){c[i].remove();save=true}}if(save){saveAll();currentIndex=Math.min(currentIndex,getCards().length-1)}}
function moveSpeak(dir){
    cleanupEmptyCards();
    const c=getCards();
    if(c.length===0)return;

    // C√°c n√∫t ƒëi·ªÅu khi·ªÉn n·∫±m trong controlArea, n√™n ta d√πng n√∫t 'Ph√°t l·∫°i' l√†m target
    const targetButton = controlArea.querySelector('.current-btn-color'); 
    
    if(dir===0){
        speak(c[currentIndex].value.trim(), targetButton);
    } else {
        currentIndex=(currentIndex+dir+c.length)%c.length;
        speak(c[currentIndex].value.trim(), targetButton);
    }
}

// S·ª≠a l·ªói: Ch·ªâ ·∫©n c√°c ph·∫ßn t·ª≠ kh√¥ng mong mu·ªën, gi·ªØ l·∫°i controlArea
function toggleLock(lock){
    const u=document.getElementById('unlock-btn');
    if(lock){
        buttonContainer.style.display='none';
        addBtnMove.style.display='none';
        settingsArea.style.display='none'; // ·∫®n khu v·ª±c c√†i ƒë·∫∑t
        
        controlArea.classList.add('locked');
        document.body.classList.add('locked');
        document.getElementById('mainTitle').classList.add('locked-h1');
        u.style.display='flex';
    } else {
        buttonContainer.style.display='grid';
        addBtnMove.style.display='block';
        settingsArea.style.display='block'; // Hi·ªán khu v·ª±c c√†i ƒë·∫∑t
        
        controlArea.classList.remove('locked');
        document.body.classList.remove('locked');
        document.getElementById('mainTitle').classList.remove('locked-h1');
        u.style.display='none';
    }
}

window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();
    deferredPrompt=e;
    if (installState === 'before_install') {
        installButton.style.display='flex';
        installButton.onclick=installApp;
    }
});

function installApp(){
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult)=>{
            if (choiceResult.outcome === 'accepted') {
                installState = 'installed';
            } else {
                installState = 'rejected';
            }
            deferredPrompt=null;
            installButton.style.display='none';
        });
    }
}

window.addEventListener('appinstalled',()=>{
    installState = 'installed';
    installButton.style.display='none';
});

if (installState === 'before_install') {
    installButton.style.display='none'; 
}

function warmUpTTS(){if(!('speechSynthesis'in window))return;let u=new SpeechSynthesisUtterance(" ");u.lang='vi-VN';u.volume=0;u.rate=10;speechSynthesis.speak(u);setTimeout(()=>speechSynthesis.cancel(),500)}
window.onload=()=>{loadButtons();warmUpTTS();}
</script>
</body>
</html>
