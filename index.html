<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karaoke Finder</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827, #0f172a);
      color: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
    }
    body.modal-open {
      overflow: hidden;
    }
    .app {
      width: min(100%, 900px);
      display: grid;
      gap: 18px;
    }
    .search-box {
      display: block;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
    }
    .search-box input {
      width: 100%;
      padding: 18px 20px;
      background: transparent;
      border: none;
      color: inherit;
      font-size: 1.05rem;
      outline: none;
    }
    .search-box input::placeholder { color: rgba(226, 232, 240, 0.5); }
    .status {
      margin: 0;
      padding: 0 8px 4px;
      min-height: 18px;
      font-size: 0.9rem;
      color: rgba(148, 191, 255, 0.85);
    }
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(6px);
      z-index: 999;
      padding: clamp(16px, 4vw, 32px);
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .modal.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .modal-content {
      position: relative;
      width: min(100%, 900px);
      aspect-ratio: 16 / 9;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 20px;
      box-shadow: 0 32px 64px rgba(15, 23, 42, 0.55);
      overflow: hidden;
    }
    .modal iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    .modal-placeholder {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      text-align: center;
      padding: 24px;
      color: rgba(226, 232, 240, 0.85);
      gap: 12px;
    }
    .modal-close {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.6);
      color: inherit;
      cursor: pointer;
      font-size: 1.2rem;
      display: grid;
      place-items: center;
      transition: transform 0.15s ease, background 0.2s ease;
    }
    .modal-close:hover,
    .modal-close:focus-visible {
      transform: scale(1.05);
      background: rgba(56, 189, 248, 0.2);
    }
    .results {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }
    .results button,
    .results li.empty {
      width: 100%;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 14px 18px;
      color: inherit;
      font-weight: 500;
      text-align: left;
      cursor: pointer;
      transition: transform 0.18s ease, border-color 0.18s ease, background 0.18s ease;
      outline: none;
    }
    .results button:hover,
    .results button:focus-visible {
      transform: translateY(-1px);
      border-color: rgba(56, 189, 248, 0.6);
      background: rgba(56, 189, 248, 0.12);
    }
    .results li.empty {
      text-align: center;
      opacity: 0.6;
      font-weight: 400;
      cursor: default;
    }
    @media (min-width: 640px) {
      body { padding: 48px 16px; }
    }
  </style>
</head>
<body>
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Trình phát karaoke">
    <div class="modal-content">
      <button id="modal-close" class="modal-close" type="button" aria-label="Đóng trình phát">&times;</button>
      <div id="modal-placeholder" class="modal-placeholder">Đang chuẩn bị video...</div>
      <iframe
        id="modal-frame"
        title="Karaoke Player"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen
      ></iframe>
    </div>
  </div>

  <main class="app">
    <label class="search-box">
      <input
        type="search"
        id="search"
        placeholder="Nhập tên bài hát karaoke..."
        autocomplete="off"
        spellcheck="false"
      />
    </label>
    <p id="status" class="status" role="status" aria-live="polite"></p>
    <ul id="results" class="results"></ul>
  </main>

  <script>
    const songs = [
      { title: "Karaoke Em Gái Mưa - Hương Tràm", query: "karaoke em gái mưa hương tràm" },
      { title: "Karaoke Người Lạ Ơi - Karik ft. Orange", query: "karaoke người lạ ơi karik orange" },
      { title: "Karaoke Sầu Hồng Gai - G5R Squad", query: "karaoke sầu hồng gai g5r squad" },
      { title: "Karaoke Đừng Lo Anh Đợi Mà - Mr. Siro", query: "karaoke đừng lo anh đợi mà mr siro" },
      { title: "Karaoke Waiting For You - Mono", query: "karaoke waiting for you mono" },
      { title: "Karaoke Muộn Rồi Mà Sao Còn - Sơn Tùng M-TP", query: "karaoke muộn rồi mà sao còn sơn tùng" },
      { title: "Karaoke Có Chàng Trai Viết Lên Cây - Phan Mạnh Quỳnh", query: "karaoke có chàng trai viết lên cây phan mạnh quỳnh" },
      { title: "Karaoke Lạc Trôi - Sơn Tùng M-TP", query: "karaoke lạc trôi sơn tùng" },
      { title: "Karaoke Vùng Ký Ức - Chi Dân", query: "karaoke vùng ký ức chi dân" },
      { title: "Karaoke Họ Yêu Ai Mất Rồi - Doãn Hiếu", query: "karaoke họ yêu ai mất rồi doãn hiếu" },
      { title: "Karaoke Thương Em Là Điều Anh Không Thể Ngờ - Noo Phước Thịnh", query: "karaoke thương em là điều anh không thể ngờ noo phước thịnh" },
      { title: "Karaoke Bên Trên Tầng Lầu - Tăng Duy Tân", query: "karaoke bên trên tầng lầu tăng duy tân" },
      { title: "Karaoke Hoa Nở Không Màu - Hoài Lâm", query: "karaoke hoa nở không màu hoài lâm" },
      { title: "Karaoke Cưới Thôi - Masew, BRay", query: "karaoke cưới thôi masew bray" },
      { title: "Karaoke Yêu Là Cưới - Phát Hồ", query: "karaoke yêu là cưới phát hồ" }
    ];

    const searchInput = document.getElementById("search");
    const resultsList = document.getElementById("results");
    const status = document.getElementById("status");
    const modal = document.getElementById("modal");
    const modalFrame = document.getElementById("modal-frame");
    const modalPlaceholder = document.getElementById("modal-placeholder");
    const modalClose = document.getElementById("modal-close");
    const MIN_CHARS = 2;

    function setStatus(message) {
      status.textContent = message || "";
    }

    function showModal(message) {
      modalPlaceholder.textContent = message || "Đang chuẩn bị video karaoke...";
      modalPlaceholder.style.display = "grid";
      modalFrame.style.display = "none";
      modalFrame.src = "";
      modal.classList.remove("hidden");
      document.body.classList.add("modal-open");
    }

    function playInModal(src, message) {
      if (message) {
        modalPlaceholder.textContent = message;
      }
      modalPlaceholder.style.display = "grid";
      modalFrame.style.display = "none";
      modalFrame.src = src;
    }

    function createItem(song) {
      const li = document.createElement("li");
      const button = document.createElement("button");
      button.type = "button";
      button.textContent = song.title;
      button.dataset.query = song.query;
      button.addEventListener("click", () => playSong(song.query, song.title));
      li.appendChild(button);
      return li;
    }

    async function playSong(query, title) {
      showModal(`Đang chuẩn bị video cho: ${title}`);
      setStatus(`Đang tìm video: ${title}`);
      const fallback = `https://www.youtube.com/embed?listType=search&list=${encodeURIComponent(query)}&autoplay=1&rel=0&modestbranding=1&playsinline=1`;
      
      // Luôn có fallback sẵn sàng
      let fallbackTimeout = setTimeout(() => {
        playInModal(fallback, "Đang tải danh sách karaoke...");
        setStatus(`Đang phát danh sách karaoke: ${title}`);
      }, 5000); // Sau 5 giây nếu chưa có kết quả, dùng fallback
      
      try {
        const videoId = await fetchFirstVideoId(query);
        clearTimeout(fallbackTimeout);
        
        if (!videoId) {
          playInModal(fallback, "Đang phát danh sách karaoke phù hợp...");
          setStatus(`Đang phát danh sách karaoke theo từ khóa: ${title}`);
          return;
        }
        
        playInModal(
          `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&playsinline=1&enablejsapi=1`,
          "Đang tải video karaoke..."
        );
        setStatus(`Đang phát: ${title}`);
      } catch (error) {
        clearTimeout(fallbackTimeout);
        playInModal(fallback, "Đang phát danh sách karaoke...");
        setStatus(`Đang phát danh sách karaoke: ${title}`);
        console.error('Lỗi khi tìm video:', error);
      }
    }

    function closeModal() {
      modal.classList.add("hidden");
      document.body.classList.remove("modal-open");
      modalPlaceholder.textContent = "Đang chuẩn bị video...";
      modalPlaceholder.style.display = "grid";
      modalFrame.style.display = "none";
      modalFrame.src = "";
      setStatus("Đã đóng trình phát.");
    }

    modalFrame.addEventListener("load", () => {
      if (modal.classList.contains("hidden")) return;
      modalPlaceholder.style.display = "none";
      modalFrame.style.display = "block";
    });
    
    // Xử lý lỗi iframe trên mobile
    modalFrame.addEventListener("error", () => {
      if (modal.classList.contains("hidden")) return;
      const currentSrc = modalFrame.src;
      if (currentSrc && currentSrc.includes('youtube')) {
        // Thử fallback với URL khác
        const fallbackUrl = currentSrc.replace('youtube-nocookie.com', 'youtube.com');
        modalFrame.src = fallbackUrl;
        modalPlaceholder.textContent = "Đang thử phương án dự phòng...";
      }
    });

    modalClose.addEventListener("click", closeModal);

    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !modal.classList.contains("hidden")) {
        closeModal();
      }
    });

    function showEmpty() {
      const li = document.createElement("li");
      li.className = "empty";
      li.textContent = "Không có kết quả.";
      return li;
    }

    // Hàm tìm kiếm trên YouTube (không dùng API - web scraping qua proxy)
    async function searchYouTube(query) {
      if (!query || query.length < 2) {
        return null;
      }
      
      const searchQuery = encodeURIComponent(query);
      
      // Tạo AbortController với timeout (dài hơn cho mobile)
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const timeout = isMobile ? 12000 : 6000; // Tăng timeout cho mobile
      
      const createFetchWithTimeout = (url, timeoutMs = timeout) => {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        return fetch(url, { 
          signal: controller.signal,
          mode: 'cors',
          cache: 'no-cache'
        })
          .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) throw new Error('Network response was not ok');
            return response;
          })
          .catch(err => {
            clearTimeout(timeoutId);
            throw err;
          });
      };
      
      // Thử nhiều proxy cùng lúc (ưu tiên proxy ổn định cho mobile)
      const youtubeUrl = `https://www.youtube.com/results?search_query=${searchQuery}`;
      const proxyPromises = [
        // Proxy 1: allorigins (ổn định nhất)
        createFetchWithTimeout(`https://api.allorigins.win/get?url=${encodeURIComponent(youtubeUrl)}`)
          .then(r => r.json())
          .then(d => d.contents || '')
          .catch(() => ''),
        // Proxy 2: corsproxy (tốt cho mobile)
        createFetchWithTimeout(`https://corsproxy.io/?${encodeURIComponent(youtubeUrl)}`)
          .then(r => r.text())
          .catch(() => ''),
        // Proxy 3: codetabs
        createFetchWithTimeout(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(youtubeUrl)}`)
          .then(r => r.text())
          .catch(() => ''),
        // Proxy 4: thingproxy (backup)
        createFetchWithTimeout(`https://thingproxy.freeboard.io/fetch/${youtubeUrl}`)
          .then(r => r.text())
          .catch(() => '')
      ];
      
      try {
        let html = '';
        // Thử Promise.race trước (lấy kết quả nhanh nhất)
        try {
          html = await Promise.race(proxyPromises);
        } catch (raceError) {
          console.log('Promise.race failed, trying allSettled...');
        }
        
        // Nếu không có kết quả, thử tất cả
        if (!html || html.trim() === '') {
          const settled = await Promise.allSettled(proxyPromises);
          for (const result of settled) {
            if (result.status === 'fulfilled' && result.value && result.value.trim() !== '') {
              html = result.value;
              console.log('Got HTML from fallback proxy');
              break;
            }
          }
        }
        
        if (!html || html.trim() === '') {
          console.log('No HTML content from proxies, trying RSS fallback...');
          // Fallback: Thử RSS feed (đơn giản hơn, ít bị chặn hơn)
          try {
            const rssUrl = `https://www.youtube.com/feeds/videos.xml?search_query=${searchQuery}`;
            const rssResponse = await createFetchWithTimeout(rssUrl, timeout);
            if (rssResponse.ok) {
              const xmlText = await rssResponse.text();
              const parser = new DOMParser();
              const doc = parser.parseFromString(xmlText, "application/xml");
              const entry = doc.getElementsByTagName("entry")[0];
              if (entry) {
                const videoTag = entry.getElementsByTagName("yt:videoId")[0] || entry.getElementsByTagName("videoId")[0];
                if (videoTag && videoTag.textContent) {
                  console.log('Got videoId from RSS feed');
                  return videoTag.textContent;
                }
              }
            }
          } catch (rssError) {
            console.log('RSS fallback also failed:', rssError);
          }
          return null;
        }
        
        // Parse với regex - tìm pattern videoRenderer
        const videoPattern = /"videoRenderer":\{[^}]*"videoId":"([^"]{11})"[^}]*"title":\{"runs":\[\{"text":"([^"]+)"\}[^}]*"ownerText":\{"runs":\[\{"text":"([^"]+)"\}/g;
        
        let match;
        const seenIds = new Set();
        match = videoPattern.exec(html);
        
        if (match && match[1]) {
          const videoId = match[1];
          if (!seenIds.has(videoId)) {
            seenIds.add(videoId);
            console.log('Got videoId from videoRenderer pattern');
            return videoId;
          }
        }
        
        // Fallback: pattern đơn giản hơn - tìm videoId đầu tiên
        const videoIdRegex = /"videoId":"([^"]{11})"/g;
        const matches = [];
        let vidMatch;
        while ((vidMatch = videoIdRegex.exec(html)) !== null && matches.length < 5) {
          if (!seenIds.has(vidMatch[1])) {
            seenIds.add(vidMatch[1]);
            matches.push(vidMatch[1]);
          }
        }
        
        if (matches.length > 0) {
          console.log('Got videoId from simple pattern');
          return matches[0];
        }
        
        return null;
      } catch (error) {
        console.error('Lỗi tìm kiếm YouTube:', error);
        return null;
      }
    }

    async function fetchFirstVideoId(rawQuery) {
      const keyword = rawQuery.toLowerCase().includes("karaoke")
        ? rawQuery
        : `${rawQuery} karaoke`;
      return await searchYouTube(keyword);
    }

    searchInput.addEventListener("input", () => {
      const keyword = searchInput.value.trim().toLowerCase();
      resultsList.innerHTML = "";

      if (keyword.length < MIN_CHARS) {
        return;
      }

      const filtered = songs.filter((song) =>
        song.title.toLowerCase().includes(keyword)
      );

      if (!filtered.length) {
        resultsList.appendChild(showEmpty());
        return;
      }

      filtered.forEach((song) => resultsList.appendChild(createItem(song)));
    });
  </script>
</body>
</html>
