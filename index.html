<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√°y h·ªó tr·ª£ gi·ªçng n√≥i</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
body.locked{overflow:hidden;overscroll-behavior-y:contain;touch-action:none}
.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
.card{background:#fff;padding:12px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative;box-sizing:border-box}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%;box-sizing:border-box}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047);width:100%;box-sizing:border-box}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{width:220px;height:50px;font-size:18px;margin:8px auto;display:flex;justify-content:center;align-items:center}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)}
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
.control-btn{width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;touch-action:manipulation}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}
.control-container.locked{position:fixed;top:0;left:0;width:100%;height:100%;overflow:hidden;z-index:99;background:#e3f2fd;justify-content:center}
.control-container.locked #add-btn-move,#controlArea #settingsArea{display:none!important}
.control-container.locked .navigation-group{margin:0}
.control-container.locked #unlock-btn{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);display:flex;z-index:100}
#popup{position:fixed;top:200px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:15px 20px;border-radius:12px;font-size:18px;display:none;z-index:1000;max-width:90%;min-width:100px;text-align:center;transition:opacity .5s}
.suggestion-box{position:absolute;bottom:calc(100% - 10px);left:0;right:0;z-index:10;background:#fff;border:1px solid #ddd;border-bottom:none;border-radius:8px 8px 0 0;box-shadow:0 -4px 6px rgba(0,0,0,0.1);max-height:150px;overflow-y:auto;text-align:left;display:none}
.suggestion-box.align-bottom{bottom:auto;top:calc(100% - 10px);border-top:none;border-bottom:1px solid #ddd;border-radius:0 0 8px 8px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
.suggestion-item{padding:10px;cursor:pointer;font-size:16px;border-bottom:1px solid #eee;transition:background-color .2s}
.suggestion-item:last-child{border-bottom:none}
.suggestion-item:hover{background-color:#f0f0f0}
#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
 /* CSS M·ªöI ƒê·ªÇ T·∫†O HI·ªÜU ·ª®NG CH·∫†Y CH·ªÆ */
#scrolling-message {
    position: fixed;
    bottom: px; /* ƒê·∫∑t ·ªü tr√™n #tts-info */
    left: 0;
    width: 100%;
    padding: 8px 0;
    background: linear-gradient(90deg, #bbdefb, #e3f2fd, #bbdefb); /* N·ªÅn nh·∫π nh√†ng */
    border-top: 1px solid #90caf9;
    border-bottom: 1px solid #90caf9;
    color: #1565c0; /* M√†u ch·ªØ xanh */
    font-size: 15px;
    font-weight: bold;
    white-space: nowrap; /* NgƒÉn ch·ªØ xu·ªëng d√≤ng */
    overflow: hidden; /* Che ƒëi ph·∫ßn ch·ªØ th·ª´a */
    box-sizing: border-box;
    z-index: 1005;
}

#scrolling-message-content {
    display: inline-block;
    padding-left: 100%; /* B·∫Øt ƒë·∫ßu t·ª´ ngo√†i c√πng b√™n ph·∫£i */
    animation: marquee 25s linear infinite; /* Hi·ªáu ·ª©ng ch·∫°y ch·ªØ */
}

@keyframes marquee {
    0% { transform: translate(0, 0); }
    100% { transform: translate(-100%, 0); }
}

body.locked #scrolling-message {
    bottom: 148px; /* Di chuy·ªÉn l√™n khi giao di·ªán b·ªã kh√≥a */
}

body.locked #tts-info {
    z-index: 1011; /* ƒê·∫£m b·∫£o tts-info n·∫±m tr√™n c√πng */
}   
</style>
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">M√°y h·ªó tr·ª£ gi·ªçng n√≥i</h1>
<div class="container" id="buttonContainer"></div>
<div id="popup"></div>
<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">‚ûï Th√™m c√¢u m·ªõi</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">C√¢u tr∆∞·ªõc</button>
<button class="control-btn current-btn-color" data-direction="0">Ph√°t l·∫°i</button>
<button class="control-btn play-control-btn" data-direction="1">C√¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">M·ªü kh√≥a giao di·ªán</button>
</div>

<div id="settingsArea">
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:20px;padding:10px;border:1px solid #ccc;border-radius:8px;background:#fff">
        <label for="rate-slider" style="font-weight:bold;color:#333">T·ªëc ƒë·ªô ƒë·ªçc (<span id="rate-value">1.0</span>)</label>
        <input type="range" id="rate-slider" min="0.5" max="2.0" step="0.1" value="1.0" style="width:90%;cursor:pointer">
    </div>
    <button class="btn settings-btn" onclick="toggleLock(true)">Kh√≥a giao di·ªán</button>
    <button class="btn install-btn large-control-btn" id="installButton">üì≤ C√†i ƒë·∫∑t app</button>
    <button class="btn reset-btn" onclick="resetDefaults()">‚ôªÔ∏è Reset m·∫∑c ƒë·ªãnh</button>
</div>
</div>

<div id="scrolling-message">
    <span id="scrolling-message-content">
        ‚≠êÔ∏è ƒê√¢y l√† n·ªÅn t·∫£ng h·ªó tr·ª£ giao ti·∫øp d√†nh cho ng∆∞·ªùi g·∫∑p kh√≥ khƒÉn v·ªÅ ph√°t √¢m ho·∫∑c v·∫≠n ƒë·ªông, ƒë·∫∑c bi·ªát l√† sau tai bi·∫øn. H·ªá th·ªëng cho ph√©p ng∆∞·ªùi d√πng t·∫°o v√† ph√°t √¢m thanh c√°c c√¢u n√≥i th∆∞·ªùng d√πng, gi√∫p vi·ªác trao ƒë·ªïi v·ªõi gia ƒë√¨nh, y b√°c sƒ© hay ng∆∞·ªùi chƒÉm s√≥c tr·ªü n√™n d·ªÖ d√†ng h∆°n. C·∫ßn h·ªó tr·ª£? H√£y li√™n h·ªá! ‚≠êÔ∏è
    </span>
</div>
    
<div id="tts-info">N·∫øu kh√¥ng th·∫•y √¢m thanh, t·∫£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>
function getTonePriority(word){
    const lowerWord = word.toLowerCase();
    if (/[√°√©√≠√≥√∫√Ω·∫£·∫ª·ªâ·ªè·ªß·ª∑]/.test(lowerWord)) return 2;
    if (/[√†√®√¨√≤√π·ª≥√£·∫Ωƒ©√µ≈©·ªπ·∫°·∫π·ªã·ªç·ª•·ªµ]/.test(lowerWord)) return 3;
    return 1;
}

function removeDiacritics(str){
    if (typeof str !== 'string') return '';
    return str.toLowerCase()
        .replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, "a")
        .replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, "e")
        .replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, "i")
        .replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, "o")
        .replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, "u")
        .replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, "y")
        .replace(/ƒë/g, "d");
}

const SUGGESTION_URL = 'goi-y-tu.txt';
const LOCAL_SUGGESTION_KEY = 'userSuggestions';
let serverSuggestions = [], userSuggestions = [], wordSuggestions = [];

async function loadSuggestions(){
    try{
        const response = await fetch(SUGGESTION_URL);
        if(response.ok){
            const textContent = await response.text();
            serverSuggestions = textContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        } else {
            console.error('L·ªói t·∫£i file g·ª£i √Ω server (ki·ªÉm tra file goi-y-tu.txt):', response.statusText);
        }
    } catch (error){
        console.error('L·ªói khi t·∫£i ho·∫∑c x·ª≠ l√Ω file TXT:', error);
    }

    try{
        const saved = localStorage.getItem(LOCAL_SUGGESTION_KEY);
        userSuggestions = saved ? JSON.parse(saved) : [];
    } catch(e){
        console.error('L·ªói t·∫£i g·ª£i √Ω ng∆∞·ªùi d√πng:', e);
        userSuggestions = [];
    }

    wordSuggestions = [...new Set([...serverSuggestions, ...userSuggestions])].sort();
    console.log(`ƒê√£ t·∫£i t·ªïng c·ªông ${wordSuggestions.length} g·ª£i √Ω t·ª´ file TXT v√† LocalStorage.`);
}

function extractWordBeforeCursor(inputElement){
    const fullText = inputElement.value;
    const cursorPosition = inputElement.selectionStart;
    const textBeforeCursor = fullText.substring(0, cursorPosition);
    const match = textBeforeCursor.match(/(\S+)$/);
    if(match){
        return { word: match[0], startIndex: match.index };
    }
    return { word: '', startIndex: -1 };
}

function showSuggestions(inputElement, boxElement){
    const fullText = inputElement.value;
    const { word: lastWord, startIndex: lastWordStart } = extractWordBeforeCursor(inputElement);
    const cursorPosition = inputElement.selectionStart;
    const charBeforeCursor = fullText.charAt(cursorPosition - 1);
    const isAfterSpace = cursorPosition === 0 || /\s/.test(charBeforeCursor);

    if(lastWord.length === 0 || isAfterSpace){
        boxElement.style.display = 'none';
        return;
    }

    const lastWordNoDiacritics = removeDiacritics(lastWord).toLowerCase();
    boxElement.innerHTML = '';

    let filteredSuggestions = wordSuggestions
        .filter(phrase => removeDiacritics(phrase).toLowerCase().startsWith(lastWordNoDiacritics));

    filteredSuggestions.sort((a, b) => {
        const aNo = removeDiacritics(a).toLowerCase();
        const bNo = removeDiacritics(b).toLowerCase();
        if(aNo < bNo) return -1;
        if(aNo > bNo) return 1;
        if(a < b) return -1;
        if(a > b) return 1;
        return 0;
    });

    if(filteredSuggestions.length > 0){
        const rect = inputElement.getBoundingClientRect();
        const suggestionHeight = 150;
        const spaceAbove = rect.top;
        const TOP_THRESHOLD = window.innerHeight * 0.15;
        let shouldAlignBottom = false;

        if(spaceAbove < suggestionHeight + 50 && (window.innerHeight - rect.bottom) > suggestionHeight){
            shouldAlignBottom = true;
        }
        if(rect.top < TOP_THRESHOLD) shouldAlignBottom = true;

        if(shouldAlignBottom) boxElement.classList.add('align-bottom');
        else boxElement.classList.remove('align-bottom');

        filteredSuggestions.forEach(phrase => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = phrase;
            item.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const currentFullText = inputElement.value;
                const currentCursorPosition = inputElement.selectionStart;
                let newText = currentFullText.substring(0, lastWordStart) + phrase;
                newText += currentFullText.substring(currentCursorPosition);
                if(currentCursorPosition === currentFullText.length){
                    newText += ' ';
                } else if(!newText.endsWith(' ')){
                    const nextChar = newText.charAt(lastWordStart + phrase.length);
                    if(/\S/.test(nextChar) && nextChar.length > 0){
                        newText = newText.substring(0, lastWordStart + phrase.length) + ' ' + newText.substring(lastWordStart + phrase.length);
                    }
                }
                inputElement.value = newText;
                boxElement.style.display = 'none';
                saveAll();
                inputElement.focus();
                inputElement.selectionStart = inputElement.selectionEnd = lastWordStart + phrase.length + (newText.charAt(lastWordStart + phrase.length) === ' ' ? 1 : 0);
            });
            boxElement.appendChild(item);
        });
        boxElement.style.display = 'block';
    } else {
        boxElement.style.display = 'none';
    }
}

let deferredPrompt, currentIndex = 0;
const defaults = ["T√¥i mu·ªën ƒÉn c∆°m","T√¥i mu·ªën u·ªëng n∆∞·ªõc","T√¥i mu·ªën ƒëi v·ªá sinh","T√¥i mu·ªën ƒëi ng·ªß"];
let installState = 'before_install';
const controlArea = document.getElementById('controlArea'),
      installButton = document.getElementById('installButton'),
      addBtnMove = document.getElementById('add-btn-move'),
      popupElement = document.getElementById('popup'),
      buttonContainer = document.getElementById('buttonContainer'),
      settingsArea = document.getElementById('settingsArea');

let currentRate = 1.0;
const rateSlider = document.getElementById('rate-slider');
const rateValueSpan = document.getElementById('rate-value');

function speak(text){
    if(!text || !('speechSynthesis' in window)) return;
    speechSynthesis.cancel();
    let u = new SpeechSynthesisUtterance(text);
    u.lang = 'vi-VN';
    u.rate = currentRate;
    speechSynthesis.speak(u);
    showPopup(text);
}

function showPopup(text){
    popupElement.textContent = text;
    popupElement.style.display = 'block';
    popupElement.style.opacity = '1';
    setTimeout(()=>{ popupElement.style.opacity = '0'; setTimeout(()=>popupElement.style.display='none',500) },3500);
}

function getCards(){ return document.querySelectorAll('.card input') }

function updateCurrentIndexAfterChange(){
    const c = getCards();
    currentIndex = Math.min(currentIndex, c.length - 1);
    if(currentIndex < 0) currentIndex = 0;
}

function addButton(v=''){
    let c = document.createElement('div');
    c.className = 'card';
    let i = document.createElement('input');
    i.value = v;
    i.placeholder = "Nh·∫≠p vƒÉn b·∫£n...";
    i.onchange = saveAll;

    let sBox = document.createElement('div');
    sBox.className = 'suggestion-box';

    i.addEventListener('input', (e) => showSuggestions(e.target, sBox));
    i.addEventListener('blur', () => { setTimeout(() => sBox.style.display = 'none', 150); });

    let p = document.createElement('button');
    p.className = 'btn play-btn';
    p.textContent = 'üîä Ph√°t √¢m';
    p.onclick = ()=>speak(i.value.trim());
    let d = document.createElement('button');
    d.className = 'delete-btn';
    d.textContent = '‚ùå';
    d.onclick = ()=>{ c.remove(); saveAll(); updateCurrentIndexAfterChange(); };

    c.append(i, sBox, p, d);
    document.getElementById('buttonContainer').appendChild(c);
    saveAll();
    currentIndex = getCards().length - 1;
}

function saveAll(){ localStorage.setItem('voiceButtons', JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim()))) }
function loadButtons(){ let s = JSON.parse(localStorage.getItem('voiceButtons') || "[]"); (s.length ? s : defaults).forEach(t => addButton(t)); currentIndex = 0; cleanupEmptyCards(); }
function resetDefaults(){ if(confirm("ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh?")){ localStorage.removeItem('voiceButtons'); document.getElementById('buttonContainer').innerHTML = ''; loadButtons(); currentIndex = 0; } }

function cleanupEmptyCards(){
    let c = document.querySelectorAll('.card'), save = false;
    for(let i = c.length - 1; i >= 0; i--){
        let inp = c[i].querySelector('input');
        if(!inp || inp.value.trim() === ''){
            c[i].remove();
            save = true;
        }
    }
    if(save){ saveAll(); updateCurrentIndexAfterChange(); }
}

function moveSpeak(dir){
    const c = getCards();
    if(c.length === 0) return;
    if(dir === 0){
        const text = c[currentIndex].value.trim();
        if(text) speak(text);
        else showPopup("C√¢u tr·ªëng! Vui l√≤ng s·ª≠a ho·∫∑c x√≥a.");
    } else {
        currentIndex = (currentIndex + dir + c.length) % c.length;
        let count = 0;
        while(c[currentIndex].value.trim() === '' && count < c.length){
            currentIndex = (currentIndex + dir + c.length) % c.length;
            count++;
        }
        const text = c[currentIndex].value.trim();
        if(text) speak(text);
        else showPopup("Kh√¥ng c√≥ c√¢u n√†o ƒë·ªÉ ƒë·ªçc.");
    }
}

function toggleLock(lock){
    const u = document.getElementById('unlock-btn');
    if(!lock) cleanupEmptyCards();
    if(lock){
        buttonContainer.style.display = 'none';
        addBtnMove.style.display = 'none';
        settingsArea.style.display = 'none';
        controlArea.classList.add('locked');
        document.body.classList.add('locked');
        document.getElementById('mainTitle').classList.add('locked-h1');
        u.style.display = 'flex';
    } else {
        buttonContainer.style.display = 'grid';
        addBtnMove.style.display = 'block';
        settingsArea.style.display = 'block';
        controlArea.classList.remove('locked');
        document.body.classList.remove('locked');
        document.getElementById('mainTitle').classList.remove('locked-h1');
        u.style.display = 'none';
    }
}

document.querySelectorAll('.control-btn').forEach(button => {
    ['click','touchend'].forEach(event => {
        button.addEventListener(event, function(e){
            e.preventDefault();
            moveSpeak(parseInt(e.currentTarget.dataset.direction));
        }, { passive: false });
    });
});

window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    if (installState === 'before_install') {
        installButton.style.display = 'flex';
        installButton.onclick = installApp;
    }
});

function installApp(){
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            installState = (choiceResult.outcome === 'accepted') ? 'installed' : 'rejected';
            deferredPrompt = null;
            installButton.style.display = 'none';
        });
    }
}

window.addEventListener('appinstalled', ()=>{ installState = 'installed'; installButton.style.display = 'none'; });
if(installState === 'before_install') installButton.style.display = 'none';

function warmUpTTS(){
    if(!('speechSynthesis' in window)) return;
    let u = new SpeechSynthesisUtterance(" ");
    u.lang = 'vi-VN';
    u.volume = 0;
    u.rate = 10;
    speechSynthesis.speak(u);
    setTimeout(()=>speechSynthesis.cancel(), 500);
}

function loadRate(){
    const savedRate = localStorage.getItem('ttsRate');
    if(savedRate !== null) currentRate = parseFloat(savedRate);
    if(rateSlider){
        rateSlider.value = currentRate.toFixed(1);
        rateValueSpan.textContent = currentRate.toFixed(1);
    }
}

function saveRate(rate){
    currentRate = rate;
    localStorage.setItem('ttsRate', rate.toFixed(1));
    rateValueSpan.textContent = rate.toFixed(1);
}

window.addEventListener('DOMContentLoaded', () => {
    if(rateSlider){
        rateSlider.addEventListener('input', (e) => {
            const newRate = parseFloat(e.target.value);
            rateValueSpan.textContent = newRate.toFixed(1);
            currentRate = newRate;
        });
        rateSlider.addEventListener('change', (e) => { saveRate(parseFloat(e.target.value)); });
    }
});

window.onload = () => { loadButtons(); warmUpTTS(); loadSuggestions(); loadRate(); };
</script>

</body>
</html>
