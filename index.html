<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√°y h·ªó tr·ª£ gi·ªçng n√≥i</title>
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:50px;left:50%;transform:translateX(-50%);z-index:1000;color:#333;background:#e3f2fd;padding:0 10px}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px;max-width:700px;margin:0 auto}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.add-btn{background:linear-gradient(45deg,#2196F3,#1976D2);width:200px;margin:8px auto;display:block}
.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2);width:220px;height:50px;font-size:18px;margin:8px auto;display:block}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7);width:200px;margin:8px auto;display:block}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f);width:220px;height:50px;font-size:18px;margin:8px auto;display:block}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f);position:fixed;bottom:70px;left:50%;transform:translateX(-50%);z-index:1000}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;max-width:700px;margin:0 auto}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
.control-btn{width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center;max-width:700px;margin:0 auto}
#popup{position:fixed;background:rgba(0,0,0,.8);color:#fff;padding:15px 20px;border-radius:12px;font-size:18px;display:none;z-index:1000;max-width:90%;min-width:100px;text-align:center;transition:opacity .5s}
#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
</head>
<body>

<h1 id="mainTitle">M√°y h·ªó tr·ª£ gi·ªçng n√≥i</h1>

<!-- N√∫t c√¢u -->
<div class="container" id="buttonContainer"></div>

<!-- N√∫t ƒëi·ªÅu h∆∞·ªõng + add + unlock -->
<div class="control-container" id="controlArea">
    <div class="navigation-group">
        <button class="control-btn play-control-btn" onclick="moveSpeak(-1)">C√¢u tr∆∞·ªõc</button>
        <button class="control-btn current-btn-color" onclick="moveSpeak(0)">Ph√°t l·∫°i</button>
        <button class="control-btn play-control-btn" onclick="moveSpeak(1)">C√¢u sau</button>
    </div>
    <button class="btn add-btn" id="add-btn-move" onclick="addButton()">‚ûï Th√™m c√¢u m·ªõi</button>
    <button class="btn" id="unlock-btn" onclick="toggleLock(false)">M·ªü kh√≥a giao di·ªán</button>
</div>

<!-- N√∫t d∆∞·ªõi -->
<div id="settingsArea">
    <button class="btn settings-btn" onclick="toggleLock(true)">Kh√≥a giao di·ªán</button>
    <button class="btn install-btn" id="installButton" style="display:none;">üì≤ T·∫°o L·ªëi t·∫Øt</button>
    <button class="btn reset-btn" onclick="resetDefaults()">‚ôªÔ∏è Reset m·∫∑c ƒë·ªãnh</button>
</div>

<!-- Popup -->
<div id="popup"></div>

<!-- Th√¥ng tin TTS c·ªë ƒë·ªãnh d∆∞·ªõi -->
<div id="tts-info">N·∫øu kh√¥ng th·∫•y √¢m thanh, t·∫£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>
let deferredPrompt,currentIndex=0;
const defaults=["T√¥i mu·ªën ƒÉn c∆°m","T√¥i mu·ªën u·ªëng n∆∞·ªõc","T√¥i mu·ªën ƒëi v·ªá sinh","T√¥i mu·ªën ƒëi ng·ªß"];
const controlArea=document.getElementById('controlArea');
const installButton=document.getElementById('installButton');
const addBtnMove=document.getElementById('add-btn-move');

// PH√ÅT √ÇM
function speak(text){
    if(!text||!('speechSynthesis'in window)) return;
    speechSynthesis.cancel();
    let u=new SpeechSynthesisUtterance(text);
    u.lang='vi-VN';
    speechSynthesis.speak(u);
    showPopup(text);
}

// HI·ªÇN TH·ªä POPUP CH·ªà FADE-OUT
function showPopup(text){
    const p=document.getElementById('popup');
    p.textContent=text;
    p.style.display='block';
    p.style.opacity='1';
    const isLocked=controlArea.classList.contains('locked');

    if(isLocked){
        p.style.position='fixed';
        p.style.top='200px';
        p.style.left='50%';
        p.style.transform='translateX(-50%)';
    }else{
        const cards=document.querySelectorAll('.card');
        if(cards.length && currentIndex>=0 && currentIndex<cards.length){
            const playBtn=cards[currentIndex].querySelector('.play-btn');
            if(playBtn){
                const rect=playBtn.getBoundingClientRect();
                p.style.position='absolute';
                p.style.left=`${rect.left + rect.width/2 + window.scrollX}px`;
                p.style.top=`${rect.top + window.scrollY - 10}px`;
                p.style.transform='translateX(-50%)';
            }
        }
    }

    setTimeout(()=>{
        p.style.opacity='0';
        setTimeout(()=>p.style.display='none',500);
    },2000);
}

// TH√äM BUTTON M·ªöI
function addButton(v=''){
    let c=document.createElement('div'); c.className='card';
    let i=document.createElement('input'); i.value=v; i.placeholder="Nh·∫≠p vƒÉn b·∫£n..."; i.onchange=saveAll;
    let p=document.createElement('button'); p.className='btn play-btn'; p.textContent='üîä Ph√°t √¢m'; p.onclick=()=>speak(i.value.trim());
    let d=document.createElement('button'); d.className='delete-btn'; d.textContent='‚ùå'; d.onclick=()=>{c.remove(); saveAll(); currentIndex=Math.min(currentIndex,getCards().length-1)};
    c.append(i,p,d); document.getElementById('buttonContainer').appendChild(c); saveAll();
}

// L∆ØU & T·∫¢I D·ªÆ LI·ªÜU
function saveAll(){localStorage.setItem('voiceButtons',JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim())));}
function loadButtons(){let saved=JSON.parse(localStorage.getItem('voiceButtons')||"[]");(saved.length?saved:defaults).forEach(t=>addButton(t)); currentIndex=0;}
function resetDefaults(){if(confirm("ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh?")){localStorage.removeItem('voiceButtons'); document.getElementById('buttonContainer').innerHTML=''; loadButtons(); currentIndex=0;}}

// H·ªñ TR·ª¢
function getCards(){return document.querySelectorAll('.card input');}
function cleanupEmptyCards(){let c=document.querySelectorAll('.card'),save=false; for(let i=c.length-1;i>=0;i--){let inp=c[i].querySelector('input'); if(!inp||inp.value.trim()===''){c[i].remove(); save=true;}} if(save){saveAll(); currentIndex=Math.min(currentIndex,getCards().length-1);}}

// DI CHUY·ªÇN PH√ÅT
function moveSpeak(dir){cleanupEmptyCards(); const c=getCards(); if(c.length===0) return; if(dir===0) speak(c[currentIndex].value.trim()); else{currentIndex=(currentIndex+dir+c.length)%c.length; speak(c[currentIndex].value.trim());}}

// KH√ìA / M·ªû GIAO DI·ªÜN
function toggleLock(lock){
    const cards=document.getElementById('buttonContainer');
    const addBtn=document.getElementById('add-btn-move');
    const settings=document.getElementById('settingsArea');
    const unlockBtn=document.getElementById('unlock-btn');
    const mainTitle=document.getElementById('mainTitle');
    const navGroup=document.querySelector('.navigation-group');

    if(lock){
        cards.style.display='none';
        addBtn.style.display='none';
        settings.style.display='none';

        mainTitle.classList.add('locked-h1');

        navGroup.style.position='fixed';
        navGroup.style.top='50%';
        navGroup.style.left='50%';
        navGroup.style.transform='translate(-50%, -50%)';

        unlockBtn.style.display='flex';
    } else {
        cards.style.display='grid';
        addBtn.style.display='block';
        settings.style.display='block';

        mainTitle.classList.remove('locked-h1');

        navGroup.style.position='static';
        navGroup.style.transform='none';

        unlockBtn.style.display='none';
    }
}

// INSTALL PWA
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault(); deferredPrompt=e; installButton.style.display='block'; installButton.onclick=installApp;});
function installApp(){if(deferredPrompt){deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>{deferredPrompt=null; installButton.style.display='none';});}}
window.addEventListener('appinstalled',()=>installButton.style.display='none');

// WARM UP TTS
function warmUpTTS(){if(!('speechSynthesis' in window)) return; let u=new SpeechSynthesisUtterance(" "); u.lang='vi-VN'; u.volume=0; u.rate=10; speechSynthesis.speak(u); setTimeout(()=>speechSynthesis.cancel(),500);}
window.onload=()=>{loadButtons(); warmUpTTS();}
</script>

</body>
</html>
