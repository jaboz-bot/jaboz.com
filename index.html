<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MÃ¡y há»— trá»£ giá»ng nÃ³i</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
/* Chá»‘ng ngÆ°á»i dÃ¹ng vuá»‘t mÃ n hÃ¬nh khi khÃ³a */
body.locked {
Â  Â  overflow: hidden;Â 
Â  Â  overscroll-behavior-y: contain;Â 
Â  Â  touch-action: none;
}

.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{
Â  Â  width:220px;
Â  Â  height:50px;
Â  Â  font-size:18px;
Â  Â  margin:8px auto;
Â  Â  display:flex;
Â  Â  justify-content:center;
Â  Â  align-items:center;
}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)}Â 
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
/* THAY Äá»”I: Sá»­ dá»¥ng touch-action: manipulation; Ä‘á»ƒ Æ°u tiÃªn cÃ¡c sá»± kiá»‡n nháº¥n/cháº¡m */
.control-btn{
Â  Â  width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;
Â  Â  touch-action: manipulation;Â 
}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}

/* CSS cho cháº¿ Ä‘á»™ khÃ³a */
.control-container.locked{
Â  Â  position:fixed;
Â  Â  top:0;
Â  Â  left:0;
Â  Â  width:100%;
Â  Â  height:100%;
Â  Â  overflow:hidden;
Â  Â  z-index:99;
Â  Â  background:#e3f2fd;
Â  Â  justify-content: center;Â 
}
.control-container.locked #add-btn-move,
.control-container.locked #settingsArea {
Â  Â  display: none !important;
}
.control-container.locked .navigation-group{
Â  Â  margin:0;
}
.control-container.locked #unlock-btn{
Â  Â  position:fixed;
Â  Â  bottom: 80px;Â 
Â  Â  left:50%;
Â  Â  transform:translateX(-50%);
Â  Â  display:flex;
Â  Â  z-index:100;
}

/* Cáº­p nháº­t CSS cho Popup: LuÃ´n fixed vÃ  cÄƒn giá»¯a */
#popup{
Â  Â  position: fixed;
Â  Â  top: 200px;
Â  Â  left: 50%;
Â  Â  transform: translateX(-50%);
Â  Â Â 
Â  Â  background:rgba(0,0,0,.8);
Â  Â  color:#fff;
Â  Â  padding:15px 20px;
Â  Â  border-radius:12px;
Â  Â  font-size:18px;
Â  Â  display:none;
Â  Â  z-index:1000;
Â  Â  max-width:90%;
Â  Â  min-width:100px;
Â  Â  text-align:center;
Â  Â  transition: opacity 0.5s ease-out;Â 
}

/* Bá»” SUNG CSS CHO Há»˜P Gá»¢I Ã TÃ™Y CHá»ˆNH (ÄÃƒ Sá»¬A Äá»‚ Há»– TRá»¢ Sá»” LÃŠN VÃ€ Sá»” XUá»NG) */
.suggestion-box {
Â  Â  position: absolute;
Â  Â  left: 0;
Â  Â  right: 0;
Â  Â  z-index: 10;
Â  Â  background: #fff;
Â  Â  border: 1px solid #ddd;
Â  Â  border-radius: 8px; /* Bo gÃ³c máº·c Ä‘á»‹nh */
Â  Â  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
Â  Â  max-height: 150px;
Â  Â  overflow-y: auto;
Â  Â  text-align: left;
Â  Â  display: none;Â 
}

/* CSS cho trÆ°á»ng há»£p sá»• lÃªn (Khi input á»Ÿ dÆ°á»›i) */
.suggestion-box.up {
Â  Â  bottom: calc(100% + 5px); /* Sá»• lÃªn phÃ­a trÃªn input */
Â  Â  border-bottom: 1px solid #ddd; /* Giá»¯ láº¡i viá»n dÆ°á»›i */
Â  Â  border-radius: 8px 8px 0 0; /* Bo gÃ³c trÃªn */
Â  Â  box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1); /* Äá»• bÃ³ng lÃªn trÃªn */
}

/* CSS cho trÆ°á»ng há»£p sá»• xuá»‘ng (Khi input á»Ÿ trÃªn) */
.suggestion-box.down {
Â  Â  top: calc(100% + 5px); /* Sá»• xuá»‘ng phÃ­a dÆ°á»›i input */
Â  Â  border-top: 1px solid #ddd; /* Giá»¯ láº¡i viá»n trÃªn */
Â  Â  border-radius: 0 0 8px 8px; /* Bo gÃ³c dÆ°á»›i */
Â  Â  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Äá»• bÃ³ng xuá»‘ng dÆ°á»›i */
}

.suggestion-item {
Â  Â  padding: 10px;
Â  Â  cursor: pointer;
Â  Â  font-size: 16px;
Â  Â  border-bottom: 1px solid #eee;
Â  Â  transition: background-color 0.2s;
}
.suggestion-item:last-child {
Â  Â  border-bottom: none;
}
.suggestion-item:hover {
Â  Â  background-color: #f0f0f0;
}
/* Káº¾T THÃšC Bá»” SUNG CSS */


#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">MÃ¡y há»— trá»£ giá»ng nÃ³i</h1>
<div class="container" id="buttonContainer"></div>

<div id="popup"></div>

<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">â• ThÃªm cÃ¢u má»›i</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">CÃ¢u trÆ°á»›c</button>
<button class="control-btn current-btn-color" data-direction="0">PhÃ¡t láº¡i</button>
<button class="control-btn play-control-btn" data-direction="1">CÃ¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">Má»Ÿ khÃ³a giao diá»‡n</button>
</div>

<div id="settingsArea">
<button class="btn settings-btn" onclick="toggleLock(true)">KhÃ³a giao diá»‡n</button>
<button class="btn install-btn large-control-btn" id="installButton">ğŸ“² CÃ i Ä‘áº·t app</button>
<button class="btn reset-btn" onclick="resetDefaults()">â™»ï¸ Reset máº·c Ä‘á»‹nh</button>
</div>
</div>

<div id="tts-info">Náº¿u khÃ´ng tháº¥y Ã¢m thanh, táº£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>

// HÃ€M Bá»” SUNG: Chuyá»ƒn Ä‘á»•i chuá»—i cÃ³ dáº¥u thÃ nh khÃ´ng dáº¥u
function removeDiacritics(str) {
Â  Â  if (typeof str !== 'string') return '';
Â  Â  return str.toLowerCase()
Â  Â  Â  Â  .replace(/Ã |Ã¡|áº¡|áº£|Ã£|Ã¢|áº§|áº¥|áº­|áº©|áº«|Äƒ|áº±|áº¯|áº·|áº³|áºµ/g, "a")
Â  Â  Â  Â  .replace(/Ã¨|Ã©|áº¹|áº»|áº½|Ãª|á»|áº¿|á»‡|á»ƒ|á»…/g, "e")
Â  Â  Â  Â  .replace(/Ã¬|Ã­|á»‹|á»‰|Ä©/g, "i")
Â  Â  Â  Â  .replace(/Ã²|Ã³|á»|á»|Ãµ|Ã´|á»“|á»‘|á»™|á»•|á»—|Æ¡|á»|á»›|á»£|á»Ÿ|á»¡/g, "o")
Â  Â  Â  Â  .replace(/Ã¹|Ãº|á»¥|á»§|Å©|Æ°|á»«|á»©|á»±|á»­|á»¯/g, "u")
Â  Â  Â  Â  .replace(/á»³|Ã½|á»µ|á»·|á»¹/g, "y")
Â  Â  Â  Â  .replace(/Ä‘/g, "d");
}
Â  Â Â 
// Báº®T Äáº¦U PHáº¦N Bá»” SUNG VÃ€ Sá»¬A Äá»”I
const SUGGESTION_URL = 'goi-y-tu.json';Â 
let wordSuggestions = []; // DÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ danh sÃ¡ch tá»« gá»£i Ã½

// HÃ€M Má»šI: Táº£i dá»¯ liá»‡u gá»£i Ã½ vÃ  lÆ°u vÃ o wordSuggestions
async function loadSuggestions() {
Â  Â  try {
Â  Â  Â  Â  const response = await fetch(SUGGESTION_URL);Â 
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  console.error('Lá»—i táº£i file gá»£i Ã½ (kiá»ƒm tra file goi-y-tu.json):', response.statusText);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  wordSuggestions = await response.json();
Â  Â  Â  Â  if (!Array.isArray(wordSuggestions)) {
Â  Â  Â  Â  Â  Â  wordSuggestions = [];
Â  Â  Â  Â  Â  Â  console.error('Dá»¯ liá»‡u gá»£i Ã½ khÃ´ng pháº£i lÃ  máº£ng.');
Â  Â  Â  Â  }
Â  Â  Â  Â  console.log(`ÄÃ£ táº£i ${wordSuggestions.length} gá»£i Ã½.`);
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Lá»—i khi táº£i hoáº·c xá»­ lÃ½ file JSON:', error);
Â  Â  }
}

// HÃ€M Sá»¬A Äá»”I CUá»I CÃ™NG: Hiá»ƒn thá»‹ gá»£i Ã½ tÃ¹y chá»‰nh (Há»— trá»£ gÃµ khÃ´ng dáº¥u vÃ  Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh vá»‹ trÃ­)
function showSuggestions(inputElement, boxElement) {
Â  Â  const fullText = inputElement.value;
Â  Â  // TÃ¡ch chuá»—i báº±ng dáº¥u cÃ¡ch (bao gá»“m nhiá»u dáº¥u cÃ¡ch liÃªn tiáº¿p)
Â  Â  const parts = fullText.split(/\s+/).filter(p => p.length > 0); 
Â  Â Â 
Â  Â  // 1. Láº¥y tá»« cuá»‘i cÃ¹ng Ä‘ang Ä‘Æ°á»£c gÃµ
Â  Â  const lastWord = parts.length > 0 ? parts[parts.length - 1] : '';
Â  Â Â 
Â  Â  // CHUáº¨N HÃ“A: Láº¥y tá»« cuá»‘i cÃ¹ng KHÃ”NG Dáº¤U Ä‘á»ƒ so khá»›p
Â  Â  const lastWordNoDiacritics = removeDiacritics(lastWord).toLowerCase();

    // ----------------------------------------------------
    // LOGIC ÄIá»€U CHá»ˆNH Vá»Š TRÃ Há»˜P Gá»¢I Ã (Má»šI)
    // ----------------------------------------------------
    const inputRect = inputElement.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const boxHeight = 150; // Chiá»u cao tá»‘i Ä‘a cá»§a há»™p gá»£i Ã½ (max-height) + má»™t chÃºt Ä‘á»‡m

    // TÃ­nh khoáº£ng trá»‘ng cÃ²n láº¡i á»Ÿ phÃ­a trÃªn vÃ  phÃ­a dÆ°á»›i input
    const spaceAbove = inputRect.top;
    const spaceBelow = viewportHeight - inputRect.bottom;

    // Æ¯u tiÃªn sá»• xuá»‘ng (down) náº¿u cÃ²n Ä‘á»§ chá»— hoáº·c khÃ´ng Ä‘á»§ chá»— phÃ­a trÃªn
    // Náº¿u khoáº£ng trá»‘ng phÃ­a dÆ°á»›i lá»›n hÆ¡n khoáº£ng trá»‘ng phÃ­a trÃªn HOáº¶C khoáº£ng trá»‘ng phÃ­a trÃªn khÃ´ng Ä‘á»§ 200px
    if (spaceBelow > spaceAbove || spaceAbove < boxHeight + 50) { 
        boxElement.classList.remove('up');
        boxElement.classList.add('down');
    } else {
        // Æ¯u tiÃªn sá»• lÃªn (up)
        boxElement.classList.remove('down');
        boxElement.classList.add('up');
    }
    // ----------------------------------------------------
    
Â  Â  // áº¨n box náº¿u input rá»—ng hoáº·c chá»‰ cÃ³ khoáº£ng tráº¯ng
Â  Â  if (fullText.trim().length === 0 || lastWord.length === 0) {
Â  Â  Â  Â  boxElement.style.display = 'none';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  boxElement.innerHTML = '';
Â  Â Â 
Â  Â  // Lá»c danh sÃ¡ch gá»£i Ã½: So sÃ¡nh gá»£i Ã½ (Ä‘Ã£ bá» dáº¥u) vá»›i tá»« cuá»‘i cÃ¹ng (Ä‘Ã£ bá» dáº¥u)
Â  Â  const filteredSuggestions = wordSuggestions
Â  Â  Â  Â  .filter(phrase => removeDiacritics(phrase).toLowerCase().startsWith(lastWordNoDiacritics))
Â  Â  Â  Â  .slice(0, 5);Â 

Â  Â  if (filteredSuggestions.length > 0) {
Â  Â  Â  Â  filteredSuggestions.forEach(phrase => {
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'suggestion-item';
Â  Â  Â  Â  Â  Â  item.textContent = phrase;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Xá»­ lÃ½ khi click vÃ o má»¥c gá»£i Ã½ (dÃ¹ng mousedown Ä‘á»ƒ ngÄƒn input blur ngay láº­p tá»©c)
Â  Â  Â  Â  Â  Â  item.addEventListener('mousedown', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // TÃ¬m vá»‹ trÃ­ báº¯t Ä‘áº§u cá»§a tá»« cuá»‘i cÃ¹ng
Â  Â  Â  Â  Â  Â  Â  Â  const lastWordStart = fullText.lastIndexOf(lastWord);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // TÃ¡i táº¡o vÄƒn báº£n: Thay tháº¿ tá»« cuá»‘i cÃ¹ng báº±ng gá»£i Ã½ (cÃ³ dáº¥u) Ä‘Æ°á»£c chá»n
Â  Â  Â  Â  Â  Â  Â  Â  let newText = fullText.substring(0, lastWordStart) + phrase;

Â  Â  Â  Â  Â  Â  Â  Â  // ThÃªm dáº¥u cÃ¡ch
Â  Â  Â  Â  Â  Â  Â  Â  newText += ' ';Â 

Â  Â  Â  Â  Â  Â  Â  Â  inputElement.value = newText;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  boxElement.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  saveAll();Â 
Â  Â  Â  Â  Â  Â  Â  Â  inputElement.focus();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Äáº·t con trá» vá» cuá»‘i input
Â  Â  Â  Â  Â  Â  Â  Â  inputElement.selectionStart = inputElement.selectionEnd = newText.length;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  boxElement.appendChild(item);
Â  Â  Â  Â  });
Â  Â  Â  Â  boxElement.style.display = 'block';
Â  Â  } else {
Â  Â  Â  Â  boxElement.style.display = 'none';
Â  Â  }
}

Â  Â Â 
// Káº¾T THÃšC PHáº¦N Bá»” SUNG

let deferredPrompt,currentIndex=0,defaults=["TÃ´i muá»‘n Äƒn cÆ¡m","TÃ´i muá»‘n uá»‘ng nÆ°á»›c","TÃ´i muá»‘n Ä‘i vá»‡ sinh","TÃ´i muá»‘n Ä‘i ngá»§"],installState = 'before_install';
const controlArea=document.getElementById('controlArea'),
Â  Â  Â  installButton=document.getElementById('installButton'),
Â  Â  Â  addBtnMove=document.getElementById('add-btn-move'),
Â  Â  Â  popupElement=document.getElementById('popup'),
Â  Â  Â  buttonContainer=document.getElementById('buttonContainer'),
Â  Â  Â  settingsArea=document.getElementById('settingsArea');

function speak(text, targetElement){
Â  Â  if(!text||!('speechSynthesis'in window))return;
Â  Â  speechSynthesis.cancel();
Â  Â  let u=new SpeechSynthesisUtterance(text);
Â  Â  u.lang='vi-VN';
Â  Â  speechSynthesis.speak(u);
Â  Â  showPopup(text);Â 
}

function showPopup(text){
Â  Â  popupElement.textContent=text;
Â  Â  popupElement.style.display='block';
Â  Â  popupElement.style.opacity='1';

Â  Â  setTimeout(()=>{Â 
Â  Â  Â  Â  popupElement.style.opacity='0';Â 
Â  Â  Â  Â  setTimeout(()=>popupElement.style.display='none', 500)Â 
Â  Â  },3500)Â 
}

function getCards(){return document.querySelectorAll('.card input')}

// HÃ m nÃ y Ä‘áº£m báº£o currentIndex luÃ´n trá» Ä‘áº¿n má»™t vá»‹ trÃ­ há»£p lá»‡
function updateCurrentIndexAfterChange() {
Â  Â  const c = getCards();
Â  Â  currentIndex = Math.min(currentIndex, c.length - 1);
Â  Â  if (currentIndex < 0) currentIndex = 0;
}

// HÃ€M Sá»¬A Äá»”I: ThÃªm suggestion-box vÃ  sá»± kiá»‡n input/blur
function addButton(v=''){
Â  Â  let c=document.createElement('div');
Â  Â  c.className='card';
Â  Â Â 
Â  Â  // INPUT Bá»” SUNG: ThÃªm sá»± kiá»‡n vÃ  táº¡o suggestion-box
Â  Â  let i=document.createElement('input');
Â  Â  i.value=v;
Â  Â  i.placeholder="Nháº­p vÄƒn báº£n...";
Â  Â  i.onchange=saveAll;
Â  Â Â 
Â  Â  let sBox = document.createElement('div'); // Há»™p gá»£i Ã½
Â  Â  sBox.className = 'suggestion-box';

Â  Â  // Gáº¯n sá»± kiá»‡n khi gÃµ
Â  Â  i.addEventListener('input', (e) => showSuggestions(e.target, sBox));
Â  Â Â 
Â  Â  // áº¨n há»™p gá»£i Ã½ khi máº¥t focus (dÃ¹ng setTimeout Ä‘á»ƒ cho phÃ©p click vÃ o gá»£i Ã½)
Â  Â  i.addEventListener('blur', () => {
Â  Â  Â  Â  setTimeout(() => sBox.style.display = 'none', 150);
Â  Â  });
Â  Â  // Káº¾T THÃšC Sá»¬A Äá»”I INPUT
Â  Â Â 
Â  Â  let p=document.createElement('button');
Â  Â  p.className='btn play-btn';
Â  Â  p.textContent='ğŸ”Š PhÃ¡t Ã¢m';
Â  Â  p.onclick=()=>speak(i.value.trim(), p);Â 
Â  Â  let d=document.createElement('button');
Â  Â  d.className='delete-btn';
Â  Â  d.textContent='âŒ';
Â  Â  d.onclick=()=>{
Â  Â  Â  Â  c.remove();
Â  Â  Â  Â  saveAll();
Â  Â  Â  Â  updateCurrentIndexAfterChange(); // Cáº­p nháº­t sau khi xÃ³a
Â  Â  };
Â  Â  // ÄÃ­nh kÃ¨m suggestion box vÃ o card
Â  Â  c.append(i, sBox, p, d);Â 
Â  Â  document.getElementById('buttonContainer').appendChild(c);
Â  Â  saveAll();
Â  Â  // Äáº·t currentIndex vÃ o tháº» má»›i (tháº» cuá»‘i cÃ¹ng)
Â  Â  currentIndex = getCards().length - 1;Â 
}

function saveAll(){localStorage.setItem('voiceButtons',JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim())))}
function loadButtons(){let s=JSON.parse(localStorage.getItem('voiceButtons')||"[]");(s.length?s:defaults).forEach(t=>addButton(t));currentIndex=0; cleanupEmptyCards();}
function resetDefaults(){if(confirm("Äáº·t láº¡i máº·c Ä‘á»‹nh?")){localStorage.removeItem('voiceButtons');document.getElementById('buttonContainer').innerHTML='';loadButtons();currentIndex=0;}}

function cleanupEmptyCards(){
Â  Â  let c=document.querySelectorAll('.card'),save=false;
Â  Â  for(let i=c.length-1;i>=0;i--){
Â  Â  Â  Â  let inp=c[i].querySelector('input');
Â  Â  Â  Â  // Chá»‰ xÃ³a tháº» náº¿u nÃ³ hoÃ n toÃ n trá»‘ng
Â  Â  Â  Â  if(!inp||inp.value.trim()===''){
Â  Â  Â  Â  Â  Â  c[i].remove();
Â  Â  Â  Â  Â  Â  save=true;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if(save){
Â  Â  Â  Â  saveAll();
Â  Â  Â  Â  updateCurrentIndexAfterChange();
Â  Â  }
}

function moveSpeak(dir){
Â  Â  // Bá» cleanupEmptyCards() Ä‘á»ƒ Ä‘áº£m báº£o Ä‘iá»u hÆ°á»›ng á»•n Ä‘á»‹nh
Â  Â  const c=getCards();
Â  Â  if(c.length===0)return;
Â  Â Â 
Â  Â  if(dir===0){
Â  Â  Â  Â  // PhÃ¡t láº¡i cÃ¢u hiá»‡n táº¡i, kiá»ƒm tra trá»‘ng
Â  Â  Â  Â  const text = c[currentIndex].value.trim();
Â  Â  Â  Â  if (text) {
Â  Â  Â  Â  Â  Â  speak(text);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showPopup("CÃ¢u trá»‘ng! Vui lÃ²ng sá»­a hoáº·c xÃ³a.");
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  // Di chuyá»ƒn cÃ¢u trÆ°á»›c/sau
Â  Â  Â  Â  currentIndex=(currentIndex+dir+c.length)%c.length;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // VÃ²ng láº·p tÃ¬m cÃ¢u khÃ´ng trá»‘ng (Ä‘á»ƒ trÃ¡nh láº·p vÃ´ táº­n náº¿u Táº¤T Cáº¢ trá»‘ng)
Â  Â  Â  Â  let count = 0;
Â  Â  Â  Â  while(c[currentIndex].value.trim() === '' && count < c.length) {
Â  Â  Â  Â  Â  Â  currentIndex=(currentIndex+dir+c.length)%c.length;
Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Náº¿u tÃ¬m tháº¥y cÃ¢u Ä‘á»ƒ Ä‘á»c
Â  Â  Â  Â  const text = c[currentIndex].value.trim();
Â  Â  Â  Â  if (text) {
Â  Â  Â  Â  Â  Â  speak(text);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â // Chá»‰ xáº£y ra náº¿u táº¥t cáº£ cÃ¡c cÃ¢u Ä‘á»u trá»‘ng
Â  Â  Â  Â  Â  Â  showPopup("KhÃ´ng cÃ³ cÃ¢u nÃ o Ä‘á»ƒ Ä‘á»c.");
Â  Â  Â  Â  }
Â  Â  }
}

function toggleLock(lock){
Â  Â  const u=document.getElementById('unlock-btn');
Â  Â  // Khi thoÃ¡t khá»i cháº¿ Ä‘á»™ khÃ³a, dá»n dáº¹p tháº» trá»‘ng
Â  Â  if (!lock) {
Â  Â  Â  Â  cleanupEmptyCards();
Â  Â  }
Â  Â Â 
Â  Â  if(lock){
Â  Â  Â  Â  buttonContainer.style.display='none';
Â  Â  Â  Â  addBtnMove.style.display='none';
Â  Â  Â  Â  settingsArea.style.display='none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  controlArea.classList.add('locked');
Â  Â  Â  Â  document.body.classList.add('locked');
Â  Â  Â  Â  document.getElementById('mainTitle').classList.add('locked-h1');
Â  Â  Â  Â  u.style.display='flex';
Â  Â  } else {
Â  Â  Â  Â  buttonContainer.style.display='grid';
Â  Â  Â  Â  addBtnMove.style.display='block';
Â  Â  Â  Â  settingsArea.style.display='block';
Â  Â  Â  Â Â 
Â  Â  Â  Â  controlArea.classList.remove('locked');
Â  Â  Â  Â  document.body.classList.remove('locked');
Â  Â  Â  Â  document.getElementById('mainTitle').classList.remove('locked-h1');
Â  Â  Â  Â  u.style.display='none';
Â  Â  }
}

// Gáº¯n sá»± kiá»‡n cho cÃ¡c nÃºt Ä‘iá»u hÆ°á»›ng
document.querySelectorAll('.control-btn').forEach(button => {
Â  Â  // Giá»¯ cáº£ click vÃ  touchend Ä‘á»ƒ tá»‘i Æ°u pháº£n há»“i trÃªn di Ä‘á»™ng
Â  Â  ['click', 'touchend'].forEach(event => {
Â  Â  Â  Â  button.addEventListener(event, function(e) {
Â  Â  Â  Â  Â  Â  // NgÄƒn cháº·n sá»± kiá»‡n cháº¡m kÃ­ch hoáº¡t click hai láº§n
Â  Â  Â  Â  Â  Â  e.preventDefault();Â 
Â  Â  Â  Â  Â  Â  // DÃ¹ng currentTarget Ä‘á»ƒ láº¥y data-direction cá»§a nÃºt
Â  Â  Â  Â  Â  Â  moveSpeak(parseInt(e.currentTarget.dataset.direction));Â 
Â  Â  Â  Â  }, { passive: false });
Â  Â  });
});

window.addEventListener('beforeinstallprompt',e=>{Â 
Â  Â  e.preventDefault();Â 
Â  Â  deferredPrompt=e;Â 
Â  Â  if (installState === 'before_install') {
Â  Â  Â  Â  installButton.style.display='flex';
Â  Â  Â  Â  installButton.onclick=installApp;
Â  Â  }
});

function installApp(){
Â  Â  if(deferredPrompt){
Â  Â  Â  Â  deferredPrompt.prompt();
Â  Â  Â  Â  deferredPrompt.userChoice.then((choiceResult)=>{
Â  Â  Â  Â  Â  Â  if (choiceResult.outcome === 'accepted') {
Â  Â  Â  Â  Â  Â  Â  Â  installState = 'installed';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  installState = 'rejected';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  deferredPrompt=null;
Â  Â  Â  Â  Â  Â  installButton.style.display='none';
Â  Â  Â  Â  });
Â  Â  }
}

window.addEventListener('appinstalled',()=>{Â 
Â  Â  installState = 'installed';Â 
Â  Â  installButton.style.display='none';Â 
});

if (installState === 'before_install') {Â 
Â  Â  installButton.style.display='none';Â 
}

function warmUpTTS(){
Â  Â  if(!('speechSynthesis'in window))return;
Â  Â  let u=new SpeechSynthesisUtterance(" ");
Â  Â  u.lang='vi-VN';
Â  Â  u.volume=0;
Â  Â  u.rate=10;
Â  Â  speechSynthesis.speak(u);
Â  Â  setTimeout(()=>speechSynthesis.cancel(),500)
}
// Sá»¬A Äá»”I: Gá»i hÃ m táº£i gá»£i Ã½ má»›i
window.onload=()=>{loadButtons();warmUpTTS();loadSuggestions();}Â 
</script>

</body>
</html>
