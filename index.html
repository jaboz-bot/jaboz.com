<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√°y h·ªó tr·ª£ gi·ªçng n√≥i</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
/* Ch·ªëng ng∆∞·ªùi d√πng vu·ªët m√†n h√¨nh khi kh√≥a */
body.locked {
    overflow: hidden; 
    overscroll-behavior-y: contain; 
    touch-action: none;
}

.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{
    width:220px;
    height:50px;
    font-size:18px;
    margin:8px auto;
    display:flex;
    justify-content:center;
    align-items:center;
}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)} 
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
/* THAY ƒê·ªîI: S·ª≠ d·ª•ng touch-action: manipulation; ƒë·ªÉ ∆∞u ti√™n c√°c s·ª± ki·ªán nh·∫•n/ch·∫°m */
.control-btn{
    width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;
    touch-action: manipulation; 
}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}

/* CSS cho ch·∫ø ƒë·ªô kh√≥a */
.control-container.locked{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    overflow:hidden;
    z-index:99;
    background:#e3f2fd;
    justify-content: center; 
}
.control-container.locked #add-btn-move,
.control-container.locked #settingsArea {
    display: none !important;
}
.control-container.locked .navigation-group{
    margin:0;
}
.control-container.locked #unlock-btn{
    position:fixed;
    bottom: 80px; 
    left:50%;
    transform:translateX(-50%);
    display:flex;
    z-index:100;
}

/* C·∫≠p nh·∫≠t CSS cho Popup: Lu√¥n fixed v√† cƒÉn gi·ªØa */
#popup{
    position: fixed;
    top: 200px;
    left: 50%;
    transform: translateX(-50%);
    
    background:rgba(0,0,0,.8);
    color:#fff;
    padding:15px 20px;
    border-radius:12px;
    font-size:18px;
    display:none;
    z-index:1000;
    max-width:90%;
    min-width:100px;
    text-align:center;
    transition: opacity 0.5s ease-out; 
}

/* B·ªî SUNG CSS CHO H·ªòP G·ª¢I √ù T√ôY CH·ªàNH */
.suggestion-box {
    position: absolute;
    top: calc(100% - 10px); /* ƒê·∫∑t ngay d∆∞·ªõi input */
    left: 0;
    right: 0;
    z-index: 10;
    background: #fff;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 150px;
    overflow-y: auto;
    text-align: left;
    display: none; 
}
.suggestion-item {
    padding: 10px;
    cursor: pointer;
    font-size: 16px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}
.suggestion-item:last-child {
    border-bottom: none;
}
.suggestion-item:hover {
    background-color: #f0f0f0;
}
/* K·∫æT TH√öC B·ªî SUNG CSS */


#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">M√°y h·ªó tr·ª£ gi·ªçng n√≥i</h1>
<div class="container" id="buttonContainer"></div>

<div id="popup"></div>

<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">‚ûï Th√™m c√¢u m·ªõi</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">C√¢u tr∆∞·ªõc</button>
<button class="control-btn current-btn-color" data-direction="0">Ph√°t l·∫°i</button>
<button class="control-btn play-control-btn" data-direction="1">C√¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">M·ªü kh√≥a giao di·ªán</button>
</div>

<div id="settingsArea">
<button class="btn settings-btn" onclick="toggleLock(true)">Kh√≥a giao di·ªán</button>
<button class="btn install-btn large-control-btn" id="installButton">üì≤ C√†i ƒë·∫∑t app</button>
<button class="btn reset-btn" onclick="resetDefaults()">‚ôªÔ∏è Reset m·∫∑c ƒë·ªãnh</button>
</div>
</div>

<div id="tts-info">N·∫øu kh√¥ng th·∫•y √¢m thanh, t·∫£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>
// B·∫ÆT ƒê·∫¶U PH·∫¶N B·ªî SUNG V√Ä S·ª¨A ƒê·ªîI
const SUGGESTION_URL = 'goi-y-tu.json'; 
let wordSuggestions = []; // D√πng ƒë·ªÉ l∆∞u tr·ªØ danh s√°ch t·ª´ g·ª£i √Ω

// H√ÄM M·ªöI: T·∫£i d·ªØ li·ªáu g·ª£i √Ω v√† l∆∞u v√†o wordSuggestions
async function loadSuggestions() {
    try {
        const response = await fetch(SUGGESTION_URL); 
        if (!response.ok) {
            console.error('L·ªói t·∫£i file g·ª£i √Ω (ki·ªÉm tra file goi-y-tu.json):', response.statusText);
            return;
        }
        wordSuggestions = await response.json();
        if (!Array.isArray(wordSuggestions)) {
            wordSuggestions = [];
            console.error('D·ªØ li·ªáu g·ª£i √Ω kh√¥ng ph·∫£i l√† m·∫£ng.');
        }
        console.log(`ƒê√£ t·∫£i ${wordSuggestions.length} g·ª£i √Ω.`);
    } catch (error) {
        console.error('L·ªói khi t·∫£i ho·∫∑c x·ª≠ l√Ω file JSON:', error);
    }
}


// H√ÄM S·ª¨A ƒê·ªîI: Hi·ªÉn th·ªã g·ª£i √Ω t√πy ch·ªânh (t√¨m ki·∫øm linh ho·∫°t h∆°n)
function showSuggestions(inputElement, boxElement) {
    const inputText = inputElement.value.trim().toLowerCase();
    boxElement.innerHTML = '';
    
    if (inputText.length === 0) {
        boxElement.style.display = 'none';
        return;
    }
    
    // B·ªî SUNG: Chuy·ªÉn sang t√¨m ki·∫øm "ch·ª©a" (includes)
    const filteredSuggestions = wordSuggestions
        .filter(phrase => phrase.toLowerCase().includes(inputText))
        .slice(0, 4); // CH·ªà GI·ªöI H·∫†N 4 G·ª¢I √ù ƒê·∫¶U TI√äN
        
    // L∆ØU √ù: N·∫øu mu·ªën ∆∞u ti√™n t·ª´ b·∫Øt ƒë·∫ßu b·∫±ng, b·∫°n ph·∫£i d√πng th∆∞ vi·ªán ngo√†i
    // ho·∫∑c s·∫Øp x·∫øp l·∫°i danh s√°ch n√†y tr∆∞·ªõc khi d√πng .slice(0, 4)
    
    if (filteredSuggestions.length > 0) {
        filteredSuggestions.forEach(phrase => {
            // ... (Logic t·∫°o suggestion-item gi·ªØ nguy√™n)
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = phrase;
            
            // X·ª≠ l√Ω khi click v√†o m·ª•c g·ª£i √Ω (d√πng mousedown ƒë·ªÉ ngƒÉn input blur ngay l·∫≠p t·ª©c)
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                inputElement.value = phrase;
                boxElement.style.display = 'none';
                saveAll(); 
                inputElement.focus();
            });

            boxElement.appendChild(item);
        });
        boxElement.style.display = 'block';
    } else {
        boxElement.style.display = 'none';
    }
}
// K·∫æT TH√öC PH·∫¶N B·ªî SUNG

let deferredPrompt,currentIndex=0,defaults=["T√¥i mu·ªën ƒÉn c∆°m","T√¥i mu·ªën u·ªëng n∆∞·ªõc","T√¥i mu·ªën ƒëi v·ªá sinh","T√¥i mu·ªën ƒëi ng·ªß"],installState = 'before_install';
const controlArea=document.getElementById('controlArea'),
¬† ¬† ¬† installButton=document.getElementById('installButton'),
¬† ¬† ¬† addBtnMove=document.getElementById('add-btn-move'),
¬† ¬† ¬† popupElement=document.getElementById('popup'),
¬† ¬† ¬† buttonContainer=document.getElementById('buttonContainer'),
¬† ¬† ¬† settingsArea=document.getElementById('settingsArea');

function speak(text, targetElement){
¬† ¬† if(!text||!('speechSynthesis'in window))return;
¬† ¬† speechSynthesis.cancel();
¬† ¬† let u=new SpeechSynthesisUtterance(text);
¬† ¬† u.lang='vi-VN';
¬† ¬† speechSynthesis.speak(u);
¬† ¬† showPopup(text);¬†
}

function showPopup(text){
¬† ¬† popupElement.textContent=text;
¬† ¬† popupElement.style.display='block';
¬† ¬† popupElement.style.opacity='1';

¬† ¬† setTimeout(()=>{¬†
¬† ¬† ¬† ¬† popupElement.style.opacity='0';¬†
¬† ¬† ¬† ¬† setTimeout(()=>popupElement.style.display='none', 500)¬†
¬† ¬† },3500)¬†
}

function getCards(){return document.querySelectorAll('.card input')}

// H√†m n√†y ƒë·∫£m b·∫£o currentIndex lu√¥n tr·ªè ƒë·∫øn m·ªôt v·ªã tr√≠ h·ª£p l·ªá
function updateCurrentIndexAfterChange() {
¬† ¬† const c = getCards();
¬† ¬† currentIndex = Math.min(currentIndex, c.length - 1);
¬† ¬† if (currentIndex < 0) currentIndex = 0;
}

// H√ÄM S·ª¨A ƒê·ªîI: Th√™m suggestion-box v√† s·ª± ki·ªán input/blur
function addButton(v=''){
¬† ¬† let c=document.createElement('div');
¬† ¬† c.className='card';
¬† ¬† 
    // INPUT B·ªî SUNG: Th√™m s·ª± ki·ªán v√† t·∫°o suggestion-box
¬† ¬† let i=document.createElement('input');
¬† ¬† i.value=v;
¬† ¬† i.placeholder="Nh·∫≠p vƒÉn b·∫£n...";
¬† ¬† i.onchange=saveAll;
    
    let sBox = document.createElement('div'); // H·ªôp g·ª£i √Ω
    sBox.className = 'suggestion-box';

    // G·∫Øn s·ª± ki·ªán khi g√µ
    i.addEventListener('input', (e) => showSuggestions(e.target, sBox));
    
    // ·∫®n h·ªôp g·ª£i √Ω khi m·∫•t focus (d√πng setTimeout ƒë·ªÉ cho ph√©p click v√†o g·ª£i √Ω)
    i.addEventListener('blur', () => {
        setTimeout(() => sBox.style.display = 'none', 150);
    });
    // K·∫æT TH√öC S·ª¨A ƒê·ªîI INPUT
    
¬† ¬† let p=document.createElement('button');
¬† ¬† p.className='btn play-btn';
¬† ¬† p.textContent='üîä Ph√°t √¢m';
¬† ¬† p.onclick=()=>speak(i.value.trim(), p);¬†
¬† ¬† let d=document.createElement('button');
¬† ¬† d.className='delete-btn';
¬† ¬† d.textContent='‚ùå';
¬† ¬† d.onclick=()=>{
¬† ¬† ¬† ¬† c.remove();
¬† ¬† ¬† ¬† saveAll();
¬† ¬† ¬† ¬† updateCurrentIndexAfterChange(); // C·∫≠p nh·∫≠t sau khi x√≥a
¬† ¬† };
    // ƒê√≠nh k√®m suggestion box v√†o card
¬† ¬† c.append(i, sBox, p, d); 
¬† ¬† document.getElementById('buttonContainer').appendChild(c);
¬† ¬† saveAll();
¬† ¬† // ƒê·∫∑t currentIndex v√†o th·∫ª m·ªõi (th·∫ª cu·ªëi c√πng)
¬† ¬† currentIndex = getCards().length - 1;¬†
}

function saveAll(){localStorage.setItem('voiceButtons',JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim())))}
function loadButtons(){let s=JSON.parse(localStorage.getItem('voiceButtons')||"[]");(s.length?s:defaults).forEach(t=>addButton(t));currentIndex=0; cleanupEmptyCards();}
function resetDefaults(){if(confirm("ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh?")){localStorage.removeItem('voiceButtons');document.getElementById('buttonContainer').innerHTML='';loadButtons();currentIndex=0;}}

function cleanupEmptyCards(){
¬† ¬† let c=document.querySelectorAll('.card'),save=false;
¬† ¬† for(let i=c.length-1;i>=0;i--){
¬† ¬† ¬† ¬† let inp=c[i].querySelector('input');
¬† ¬† ¬† ¬† // Ch·ªâ x√≥a th·∫ª n·∫øu n√≥ ho√†n to√†n tr·ªëng
¬† ¬† ¬† ¬† if(!inp||inp.value.trim()===''){
¬† ¬† ¬† ¬† ¬† ¬† c[i].remove();
¬† ¬† ¬† ¬† ¬† ¬† save=true;
¬† ¬† ¬† ¬† }
¬† ¬† }
¬† ¬† if(save){
¬† ¬† ¬† ¬† saveAll();
¬† ¬† ¬† ¬† updateCurrentIndexAfterChange();
¬† ¬† }
}

function moveSpeak(dir){
¬† ¬† // B·ªé cleanupEmptyCards() ƒë·ªÉ ƒë·∫£m b·∫£o ƒëi·ªÅu h∆∞·ªõng ·ªïn ƒë·ªãnh
¬† ¬† const c=getCards();
¬† ¬† if(c.length===0)return;
¬† ¬†¬†
¬† ¬† if(dir===0){
¬† ¬† ¬† ¬† // Ph√°t l·∫°i c√¢u hi·ªán t·∫°i, ki·ªÉm tra tr·ªëng
¬† ¬† ¬† ¬† const text = c[currentIndex].value.trim();
¬† ¬† ¬† ¬† if (text) {
¬† ¬† ¬† ¬† ¬† ¬† speak(text);
¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† showPopup("C√¢u tr·ªëng! Vui l√≤ng s·ª≠a ho·∫∑c x√≥a.");
¬† ¬† ¬† ¬† }
¬† ¬† } else {
¬† ¬† ¬† ¬† // Di chuy·ªÉn c√¢u tr∆∞·ªõc/sau
¬† ¬† ¬† ¬† currentIndex=(currentIndex+dir+c.length)%c.length;
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† // V√≤ng l·∫∑p t√¨m c√¢u kh√¥ng tr·ªëng (ƒë·ªÉ tr√°nh l·∫∑p v√¥ t·∫≠n n·∫øu T·∫§T C·∫¢ tr·ªëng)
¬† ¬† ¬† ¬† let count = 0;
¬† ¬† ¬† ¬† while(c[currentIndex].value.trim() === '' && count < c.length) {
¬† ¬† ¬† ¬† ¬† ¬† currentIndex=(currentIndex+dir+c.length)%c.length;
¬† ¬† ¬† ¬† ¬† ¬† count++;
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† // N·∫øu t√¨m th·∫•y c√¢u ƒë·ªÉ ƒë·ªçc
¬† ¬† ¬† ¬† const text = c[currentIndex].value.trim();
¬† ¬† ¬† ¬† if (text) {
¬† ¬† ¬† ¬† ¬† ¬† speak(text);
¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬†// Ch·ªâ x·∫£y ra n·∫øu t·∫•t c·∫£ c√°c c√¢u ƒë·ªÅu tr·ªëng
¬† ¬† ¬† ¬† ¬† ¬† showPopup("Kh√¥ng c√≥ c√¢u n√†o ƒë·ªÉ ƒë·ªçc.");
¬† ¬† ¬† ¬† }
¬† ¬† }
}

function toggleLock(lock){
¬† ¬† const u=document.getElementById('unlock-btn');
¬† ¬† // Khi tho√°t kh·ªèi ch·∫ø ƒë·ªô kh√≥a, d·ªçn d·∫πp th·∫ª tr·ªëng
¬† ¬† if (!lock) {
¬† ¬† ¬† ¬† cleanupEmptyCards();
¬† ¬† }
¬† ¬†¬†
¬† ¬† if(lock){
¬† ¬† ¬† ¬† buttonContainer.style.display='none';
¬† ¬† ¬† ¬† addBtnMove.style.display='none';
¬† ¬† ¬† ¬† settingsArea.style.display='none';
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† controlArea.classList.add('locked');
¬† ¬† ¬† ¬† document.body.classList.add('locked');
¬† ¬† ¬† ¬† document.getElementById('mainTitle').classList.add('locked-h1');
¬† ¬† ¬† ¬† u.style.display='flex';
¬† ¬† } else {
¬† ¬† ¬† ¬† buttonContainer.style.display='grid';
¬† ¬† ¬† ¬† addBtnMove.style.display='block';
¬† ¬† ¬† ¬† settingsArea.style.display='block';
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† controlArea.classList.remove('locked');
¬† ¬† ¬† ¬† document.body.classList.remove('locked');
¬† ¬† ¬† ¬† document.getElementById('mainTitle').classList.remove('locked-h1');
¬† ¬† ¬† ¬† u.style.display='none';
¬† ¬† }
}

// G·∫Øn s·ª± ki·ªán cho c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng
document.querySelectorAll('.control-btn').forEach(button => {
¬† ¬† // Gi·ªØ c·∫£ click v√† touchend ƒë·ªÉ t·ªëi ∆∞u ph·∫£n h·ªìi tr√™n di ƒë·ªông
¬† ¬† ['click', 'touchend'].forEach(event => {
¬† ¬† ¬† ¬† button.addEventListener(event, function(e) {
¬† ¬† ¬† ¬† ¬† ¬† // NgƒÉn ch·∫∑n s·ª± ki·ªán ch·∫°m k√≠ch ho·∫°t click hai l·∫ßn
¬† ¬† ¬† ¬† ¬† ¬† e.preventDefault();¬†
¬† ¬† ¬† ¬† ¬† ¬† // D√πng currentTarget ƒë·ªÉ l·∫•y data-direction c·ªßa n√∫t
¬† ¬† ¬† ¬† ¬† ¬† moveSpeak(parseInt(e.currentTarget.dataset.direction));¬†
¬† ¬† ¬† ¬† }, { passive: false });
¬† ¬† });
});

window.addEventListener('beforeinstallprompt',e=>{¬†
¬† ¬† e.preventDefault();¬†
¬† ¬† deferredPrompt=e;¬†
¬† ¬† if (installState === 'before_install') {
¬† ¬† ¬† ¬† installButton.style.display='flex';
¬† ¬† ¬† ¬† installButton.onclick=installApp;
¬† ¬† }
});

function installApp(){
¬† ¬† if(deferredPrompt){
¬† ¬† ¬† ¬† deferredPrompt.prompt();
¬† ¬† ¬† ¬† deferredPrompt.userChoice.then((choiceResult)=>{
¬† ¬† ¬† ¬† ¬† ¬† if (choiceResult.outcome === 'accepted') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† installState = 'installed';
¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† installState = 'rejected';
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† deferredPrompt=null;
¬† ¬† ¬† ¬† ¬† ¬† installButton.style.display='none';
¬† ¬† ¬† ¬† });
¬† ¬† }
}

window.addEventListener('appinstalled',()=>{¬†
¬† ¬† installState = 'installed';¬†
¬† ¬† installButton.style.display='none';¬†
});

if (installState === 'before_install') {¬†
¬† ¬† installButton.style.display='none';¬†
}

function warmUpTTS(){
¬† ¬† if(!('speechSynthesis'in window))return;
¬† ¬† let u=new SpeechSynthesisUtterance(" ");
¬† ¬† u.lang='vi-VN';
¬† ¬† u.volume=0;
¬† ¬† u.rate=10;
¬† ¬† speechSynthesis.speak(u);
¬† ¬† setTimeout(()=>speechSynthesis.cancel(),500)
}
// S·ª¨A ƒê·ªîI: G·ªçi h√†m t·∫£i g·ª£i √Ω m·ªõi
window.onload=()=>{loadButtons();warmUpTTS();loadSuggestions();} 
</script>

</body>
</html>
