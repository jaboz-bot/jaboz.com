<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MÃ¡y há»— trá»£ giá»ng nÃ³i</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
/* Chá»‘ng ngÆ°á»i dÃ¹ng vuá»‘t mÃ n hÃ¬nh khi khÃ³a */
body.locked {
    overflow: hidden; 
    overscroll-behavior-y: contain; 
    touch-action: none;
}

.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
/* Sá»¬A Äá»”I: Chá»‰nh láº¡i padding cá»§a card vÃ  thÃªm box-sizing */
.card {
    background: #fff;
    padding: 12px; /* Giáº£m padding tá»« 18px xuá»‘ng 12px */
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,.15);
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
    box-sizing: border-box; /* Bá»” SUNG QUAN TRá»ŒNG */
}
/* Äá»‚ NGUYÃŠN (hoáº·c chá»‰ cáº§n Ä‘áº£m báº£o nÃ³ lÃ  100%) */
input {
    padding: 10px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: 100%;
    box-sizing: border-box; /* Bá»” SUNG QUAN TRá»ŒNG: Ä‘á»ƒ padding khÃ´ng lÃ m trÃ n */
}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn {
    background:linear-gradient(45deg,#4CAF50,#43A047);
    width: 100%; 
    box-sizing: border-box; /* Bá»” SUNG QUAN TRá»ŒNG */
}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{
    width:220px;
    height:50px;
    font-size:18px;
    margin:8px auto;
    display:flex;
    justify-content:center;
    align-items:center;
}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)} 
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
/* THAY Äá»”I: Sá»­ dá»¥ng touch-action: manipulation; Ä‘á»ƒ Æ°u tiÃªn cÃ¡c sá»± kiá»‡n nháº¥n/cháº¡m */
.control-btn{
    width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;
    touch-action: manipulation; 
}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}

/* CSS cho cháº¿ Ä‘á»™ khÃ³a */
.control-container.locked{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    overflow:hidden;
    z-index:99;
    background:#e3f2fd;
    justify-content: center; 
}
.control-container.locked #add-btn-move,
.control-container.locked #settingsArea {
    display: none !important;
}
.control-container.locked .navigation-group{
    margin:0;
}
.control-container.locked #unlock-btn{
    position:fixed;
    bottom: 80px; 
    left:50%;
    transform:translateX(-50%);
    display:flex;
    z-index:100;
}

/* Cáº­p nháº­t CSS cho Popup: LuÃ´n fixed vÃ  cÄƒn giá»¯a */
#popup{
    position: fixed;
    top: 200px;
    left: 50%;
    transform: translateX(-50%);
    
    background:rgba(0,0,0,.8);
    color:#fff;
    padding:15px 20px;
    border-radius:12px;
    font-size:18px;
    display:none;
    z-index:1000;
    max-width:90%;
    min-width:100px;
    text-align:center;
    transition: opacity 0.5s ease-out; 
}

/* Báº®T Äáº¦U PHáº¦N CSS ÄÃƒ Sá»¬A: Máº·c Ä‘á»‹nh Sá»” LÃŠN */
.suggestion-box {
    position: absolute;
    bottom: calc(100% - 10px); /* THAY Äá»”I: Máº·c Ä‘á»‹nh Sá»” LÃŠN trÃªn input */
    left: 0;
    right: 0;
    z-index: 10;
    background: #fff;
    border: 1px solid #ddd;
    border-bottom: none; /* Bá» viá»n dÆ°á»›i */
    border-radius: 8px 8px 0 0; /* Bo gÃ³c trÃªn */
    box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1); /* Äá»• bÃ³ng lÃªn trÃªn */
    max-height: 150px;
    overflow-y: auto;
    text-align: left;
    display: none;
}

/* THÃŠM CLASS Má»šI CHO TRÆ¯á»œNG Há»¢P NGOáº I Lá»† (Sá»• XUá»NG) */
.suggestion-box.align-bottom { /* Äáº·t tÃªn class má»›i Ä‘á»ƒ dá»… hiá»ƒu hÆ¡n */
    bottom: auto; /* XÃ³a thuá»™c tÃ­nh bottom */
    top: calc(100% - 10px); /* Äáº·t ngay phÃ­a dÆ°á»›i input */
    border-top: none; /* Bá» viá»n trÃªn */
    border-bottom: 1px solid #ddd; /* KhÃ´i phá»¥c viá»n dÆ°á»›i */
    border-radius: 0 0 8px 8px; /* Bo gÃ³c dÆ°á»›i */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Äá»• bÃ³ng xuá»‘ng dÆ°á»›i */
}

.suggestion-item {
    padding: 10px;
    cursor: pointer;
    font-size: 16px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}
.suggestion-item:last-child {
    border-bottom: none;
}
.suggestion-item:hover {
    background-color: #f0f0f0;
}
    
/* Káº¾T THÃšC Bá»” SUNG CSS */


#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">MÃ¡y há»— trá»£ giá»ng nÃ³i</h1>
<div class="container" id="buttonContainer"></div>

<div id="popup"></div>

<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">â• ThÃªm cÃ¢u má»›i</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">CÃ¢u trÆ°á»›c</button>
<button class="control-btn current-btn-color" data-direction="0">PhÃ¡t láº¡i</button>
<button class="control-btn play-control-btn" data-direction="1">CÃ¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">Má»Ÿ khÃ³a giao diá»‡n</button>
</div>

<div id="settingsArea">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: #fff;">
        <label for="rate-slider" style="font-weight: bold; color: #333;">Tá»‘c Ä‘á»™ Ä‘á»c (<span id="rate-value">1.0</span>)</label>
        <input type="range" id="rate-slider" min="0.5" max="2.0" step="0.1" value="1.0" style="width: 90%; cursor: pointer;">
    </div>
    <button class="btn settings-btn" onclick="toggleLock(true)">KhÃ³a giao diá»‡n</button>
    <button class="btn install-btn large-control-btn" id="installButton">ğŸ“² CÃ i Ä‘áº·t app</button>
    <button class="btn reset-btn" onclick="resetDefaults()">â™»ï¸ Reset máº·c Ä‘á»‹nh</button>
</div>
</div>

<div id="tts-info">Náº¿u khÃ´ng tháº¥y Ã¢m thanh, táº£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>

// HÃ€M Má»šI: TrÃ­ch xuáº¥t dáº¥u thanh cho má»¥c Ä‘Ã­ch sáº¯p xáº¿p Æ°u tiÃªn
function getTonePriority(word) {
    // 1: Thanh Báº±ng/Ngang (cÃ³ thá»ƒ khÃ´ng dáº¥u) - Æ¯u tiÃªn cao nháº¥t
    // 2: Thanh Sáº¯c, Há»i
    // 3: Thanh Huyá»n, NgÃ£, Náº·ng
    
    // Logic Ä‘Æ¡n giáº£n:
    // a/e/o/u/i/y cÃ³ thá»ƒ cÃ³ dáº¥u: Ã¡/Ã /áº£/Ã£/áº¡, Ã©/Ã¨/áº»/áº½/áº¹, v.v.
    
    // Náº¿u khÃ´ng cÃ³ dáº¥u, coi lÃ  Thanh Báº±ng (1)
    if (removeDiacritics(word).toLowerCase() === word.toLowerCase()) {
        return 1;
    }
    
    // Dáº¥u Sáº¯c (Ã¡, Ã©, Ã­, Ã³, Ãº, Ã½) vÃ  Há»i (áº£, áº», á»‰, á», á»§, á»·)
    // Sáº¯c: Ã¡Ã©Ã­Ã³ÃºÃ½
    // Há»i: áº£áº»á»‰á»á»§á»·
    if (/[Ã¡Ã©Ã­Ã³ÃºÃ½áº£áº»á»‰á»á»§á»·]/.test(word.toLowerCase())) {
        return 2;
    }

    // Dáº¥u Huyá»n (Ã , Ã¨, Ã¬, Ã², Ã¹, á»³), NgÃ£ (Ã£, áº½, Ä©, Ãµ, Å©, á»¹) vÃ  Náº·ng (áº¡, áº¹, á»‹, á», á»¥, á»µ)
    // Huyá»n/NgÃ£/Náº·ng: Ã Ã¨Ã¬Ã²Ã¹á»³Ã£áº½Ä©ÃµÅ©á»¹áº¡áº¹á»‹á»á»¥á»µ
    // Tráº£ vá» Æ°u tiÃªn tháº¥p hÆ¡n (3)
    if (/[Ã Ã¨Ã¬Ã²Ã¹á»³Ã£áº½Ä©ÃµÅ©á»¹áº¡áº¹á»‹á»á»¥á»µ]/.test(word.toLowerCase())) {
        return 3;
    }
    
    // CÃ¡c trÆ°á»ng há»£p Ä‘áº·c biá»‡t khÃ¡c hoáº·c khÃ´ng tÃ¬m tháº¥y dáº¥u (fallback)
    return 1;
}
    
// HÃ€M Bá»” SUNG: Chuyá»ƒn Ä‘á»•i chuá»—i cÃ³ dáº¥u thÃ nh khÃ´ng dáº¥u
function removeDiacritics(str) {
    if (typeof str !== 'string') return '';
    return str.toLowerCase()
        .replace(/Ã |Ã¡|áº¡|áº£|Ã£|Ã¢|áº§|áº¥|áº­|áº©|áº«|Äƒ|áº±|áº¯|áº·|áº³|áºµ/g, "a")
        .replace(/Ã¨|Ã©|áº¹|áº»|áº½|Ãª|á»|áº¿|á»‡|á»ƒ|á»…/g, "e")
        .replace(/Ã¬|Ã­|á»‹|á»‰|Ä©/g, "i")
        .replace(/Ã²|Ã³|á»|á»|Ãµ|Ã´|á»“|á»‘|á»™|á»•|á»—|Æ¡|á»|á»›|á»£|á»Ÿ|á»¡/g, "o")
        .replace(/Ã¹|Ãº|á»¥|á»§|Å©|Æ°|á»«|á»©|á»±|á»­|á»¯/g, "u")
        .replace(/á»³|Ã½|á»µ|á»·|á»¹/g, "y")
        .replace(/Ä‘/g, "d");
}
    

// HÃ€M Má»šI: Táº£i dá»¯ liá»‡u gá»£i Ã½ vÃ  lÆ°u vÃ o wordSuggestions
const SUGGESTION_URL = 'goi-y-tu.txt'; // â¬…ï¸ QUAN TRá»ŒNG: Äá»•i Ä‘Æ°á»ng dáº«n file
const LOCAL_SUGGESTION_KEY = 'userSuggestions'; 
let serverSuggestions = []; 
let userSuggestions = []; 
let wordSuggestions = []; 

// HÃ€M Sá»¬A Äá»”I: Táº£i vÃ  xá»­ lÃ½ file TXT
async function loadSuggestions() {
    // 1. Táº£i tá»« Server (Sá»¬ Dá»¤NG .text() VÃ€ Tá»° PHÃ‚N TÃCH)
    try {
        const response = await fetch(SUGGESTION_URL);
        if (response.ok) {
            // Láº¥y ná»™i dung file dÆ°á»›i dáº¡ng vÄƒn báº£n thÃ´
            const textContent = await response.text(); 
            
            // TÃ¡ch chuá»—i vÄƒn báº£n thÃ nh máº£ng dá»±a trÃªn kÃ½ tá»± xuá»‘ng dÃ²ng ('\n')
            serverSuggestions = textContent
                .split('\n')
                .map(line => line.trim()) // Loáº¡i bá» khoáº£ng tráº¯ng thá»«a á»Ÿ Ä‘áº§u/cuá»‘i má»—i tá»«
                .filter(line => line.length > 0); // Loáº¡i bá» cÃ¡c dÃ²ng trá»‘ng
            
        } else {
            console.error('Lá»—i táº£i file gá»£i Ã½ server (kiá»ƒm tra file goi-y-tu.txt):', response.statusText);
        }
    } catch (error) {
        console.error('Lá»—i khi táº£i hoáº·c xá»­ lÃ½ file TXT:', error);
    }

    // 2. Táº£i tá»« LocalStorage (Giá»¯ nguyÃªn)
    try {
        const saved = localStorage.getItem(LOCAL_SUGGESTION_KEY);
        // VÃ¬ lÆ°u trong LocalStorage váº«n lÃ  JSON string, ta váº«n dÃ¹ng JSON.parse
        userSuggestions = saved ? JSON.parse(saved) : []; 
    } catch(e) {
        console.error('Lá»—i táº£i gá»£i Ã½ ngÆ°á»i dÃ¹ng:', e);
        userSuggestions = [];
    }

    // 3. Há»£p nháº¥t, loáº¡i bá» trÃ¹ng láº·p vÃ  sáº¯p xáº¿p
    wordSuggestions = [...new Set([...serverSuggestions, ...userSuggestions])].sort();
    console.log(`ÄÃ£ táº£i tá»•ng cá»™ng ${wordSuggestions.length} gá»£i Ã½ tá»« file TXT vÃ  LocalStorage.`);
}

// HÃ€M Sá»¬A Äá»”I: Äáº£o ngÆ°á»£c logic (Máº·c Ä‘á»‹nh Sá»” LÃŠN, Sá»• XUá»NG khi sÃ¡t mÃ©p trÃªn)
function showSuggestions(inputElement, boxElement) {
    const fullText = inputElement.value;
    const trimmedText = fullText.trim();

    // Láº¤Y Tá»ª CUá»I CÃ™NG HOáº¶C CHUá»–I Rá»–NG
    const parts = trimmedText.split(/\s+/).filter(p => p.length > 0);
    const lastWord = parts.length > 0 ? parts[parts.length - 1] : '';
    
    // Bá»” SUNG: Kiá»ƒm tra kÃ½ tá»± cuá»‘i cÃ¹ng trong fullText
    const lastCharIsSpace = fullText.length > 0 && fullText[fullText.length - 1] === ' ';

    // 1. Táº®T Gá»¢I Ã: Náº¿u toÃ n bá»™ trá»‘ng HOáº¶C kÃ½ tá»± cuá»‘i cÃ¹ng lÃ  phÃ­m cÃ¡ch
    if (trimmedText.length === 0 || lastCharIsSpace) {
        boxElement.style.display = 'none';
        return;
    }

    // Náº¿u khÃ´ng pháº£i phÃ­m cÃ¡ch, tiáº¿n hÃ nh gá»£i Ã½ cho 'lastWord'
    const lastWordNoDiacritics = removeDiacritics(lastWord).toLowerCase();
    
    // Náº¿u tá»« cuá»‘i cÃ¹ng khÃ´ng cÃ³ kÃ½ tá»±, táº¯t gá»£i Ã½
    if (lastWord.length === 0) {
        boxElement.style.display = 'none';
        return;
    }
    
    boxElement.innerHTML = '';
    
   // 1. Lá»c: Chá»‰ láº¥y cÃ¡c tá»« báº¯t Ä‘áº§u báº±ng 'lastWordNoDiacritics'
Â  Â  let filteredSuggestions = wordSuggestions
Â  Â  Â  Â  .filter(phrase => removeDiacritics(phrase).toLowerCase().startsWith(lastWordNoDiacritics));

Â  Â  // 2. Sáº¯p xáº¿p: Æ¯u tiÃªn Thanh Báº±ng (priority 1), sau Ä‘Ã³ lÃ  Thanh Sáº¯c/Há»i (priority 2), v.v.
Â  Â  filteredSuggestions.sort((a, b) => {
Â  Â  Â  Â  const toneA = getTonePriority(a);
Â  Â  Â  Â  const toneB = getTonePriority(b);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Sáº¯p xáº¿p theo Æ°u tiÃªn thanh (1 -> 2 -> 3)
Â  Â  Â  Â  if (toneA !== toneB) {
Â  Â  Â  Â  Â  Â  return toneA - toneB;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Náº¿u cÃ¹ng thanh, sáº¯p xáº¿p theo thá»© tá»± báº£ng chá»¯ cÃ¡i (máº·c Ä‘á»‹nh Ä‘Ã£ Ä‘Æ°á»£c sáº¯p xáº¿p trÆ°á»›c Ä‘Ã³)
Â  Â  Â  Â  if (a < b) return -1;
Â  Â  Â  Â  if (a > b) return 1;
Â  Â  Â  Â  return 0;
Â  Â  });
Â  Â Â 
Â  Â  // 3. Cáº¯t: Chá»‰ láº¥y 5 káº¿t quáº£ Ä‘áº§u tiÃªn sau khi Ä‘Ã£ sáº¯p xáº¿p
Â  Â  filteredSuggestions = filteredSuggestions.slice(0, 5);  

    // ... (Pháº§n logic cÃ²n láº¡i giá»¯ nguyÃªn) ...
    // Báº®T Äáº¦U LOGIC ÄIá»€U CHá»ˆNH Vá»Š TRÃ Má»šI (Máº·c Ä‘á»‹nh Sá»” LÃŠN)
    // ... (Pháº§n nÃ y giá»¯ nguyÃªn) ...

    if (filteredSuggestions.length > 0) {
        // Báº®T Äáº¦U LOGIC ÄIá»€U CHá»ˆNH Vá»Š TRÃ Má»šI (Máº·c Ä‘á»‹nh Sá»” LÃŠN)
        const rect = inputElement.getBoundingClientRect();
        const suggestionHeight = 150; // max-height trong CSS
        const spaceAbove = rect.top;

        // XÃ¡c Ä‘á»‹nh ngÆ°á»¡ng linh hoáº¡t: 15% chiá»u cao mÃ n hÃ¬nh
        const TOP_THRESHOLD = window.innerHeight * 0.15; 
        
        let shouldAlignBottom = false; // Máº·c Ä‘á»‹nh lÃ  Sá»• LÃŠN (align-top)

        // Ká»‹ch báº£n 1: KhÃ´ng Ä‘á»§ chá»— bÃªn trÃªn VÃ€ Ä‘á»§ chá»— bÃªn dÆ°á»›i -> Sá»• XUá»NG
        // NgÄƒn ngá»«a trÆ°á»ng há»£p trÃ n trÃªn (khi bÃ n phÃ­m khÃ´ng báº­t)
        if (spaceAbove < suggestionHeight + 50 && (window.innerHeight - rect.bottom) > suggestionHeight) {
            shouldAlignBottom = true;
        } 
        
        // Ká»‹ch báº£n 2 (Má»¥c tiÃªu cá»§a báº¡n): Náº¿u Input SÃT MÃ‰P TRÃŠN (< 15% mÃ n hÃ¬nh)
        // Báº¯t buá»™c sá»• XUá»NG Ä‘á»ƒ trÃ¡nh bá»‹ che bá»Ÿi thanh trÃ¬nh duyá»‡t/thanh tráº¡ng thÃ¡i.
        if (rect.top < TOP_THRESHOLD) { 
            shouldAlignBottom = true; // Báº¯t buá»™c sá»• xuá»‘ng
        }

        // Ãp dá»¥ng class má»›i
        if (shouldAlignBottom) {
            boxElement.classList.add('align-bottom');
        } else {
            boxElement.classList.remove('align-bottom');
        }
        // Káº¾T THÃšC LOGIC ÄIá»€U CHá»ˆNH Vá»Š TRÃ

        filteredSuggestions.forEach(phrase => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = phrase;
            
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                
                // Láº¥y láº¡i tá»« cuá»‘i cÃ¹ng (Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng bá»‹ láº«n phÃ­m cÃ¡ch)
                const currentFullText = inputElement.value;
                const currentTrimmedText = currentFullText.trim();
                const currentParts = currentTrimmedText.split(/\s+/).filter(p => p.length > 0);
                const currentLastWord = currentParts.length > 0 ? currentParts[currentParts.length - 1] : '';
                
                // TÃ¬m vá»‹ trÃ­ báº¯t Ä‘áº§u cá»§a tá»« cuá»‘i cÃ¹ng trong chuá»—i *ban Ä‘áº§u* (cÃ³ thá»ƒ cÃ³ khoáº£ng tráº¯ng cuá»‘i)
                let lastWordStart = -1;
                // Náº¿u khÃ´ng cÃ³ khoáº£ng tráº¯ng cuá»‘i, ta tÃ¬m tá»« cuá»‘i trong chuá»—i Ä‘Ã£ trim
                if (currentFullText.endsWith(currentLastWord)) {
                   lastWordStart = currentFullText.lastIndexOf(currentLastWord);
                } else {
                   // TrÆ°á»ng há»£p cÃ³ khoáº£ng tráº¯ng cuá»‘i (lá»—i logic vá»›i trim, nhÆ°ng an toÃ n hÆ¡n lÃ  dÃ¹ng lastWord.length)
                   lastWordStart = currentFullText.length - currentLastWord.length; 
                }
                
                // Äáº£m báº£o khÃ´ng thay tháº¿ nháº§m náº¿u tá»« cuá»‘i khÃ´ng tá»“n táº¡i
                if (lastWordStart === -1 || currentLastWord.length === 0) {
                     inputElement.value += phrase + ' ';
                } else {
                     let newText = currentFullText.substring(0, lastWordStart) + phrase;
                     newText += ' ';
                     inputElement.value = newText;
                }
                
                boxElement.style.display = 'none';
                saveAll(); 
                inputElement.focus();
                
                inputElement.selectionStart = inputElement.selectionEnd = inputElement.value.length;
            });

            boxElement.appendChild(item);
        });
        boxElement.style.display = 'block';
    } else {
        boxElement.style.display = 'none';
    }
}
    
// Káº¾T THÃšC PHáº¦N Bá»” SUNG

let deferredPrompt,currentIndex=0,defaults=["TÃ´i muá»‘n Äƒn cÆ¡m","TÃ´i muá»‘n uá»‘ng nÆ°á»›c","TÃ´i muá»‘n Ä‘i vá»‡ sinh","TÃ´i muá»‘n Ä‘i ngá»§"],installState = 'before_install';
const controlArea=document.getElementById('controlArea'),
      installButton=document.getElementById('installButton'),
      addBtnMove=document.getElementById('add-btn-move'),
      popupElement=document.getElementById('popup'),
      buttonContainer=document.getElementById('buttonContainer'),
      settingsArea=document.getElementById('settingsArea');

// Bá»” SUNG: Khá»Ÿi táº¡o biáº¿n cho tá»‘c Ä‘á»™ Ä‘á»c
let currentRate = 1.0; 
const rateSlider = document.getElementById('rate-slider');
const rateValueSpan = document.getElementById('rate-value');
    
function speak(text, targetElement){
    if(!text||!('speechSynthesis'in window))return;
    speechSynthesis.cancel();
    let u=new SpeechSynthesisUtterance(text);
    u.lang='vi-VN';
    // Sá»¬A Äá»”I: Ãp dá»¥ng tá»‘c Ä‘á»™ Ä‘á»c hiá»‡n táº¡i
    u.rate = currentRate; 
    speechSynthesis.speak(u);
    showPopup(text); 
}

function showPopup(text){
    popupElement.textContent=text;
    popupElement.style.display='block';
    popupElement.style.opacity='1';

    setTimeout(()=>{ 
        popupElement.style.opacity='0'; 
        setTimeout(()=>popupElement.style.display='none', 500) 
    },3500) 
}

function getCards(){return document.querySelectorAll('.card input')}

// HÃ m nÃ y Ä‘áº£m báº£o currentIndex luÃ´n trá» Ä‘áº¿n má»™t vá»‹ trÃ­ há»£p lá»‡
function updateCurrentIndexAfterChange() {
    const c = getCards();
    currentIndex = Math.min(currentIndex, c.length - 1);
    if (currentIndex < 0) currentIndex = 0;
}

// HÃ€M Sá»¬A Äá»”I: ThÃªm suggestion-box vÃ  sá»± kiá»‡n input/blur
function addButton(v=''){
    let c=document.createElement('div');
    c.className='card';
    
    // INPUT Bá»” SUNG: ThÃªm sá»± kiá»‡n vÃ  táº¡o suggestion-box
    let i=document.createElement('input');
    i.value=v;
    i.placeholder="Nháº­p vÄƒn báº£n...";
    i.onchange=saveAll;
    
    let sBox = document.createElement('div'); // Há»™p gá»£i Ã½
    sBox.className = 'suggestion-box';

    // Gáº¯n sá»± kiá»‡n khi gÃµ
    i.addEventListener('input', (e) => showSuggestions(e.target, sBox));
    
    // áº¨n há»™p gá»£i Ã½ khi máº¥t focus (dÃ¹ng setTimeout Ä‘á»ƒ cho phÃ©p click vÃ o gá»£i Ã½)
    i.addEventListener('blur', () => {
        setTimeout(() => sBox.style.display = 'none', 150);
    });
    // Káº¾T THÃšC Sá»¬A Äá»”I INPUT
    
    let p=document.createElement('button');
    p.className='btn play-btn';
    p.textContent='ğŸ”Š PhÃ¡t Ã¢m';
    p.onclick=()=>speak(i.value.trim(), p); 
    let d=document.createElement('button');
    d.className='delete-btn';
    d.textContent='âŒ';
    d.onclick=()=>{
        c.remove();
        saveAll();
        updateCurrentIndexAfterChange(); // Cáº­p nháº­t sau khi xÃ³a
    };
    // ÄÃ­nh kÃ¨m suggestion box vÃ o card
    c.append(i, sBox, p, d); 
    document.getElementById('buttonContainer').appendChild(c);
    saveAll();
    // Äáº·t currentIndex vÃ o tháº» má»›i (tháº» cuá»‘i cÃ¹ng)
    currentIndex = getCards().length - 1; 
}

function saveAll(){localStorage.setItem('voiceButtons',JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim())))}
function loadButtons(){let s=JSON.parse(localStorage.getItem('voiceButtons')||"[]");(s.length?s:defaults).forEach(t=>addButton(t));currentIndex=0; cleanupEmptyCards();}
function resetDefaults(){if(confirm("Äáº·t láº¡i máº·c Ä‘á»‹nh?")){localStorage.removeItem('voiceButtons');document.getElementById('buttonContainer').innerHTML='';loadButtons();currentIndex=0;}}

function cleanupEmptyCards(){
    let c=document.querySelectorAll('.card'),save=false;
    for(let i=c.length-1;i>=0;i--){
        let inp=c[i].querySelector('input');
        // Chá»‰ xÃ³a tháº» náº¿u nÃ³ hoÃ n toÃ n trá»‘ng
        if(!inp||inp.value.trim()===''){
            c[i].remove();
            save=true;
        }
    }
    if(save){
        saveAll();
        updateCurrentIndexAfterChange();
    }
}

function moveSpeak(dir){
    // Bá» cleanupEmptyCards() Ä‘á»ƒ Ä‘áº£m báº£o Ä‘iá»u hÆ°á»›ng á»•n Ä‘á»‹nh
    const c=getCards();
    if(c.length===0)return;
    
    if(dir===0){
        // PhÃ¡t láº¡i cÃ¢u hiá»‡n táº¡i, kiá»ƒm tra trá»‘ng
        const text = c[currentIndex].value.trim();
        if (text) {
            speak(text);
        } else {
            showPopup("CÃ¢u trá»‘ng! Vui lÃ²ng sá»­a hoáº·c xÃ³a.");
        }
    } else {
        // Di chuyá»ƒn cÃ¢u trÆ°á»›c/sau
        currentIndex=(currentIndex+dir+c.length)%c.length;
        
        // VÃ²ng láº·p tÃ¬m cÃ¢u khÃ´ng trá»‘ng (Ä‘á»ƒ trÃ¡nh láº·p vÃ´ táº­n náº¿u Táº¤T Cáº¢ trá»‘ng)
        let count = 0;
        while(c[currentIndex].value.trim() === '' && count < c.length) {
            currentIndex=(currentIndex+dir+c.length)%c.length;
            count++;
        }
        
        // Náº¿u tÃ¬m tháº¥y cÃ¢u Ä‘á»ƒ Ä‘á»c
        const text = c[currentIndex].value.trim();
        if (text) {
            speak(text);
        } else {
             // Chá»‰ xáº£y ra náº¿u táº¥t cáº£ cÃ¡c cÃ¢u Ä‘á»u trá»‘ng
            showPopup("KhÃ´ng cÃ³ cÃ¢u nÃ o Ä‘á»ƒ Ä‘á»c.");
        }
    }
}

function toggleLock(lock){
    const u=document.getElementById('unlock-btn');
    // Khi thoÃ¡t khá»i cháº¿ Ä‘á»™ khÃ³a, dá»n dáº¹p tháº» trá»‘ng
    if (!lock) {
        cleanupEmptyCards();
    }
    
    if(lock){
        buttonContainer.style.display='none';
        addBtnMove.style.display='none';
        settingsArea.style.display='none';
        
        controlArea.classList.add('locked');
        document.body.classList.add('locked');
        document.getElementById('mainTitle').classList.add('locked-h1');
        u.style.display='flex';
    } else {
        buttonContainer.style.display='grid';
        addBtnMove.style.display='block';
        settingsArea.style.display='block';
        
        controlArea.classList.remove('locked');
        document.body.classList.remove('locked');
        document.getElementById('mainTitle').classList.remove('locked-h1');
        u.style.display='none';
    }
}

// Gáº¯n sá»± kiá»‡n cho cÃ¡c nÃºt Ä‘iá»u hÆ°á»›ng
document.querySelectorAll('.control-btn').forEach(button => {
    // Giá»¯ cáº£ click vÃ  touchend Ä‘á»ƒ tá»‘i Æ°u pháº£n há»“i trÃªn di Ä‘á»™ng
    ['click', 'touchend'].forEach(event => {
        button.addEventListener(event, function(e) {
            // NgÄƒn cháº·n sá»± kiá»‡n cháº¡m kÃ­ch hoáº¡t click hai láº§n
            e.preventDefault(); 
            // DÃ¹ng currentTarget Ä‘á»ƒ láº¥y data-direction cá»§a nÃºt
            moveSpeak(parseInt(e.currentTarget.dataset.direction)); 
        }, { passive: false });
    });
});

window.addEventListener('beforeinstallprompt',e=>{ 
    e.preventDefault(); 
    deferredPrompt=e; 
    if (installState === 'before_install') {
        installButton.style.display='flex';
        installButton.onclick=installApp;
    }
});

function installApp(){
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult)=>{
            if (choiceResult.outcome === 'accepted') {
                installState = 'installed';
            } else {
                installState = 'rejected';
            }
            deferredPrompt=null;
            installButton.style.display='none';
        });
    }
}

window.addEventListener('appinstalled',()=>{ 
    installState = 'installed'; 
    installButton.style.display='none'; 
});

if (installState === 'before_install') { 
    installButton.style.display='none'; 
}

function warmUpTTS(){
    if(!('speechSynthesis'in window))return;
    let u=new SpeechSynthesisUtterance(" ");
    u.lang='vi-VN';
    u.volume=0;
    u.rate=10;
    speechSynthesis.speak(u);
    setTimeout(()=>speechSynthesis.cancel(),500)
}
// Sá»¬A Äá»”I: Gá»i hÃ m táº£i gá»£i Ã½ má»›i
// HÃ€M Má»šI: Táº£i tá»‘c Ä‘á»™ Ä‘á»c tá»« LocalStorage
function loadRate() {
    const savedRate = localStorage.getItem('ttsRate');
    if (savedRate !== null) {
        currentRate = parseFloat(savedRate);
    }
    // Cáº­p nháº­t giao diá»‡n
    if (rateSlider) {
        rateSlider.value = currentRate.toFixed(1);
        rateValueSpan.textContent = currentRate.toFixed(1);
    }
}

// HÃ€M Má»šI: LÆ°u tá»‘c Ä‘á»™ Ä‘á»c
function saveRate(rate) {
    currentRate = rate;
    localStorage.setItem('ttsRate', rate.toFixed(1));
    rateValueSpan.textContent = rate.toFixed(1);
}

// LOGIC THANH TRÆ¯á»¢T
window.addEventListener('DOMContentLoaded', () => {
    // Chá»‰ cháº¡y náº¿u thanh trÆ°á»£t tá»“n táº¡i
    if (rateSlider) {
        rateSlider.addEventListener('input', (e) => {
            const newRate = parseFloat(e.target.value);
            // Cáº­p nháº­t ngay khi kÃ©o, nhÆ°ng chá»‰ lÆ°u vÃ o localStorage khi dá»«ng háº³n (dÃ¹ng change)
            rateValueSpan.textContent = newRate.toFixed(1);
            currentRate = newRate; // Cáº­p nháº­t biáº¿n Ä‘á»ƒ dÃ¹ng ngay
        });

        rateSlider.addEventListener('change', (e) => {
            // LÆ°u vÃ o LocalStorage khi ngÆ°á»i dÃ¹ng nháº¥c tay ra khá»i thanh trÆ°á»£t
            saveRate(parseFloat(e.target.value)); 
        });
    }
});
    
// Sá»¬A Äá»”I: Gá»i hÃ m táº£i gá»£i Ã½ má»›i vÃ  táº£i tá»‘c Ä‘á»™ Ä‘á»c
window.onload=()=>{loadButtons();warmUpTTS();loadSuggestions();loadRate();}
    
</script>

</body>
</html>
