<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MÃ¡y há»— trá»£ giá»ng nÃ³i</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
/* Chá»‘ng ngÆ°á»i dÃ¹ng vuá»‘t mÃ n hÃ¬nh khi khÃ³a */
body.locked {
    overflow: hidden; 
    overscroll-behavior-y: contain; 
    touch-action: none;
}

.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{
    width:220px;
    height:50px;
    font-size:18px;
    margin:8px auto;
    display:flex;
    justify-content:center;
    align-items:center;
}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)} 
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
/* THAY Äá»”I: Sá»­ dá»¥ng touch-action: manipulation; Ä‘á»ƒ Æ°u tiÃªn cÃ¡c sá»± kiá»‡n nháº¥n/cháº¡m */
.control-btn{
    width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;
    touch-action: manipulation; 
}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}

/* CSS cho cháº¿ Ä‘á»™ khÃ³a */
.control-container.locked{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    overflow:hidden;
    z-index:99;
    background:#e3f2fd;
    justify-content: center; 
}
.control-container.locked #add-btn-move,
.control-container.locked #settingsArea {
    display: none !important;
}
.control-container.locked .navigation-group{
    margin:0;
}
.control-container.locked #unlock-btn{
    position:fixed;
    bottom: 80px; 
    left:50%;
    transform:translateX(-50%);
    display:flex;
    z-index:100;
}

/* Cáº­p nháº­t CSS cho Popup: LuÃ´n fixed vÃ  cÄƒn giá»¯a */
#popup{
    position: fixed;
    top: 200px;
    left: 50%;
    transform: translateX(-50%);
    
    background:rgba(0,0,0,.8);
    color:#fff;
    padding:15px 20px;
    border-radius:12px;
    font-size:18px;
    display:none;
    z-index:1000;
    max-width:90%;
    min-width:100px;
    text-align:center;
    transition: opacity 0.5s ease-out; 
}

#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
    /* CSS cho chá»©c nÄƒng Gá»£i Ã½ tá»« */
.autocomplete-results {
Â  Â  position: absolute;
Â  Â  z-index: 10;
Â  Â  border: 1px solid #d4d4d4;
Â  Â  border-bottom: none;
Â  Â  border-top: none;
Â  Â  cursor: pointer;
Â  Â  background-color: #fff;
Â  Â  max-height: 150px;
Â  Â  overflow-y: auto;
Â  Â  text-align: left;
Â  Â  top: 100%; /* Äáº£m báº£o nÃ³ náº±m ngay dÆ°á»›i input */
Â  Â  left: 0;
Â  Â  right: 0;
Â  Â  box-shadow: 0 4px 6px rgba(0,0,0,.1);
Â  Â  border-radius: 0 0 8px 8px;
}

.autocomplete-results div {
Â  Â  padding: 10px;
Â  Â  border-bottom: 1px solid #d4d4d4;
}

.autocomplete-results .autocomplete-active,
.autocomplete-results div:hover {
Â  Â  background-color: #e3f2fd;
Â  Â  color: #1976D2;
}

/* Äáº£m báº£o tháº» card cÃ³ position: relative Ä‘á»ƒ gá»£i Ã½ hiá»ƒn thá»‹ Ä‘Ãºng */
.card {
Â  Â  position: relative;
}
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">MÃ¡y há»— trá»£ giá»ng nÃ³i</h1>
<div class="container" id="buttonContainer"></div>

<div id="popup"></div>

<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">â• ThÃªm cÃ¢u má»›i</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">CÃ¢u trÆ°á»›c</button>
<button class="control-btn current-btn-color" data-direction="0">PhÃ¡t láº¡i</button>
<button class="control-btn play-control-btn" data-direction="1">CÃ¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">Má»Ÿ khÃ³a giao diá»‡n</button>
</div>

<div id="settingsArea">
<button class="btn settings-btn" onclick="toggleLock(true)">KhÃ³a giao diá»‡n</button>
<button class="btn install-btn large-control-btn" id="installButton">ğŸ“² CÃ i Ä‘áº·t app</button>
<button class="btn reset-btn" onclick="resetDefaults()">â™»ï¸ Reset máº·c Ä‘á»‹nh</button>
</div>
</div>

<div id="tts-info">Náº¿u khÃ´ng tháº¥y Ã¢m thanh, táº£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>
<script>
let deferredPrompt,currentIndex=0,defaults=["TÃ´i muá»‘n Äƒn cÆ¡m","TÃ´i muá»‘n uá»‘ng nÆ°á»›c","TÃ´i muá»‘n Ä‘i vá»‡ sinh","TÃ´i muá»‘n Ä‘i ngá»§"],installState = 'before_install';
const controlArea=document.getElementById('controlArea'),
Â  Â  Â  installButton=document.getElementById('installButton'),
Â  Â  Â  addBtnMove=document.getElementById('add-btn-move'),
Â  Â  Â  popupElement=document.getElementById('popup'),
Â  Â  Â  buttonContainer=document.getElementById('buttonContainer'),
Â  Â  Â  settingsArea=document.getElementById('settingsArea');

// DANH SÃCH Tá»ª Vá»°NG Gá»¢I Ã (CÃ³ thá»ƒ má»Ÿ rá»™ng thÃªm)
const VIETNAMESE_VOCAB = [
    "TÃ´i muá»‘n Äƒn cÆ¡m", "TÃ´i muá»‘n uá»‘ng nÆ°á»›c", "TÃ´i muá»‘n Ä‘i vá»‡ sinh", "TÃ´i muá»‘n Ä‘i ngá»§",
    "TÃ´i má»‡t", "TÃ´i Ä‘Ã³i", "TÃ´i khÃ¡t", "TÃ´i láº¡nh", "TÃ´i nÃ³ng", "TÃ´i Ä‘au", "Xin chÃ o",
    "Cáº£m Æ¡n", "KhÃ´ng sao", "Chá» má»™t chÃºt", "VÃ¢ng", "KhÃ´ng", "Má»Ÿ tivi", "Nghe nháº¡c", 
    "Äá»c sÃ¡ch", "Uá»‘ng thuá»‘c", "Thay quáº§n Ã¡o", "Táº¯m rá»­a", "Cháº£i tÃ³c", "Gá»i Ä‘iá»‡n thoáº¡i"
].map(s => s.toLowerCase());

let currentFocus = -1; // Chá»‰ sá»‘ cá»§a má»¥c Ä‘Æ°á»£c chá»n trong danh sÃ¡ch gá»£i Ã½

function speak(text, targetElement){
Â  Â  if(!text||!('speechSynthesis'in window))return;
Â  Â  speechSynthesis.cancel();
Â  Â  let u=new SpeechSynthesisUtterance(text);
Â  Â  u.lang='vi-VN';
Â  Â  speechSynthesis.speak(u);
Â  Â  showPopup(text);Â 
}

function showPopup(text){
Â  Â  popupElement.textContent=text;
Â  Â  popupElement.style.display='block';
Â  Â  popupElement.style.opacity='1';

Â  Â  setTimeout(()=>{Â 
Â  Â  Â  Â  popupElement.style.opacity='0';Â 
Â  Â  Â  Â  setTimeout(()=>popupElement.style.display='none', 500)Â 
Â  Â  },3500)Â 
}

function getCards(){return document.querySelectorAll('.card input')}

function updateCurrentIndexAfterChange() {
    const c = getCards();
    currentIndex = Math.min(currentIndex, c.length - 1);
    if (currentIndex < 0) currentIndex = 0;
}

function addButton(v=''){
Â  Â  let c=document.createElement('div');
Â  Â  c.className='card';
Â  Â  let i=document.createElement('input');
Â  Â  i.value=v;
Â  Â  i.placeholder="Nháº­p vÄƒn báº£n...";
Â  Â  i.onchange=saveAll;
    
    // Gáº®N Sá»° KIá»†N Gá»¢I Ã Tá»ª CHO INPUT Má»šI
    i.addEventListener("input", function(e) { autocomplete(e.target); });
    i.addEventListener("keydown", function(e) { handleAutocompleteKeydown(e, i); });
    
Â  Â  let p=document.createElement('button');
Â  Â  p.className='btn play-btn';
Â  Â  p.textContent='ğŸ”Š PhÃ¡t Ã¢m';
Â  Â  p.onclick=()=>speak(i.value.trim(), p);Â 
Â  Â  let d=document.createElement('button');
Â  Â  d.className='delete-btn';
Â  Â  d.textContent='âŒ';
Â  Â  d.onclick=()=>{
        c.remove();
        saveAll();
        updateCurrentIndexAfterChange();
    };
Â  Â  c.append(i,p,d);
Â  Â  document.getElementById('buttonContainer').appendChild(c);
Â  Â  saveAll();
    currentIndex = getCards().length - 1; 
}

function saveAll(){localStorage.setItem('voiceButtons',JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim())))}
function loadButtons(){
    let s=JSON.parse(localStorage.getItem('voiceButtons')||"[]");
    (s.length?s:defaults).forEach(t=>addButton(t));
    currentIndex=0; 
    cleanupEmptyCards();
}
function resetDefaults(){if(confirm("Äáº·t láº¡i máº·c Ä‘á»‹nh?")){localStorage.removeItem('voiceButtons');document.getElementById('buttonContainer').innerHTML='';loadButtons();currentIndex=0;}}

function cleanupEmptyCards(){
    let c=document.querySelectorAll('.card'),save=false;
    for(let i=c.length-1;i>=0;i--){
        let inp=c[i].querySelector('input');
        if(!inp||inp.value.trim()===''){
            c[i].remove();
            save=true;
        }
    }
    if(save){
        saveAll();
        updateCurrentIndexAfterChange();
    }
}

function moveSpeak(dir){
Â  Â  const c=getCards();
Â  Â  if(c.length===0)return;
Â  Â Â 
Â  Â  if(dir===0){
Â  Â  Â  Â  const text = c[currentIndex].value.trim();
        if (text) {
            speak(text);
        } else {
            showPopup("CÃ¢u trá»‘ng! Vui lÃ²ng sá»­a hoáº·c xÃ³a.");
        }
Â  Â  } else {
Â  Â  Â  Â  currentIndex=(currentIndex+dir+c.length)%c.length;
        
        let count = 0;
        while(c[currentIndex].value.trim() === '' && count < c.length) {
            currentIndex=(currentIndex+dir+c.length)%c.length;
            count++;
        }
        
        const text = c[currentIndex].value.trim();
        if (text) {
            speak(text);
        } else {
            showPopup("KhÃ´ng cÃ³ cÃ¢u nÃ o Ä‘á»ƒ Ä‘á»c.");
        }
Â  Â  }
}

function toggleLock(lock){
Â  Â  const u=document.getElementById('unlock-btn');
    if (!lock) {
        cleanupEmptyCards();
    }
    
Â  Â  if(lock){
Â  Â  Â  Â  buttonContainer.style.display='none';
Â  Â  Â  Â  addBtnMove.style.display='none';
Â  Â  Â  Â  settingsArea.style.display='none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  controlArea.classList.add('locked');
Â  Â  Â  Â  document.body.classList.add('locked');
Â  Â  Â  Â  document.getElementById('mainTitle').classList.add('locked-h1');
Â  Â  Â  Â  u.style.display='flex';
Â  Â  } else {
Â  Â  Â  Â  buttonContainer.style.display='grid';
Â  Â  Â  Â  addBtnMove.style.display='block';
Â  Â  Â  Â  settingsArea.style.display='block';
Â  Â  Â  Â Â 
Â  Â  Â  Â  controlArea.classList.remove('locked');
Â  Â  Â  Â  document.body.classList.remove('locked');
Â  Â  Â  Â  document.getElementById('mainTitle').classList.remove('locked-h1');
Â  Â  Â  Â  u.style.display='none';
Â  Â  }
}

// Gáº¯n sá»± kiá»‡n cho cÃ¡c nÃºt Ä‘iá»u hÆ°á»›ng
document.querySelectorAll('.control-btn').forEach(button => {
Â  Â  ['click', 'touchend'].forEach(event => {
        button.addEventListener(event, function(e) {
            e.preventDefault(); 
            moveSpeak(parseInt(e.currentTarget.dataset.direction)); 
        }, { passive: false });
    });
});

/* --- LOGIC Gá»¢I Ã Tá»ª Má»šI --- */

// HÃ m loáº¡i bá» dáº¥u tiáº¿ng Viá»‡t (chuyá»ƒn "tiáº¿ng viá»‡t" thÃ nh "tieng viet")
function removeDiacritics(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function autocomplete(inp) {
    let a, val = inp.value.toLowerCase(), i, item, text;
    // ÄÃ³ng má»i danh sÃ¡ch gá»£i Ã½ Ä‘ang má»Ÿ
    closeAllLists();
    if (!val) { return false; }
    currentFocus = -1;

    // Táº¡o DIV cho danh sÃ¡ch gá»£i Ã½
    a = document.createElement("div");
    a.setAttribute("id", inp.id + "autocomplete-list");
    a.setAttribute("class", "autocomplete-results");
    
    // Gáº¯n DIV gá»£i Ã½ vÃ o ngay dÆ°á»›i INPUT
    inp.parentNode.appendChild(a);
    
    let count = 0;
    const cleanVal = removeDiacritics(val);

    for (i = 0; i < VIETNAMESE_VOCAB.length && count < 6; i++) { // Giá»›i háº¡n 6 gá»£i Ã½
        text = VIETNAMESE_VOCAB[i];
        const cleanText = removeDiacritics(text);
        
        // So sÃ¡nh chuá»—i khÃ´ng dáº¥u
        if (cleanText.includes(cleanVal)) { 
            count++;
            
            item = document.createElement("div");
            // Hiá»ƒn thá»‹ tá»« gá»£i Ã½ nguyÃªn báº£n
            item.innerHTML = text;
            
            // Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng nháº¥p vÃ o gá»£i Ã½
            item.addEventListener("click", function(e) {
                // ÄÆ°a giÃ¡ trá»‹ gá»£i Ã½ vÃ o input
                inp.value = this.innerText;
                saveAll(); // LÆ°u láº¡i sau khi chá»n
                closeAllLists();
            });
            a.appendChild(item);
        }
    }
}

function handleAutocompleteKeydown(e, inp) {
    let x = document.getElementById(inp.id + "autocomplete-list");
    if (x) x = x.getElementsByTagName("div");
    if (e.keyCode === 40) { // MÅ©i tÃªn xuá»‘ng
        currentFocus++;
        addActive(x);
    } else if (e.keyCode === 38) { // MÅ©i tÃªn lÃªn
        currentFocus--;
        addActive(x);
    } else if (e.keyCode === 13) { // Enter
        e.preventDefault();
        if (currentFocus > -1) {
            if (x) x[currentFocus].click();
        }
    }
}

function addActive(x) {
    if (!x) return false;
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    x[currentFocus].classList.add("autocomplete-active");
}

function removeActive(x) {
    for (let i = 0; i < x.length; i++) {
        x[i].classList.remove("autocomplete-active");
    }
}

function closeAllLists(elmnt) {
    let x = document.getElementsByClassName("autocomplete-results");
    for (let i = 0; i < x.length; i++) {
        if (elmnt != x[i] && elmnt != document.activeElement && elmnt != x[i].parentNode.querySelector('input')) {
            x[i].parentNode.removeChild(x[i]);
        }
    }
    currentFocus = -1;
}

// ÄÃ³ng gá»£i Ã½ khi nháº¥p chuá»™t ra ngoÃ i
document.addEventListener("click", function (e) {
    closeAllLists(e.target);
});


/* --- CODE CÃ€I Äáº¶T PWA VÃ€ TTS CÅ¨ VáºªN GIá»® NGUYÃŠN --- */

window.addEventListener('beforeinstallprompt',e=>{Â 
Â  Â  e.preventDefault();Â 
Â  Â  deferredPrompt=e;Â 
Â  Â  if (installState === 'before_install') {
Â  Â  Â  Â  installButton.style.display='flex';
Â  Â  Â  Â  installButton.onclick=installApp;
Â  Â  }
});

function installApp(){
Â  Â  if(deferredPrompt){
Â  Â  Â  Â  deferredPrompt.prompt();
Â  Â  Â  Â  deferredPrompt.userChoice.then((choiceResult)=>{
Â  Â  Â  Â  Â  Â  if (choiceResult.outcome === 'accepted') {
Â  Â  Â  Â  Â  Â  Â  Â  installState = 'installed';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  installState = 'rejected';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  deferredPrompt=null;
Â  Â  Â  Â  Â  Â  installButton.style.display='none';
Â  Â  Â  Â  });
Â  Â  }
}

window.addEventListener('appinstalled',()=>{Â 
Â  Â  installState = 'installed';Â 
Â  Â  installButton.style.display='none';Â 
});

if (installState === 'before_install') {Â 
Â  Â  installButton.style.display='none';Â 
}

function warmUpTTS(){
Â  Â  if(!('speechSynthesis'in window))return;
Â  Â  let u=new SpeechSynthesisUtterance(" ");
Â  Â  u.lang='vi-VN';
Â  Â  u.volume=0;
Â  Â  u.rate=10;
Â  Â  speechSynthesis.speak(u);
Â  Â  setTimeout(()=>speechSynthesis.cancel(),500)
}
window.onload=()=>{loadButtons();warmUpTTS();}
</script>
</body>
</html>
