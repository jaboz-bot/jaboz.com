<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MÃ¡y há»— trá»£ giá»ng nÃ³i</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
/* Chá»‘ng ngÆ°á»i dÃ¹ng vuá»‘t mÃ n hÃ¬nh khi khÃ³a */
body.locked {
Â  Â  overflow: hidden;Â 
Â  Â  overscroll-behavior-y: contain;Â 
Â  Â  touch-action: none;
}

.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{
Â  Â  width:220px;
Â  Â  height:50px;
Â  Â  font-size:18px;
Â  Â  margin:8px auto;
Â  Â  display:flex;
Â  Â  justify-content:center;
Â  Â  align-items:center;
}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)}Â 
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
/* THAY Äá»”I: Sá»­ dá»¥ng touch-action: manipulation; Ä‘á»ƒ Æ°u tiÃªn cÃ¡c sá»± kiá»‡n nháº¥n/cháº¡m */
.control-btn{
Â  Â  width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;
Â  Â  touch-action: manipulation;Â 
}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}

/* CSS cho cháº¿ Ä‘á»™ khÃ³a */
.control-container.locked{
Â  Â  position:fixed;
Â  Â  top:0;
Â  Â  left:0;
Â  Â  width:100%;
Â  Â  height:100%;
Â  Â  overflow:hidden;
Â  Â  z-index:99;
Â  Â  background:#e3f2fd;
Â  Â  justify-content: center;Â 
}
.control-container.locked #add-btn-move,
.control-container.locked #settingsArea {
Â  Â  display: none !important;
}
.control-container.locked .navigation-group{
Â  Â  margin:0;
}
.control-container.locked #unlock-btn{
Â  Â  position:fixed;
Â  Â  bottom: 80px;Â 
Â  Â  left:50%;
Â  Â  transform:translateX(-50%);
Â  Â  display:flex;
Â  Â  z-index:100;
}

/* Cáº­p nháº­t CSS cho Popup: LuÃ´n fixed vÃ  cÄƒn giá»¯a */
#popup{
Â  Â  position: fixed;
Â  Â  top: 200px;
Â  Â  left: 50%;
Â  Â  transform: translateX(-50%);
Â  Â Â 
Â  Â  background:rgba(0,0,0,.8);
Â  Â  color:#fff;
Â  Â  padding:15px 20px;
Â  Â  border-radius:12px;
Â  Â  font-size:18px;
Â  Â  display:none;
Â  Â  z-index:1000;
Â  Â  max-width:90%;
Â  Â  min-width:100px;
Â  Â  text-align:center;
Â  Â  transition: opacity 0.5s ease-out;Â 
}

#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">MÃ¡y há»— trá»£ giá»ng nÃ³i</h1>
<div class="container" id="buttonContainer"></div>

<div id="popup"></div>

<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">â• ThÃªm cÃ¢u má»›i</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">CÃ¢u trÆ°á»›c</button>
<button class="control-btn current-btn-color" data-direction="0">PhÃ¡t láº¡i</button>
<button class="control-btn play-control-btn" data-direction="1">CÃ¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">Má»Ÿ khÃ³a giao diá»‡n</button>
</div>

<div id="settingsArea">
<button class="btn settings-btn" onclick="toggleLock(true)">KhÃ³a giao diá»‡n</button>
<button class="btn install-btn large-control-btn" id="installButton">ğŸ“² CÃ i Ä‘áº·t app</button>
<button class="btn reset-btn" onclick="resetDefaults()">â™»ï¸ Reset máº·c Ä‘á»‹nh</button>
</div>
</div>

<div id="tts-info">Náº¿u khÃ´ng tháº¥y Ã¢m thanh, táº£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>
let deferredPrompt, currentIndex = 0, defaults = ["TÃ´i muá»‘n Äƒn cÆ¡m", "TÃ´i muá»‘n uá»‘ng nÆ°á»›c", "TÃ´i muá»‘n Ä‘i vá»‡ sinh", "TÃ´i muá»‘n Ä‘i ngá»§"], installState = 'before_install';
const controlArea = document.getElementById('controlArea'),
      installButton = document.getElementById('installButton'),
      addBtnMove = document.getElementById('add-btn-move'),
      popupElement = document.getElementById('popup'),
      buttonContainer = document.getElementById('buttonContainer'),
      settingsArea = document.getElementById('settingsArea');

function speak(text, targetElement) {
    if (!text || !('speechSynthesis' in window)) return;
    speechSynthesis.cancel();
    let u = new SpeechSynthesisUtterance(text);
    u.lang = 'vi-VN';
    speechSynthesis.speak(u);
    showPopup(text);
}

function showPopup(text) {
    popupElement.textContent = text;
    popupElement.style.display = 'block';
    popupElement.style.opacity = '1';

    setTimeout(() => {
        popupElement.style.opacity = '0';
        setTimeout(() => popupElement.style.display = 'none', 500)
    }, 3500)
}

function addButton(v = '') {
    let c = document.createElement('div');
    c.className = 'card';
    let i = document.createElement('input');
    i.value = v;
    i.placeholder = "Nháº­p vÄƒn báº£n...";
    i.onchange = saveAll;
    let p = document.createElement('button');
    p.className = 'btn play-btn';
    p.textContent = 'ğŸ”Š PhÃ¡t Ã¢m';
    // Cáº­p nháº­t currentIndex khi nháº¥n nÃºt PhÃ¡t Ã¢m trá»±c tiáº¿p trÃªn card
    p.onclick = () => {
        const currentCards = getCards();
        const cardIndex = Array.from(buttonContainer.children).findIndex(card => card === c);
        if (cardIndex !== -1) {
            currentIndex = cardIndex;
        }
        speak(i.value.trim(), p);
    };
    let d = document.createElement('button');
    d.className = 'delete-btn';
    d.textContent = 'âŒ';
    d.onclick = () => {
        c.remove();
        saveAll();
        // Sau khi xÃ³a, Ä‘áº£m báº£o currentIndex khÃ´ng vÆ°á»£t quÃ¡ giá»›i háº¡n
        currentIndex = Math.min(currentIndex, getCards().length - 1);
        if (currentIndex < 0) currentIndex = 0; // Äáº·t láº¡i vá» 0 náº¿u khÃ´ng cÃ²n tháº» nÃ o
    };
    c.append(i, p, d);
    document.getElementById('buttonContainer').appendChild(c);
    saveAll()
}

function saveAll() { localStorage.setItem('voiceButtons', JSON.stringify([...document.querySelectorAll('.card input')].map(i => i.value.trim()))) }
function loadButtons() { let s = JSON.parse(localStorage.getItem('voiceButtons') || "[]"); (s.length ? s : defaults).forEach(t => addButton(t)); currentIndex = 0 }
function resetDefaults() { if (confirm("Äáº·t láº¡i máº·c Ä‘á»‹nh?")) { localStorage.removeItem('voiceButtons'); document.getElementById('buttonContainer').innerHTML = ''; loadButtons(); currentIndex = 0 } }
function getCards() { return document.querySelectorAll('.card input') }
function cleanupEmptyCards() {
    let c = document.querySelectorAll('.card'), save = false;
    for (let i = c.length - 1; i >= 0; i--) {
        let inp = c[i].querySelector('input');
        if (!inp || inp.value.trim() === '') {
            c[i].remove();
            save = true;
        }
    }
    if (save) {
        saveAll();
        // Cáº­p nháº­t láº¡i currentIndex sau khi dá»n dáº¹p
        currentIndex = Math.min(currentIndex, getCards().length - 1);
        if (currentIndex < 0) currentIndex = 0;
    }
    return save;
}


/**
 * @param {number} dir - HÆ°á»›ng di chuyá»ƒn: -1 (CÃ¢u trÆ°á»›c), 0 (PhÃ¡t láº¡i), 1 (CÃ¢u sau)
 */
function moveSpeak(dir) {
    cleanupEmptyCards();
    const c = getCards();
    if (c.length === 0) {
        currentIndex = 0;
        return;
    }

    if (dir === 0) {
        // PhÃ¡t láº¡i cÃ¢u hiá»‡n táº¡i, Ä‘áº£m báº£o currentIndex khÃ´ng vÆ°á»£t quÃ¡ giá»›i háº¡n
        currentIndex = Math.min(currentIndex, c.length - 1);
        speak(c[currentIndex].value.trim());
    } else {
        // Di chuyá»ƒn vÃ  phÃ¡t
        let nextIndex = currentIndex + dir;

        // Xá»­ lÃ½ vÃ²ng láº·p (Looping):
        if (nextIndex < 0) {
            nextIndex = c.length - 1; // CÃ¢u trÆ°á»›c tá»« cÃ¢u Ä‘áº§u tiÃªn -> cÃ¢u cuá»‘i cÃ¹ng
        } else if (nextIndex >= c.length) {
            nextIndex = 0; // CÃ¢u sau tá»« cÃ¢u cuá»‘i cÃ¹ng -> cÃ¢u Ä‘áº§u tiÃªn
        }

        currentIndex = nextIndex;
        speak(c[currentIndex].value.trim());
    }
}

function toggleLock(lock) {
    const u = document.getElementById('unlock-btn');
    if (lock) {
        buttonContainer.style.display = 'none';
        addBtnMove.style.display = 'none';
        settingsArea.style.display = 'none';

        controlArea.classList.add('locked');
        document.body.classList.add('locked');
        document.getElementById('mainTitle').classList.add('locked-h1');
        u.style.display = 'flex';
    } else {
        buttonContainer.style.display = 'grid';
        addBtnMove.style.display = 'block';
        settingsArea.style.display = 'block';

        controlArea.classList.remove('locked');
        document.body.classList.remove('locked');
        document.getElementById('mainTitle').classList.remove('locked-h1');
        u.style.display = 'none';
    }
}

// Gáº¯n sá»± kiá»‡n cho cÃ¡c nÃºt Ä‘iá»u hÆ°á»›ng (ÄÃ£ tá»‘i Æ°u hÃ³a Ä‘á»ƒ trÃ¡nh lá»—i gá»i 2 láº§n)
document.querySelectorAll('.control-btn').forEach(button => {
    // Chá»‰ sá»­ dá»¥ng 'click' event, dá»±a vÃ o CSS 'touch-action: manipulation' Ä‘á»ƒ tá»‘i Æ°u cáº£m á»©ng.
    button.addEventListener('click', function(event) {
        moveSpeak(parseInt(event.currentTarget.dataset.direction));
    });

    // ThÃªm láº¯ng nghe cho touchend Ä‘á»ƒ xá»­ lÃ½ tá»‘t hÆ¡n trÃªn má»™t sá»‘ trÃ¬nh duyá»‡t/thiáº¿t bá»‹
    // Tuy nhiÃªn cáº§n cáº©n tháº­n Ä‘á»ƒ khÃ´ng gá»i 2 láº§n. Ta sáº½ dÃ¹ng má»™t biáº¿n flag:
    let isTouch = false;
    button.addEventListener('touchstart', () => { isTouch = true; });
    button.addEventListener('touchend', (event) => {
        if (isTouch) { // Chá»‰ xá»­ lÃ½ náº¿u Ä‘Ã¢y lÃ  má»™t láº§n cháº¡m thá»±c sá»± (khÃ´ng pháº£i click chuá»™t mÃ´ phá»ng)
            moveSpeak(parseInt(event.currentTarget.dataset.direction));
            event.preventDefault(); // NgÄƒn cháº·n sá»± kiá»‡n click Ä‘Æ°á»£c gá»i sau Ä‘Ã³
            isTouch = false;
        }
    });
});

window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    if (installState === 'before_install') {
        installButton.style.display = 'flex';
        installButton.onclick = installApp;
    }
});

function installApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                installState = 'installed';
            } else {
                installState = 'rejected';
            }
            deferredPrompt = null;
            installButton.style.display = 'none';
        });
    }
}

window.addEventListener('appinstalled', () => {
    installState = 'installed';
    installButton.style.display = 'none';
});

if (installState === 'before_install') {
    installButton.style.display = 'none';
}

function warmUpTTS() {
    if (!('speechSynthesis' in window)) return;
    let u = new SpeechSynthesisUtterance(" ");
    u.lang = 'vi-VN';
    u.volume = 0;
    u.rate = 10;
    speechSynthesis.speak(u);
    setTimeout(() => speechSynthesis.cancel(), 500)
}
window.onload = () => { loadButtons(); warmUpTTS(); }
</script>
</body>
</html>
