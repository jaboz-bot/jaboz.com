let deferredPrompt;
let currentIndex = 0;
const defaults = ["Tôi muốn ăn cơm", "Tôi muốn uống nước", "Tôi muốn đi vệ sinh", "Tôi muốn đi ngủ"];
const controlArea = document.getElementById('controlArea');
const installButton = document.getElementById('installButton');
const settingsArea = document.getElementById('settingsArea');
const buttonContainer = document.getElementById('buttonContainer');
const unlockBtn = document.getElementById('unlock-btn');
const popup = document.getElementById('popup');
const navGroup = document.querySelector('.navigation-group');

// Lấy tất cả các thẻ input trong container
const getInputs = () => [...document.querySelectorAll('#buttonContainer input')];

// --- Nút phát âm ---
const speak = (text) => {
    if (!text || !('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'vi-VN';
    speechSynthesis.speak(utter);
    showPopup(text);
};

// --- Popup trượt ---
const showPopup = (text) => {
    popup.textContent = text;
    const isLocked = controlArea.classList.contains('locked');
    
    // Đặt lại vị trí ban đầu (ẩn)
    let startTransform = 'translateX(-50%) translateY(20px)';
    if (isLocked) {
        startTransform = 'translateX(-50%) translateY(30px)';
    }

    popup.style.transform = startTransform;
    popup.style.display = 'block';
    popup.style.opacity = '1';

    // Vị trí kết thúc (hiện) - Cần requestAnimationFrame để đảm bảo animation hoạt động
    requestAnimationFrame(() => {
        popup.style.transform = 'translateX(-50%) translateY(0)';
    });

    // Tự động ẩn
    setTimeout(() => {
        popup.style.opacity = '0';
        // Vị trí trượt đi
        popup.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => popup.style.display = 'none', 500);
    }, 2000);
};

// --- Quản lý dữ liệu ---
const saveAll = () => {
    const texts = getInputs().map(i => i.value.trim());
    localStorage.setItem('voiceButtons', JSON.stringify(texts));
};

const addButton = (value = '') => {
    const card = document.createElement('div');
    card.className = 'card';
    
    const input = document.createElement('input');
    input.value = value;
    input.placeholder = "Nhập văn bản...";
    input.onchange = saveAll;
    
    const play = document.createElement('button');
    play.className = 'btn play-btn';
    play.textContent = '🔊 Phát âm';
    play.onclick = () => speak(input.value.trim());
    
    const del = document.createElement('button');
    del.className = 'delete-btn';
    del.textContent = '❌';
    del.onclick = () => {
        const cards = getInputs();
        const idx = cards.indexOf(input);
        card.remove();
        saveAll();
        // Cập nhật currentIndex nếu cần
        if (currentIndex >= getInputs().length) currentIndex = getInputs().length - 1;
        if (currentIndex < 0) currentIndex = 0;
    };
    
    card.append(input, play, del);
    buttonContainer.appendChild(card);
    saveAll();
};

const loadButtons = () => {
    const saved = JSON.parse(localStorage.getItem('voiceButtons') || "[]");
    const list = saved.length ? saved : defaults;
    buttonContainer.innerHTML = '';
    list.forEach(text => addButton(text));
    currentIndex = 0;
};

const resetDefaults = () => {
    if (confirm("Bạn có muốn đặt lại về mặc định?")) {
        localStorage.removeItem('voiceButtons');
        buttonContainer.innerHTML = '';
        loadButtons();
        currentIndex = 0;
    }
};

// --- BỔ SUNG: HÀM XÓA CÁC THẺ RỖNG VÀ CẬP NHẬT TRẠNG THÁI ---
const cleanupEmptyCards = () => {
    let cards = document.querySelectorAll('.card');
    let shouldSave = false;
    
    for (let i = cards.length - 1; i >= 0; i--) {
        const input = cards[i].querySelector('input');
        if (!input || input.value.trim() === '') {
            cards[i].remove();
            shouldSave = true;
        }
    }
    
    if (shouldSave) {
        saveAll();
        const newInputs = getInputs();
        if (currentIndex >= newInputs.length) {
            currentIndex = newInputs.length > 0 ? newInputs.length - 1 : 0;
        }
    }
};

// --- 3 nút điều khiển ---
const prevSpeak = () => {
    cleanupEmptyCards();
    const inputs = getInputs();
    if (inputs.length === 0) return;
    currentIndex = (currentIndex - 1 + inputs.length) % inputs.length;
    speak(inputs[currentIndex].value.trim());
};

const nextSpeak = () => {
    cleanupEmptyCards();
    const inputs = getInputs();
    if (inputs.length === 0) return;
    currentIndex = (currentIndex + 1) % inputs.length;
    speak(inputs[currentIndex].value.trim());
};

const currentSpeak = () => {
    cleanupEmptyCards();
    const inputs = getInputs();
    if (inputs.length === 0) return;
    speak(inputs[currentIndex].value.trim());
};

// --- Khóa / Mở khóa ---
const toggleLock = (lock) => {
    if (lock) {
        settingsArea.style.display = 'none';
        buttonContainer.style.display = 'none';
        controlArea.classList.add('locked');
        unlockBtn.style.display = 'block';
    } else {
        settingsArea.style.display = 'block';
        buttonContainer.style.display = 'grid';
        controlArea.classList.remove('locked');
        // Đặt lại style vị trí mặc định của Popup khi Mở khóa (quan trọng cho CSS đã chỉnh sửa)
        popup.style.position = 'absolute';
        popup.style.top = 'auto';
        popup.style.bottom = '100%';
        unlockBtn.style.display = 'none';
    }
};

// Gắn các hàm tối ưu hóa vào window để HTML vẫn hoạt động
window.addButton = addButton;
window.resetDefaults = resetDefaults;
window.prevSpeak = prevSpeak;
window.nextSpeak = nextSpeak;
window.currentSpeak = currentSpeak;
window.toggleLock = toggleLock;

// ==========================================================
// ** PHẦN CODE PWA/TTS - Giữ nguyên logic **
// ==========================================================

// PWA: 1. Lưu lại sự kiện trước khi trình duyệt hiển thị lời nhắc cài đặt
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installButton.style.display = 'block';
    installButton.addEventListener('click', installApp);
});

// PWA: 2. Hàm kích hoạt lời nhắc cài đặt
const installApp = () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            console.log(choiceResult.outcome === 'accepted' ? 'Người dùng đã chấp nhận cài đặt.' : 'Người dùng đã từ chối cài đặt.');
            deferredPrompt = null;
            installButton.style.display = 'none';
        });
    }
};

// PWA: 3. Xử lý sau khi người dùng đã cài đặt (thường ẩn nút)
window.addEventListener('appinstalled', () => {
    installButton.style.display = 'none';
});

// TTS Warm-up
const warmUpTTS = () => {
    if (!('speechSynthesis' in window)) return;
    const utter = new SpeechSynthesisUtterance(" ");
    utter.lang = 'vi-VN';
    utter.volume = 0;
    utter.rate = 10;
    
    if (speechSynthesis.getVoices().length === 0 || speechSynthesis.speaking === false) {
        speechSynthesis.speak(utter);
        setTimeout(() => {
            speechSynthesis.cancel();
        }, 500);
    }
};

window.onload = () => {
    loadButtons();
    warmUpTTS();
};
