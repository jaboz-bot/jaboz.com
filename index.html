<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MÃ¡y há»— trá»£ giá»ng nÃ³i</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
/* Chá»‘ng ngÆ°á»i dÃ¹ng vuá»‘t mÃ n hÃ¬nh khi khÃ³a */
body.locked {
Â  Â  overflow: hidden;Â 
Â  Â  overscroll-behavior-y: contain;Â 
Â  Â  touch-action: none;
}

.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{
Â  Â  width:220px;
Â  Â  height:50px;
Â  Â  font-size:18px;
Â  Â  margin:8px auto;
Â  Â  display:flex;
Â  Â  justify-content:center;
Â  Â  align-items:center;
}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)}Â 
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
/* THAY Äá»”I: Sá»­ dá»¥ng touch-action: manipulation; Ä‘á»ƒ Æ°u tiÃªn cÃ¡c sá»± kiá»‡n nháº¥n/cháº¡m */
.control-btn{
Â  Â  width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;
Â  Â  touch-action: manipulation;Â 
}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}

/* CSS cho cháº¿ Ä‘á»™ khÃ³a */
.control-container.locked{
Â  Â  position:fixed;
Â  Â  top:0;
Â  Â  left:0;
Â  Â  width:100%;
Â  Â  height:100%;
Â  Â  overflow:hidden;
Â  Â  z-index:99;
Â  Â  background:#e3f2fd;
Â  Â  justify-content: center;Â 
}
.control-container.locked #add-btn-move,
.control-container.locked #settingsArea {
Â  Â  display: none !important;
}
.control-container.locked .navigation-group{
Â  Â  margin:0;
}
.control-container.locked #unlock-btn{
Â  Â  position:fixed;
Â  Â  bottom: 80px;Â 
Â  Â  left:50%;
Â  Â  transform:translateX(-50%);
Â  Â  display:flex;
Â  Â  z-index:100;
}

/* Cáº­p nháº­t CSS cho Popup: LuÃ´n fixed vÃ  cÄƒn giá»¯a */
#popup{
Â  Â  position: fixed;
Â  Â  top: 200px;
Â  Â  left: 50%;
Â  Â  transform: translateX(-50%);
Â  Â Â 
Â  Â  background:rgba(0,0,0,.8);
Â  Â  color:#fff;
Â  Â  padding:15px 20px;
Â  Â  border-radius:12px;
Â  Â  font-size:18px;
Â  Â  display:none;
Â  Â  z-index:1000;
Â  Â  max-width:90%;
Â  Â  min-width:100px;
Â  Â  text-align:center;
Â  Â  transition: opacity 0.5s ease-out;Â 
}

#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">MÃ¡y há»— trá»£ giá»ng nÃ³i</h1>
<div class="container" id="buttonContainer"></div>

<div id="popup"></div>

<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">â• ThÃªm cÃ¢u má»›i</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">CÃ¢u trÆ°á»›c</button>
<button class="control-btn current-btn-color" data-direction="0">PhÃ¡t láº¡i</button>
<button class="control-btn play-control-btn" data-direction="1">CÃ¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">Má»Ÿ khÃ³a giao diá»‡n</button>
</div>

<div id="settingsArea">
<button class="btn settings-btn" onclick="toggleLock(true)">KhÃ³a giao diá»‡n</button>
<button class="btn install-btn large-control-btn" id="installButton">ğŸ“² CÃ i Ä‘áº·t app</button>
<button class="btn reset-btn" onclick="resetDefaults()">â™»ï¸ Reset máº·c Ä‘á»‹nh</button>
</div>
</div>

<div id="tts-info">Náº¿u khÃ´ng tháº¥y Ã¢m thanh, táº£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>
let deferredPrompt, currentIndex = 0, defaults = ["TÃ´i muá»‘n Äƒn cÆ¡m", "TÃ´i muá»‘n uá»‘ng nÆ°á»›c", "TÃ´i muá»‘n Ä‘i vá»‡ sinh", "TÃ´i muá»‘n Ä‘i ngá»§"], installState = 'before_install';
const controlArea = document.getElementById('controlArea'),
Â  Â  Â  installButton = document.getElementById('installButton'),
Â  Â  Â  addBtnMove = document.getElementById('add-btn-move'),
Â  Â  Â  popupElement = document.getElementById('popup'),
Â  Â  Â  buttonContainer = document.getElementById('buttonContainer'),
Â  Â  Â  settingsArea = document.getElementById('settingsArea');

let isSpeaking = false; // Biáº¿n flag Ä‘á»ƒ kiá»ƒm tra xem Ä‘ang phÃ¡t hay khÃ´ng

function speak(text, targetElement) {
Â  Â  if (!text || !('speechSynthesis' in window) || isSpeaking) return; // Náº¿u Ä‘ang phÃ¡t thÃ¬ khÃ´ng lÃ m gÃ¬ cáº£

Â  Â  isSpeaking = true; // ÄÃ¡nh dáº¥u lÃ  Ä‘ang phÃ¡t

Â  Â  speechSynthesis.cancel();
Â  Â  let u = new SpeechSynthesisUtterance(text);
Â  Â  u.lang = 'vi-VN';
Â  Â  u.onend = () => {
Â  Â  Â  Â  isSpeaking = false; // Sau khi phÃ¡t xong, cho phÃ©p nháº¥n láº¡i
Â  Â  };
Â  Â  speechSynthesis.speak(u);
Â  Â  showPopup(text);
}

function showPopup(text) {
Â  Â  popupElement.textContent = text;
Â  Â  popupElement.style.display = 'block';
Â  Â  popupElement.style.opacity = '1';

Â  Â  setTimeout(() => {Â 
Â  Â  Â  Â  popupElement.style.opacity = '0';Â 
Â  Â  Â  Â  setTimeout(() => popupElement.style.display = 'none', 500);Â 
Â  Â  }, 3500);
}

function addButton(v = '') {
Â  Â  let c = document.createElement('div');
Â  Â  c.className = 'card';
Â  Â  let i = document.createElement('input');
Â  Â  i.value = v;
Â  Â  i.placeholder = "Nháº­p vÄƒn báº£n...";
Â  Â  i.onchange = saveAll;
Â  Â  let p = document.createElement('button');
Â  Â  p.className = 'btn play-btn';
Â  Â  p.textContent = 'ğŸ”Š PhÃ¡t Ã¢m';
Â  Â  p.onclick = () => speak(i.value.trim(), p);
Â  Â  let d = document.createElement('button');
Â  Â  d.className = 'delete-btn';
Â  Â  d.textContent = 'âŒ';
Â  Â  d.onclick = () => { c.remove(); saveAll(); currentIndex = Math.min(currentIndex, getCards().length - 1); };
Â  Â  c.append(i, p, d);
Â  Â  document.getElementById('buttonContainer').appendChild(c);
Â  Â  saveAll();
}

function saveAll() {
Â  Â  localStorage.setItem('voiceButtons', JSON.stringify([...document.querySelectorAll('.card input')].map(i => i.value.trim())));
}

function loadButtons() {
Â  Â  let s = JSON.parse(localStorage.getItem('voiceButtons') || "[]");
Â  Â  (s.length ? s : defaults).forEach(t => addButton(t));
Â  Â  currentIndex = 0;
}

function resetDefaults() {
Â  Â  if (confirm("Äáº·t láº¡i máº·c Ä‘á»‹nh?")) {
Â  Â  Â  Â  localStorage.removeItem('voiceButtons');
Â  Â  Â  Â  document.getElementById('buttonContainer').innerHTML = '';
Â  Â  Â  Â  loadButtons();
Â  Â  Â  Â  currentIndex = 0;
Â  Â  }
}

function getCards() {
Â  Â  return document.querySelectorAll('.card input');
}

function cleanupEmptyCards() {
Â  Â  let c = document.querySelectorAll('.card'), save = false;
Â  Â  for (let i = c.length - 1; i >= 0; i--) {
Â  Â  Â  Â  let inputElement = c[i].querySelector('input'); 
Â  Â  Â  Â  if (!inputElement || inputElement.value.trim() === '') {
Â  Â  Â  Â  Â  Â  c[i].remove();
Â  Â  Â  Â  Â  Â  save = true;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if (save) {
Â  Â  Â  Â  saveAll();
Â  Â  Â  Â  currentIndex = Math.min(currentIndex, getCards().length - 1);
Â  Â  }
}

function moveSpeak(dir) {
Â  Â  cleanupEmptyCards();
Â  Â  const c = getCards();
Â  Â  if (c.length === 0) {
        showPopup("KhÃ´ng cÃ³ cÃ¢u Ä‘á»ƒ phÃ¡t!");
        return;
    }

Â  Â  if (dir === 0) {
Â  Â  Â  Â  speak(c[currentIndex].value.trim());
Â  Â  } else {
Â  Â  Â  Â  currentIndex = (currentIndex + dir + c.length) % c.length;
Â  Â  Â  Â  speak(c[currentIndex].value.trim());
Â  Â  }
}

function toggleLock(lock) {
Â  Â  const u = document.getElementById('unlock-btn');
Â  Â  if (lock) {
Â  Â  Â  Â  buttonContainer.style.display = 'none';
Â  Â  Â  Â  addBtnMove.style.display = 'none';
Â  Â  Â  Â  settingsArea.style.display = 'none';

Â  Â  Â  Â  controlArea.classList.add('locked');
Â  Â  Â  Â  document.body.classList.add('locked');
Â  Â  Â  Â  document.getElementById('mainTitle').classList.add('locked-h1');
Â  Â  Â  Â  u.style.display = 'flex';
Â  Â  } else {
Â  Â  Â  Â  buttonContainer.style.display = 'grid';
Â  Â  Â  Â  addBtnMove.style.display = 'block';
Â  Â  Â  Â  settingsArea.style.display = 'block';

Â  Â  Â  Â  controlArea.classList.remove('locked');
Â  Â  Â  Â  document.body.classList.remove('locked');
Â  Â  Â  Â  document.getElementById('mainTitle').classList.remove('locked-h1');
Â  Â  Â  Â  u.style.display = 'none';
Â  Â  }
}

window.addEventListener('beforeinstallprompt', e => {
Â  Â  e.preventDefault();
Â  Â  deferredPrompt = e;
Â  Â  if (installState === 'before_install') {
Â  Â  Â  Â  installButton.style.display = 'flex';
Â  Â  Â  Â  installButton.onclick = installApp;
Â  Â  }
});

function installApp() {
Â  Â  if (deferredPrompt) {
Â  Â  Â  Â  deferredPrompt.prompt();
Â  Â  Â  Â  deferredPrompt.userChoice.then((choiceResult) => {
Â  Â  Â  Â  Â  Â  if (choiceResult.outcome === 'accepted') {
Â  Â  Â  Â  Â  Â  Â  Â  installState = 'installed';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  installState = 'rejected';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  deferredPrompt = null;
Â  Â  Â  Â  Â  Â  installButton.style.display = 'none';
Â  Â  Â  Â  });
Â  Â  }
}

window.addEventListener('appinstalled', () => {
Â  Â  installState = 'installed';
Â  Â  installButton.style.display = 'none';
});

if (installState === 'before_install') {
Â  Â  installButton.style.display = 'none';
}

function warmUpTTS() {
Â  Â  if (!('speechSynthesis' in window)) return;
Â  Â  let u = new SpeechSynthesisUtterance(" ");
Â  Â  u.lang = 'vi-VN';
Â  Â  u.volume = 0;
Â  Â  u.rate = 10;
Â  Â  speechSynthesis.speak(u);
Â  Â  setTimeout(() => speechSynthesis.cancel(), 500);
}

window.onload = () => {
Â  Â  loadButtons();
Â  Â  warmUpTTS();
    // Báº®T Äáº¦U PHáº¦N Sá»¬A Lá»–I
    document.querySelectorAll('.navigation-group .control-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Láº¥y giÃ¡ trá»‹ 'data-direction' vÃ  chuyá»ƒn sang sá»‘ nguyÃªn
            const direction = parseInt(this.getAttribute('data-direction'));
            moveSpeak(direction); // Gá»i hÃ m moveSpeak vá»›i hÆ°á»›ng tÆ°Æ¡ng á»©ng
        });
    });
    // Káº¾T THÃšC PHáº¦N Sá»¬A Lá»–I
};
</script>
</body>
</html>
