<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Máy hỗ trợ giọng nói</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
/* Chống người dùng vuốt màn hình khi khóa */
body.locked {
    overflow: hidden; 
    overscroll-behavior-y: contain; 
    touch-action: none;
}

.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
/* Thẻ .card có position: relative là bắt buộc để .suggestion-box hoạt động đúng */
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{
    width:220px;
    height:50px;
    font-size:18px;
    margin:8px auto;
    display:flex;
    justify-content:center;
    align-items:center;
}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)} 
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
/* THAY ĐỔI: Sử dụng touch-action: manipulation; để ưu tiên các sự kiện nhấn/chạm */
.control-btn{
    width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;
    touch-action: manipulation; 
}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}

/* CSS cho chế độ khóa */
.control-container.locked{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    overflow:hidden;
    z-index:99;
    background:#e3f2fd;
    justify-content: center; 
}
.control-container.locked #add-btn-move,
.control-container.locked #settingsArea {
    display: none !important;
}
.control-container.locked .navigation-group{
    margin:0;
}
.control-container.locked #unlock-btn{
    position:fixed;
    bottom: 80px; 
    left:50%;
    transform:translateX(-50%);
    display:flex;
    z-index:100;
}

/* Cập nhật CSS cho Popup: Luôn fixed và căn giữa */
#popup{
    position: fixed;
    top: 200px;
    left: 50%;
    transform: translateX(-50%);
    
    background:rgba(0,0,0,.8);
    color:#fff;
    padding:15px 20px;
    border-radius:12px;
    font-size:18px;
    display:none;
    z-index:1000;
    max-width:90%;
    min-width:100px;
    text-align:center;
    transition: opacity 0.5s ease-out; 
}

/* BỔ SUNG CSS CHO HỘP GỢI Ý TÙY CHỈNH (SỔ LÊN ĐỂ KHÔNG BỊ BÀN PHÍM CHE) */
.suggestion-box {
    position: absolute;
    bottom: calc(100% - 10px); /* Đặt ngay BÊN TRÊN input */
    left: 0;
    right: 0;
    z-index: 1001; /* Đảm bảo hiển thị trên mọi thứ */
    background: #fff;
    border: 1px solid #ddd;
    border-bottom: none; /* Xóa viền dưới */
    border-radius: 8px 8px 0 0; /* Bo góc trên */
    box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1); /* Đổ bóng lên trên */
    max-height: 150px;
    overflow-y: auto;
    text-align: left;
    display: flex; /* Bắt đầu Flexbox */
    flex-direction: column-reverse; /* Lật thứ tự để gợi ý mới hiện gần input */
}
.suggestion-item {
    padding: 10px;
    cursor: pointer;
    font-size: 16px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}
.suggestion-item:last-child {
    border-bottom: none;
}
.suggestion-item:hover {
    background-color: #f0f0f0;
}
/* KẾT THÚC BỔ SUNG CSS */


#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:1px solid #ccc;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}
</style>
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">Máy hỗ trợ giọng nói</h1>
<div class="container" id="buttonContainer"></div>

<div id="popup"></div>

<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">➕ Thêm câu mới</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">Câu trước</button>
<button class="control-btn current-btn-color" data-direction="0">Phát lại</button>
<button class="control-btn play-control-btn" data-direction="1">Câu sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">Mở khóa giao diện</button>
</div>

<div id="settingsArea">
<button class="btn settings-btn" onclick="toggleLock(true)">Khóa giao diện</button>
<button class="btn install-btn large-control-btn" id="installButton">📲 Cài đặt app</button>
<button class="btn reset-btn" onclick="resetDefaults()">♻️ Reset mặc định</button>
</div>
</div>

<div id="tts-info">Nếu không thấy âm thanh, tải <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Google Play</a></div>

<script>
// BẮT ĐẦU PHẦN BỔ SUNG VÀ SỬA ĐỔI (ĐÃ NHÚNG DỮ LIỆU GỢI Ý ĐỂ KHẮC PHỤC LỖI TRÊN ĐIỆN THOẠ)

// *** Dán nội dung file goi-y-tu.json vào đây ***
let wordSuggestions = [
    "a", "à", "á", "án", "áp", "áy", "ấy", "ăn", "âm", "ầm",
    "ẩn", "ảnh", "ắt", "ách", "ặt", "ắc", "ạ", "át", "áo", "ấp",
    "âu", "ai", "am", "an", "ao", "au", "ax", "ay", "á", "ác",
    "áng", "ái", "ảm", "ám", "ạn", "ạo", "ạp", "ạt", "ắc", "ắm",
    "ẳm", "ằn", "ăng", "ắng", "ắn", "ắp", "ật", "ẫm", "ậm", "ất",
    "ấc", "ấn", "ận", "ần", "ất", "ấc", "ấn", "ần", "ắt", "ắp",
    "ân", "ẩn", "ật", "ẫm", "ậm", "ấn", "ần", "ất", "ấc", "ận",
    "ần", "ắt", "ắp", "ấn", "ân", "ật", "ẫm", "ậm", "ất", "ấc",
    "ấn", "ần", "ắt", "ắp", "ân", "ấn", "ần", "ất", "ấc", "ân",
    "ấn", "ần", "ật", "ẫm", "ậm", "ất", "ấc", "ấn", "ần", "ắt",
    "ba", "bà", "bác", "bán", "bánh", "bạn", "bật", "bảo", "bế", "bên",
    "bếp", "bị", "biết", "bình", "bố", "buồn", "bún", "bẩn", "bóng", "bụng",
    "bước", "bụi", "bưng", "bút", "bỏ", "bớt", "bới", "bảy", "bấm", "bẫy",
    "bận", "bật", "bẩn", "bắp", "bắp", "bếp", "bến", "bèo", "bêu", "bếu",
    "bẽ", "bẻ", "bỉ", "bịt", "bì", "bò", "bớt", "bới", "bơ", "bờ",
    "bứa", "bức", "búp", "bột", "bộ", "bồng", "bỗng", "bóng", "bãi", "bảng",
    "bành", "bàng", "báng", "bạn", "bảo", "báo", "bán", "bạc", "bát", "bất",
    "bắn", "bắt", "bất", "bần", "bận", "bận", "bảo", "báo", "bán", "bạc",
    "bát", "bật", "bán", "bạc", "bát", "bất",
    "ca", "cá", "cà", "cả", "cảm", "can", "canh", "cao", "cáp",
    "cát", "cắt", "cầu", "câu", "cầm", "cân", "cặp", "cấp", "cập",
    "cật", "cận", "cả", "cảm", "cần", "cẩn", "cận", "câm", "cũng",
    "cùng", "cung", "cung", "cục", "cúc", "của", "củi", "cũ", "cú",
    "cúp", "cười", "cưới", "cưới", "cửa", "cương", "cương", "cước",
    "cương", "cương", "cước", "cười", "của", "củi", "cụ", "cục", "cực",
    "cứ", "cứu", "cứt", "cơ", "cờ", "cọ", "cóp", "cót", "cọc", "cỏ",
    "cối", "công", "cổng", "cộng", "cỡ", "chà", "chắc", "chắn", "chắc",
    "chắn", "chặt", "chận", "chật", "châm", "chấm", "chặn", "chắp", "chất",
    "da", "dạ", "dán", "dành", "danh", "dao", "dạo", "dạng", "dán", "dạt",
    "dậy", "dài", "dày", "dẫn", "dần", "dặn", "dặn dò", "dấm", "dần", "dân",
    "dép", "dịch", "dịp", "dị", "dĩa", "dĩ", "dĩ nhiên", "dĩ vãng",
    "dính", "dòng", "dõi", "dỗi", "dối", "dở", "dọn", "dọn", "dễ",
    "dũng", "dưới", "dùng", "dựa", "dữ", "dữ dằn", "dứt",
    "đá", "đau", "đến", "đi", "đóng", "đối", "đón", "đưa", "được", "đứng",
    "đòi", "đó", "đôi", "đỏ", "độ", "đồn", "đợi", "đói", "đơn",
    "đông", "đọng", "đổi", "đối", "đứa", "đục", "đủ", "đun", "đúng", "đúp",
    "đứt", "đừng", "đường", "đáng", "đạp", "đặt", "đắp", "đạt", "đất",
    "đã", "đăng", "đáng", "đáp", "đạt", "đắt", "đắc", "đặc", "đắn", "đẵn",
    "đấm", "đẫm", "đậm", "đầy", "đây", "để", "đến", "đèn", "đền",
    "đẻ", "đẽo", "đĩa", "đĩ", "định", "đinh", "đôi", "đồi", "đòi",
    "đợi", "đói", "đón", "độ", "đồ", "đội", "đời",
    "e", "è", "é", "ẻ", "ẽ", "ẹ", "em", "én", "eo", "ép",
    "ét", "em", "en",
    "ê", "ề", "ế", "ể", "ễ", "ệ", "êm", "ên", "ếp", "ết",
    "ếch",
    "ga", "gà", "gác", "gái", "gần", "gấm", "gắp", "gậy", "ghen",
    "giao", "già", "giác", "giãy", "giận", "giặt", "giấy", "giếng",
    "giữ", "giúp", "giường", "giả", "giảm", "gián", "giáp", "giật",
    "góp", "gỡ", "gỗ", "gối", "gọng", "gọi", "gửi", "gối", "gừng",
    "gãy", "ghét", "ghế", "ghì", "ghìm", "ghim", "gói", "gót", "gọi",
    "gần", "gấp", "gắm", "găng", "gắng", "gãy", "gầy", "ghen",
    "gốc", "gối", "gân", "gạn", "gạt", "gặt", "găm",
    "gầm", "gần",
    "ha", "hà", "hạc", "hái", "hăm", "hàn", "hàng", "hát", "hầu", "hãy",
    "hai", "hàng", "hạnh", "hẹn", "hết", "hi", "hiện", "hiếu", "họ",
    "hồ", "hộp", "hợp", "hốt", "hứa", "hùm", "hùng", "hút", "hư", "hữu",
    "hay", "hẹp", "hèn", "hề", "hè", "héo", "hễ", "hít", "hòn", "hợp",
    "hớp", "hở", "hổ", "hỗ", "hối", "hỏi", "hốt", "hột",
    "hoa", "hoà", "hoạc", "hoán", "hoạt", "hóa", "hoặc", "hoàng", "hoang",
    "hoài", "hoãi", "hoãn", "hoạn",
    "học", "hóc", "hồn", "hổng", "hồng", "hơn", "hớp", "họa",
    "i", "ì", "í", "ỉ", "ĩ", "ị", "ia", "ích", "ít", "in", "im", "ím",
    "kẻ", "kém", "kéo", "kẹp", "kê", "kệ", "kí", "kì", "kíp", "kít",
    "kiếm", "kĩ", "kiêng", "kiện", "kín", "kính", "kỳ", "ký", "kỹ", "kèo",
    "kết", "kèn", "kéo", "kẹp", "kẽ", "kẹo", "két", "kêu",
    "kể", "kén",
    "kìm", "kín", "kình", "kịp", "kính", "kỷ",
    "la", "là", "lác", "lái", "lắm", "làm", "lan", "láng", "lão",
    "lấy", "lần", "lại", "lên", "lệ", "lẽ", "lép", "lẻ",
    "lêu",
    "li", "lì", "lịch", "liếc",
    "lo", "lò", "lòng", "lọc", "lóc", "lớn", "lớp",
    "lưới", "lửa", "lủi", "lùi", "lùng", "lúng", "luộc", "luôn", "luột", "luật",
    "lưu",
    "ma", "mà", "mác", "mái", "măm", "màn", "mang", "mát", "mau", "may",
    "mày", "mã", "mãnh", "mạnh", "mắn", "mật", "mặt", "mầm", "mặn", "mất",
    "mắc", "mâm", "mắng", "mặc", "mẹ", "méo", "mẻ", "mép", "mệt",
    "mèo", "mẹo", "mêu",
    "mía", "mì", "mít", "mịt",
    "mo", "mò", "móc", "mốc", "mỏ", "mỏi", "mọi", "mới", "mỏng",
    "mộng", "mốt", "mở", "mũ", "mục",
    "muối", "muộn", "muôn", "muốn", "mua",
    "mừng", "mức", "mực", "mười",
    "na", "nà", "nác", "nái", "năm", "nan", "nang", "nàng", "náo", "nát",
    "nau", "nay", "này", "năng", "nặng", "nắn", "nắp", "nắt", "nắng", "nếu",
    "nén", "nền", "nếp", "nét", "nêu", "nửa", "nữa", "nữ",
    "nhiều", "nhà", "nhìn", "nhỏ", "nhớ",
    "no", "nò", "nói", "nón", "nót",
    "nước",
    "non",
    "nợ",
    "nên",
    "o", "ò", "ó", "ỏ", "õ", "ọ", "oan", "oán", "oát", "oách",
    "oai", "oải", "oa", "oà", "oá", "oã", "oạ", "oen", "oeo",
    "ô", "ồ", "ố", "ổ", "ỗ", "ộ", "ôm", "ôn", "ốp", "ốt",
    "ông", "ốc", "ổn", "ồn", "ốm",
    "ơ", "ờ", "ớ", "ở", "ỡ", "ợ", "ơn", "ơi", "ớt", "ớn",
    "ơm",
    "pha", "phá", "phải", "phân", "phẳng", "phát", "phẩm", "phận", "phần", "phong",
    "phỏng", "phòng", "phông", "phút", "phục", "phù",
    "qua", "quá", "quán", "quang", "quát", "quân", "quận", "quần",
    "ra", "rá", "rác", "rái", "răm", "ranh", "rao", "ráp", "rát", "rau",
    "rày", "rào", "rắc", "rặn", "rằng", "rắn", "rắp", "rắt", "râu", "rây",
    "rẽ", "rẻ", "rèn", "rêu", "rê",
    "rì", "rỉ", "rít", "rình", "rỏ",
    "róc", "rồi", "rông", "rộng", "rớt", "rút",
    "rửa", "rữa", "rực", "rừng", "rụng",
    "sa", "sà", "sác", "sái", "sắm", "san", "sang", "sáng", "sao", "sát",
    "sau", "say", "sắc", "sẵn", "sắn", "sáp",
    "sắt", "sắp",
    "sẽ", "sẻ", "sếp", "sệt",
    "sêu", "si", "sĩ", "sỉ",
    "so", "sò", "sóc", "sót", "sọt",
    "sơn", "sở",
    "sút", "suy", "sự",
    "ta", "tà", "tác", "tại", "tắm", "tan", "tang", "tán", "tát",
    "tay", "tây", "tác", "tân", "tầng", "tận", "tập", "tâm", "tấm", "tầm",
    "tắt", "tăng", "tấn", "tăm",
    "te", "tè", "tép", "tẻ", "tên",
    "thưa", "thứ", "thua", "thùng",
    "thương", "thư",
    "tôi", "tới", "tối", "tốn", "tóc",
    "trà", "trả",
    "trăm", "trắng",
    "u", "ù", "ú", "ủ", "ũ", "ụ", "uý", "uỷ", "uất", "uấn",
    "uật", "uân", "uống", "uốn", "ui", "uôn", "uýt", "úi",
    "ư", "ừ", "ứ", "ử", "ữ", "ự", "ưa", "ức", "ướt", "ươm",
    "ươn", "ươc", "ươt", "ươt", "ươn", "ươn", "ươn", "ươt", "ươt", "ươn",
    "ươt", "ươn", "ươc", "ươt", "ươn", "ươt", "ươn", "ươt", "ươt", "ươn",
    "ươc", "ươt", "ươn", "ươt", "ươn", "ươt", "ươt", "ươn", "ươc", "ươt",
    "ươn", "ươt", "ươn", "ươt", "ươt", "ươn", "ươc", "ươt", "ươn", "ươt",
    "ươn", "ươt", "ươt", "ươn", "ươc", "ươt", "ươn", "ươt", "ươn", "ươt",
    "ươt", "ươn", "ươc", "ươt", "ươn", "ươt", "ươn", "ươt", "ươt", "ươn",
    "ươc", "ươt", "ươn", "ươt", "ươn", "ươt", "ươt", "ươn", "ươc", "ươt",
    "ương", "ứng",
    "va", "và", "vác", "vái", "văn", "vang", "vào",
    "vất", "vặt",
    "vậy", "vây", "về", "vẽ",
    "vì", "vị",
    "vô",
    "vòng",
    "vọng",
    "với",
    "vui",
    "vùng",
    "xa", "xà", "xác", "xách", "xanh", "xan", "xang", "xáng", "xao", "xát",
    "xây", "xảy", "xã",
    "xăm",
    "xếp",
    "xem",
    "xí",
    "xóa",
    "xông",
    "xưa",
    "y", "ý", "ỷ", "yên", "yêu", "yếu",
    "yết", "yếm", "yểm"
];
// **********************************************


// HÀM SỬA ĐỔI: Sử dụng startsWith() để ưu tiên các từ/cụm từ bắt đầu bằng đầu vào
function showSuggestions(inputElement, boxElement) {
    const inputText = inputElement.value.trim().toLowerCase();
    boxElement.innerHTML = '';
    
    // Nếu display đang là 'flex', chuyển sang 'none' nếu không có input
    if (inputText.length === 0) {
        boxElement.style.display = 'none';
        return;
    }

    // Dùng startsWith() để tìm các từ bắt đầu chính xác bằng input
    const filteredSuggestions = wordSuggestions
        .filter(phrase => phrase.toLowerCase().startsWith(inputText))
        .slice(0, 4); // CHỈ GIỚI HẠN 4 GỢI Ý ĐẦU TIÊN
        
    if (filteredSuggestions.length > 0) {
        filteredSuggestions.forEach(phrase => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = phrase;
            
            // Xử lý khi click vào mục gợi ý (dùng mousedown để ngăn input blur ngay lập tức)
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                
                let fullText = inputElement.value;
                const lastSpaceIndex = fullText.lastIndexOf(' ');
                
                if (lastSpaceIndex !== -1) {
                    // Thay thế từ đang gõ bằng từ gợi ý (thêm khoảng trắng nếu cần)
                    inputElement.value = fullText.substring(0, lastSpaceIndex + 1) + phrase + (phrase.endsWith(' ') ? '' : ' ');
                } else {
                    // Nếu là từ đầu tiên, thay thế toàn bộ
                    inputElement.value = phrase + (phrase.endsWith(' ') ? '' : ' ');
                }
                
                boxElement.style.display = 'none';
                saveAll(); 
                inputElement.focus();
            });

            boxElement.appendChild(item);
        });
        // Đặt display thành 'flex' khi có gợi ý (để CSS column-reverse hoạt động)
        boxElement.style.display = 'flex';
    } else {
        boxElement.style.display = 'none';
    }
}
// KẾT THÚC PHẦN BỔ SUNG

let deferredPrompt,currentIndex=0,defaults=["Tôi muốn ăn cơm","Tôi muốn uống nước","Tôi muốn đi vệ sinh","Tôi muốn đi ngủ"],installState = 'before_install';
const controlArea=document.getElementById('controlArea'),
      installButton=document.getElementById('installButton'),
      addBtnMove=document.getElementById('add-btn-move'),
      popupElement=document.getElementById('popup'),
      buttonContainer=document.getElementById('buttonContainer'),
      settingsArea=document.getElementById('settingsArea');

function speak(text, targetElement){
    if(!text||!('speechSynthesis'in window))return;
    speechSynthesis.cancel();
    let u=new SpeechSynthesisUtterance(text);
    u.lang='vi-VN';
    speechSynthesis.speak(u);
    showPopup(text); 
}

function showPopup(text){
    popupElement.textContent=text;
    popupElement.style.display='block';
    popupElement.style.opacity='1';

    setTimeout(()=>{ 
        popupElement.style.opacity='0'; 
        setTimeout(()=>popupElement.style.display='none', 500) 
    },3500) 
}

function getCards(){return document.querySelectorAll('.card input')}

// Hàm này đảm bảo currentIndex luôn trỏ đến một vị trí hợp lệ
function updateCurrentIndexAfterChange() {
    const c = getCards();
    currentIndex = Math.min(currentIndex, c.length - 1);
    if (currentIndex < 0) currentIndex = 0;
}

// HÀM SỬA ĐỔI: Thêm suggestion-box và sự kiện input/blur
function addButton(v=''){
    let c=document.createElement('div');
    c.className='card';
    
    // INPUT BỔ SUNG: Thêm sự kiện và tạo suggestion-box
    let i=document.createElement('input');
    i.value=v;
    i.placeholder="Nhập văn bản...";
    i.onchange=saveAll;
    
    let sBox = document.createElement('div'); // Hộp gợi ý
    sBox.className = 'suggestion-box';

    // Gắn sự kiện khi gõ
    i.addEventListener('input', (e) => showSuggestions(e.target, sBox));
    
    // Ẩn hộp gợi ý khi mất focus (dùng setTimeout để cho phép click vào gợi ý)
    i.addEventListener('blur', () => {
        setTimeout(() => sBox.style.display = 'none', 150);
    });
    // KẾT THÚC SỬA ĐỔI INPUT
    
    let p=document.createElement('button');
    p.className='btn play-btn';
    p.textContent='🔊 Phát âm';
    p.onclick=()=>speak(i.value.trim(), p); 
    let d=document.createElement('button');
    d.className='delete-btn';
    d.textContent='❌';
    d.onclick=()=>{
        c.remove();
        saveAll();
        updateCurrentIndexAfterChange(); // Cập nhật sau khi xóa
    };
    // Đính kèm suggestion box vào card
    c.append(i, sBox, p, d); 
    document.getElementById('buttonContainer').appendChild(c);
    saveAll();
    // Đặt currentIndex vào thẻ mới (thẻ cuối cùng)
    currentIndex = getCards().length - 1; 
}

function saveAll(){localStorage.setItem('voiceButtons',JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim())))}
function loadButtons(){let s=JSON.parse(localStorage.getItem('voiceButtons')||"[]");(s.length?s:defaults).forEach(t=>addButton(t));currentIndex=0; cleanupEmptyCards();}
function resetDefaults(){if(confirm("Đặt lại mặc định?")){localStorage.removeItem('voiceButtons');document.getElementById('buttonContainer').innerHTML='';loadButtons();currentIndex=0;}}

function cleanupEmptyCards(){
    let c=document.querySelectorAll('.card'),save=false;
    for(let i=c.length-1;i>=0;i--){
        let inp=c[i].querySelector('input');
        // Chỉ xóa thẻ nếu nó hoàn toàn trống
        if(!inp||inp.value.trim()===''){
            c[i].remove();
            save=true;
        }
    }
    if(save){
        saveAll();
        updateCurrentIndexAfterChange();
    }
}

function moveSpeak(dir){
    const c=getCards();
    if(c.length===0)return;
    
    if(dir===0){
        // Phát lại câu hiện tại, kiểm tra trống
        const text = c[currentIndex].value.trim();
        if (text) {
            speak(text);
        } else {
            showPopup("Câu trống! Vui lòng sửa hoặc xóa.");
        }
    } else {
        // Di chuyển câu trước/sau
        currentIndex=(currentIndex+dir+c.length)%c.length;
        
        // Vòng lặp tìm câu không trống (để tránh lặp vô tận nếu TẤT CẢ trống)
        let count = 0;
        while(c[currentIndex].value.trim() === '' && count < c.length) {
            currentIndex=(currentIndex+dir+c.length)%c.length;
            count++;
        }
        
        // Nếu tìm thấy câu để đọc
        const text = c[currentIndex].value.trim();
        if (text) {
            speak(text);
        } else {
             // Chỉ xảy ra nếu tất cả các câu đều trống
            showPopup("Không có câu nào để đọc.");
        }
    }
}

function toggleLock(lock){
    const u=document.getElementById('unlock-btn');
    // Khi thoát khỏi chế độ khóa, dọn dẹp thẻ trống
    if (!lock) {
        cleanupEmptyCards();
    }
    
    if(lock){
        buttonContainer.style.display='none';
        addBtnMove.style.display='none';
        settingsArea.style.display='none';
        
        controlArea.classList.add('locked');
        document.body.classList.add('locked');
        document.getElementById('mainTitle').classList.add('locked-h1');
        u.style.display='flex';
    } else {
        buttonContainer.style.display='grid';
        addBtnMove.style.display='block';
        settingsArea.style.display='block';
        
        controlArea.classList.remove('locked');
        document.body.classList.remove('locked');
        document.getElementById('mainTitle').classList.remove('locked-h1');
        u.style.display='none';
    }
}

// Gắn sự kiện cho các nút điều hướng
document.querySelectorAll('.control-btn').forEach(button => {
    // Giữ cả click và touchend để tối ưu phản hồi trên di động
    ['click', 'touchend'].forEach(event => {
        button.addEventListener(event, function(e) {
            // Ngăn chặn sự kiện chạm kích hoạt click hai lần
            e.preventDefault(); 
            // Dùng currentTarget để lấy data-direction của nút
            moveSpeak(parseInt(e.currentTarget.dataset.direction)); 
        }, { passive: false });
    });
});

window.addEventListener('beforeinstallprompt',e=>{ 
    e.preventDefault(); 
    deferredPrompt=e; 
    if (installState === 'before_install') {
        installButton.style.display='flex';
        installButton.onclick=installApp;
    }
});

function installApp(){
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult)=>{
            if (choiceResult.outcome === 'accepted') {
                installState = 'installed';
            } else {
                installState = 'rejected';
            }
            deferredPrompt=null;
            installButton.style.display='none';
        });
    }
}

window.addEventListener('appinstalled',()=>{ 
    installState = 'installed'; 
    installButton.style.display='none'; 
});

if (installState === 'before_install') { 
    installButton.style.display='none'; 
}

function warmUpTTS(){
    if(!('speechSynthesis'in window))return;
    let u=new SpeechSynthesisUtterance(" ");
    u.lang='vi-VN';
    u.volume=0;
    u.rate=10;
    speechSynthesis.speak(u);
    setTimeout(()=>speechSynthesis.cancel(),500)
}
// SỬA ĐỔI: Không cần loadSuggestions() nữa vì dữ liệu đã được nhúng
window.onload=()=>{loadButtons();warmUpTTS();} 
</script>

</body>
</html>
