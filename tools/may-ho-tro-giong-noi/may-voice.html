<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MÃ¡y há»— trá»£ giá»ng nÃ³i</title>
<link rel="manifest" href="may-voice.json"> 
<style>
body{font-family:'Segoe UI',sans-serif;background:#e3f2fd;margin:0;padding:0 0 55px;text-align:center}
body.locked{overflow:hidden;overscroll-behavior-y:contain;touch-action:none}
.main-wrapper{max-width:700px;margin:0 auto;padding:20px 10px}
h1{margin-bottom:20px}
.locked-h1{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:100%;max-width:700px;margin:0;padding:0 10px;z-index:1000;color:#333;background:#e3f2fd}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:20px}
.card{background:#fff;padding:12px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px;position:relative;box-sizing:border-box}
input{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:100%;box-sizing:border-box}
.btn{padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center}
.play-btn{background:linear-gradient(45deg,#4CAF50,#43A047);width:100%;box-sizing:border-box}
.add-btn,.install-btn{width:200px}
.reset-btn,.settings-btn,.install-btn.large-control-btn{width:220px;height:50px;font-size:18px;margin:8px auto;display:flex;justify-content:center;align-items:center}
.install-btn{background:linear-gradient(45deg,#00BCD4,#0097A7)}
.add-btn,.reset-btn{background:linear-gradient(45deg,#2196F3,#1976D2)}
.settings-btn{background:linear-gradient(45deg,#f44336,#d32f2f)}
.delete-btn{position:absolute;top:6px;right:8px;background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:0}
#unlock-btn{width:160px;height:60px;display:none;background:linear-gradient(45deg,#f44336,#d32f2f)}
.control-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:20px;transition:.3s;position:relative}
.navigation-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin:25px 0 0}
.control-btn{width:150px;height:60px;border-radius:8px;color:white;font-size:18px;border:none;cursor:pointer;transition:.3s;font-weight:bold;display:flex;justify-content:center;align-items:center;touch-action:manipulation}
.play-control-btn{background:linear-gradient(45deg,#4CAF50,#43A047)}
.current-btn-color{background:#ff9800}
#settingsArea{margin-top:30px;text-align:center}
.control-container.locked{position:fixed;top:0;left:0;width:100%;height:100%;overflow:hidden;z-index:99;background:#e3f2fd;justify-content:center}
.control-container.locked #add-btn-move,#controlArea #settingsArea{display:none!important}
.control-container.locked .navigation-group{margin:0}
.control-container.locked #unlock-btn{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);display:flex;z-index:100}
#popup{position:fixed;top:200px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:15px 20px;border-radius:12px;font-size:18px;display:none;z-index:1000;max-width:90%;min-width:100px;text-align:center;transition:opacity .5s}
.suggestion-box{position:absolute;bottom:calc(100% - 10px);left:0;right:0;z-index:10;background:#fff;border:1px solid #ddd;border-bottom:none;border-radius:8px 8px 0 0;box-shadow:0 -4px 6px rgba(0,0,0,0.1);max-height:150px;overflow-y:auto;text-align:left;display:none}
.suggestion-box.align-bottom{bottom:auto;top:calc(100% - 10px);border-top:none;border-bottom:1px solid #ddd;border-radius:0 0 8px 8px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
.suggestion-item{padding:10px;cursor:pointer;font-size:16px;border-bottom:1px solid #eee;transition:background-color .2s}
.suggestion-item:last-child{border-bottom:none}
.suggestion-item:hover{background-color:#f0f0f0}
#tts-info{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:700px;text-align:center;padding:10px;border-top:none;color:#616161;background:#e3f2fd;font-size:14px;z-index:1010}
#tts-info a{color:#2196F3;text-decoration:none}

/* CSS Má»šI Äá»‚ Táº O HIá»†U á»¨NG CHáº Y CHá»® */
#scrolling-message {
Â  Â  position: fixed;
Â  Â  bottom: 39px; /* Äáº·t á»Ÿ trÃªn #tts-info */
Â  Â  left: 0;
Â  Â  width: 100%;
Â  Â  padding: 8px 0;
Â  Â  background: linear-gradient(90deg, #bbdefb, #e3f2fd, #bbdefb); /* Ná»n nháº¹ nhÃ ng */
Â  Â  border-top: 1px solid #90caf9;
Â  Â  border-bottom: 1px solid #90caf9;
Â  Â  color: #1565c0; /* MÃ u chá»¯ xanh */
Â  Â  font-size: 15px;
Â  Â  font-weight: bold;
Â  Â  white-space: nowrap; /* NgÄƒn chá»¯ xuá»‘ng dÃ²ng */
Â  Â  overflow: hidden; /* Che Ä‘i pháº§n chá»¯ thá»«a */
Â  Â  box-sizing: border-box;
Â  Â  z-index: 1005;
}

#scrolling-message-content {
Â  Â  display: inline-block;
Â  Â  padding-left: 1%; /* Báº¯t Ä‘áº§u tá»« ngoÃ i cÃ¹ng bÃªn pháº£i */
Â  Â  width: max-content;
Â  Â  animation: marquee 65s linear infinite; /* Hiá»‡u á»©ng cháº¡y chá»¯ */
Â  Â  transform: translateX(100%);
}

@keyframes marquee {
Â  Â  0% { transform: translate(0%); }
Â  Â  100% { transform: translate(-50%); }
}
Â  Â Â 
body.locked #scrolling-message {
Â  Â  display: none; /* áº¨n hoÃ n toÃ n khi giao diá»‡n bá»‹ khÃ³a */
}
Â  Â Â 
body.locked #tts-info {
Â  Â  z-index: 1011; /* Äáº£m báº£o tts-info náº±m trÃªn cÃ¹ng */
}

/* Media Query: Chá»‰ Ã¡p dá»¥ng cho mÃ n hÃ¬nh cÃ³ chiá»u rá»™ng tá»‘i Ä‘a 700px (Äiá»‡n thoáº¡i/Tablet) */
@media (max-width: 700px) {
Â  Â  #scrolling-message {
Â  Â  Â  Â  /* ÃP Dá»¤NG GIÃ TRá»Š Ráº¤T THáº¤P CHá»ˆ CHO ÄIá»†N THOáº I */
Â  Â  Â  Â  bottom: 36px; /* Thá»­ vá»›i 39px. Náº¿u váº«n há»Ÿ, giáº£m xuá»‘ng 38px */
Â  Â  }
}

Â  Â Â 
</style>
Â  Â Â 
</head>
<body>
<div class="main-wrapper">
<h1 id="mainTitle">MÃ¡y há»— trá»£ giá»ng nÃ³i</h1>
<div class="container" id="buttonContainer"></div>
<div id="popup"></div>
<div class="control-container" id="controlArea">
<button class="btn add-btn" id="add-btn-move" onclick="addButton()">â• ThÃªm cÃ¢u má»›i</button>
<div class="navigation-group">
<button class="control-btn play-control-btn" data-direction="-1">CÃ¢u trÆ°á»›c</button>
<button class="control-btn current-btn-color" data-direction="0">PhÃ¡t láº¡i</button>
<button class="control-btn play-control-btn" data-direction="1">CÃ¢u sau</button>
</div>
<button class="btn" id="unlock-btn" onclick="toggleLock(false)">Má»Ÿ khÃ³a giao diá»‡n</button>
</div>

<div id="settingsArea">
Â  Â  <div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:20px;padding:10px;border:1px solid #ccc;border-radius:8px;background:#fff">
Â  Â  Â  Â  <label for="rate-slider" style="font-weight:bold;color:#333">Tá»‘c Ä‘á»™ Ä‘á»c (<span id="rate-value">1.0</span>)</label>
Â  Â  Â  Â  <input type="range" id="rate-slider" min="0.5" max="2.0" step="0.1" value="1.0" style="width:90%;cursor:pointer">
Â  Â  </div>
Â  Â  <button class="btn settings-btn" onclick="toggleLock(true)">KhÃ³a giao diá»‡n</button>
Â  Â  <button class="btn install-btn large-control-btn" id="installButton" style="display: none;">ğŸ“² CÃ i Ä‘áº·t app</button>
Â  Â  <button class="btn reset-btn" onclick="resetDefaults()">â™»ï¸ Reset máº·c Ä‘á»‹nh</button>
</div>
</div>
<div id="scrolling-message">
Â  Â  <span id="scrolling-message-content">
Â  Â  Â  Â  â­ï¸ ÄÃ¢y lÃ  ná»n táº£ng há»— trá»£ giao tiáº¿p miá»…n phÃ­ dÃ nh cho ngÆ°á»i gáº·p khÃ³ khÄƒn vá» phÃ¡t Ã¢m hoáº·c váº­n Ä‘á»™ng, Ä‘áº·c biá»‡t lÃ  sau tai biáº¿n. Há»‡ thá»‘ng cho phÃ©p ngÆ°á»i dÃ¹ng táº¡o vÃ  phÃ¡t Ã¢m thanh cÃ¡c cÃ¢u nÃ³i thÆ°á»ng dÃ¹ng, giÃºp viá»‡c trao Ä‘á»•i vá»›i gia Ä‘Ã¬nh, y bÃ¡c sÄ© hay ngÆ°á»i chÄƒm sÃ³c trá»Ÿ nÃªn dá»… dÃ ng hÆ¡n. Cáº§n há»— trá»£? HÃ£y liÃªn há»‡: jaboz.bot@gmail.com â­ï¸Â 
Â  Â  Â  Â  Â <span style="display:inline-block; width: 4em;"></span>
Â  Â  Â  Â  Â â­ï¸ ÄÃ¢y lÃ  ná»n táº£ng há»— trá»£ giao tiáº¿p miá»…n phÃ­ dÃ nh cho ngÆ°á»i gáº·p khÃ³ khÄƒn vá» phÃ¡t Ã¢m hoáº·c váº­n Ä‘á»™ng, Ä‘áº·c biá»‡t lÃ  sau tai biáº¿n. Há»‡ thá»‘ng cho phÃ©p ngÆ°á»i dÃ¹ng táº¡o vÃ  phÃ¡t Ã¢m thanh cÃ¡c cÃ¢u nÃ³i thÆ°á»ng dÃ¹ng, giÃºp viá»‡c trao Ä‘á»•i vá»›i gia Ä‘Ã¬nh, y bÃ¡c sÄ© hay ngÆ°á»i chÄƒm sÃ³c trá»Ÿ nÃªn dá»… dÃ ng hÆ¡n. Cáº§n há»— trá»£? HÃ£y liÃªn há»‡: jaboz.bot@gmail.com â­ï¸
Â  Â  </span>
</div>
<div id="tts-info">Náº¿u khÃ´ng tháº¥y Ã¢m thanh, táº£i <a href="https://play.google.com/store/apps/details?id=com.google.android.tts" target="_blank">Giá»ng NÃ³i</a></div>

<script>
function getTonePriority(word){
Â  Â  const lowerWord = word.toLowerCase();
Â  Â  if (/[Ã¡Ã©Ã­Ã³ÃºÃ½áº£áº»á»‰á»á»§á»·]/.test(lowerWord)) return 2;
Â  Â  if (/[Ã Ã¨Ã¬Ã²Ã¹á»³Ã£áº½Ä©ÃµÅ©á»¹áº¡áº¹á»‹á»á»¥á»µ]/.test(lowerWord)) return 3;
Â  Â  return 1;
}

function removeDiacritics(str){
Â  Â  if (typeof str !== 'string') return '';
Â  Â  return str.toLowerCase()
Â  Â  Â  Â  .replace(/Ã |Ã¡|áº¡|áº£|Ã£|Ã¢|áº§|áº¥|áº­|áº©|áº«|Äƒ|áº±|áº¯|áº·|áº³|áºµ/g, "a")
Â  Â  Â  Â  .replace(/Ã¨|Ã©|áº¹|áº»|áº½|Ãª|á»|áº¿|á»‡|á»ƒ|á»…/g, "e")
Â  Â  Â  Â  .replace(/Ã¬|Ã­|á»‹|á»‰|Ä©/g, "i")
Â  Â  Â  Â  .replace(/Ã²|Ã³|á»|á»|Ãµ|Ã´|á»“|á»‘|á»™|á»•|á»—|Æ¡|á»|á»›|á»£|á»Ÿ|á»¡/g, "o")
Â  Â  Â  Â  .replace(/Ã¹|Ãº|á»¥|á»§|Å©|Æ°|á»«|á»©|á»±|á»­|á»¯/g, "u")
Â  Â  Â  Â  .replace(/á»³|Ã½|á»µ|á»·|á»¹/g, "y")
Â  Â  Â  Â  .replace(/Ä‘/g, "d");
}

const SUGGESTION_URL = 'goi-y-tu.txt';
const LOCAL_SUGGESTION_KEY = 'userSuggestions';
let serverSuggestions = [], userSuggestions = [], wordSuggestions = [];

async function loadSuggestions(){
Â  Â  try{
Â  Â  Â  Â  const response = await fetch(SUGGESTION_URL);
Â  Â  Â  Â  if(response.ok){
Â  Â  Â  Â  Â  Â  const textContent = await response.text();
Â  Â  Â  Â  Â  Â  serverSuggestions = textContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error('Lá»—i táº£i file gá»£i Ã½ server (kiá»ƒm tra file goi-y-tu.txt):', response.statusText);
Â  Â  Â  Â  }
Â  Â  } catch (error){
Â  Â  Â  Â  console.error('Lá»—i khi táº£i hoáº·c xá»­ lÃ½ file TXT:', error);
Â  Â  }

Â  Â  try{
Â  Â  Â  Â  const saved = localStorage.getItem(LOCAL_SUGGESTION_KEY);
Â  Â  Â  Â  userSuggestions = saved ? JSON.parse(saved) : [];
Â  Â  } catch(e){
Â  Â  Â  Â  console.error('Lá»—i táº£i gá»£i Ã½ ngÆ°á»i dÃ¹ng:', e);
Â  Â  Â  Â  userSuggestions = [];
Â  Â  }

Â  Â  wordSuggestions = [...new Set([...serverSuggestions, ...userSuggestions])].sort();
Â  Â  console.log(`ÄÃ£ táº£i tá»•ng cá»™ng ${wordSuggestions.length} gá»£i Ã½ tá»« file TXT vÃ  LocalStorage.`);
}

function extractWordBeforeCursor(inputElement){
Â  Â  const fullText = inputElement.value;
Â  Â  const cursorPosition = inputElement.selectionStart;
Â  Â  const textBeforeCursor = fullText.substring(0, cursorPosition);
Â  Â  const match = textBeforeCursor.match(/(\S+)$/);
Â  Â  if(match){
Â  Â  Â  Â  return { word: match[0], startIndex: match.index };
Â  Â  }
Â  Â  return { word: '', startIndex: -1 };
}

function showSuggestions(inputElement, boxElement){
Â  Â  const fullText = inputElement.value;
Â  Â  const { word: lastWord, startIndex: lastWordStart } = extractWordBeforeCursor(inputElement);
Â  Â  const cursorPosition = inputElement.selectionStart;
Â  Â  const charBeforeCursor = fullText.charAt(cursorPosition - 1);
Â  Â  const isAfterSpace = cursorPosition === 0 || /\s/.test(charBeforeCursor);

Â  Â  if(lastWord.length === 0 || isAfterSpace){
Â  Â  Â  Â  boxElement.style.display = 'none';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const lastWordNoDiacritics = removeDiacritics(lastWord).toLowerCase();
Â  Â  boxElement.innerHTML = '';

Â  Â  let filteredSuggestions = wordSuggestions
Â  Â  Â  Â  .filter(phrase => removeDiacritics(phrase).toLowerCase().startsWith(lastWordNoDiacritics));

Â  Â  filteredSuggestions.sort((a, b) => {
Â  Â  Â  Â  const aNo = removeDiacritics(a).toLowerCase();
Â  Â  Â  Â  const bNo = removeDiacritics(b).toLowerCase();
Â  Â  Â  Â  if(aNo < bNo) return -1;
Â  Â  Â  Â  if(aNo > bNo) return 1;
Â  Â  Â  Â  if(a < b) return -1;
Â  Â  Â  Â  if(a > b) return 1;
Â  Â  Â  Â  return 0;
Â  Â  });

Â  Â  if(filteredSuggestions.length > 0){
Â  Â  Â  Â  const rect = inputElement.getBoundingClientRect();
Â  Â  Â  Â  const suggestionHeight = 150;
Â  Â  Â  Â  const spaceAbove = rect.top;
Â  Â  Â  Â  const TOP_THRESHOLD = window.innerHeight * 0.15;
Â  Â  Â  Â  let shouldAlignBottom = false;

Â  Â  Â  Â  if(spaceAbove < suggestionHeight + 50 && (window.innerHeight - rect.bottom) > suggestionHeight){
Â  Â  Â  Â  Â  Â  shouldAlignBottom = true;
Â  Â  Â  Â  }
Â  Â  Â  Â  if(rect.top < TOP_THRESHOLD) shouldAlignBottom = true;

Â  Â  Â  Â  if(shouldAlignBottom) boxElement.classList.add('align-bottom');
Â  Â  Â  Â  else boxElement.classList.remove('align-bottom');

Â  Â  Â  Â  filteredSuggestions.forEach(phrase => {
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'suggestion-item';
Â  Â  Â  Â  Â  Â  item.textContent = phrase;
Â  Â  Â  Â  Â  Â  item.addEventListener('mousedown', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  const currentFullText = inputElement.value;
Â  Â  Â  Â  Â  Â  Â  Â  const currentCursorPosition = inputElement.selectionStart;
Â  Â  Â  Â  Â  Â  Â  Â  let newText = currentFullText.substring(0, lastWordStart) + phrase;
Â  Â  Â  Â  Â  Â  Â  Â  newText += currentFullText.substring(currentCursorPosition);
Â  Â  Â  Â  Â  Â  Â  Â  if(currentCursorPosition === currentFullText.length){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newText += ' ';
Â  Â  Â  Â  Â  Â  Â  Â  } else if(!newText.endsWith(' ')){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nextChar = newText.charAt(lastWordStart + phrase.length);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(/\S/.test(nextChar) && nextChar.length > 0){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newText = newText.substring(0, lastWordStart + phrase.length) + ' ' + newText.substring(lastWordStart + phrase.length);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  inputElement.value = newText;
Â  Â  Â  Â  Â  Â  Â  Â  boxElement.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  saveAll();
Â  Â  Â  Â  Â  Â  Â  Â  inputElement.focus();
Â  Â  Â  Â  Â  Â  Â  Â  inputElement.selectionStart = inputElement.selectionEnd = lastWordStart + phrase.length + (newText.charAt(lastWordStart + phrase.length) === ' ' ? 1 : 0);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  boxElement.appendChild(item);
Â  Â  Â  Â  });
Â  Â  Â  Â  boxElement.style.display = 'block';
Â  Â  } else {
Â  Â  Â  Â  boxElement.style.display = 'none';
Â  Â  }
}

let deferredPrompt, currentIndex = 0;
const defaults = ["TÃ´i muá»‘n Äƒn cÆ¡m","TÃ´i muá»‘n uá»‘ng nÆ°á»›c","TÃ´i muá»‘n Ä‘i vá»‡ sinh","TÃ´i muá»‘n Ä‘i ngá»§"];
const controlArea = document.getElementById('controlArea'),
Â  Â  Â  installButton = document.getElementById('installButton'),
Â  Â  Â  addBtnMove = document.getElementById('add-btn-move'),
Â  Â  Â  popupElement = document.getElementById('popup'),
Â  Â  Â  buttonContainer = document.getElementById('buttonContainer'),
Â  Â  Â  settingsArea = document.getElementById('settingsArea');

let currentRate = 1.0;
const rateSlider = document.getElementById('rate-slider');
const rateValueSpan = document.getElementById('rate-value');

function speak(text){
Â  Â  if(!text || !('speechSynthesis' in window)) return;
Â  Â  speechSynthesis.cancel();
Â  Â  let u = new SpeechSynthesisUtterance(text);
Â  Â  u.lang = 'vi-VN';
Â  Â  u.rate = currentRate;
Â  Â  speechSynthesis.speak(u);
Â  Â  showPopup(text);
}

function showPopup(text){
Â  Â  popupElement.textContent = text;
Â  Â  popupElement.style.display = 'block';
Â  Â  popupElement.style.opacity = '1';
Â  Â  setTimeout(()=>{ popupElement.style.opacity = '0'; setTimeout(()=>popupElement.style.display='none',500) },3500);
}

function getCards(){ return document.querySelectorAll('.card input') }

function updateCurrentIndexAfterChange(){
Â  Â  const c = getCards();
Â  Â  currentIndex = Math.min(currentIndex, c.length - 1);
Â  Â  if(currentIndex < 0) currentIndex = 0;
}

function addButton(v=''){
Â  Â  let c = document.createElement('div');
Â  Â  c.className = 'card';
Â  Â  let i = document.createElement('input');
Â  Â  i.value = v;
Â  Â  i.placeholder = "Nháº­p vÄƒn báº£n...";
Â  Â  i.onchange = saveAll;

Â  Â  let sBox = document.createElement('div');
Â  Â  sBox.className = 'suggestion-box';

Â  Â  i.addEventListener('input', (e) => showSuggestions(e.target, sBox));
Â  Â  i.addEventListener('blur', () => { setTimeout(() => sBox.style.display = 'none', 150); });

Â  Â  let p = document.createElement('button');
Â  Â  p.className = 'btn play-btn';
Â  Â  p.textContent = 'ğŸ”Š PhÃ¡t Ã¢m';
Â  Â  p.onclick = ()=>speak(i.value.trim());
Â  Â  let d = document.createElement('button');
Â  Â  d.className = 'delete-btn';
Â  Â  d.textContent = 'âŒ';
Â  Â  d.onclick = ()=>{ c.remove(); saveAll(); updateCurrentIndexAfterChange(); };

Â  Â  c.append(i, sBox, p, d);
Â  Â  document.getElementById('buttonContainer').appendChild(c);
Â  Â  saveAll();
Â  Â  currentIndex = getCards().length - 1;
}

function saveAll(){ localStorage.setItem('voiceButtons', JSON.stringify([...document.querySelectorAll('.card input')].map(i=>i.value.trim()))) }
function loadButtons(){ let s = JSON.parse(localStorage.getItem('voiceButtons') || "[]"); (s.length ? s : defaults).forEach(t => addButton(t)); currentIndex = 0; cleanupEmptyCards(); }
function resetDefaults(){ if(confirm("Äáº·t láº¡i máº·c Ä‘á»‹nh?")){ localStorage.removeItem('voiceButtons'); document.getElementById('buttonContainer').innerHTML = ''; loadButtons(); currentIndex = 0; } }

function cleanupEmptyCards(){
Â  Â  let c = document.querySelectorAll('.card'), save = false;
Â  Â  for(let i = c.length - 1; i >= 0; i--){
Â  Â  Â  Â  let inp = c[i].querySelector('input');
Â  Â  Â  Â  if(!inp || inp.value.trim() === ''){
Â  Â  Â  Â  Â  Â  c[i].remove();
Â  Â  Â  Â  Â  Â  save = true;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if(save){ saveAll(); updateCurrentIndexAfterChange(); }
}

function moveSpeak(dir){
Â  Â  const c = getCards();
Â  Â  if(c.length === 0) return;
Â  Â  if(dir === 0){
Â  Â  Â  Â  const text = c[currentIndex].value.trim();
Â  Â  Â  Â  if(text) speak(text);
Â  Â  Â  Â  else showPopup("CÃ¢u trá»‘ng! Vui lÃ²ng sá»­a hoáº·c xÃ³a.");
Â  Â  } else {
Â  Â  Â  Â  currentIndex = (currentIndex + dir + c.length) % c.length;
Â  Â  Â  Â  let count = 0;
Â  Â  Â  Â  while(c[currentIndex].value.trim() === '' && count < c.length){
Â  Â  Â  Â  Â  Â  currentIndex = (currentIndex + dir + c.length) % c.length;
Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  }
Â  Â  Â  Â  const text = c[currentIndex].value.trim();
Â  Â  Â  Â  if(text) speak(text);
Â  Â  Â  Â  else showPopup("KhÃ´ng cÃ³ cÃ¢u nÃ o Ä‘á»ƒ Ä‘á»c.");
Â  Â  }
}

function toggleLock(lock){
Â  Â  const u = document.getElementById('unlock-btn');
Â  Â  if(!lock) cleanupEmptyCards();
Â  Â  if(lock){
Â  Â  Â  Â  buttonContainer.style.display = 'none';
Â  Â  Â  Â  addBtnMove.style.display = 'none';
Â  Â  Â  Â  settingsArea.style.display = 'none';
Â  Â  Â  Â  controlArea.classList.add('locked');
Â  Â  Â  Â  document.body.classList.add('locked');
Â  Â  Â  Â  document.getElementById('mainTitle').classList.add('locked-h1');
Â  Â  Â  Â  u.style.display = 'flex';
Â  Â  } else {
Â  Â  Â  Â  buttonContainer.style.display = 'grid';
Â  Â  Â  Â  addBtnMove.style.display = 'block';
Â  Â  Â  Â  settingsArea.style.display = 'block';
Â  Â  Â  Â  controlArea.classList.remove('locked');
Â  Â  Â  Â  document.body.classList.remove('locked');
Â  Â  Â  Â  document.getElementById('mainTitle').classList.remove('locked-h1');
Â  Â  Â  Â  u.style.display = 'none';
Â  Â  }
}

document.querySelectorAll('.control-btn').forEach(button => {
Â  Â  ['click','touchend'].forEach(event => {
Â  Â  Â  Â  button.addEventListener(event, function(e){
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  moveSpeak(parseInt(e.currentTarget.dataset.direction));
Â  Â  Â  Â  }, { passive: false });
Â  Â  });
});

/* LOGIC PWA Má»šI */
function setupPWA() {
Â  Â  const installButton = document.getElementById('installButton');
Â  Â  let deferredPrompt = null;

Â  Â  window.addEventListener('beforeinstallprompt', (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  deferredPrompt = e;
Â  Â  Â  Â  installButton.style.display = 'flex'; // Hiá»ƒn thá»‹ nÃºt cÃ i Ä‘áº·t
Â  Â  Â  Â  installButton.onclick = () => {
Â  Â  Â  Â  Â  Â  if (deferredPrompt) {
Â  Â  Â  Â  Â  Â  Â  Â  deferredPrompt.prompt();
Â  Â  Â  Â  Â  Â  Â  Â  deferredPrompt.userChoice.then((choiceResult) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (choiceResult.outcome === 'accepted') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('NgÆ°á»i dÃ¹ng Ä‘Ã£ cháº¥p nháº­n cÃ i Ä‘áº·t PWA');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('NgÆ°á»i dÃ¹ng Ä‘Ã£ tá»« chá»‘i cÃ i Ä‘áº·t PWA');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deferredPrompt = null;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  });

Â  Â  // áº¨n nÃºt sau khi á»©ng dá»¥ng Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t
Â  Â  window.addEventListener('appinstalled', () => {
Â  Â  Â  Â  installButton.style.display = 'none';
Â  Â  });

Â  Â  // Kiá»ƒm tra tráº¡ng thÃ¡i hiá»ƒn thá»‹
Â  Â  if(window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone){
Â  Â  Â  Â  installButton.style.display = 'none';
Â  Â  }
}
/* Káº¾T THÃšC LOGIC PWA Má»šI */


function warmUpTTS(){
Â  Â  if(!('speechSynthesis' in window)) return;
Â  Â  let u = new SpeechSynthesisUtterance(" ");
Â  Â  u.lang = 'vi-VN';
Â  Â  u.volume = 0;
Â  Â  u.rate = 10;
Â  Â  speechSynthesis.speak(u);
Â  Â  setTimeout(()=>speechSynthesis.cancel(), 500);
}

function loadRate(){
Â  Â  const savedRate = localStorage.getItem('ttsRate');
Â  Â  if(savedRate !== null) currentRate = parseFloat(savedRate);
Â  Â  if(rateSlider){
Â  Â  Â  Â  rateSlider.value = currentRate.toFixed(1);
Â  Â  Â  Â  rateValueSpan.textContent = currentRate.toFixed(1);
Â  Â  }
}

function saveRate(rate){
Â  Â  currentRate = rate;
Â  Â  localStorage.setItem('ttsRate', rate.toFixed(1));
Â  Â  rateValueSpan.textContent = rate.toFixed(1);
}

window.addEventListener('DOMContentLoaded', () => {
Â  Â  if(rateSlider){
Â  Â  Â  Â  rateSlider.addEventListener('input', (e) => {
Â  Â  Â  Â  Â  Â  const newRate = parseFloat(e.target.value);
Â  Â  Â  Â  Â  Â  rateValueSpan.textContent = newRate.toFixed(1);
Â  Â  Â  Â  Â  Â  currentRate = newRate;
Â  Â  Â  Â  });
Â  Â  Â  Â  rateSlider.addEventListener('change', (e) => { saveRate(parseFloat(e.target.value)); });
Â  Â  }
});

window.onload = () => { loadButtons(); warmUpTTS(); loadSuggestions(); loadRate(); setupPWA(); };
</script>

</body>
</html>
