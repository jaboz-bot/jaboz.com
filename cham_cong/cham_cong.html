<!DOCTYPE html>

<html lang="vi">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>B·∫£ng Ch·∫•m C√¥ng C√° Nh√¢n</title>

<style>

/* --- PH·∫¶N CSS HO√ÄN CH·ªàNH --- */

html,body{height:100%;margin:0;font-family:Arial,sans-serif;background:#f6f8f9}

.container{max-width:900px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.1)}

/* ƒê·ªãnh d·∫°ng khu v·ª±c n√∫t v√† danh s√°ch c√¥ng vi·ªác */

.top-controls {

    display: flex;

    justify-content: space-between;

    align-items: center;

    padding-bottom: 10px;

    margin-bottom: 5px; 

    border-bottom: 1px solid #ddd;

}

.control-group { display:flex; gap:10px; }

.add-job-btn, .lang-toggle-btn {

    padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;

    font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,.1); white-space: nowrap;

}

.add-job-btn { background:#2ecc71; color:#fff; }

.lang-toggle-btn { background:#f1c40f; color:#333; font-size:.9em; padding:8px 12px; }

.auto-checkin-btn { 
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color:#fff; 
    font-size:.9em; 
    padding:10px 20px; 
    border-radius:25px;
    border:none;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 4px 15px rgba(231, 76, 60, 0.4);
    transition:all 0.3s ease;
}

.auto-checkin-btn:hover { 
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(231, 76, 60, 0.6);
}

.auto-checkin-btn.active { 
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    box-shadow:0 4px 15px rgba(17, 153, 142, 0.4);
}

.auto-checkin-btn.active:hover {
    box-shadow:0 6px 20px rgba(17, 153, 142, 0.6);
}

/* CSS CHO CAROUSEL */

#jobCarousel {

    display:flex; overflow-x:auto; scroll-snap-type:x mandatory; scroll-behavior:smooth; -webkit-overflow-scrolling:touch;

    margin-bottom:15px; border:1px solid #e0e0e0; border-radius:8px; padding:10px; background:#f7f7f7; box-shadow:inset 0 0 5px rgba(0,0,0,.05);

    min-height:72px;

}

.job-item {

    min-width:100%; flex-shrink:0; padding:10px 12px; font-size:.95em; color:#333; cursor:pointer; scroll-snap-align:start; box-sizing:border-box;

    transition:background-color .15s ease;

}

.job-item.selected { background-color:#d7e8f5; border:1px solid #2980b9; border-radius:5px; }

.job-item strong { color:#2980b9; display:block; font-size:1.15em; }

.job-item span { color:#7f8c8d; display:block; margin-top:4px; font-size:.9em; }

.job-item:hover { background-color:#eaf2f8; }

.job-item.selected:hover { background-color:#d7e8f5; }

/* CSS CHUNG B·∫¢NG L·ªäCH */

.header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #3498db;padding-bottom:10px}

.month-nav{display:flex;align-items:center;gap:8px;font-weight:bold;color:#27ae60}

.arrow{cursor:pointer;user-select:none;font-size:1.3em}

#calendarTable{position:relative;overflow:hidden}
table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
#calendarTable table{transition:transform 0.25s ease, opacity 0.25s ease}
#calendarTable.flipping-left table{transform:translateX(-100%);opacity:0}
#calendarTable.flipping-right table{transform:translateX(100%);opacity:0}
#calendarTable table.fade-in{animation:fadeIn 0.25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateX(0)}to{opacity:1;transform:translateX(0)}}

th,td{border:1px solid #ccc;text-align:center;padding:5px;font-size:.85em}

th{background:#eaf2f8}

/* √î ng√†y */

.day{position:relative;height:80px;vertical-align:top;cursor:pointer;padding-top:20px}

.day span{position:absolute;top:3px;left:5px;font-weight:bold;color:#2980b9;z-index:1;}

.day .today-dot{position:absolute;top:3px;left:18px;width:6px;height:6px;background:#f1c40f;border-radius:50%;z-index:2;}

#monthYear{cursor:pointer;user-select:none;}

.day div{width:100%;margin-top:5px;text-align:center;line-height:1.2}

.day .hours-display{font-weight:bold;color:#2ecc71;font-size:.9em}

.day .pay-display{color:#e74c3c;font-size:.8em;font-weight:normal;margin-top:2px}

/* ƒê√°nh d·∫•u ng√†y tr·∫£ l∆∞∆°ng */

.payday-cell{background:#e8f8ec !important;}

.job-date-cell{background:#fff3e0 !important;}

/* Khi c·∫£ ng√†y tr·∫£ l∆∞∆°ng v√† ng√†y b·∫Øt ƒë·∫ßu/k·∫øt th√∫c tr√πng nhau */
.payday-cell.job-date-cell{background:#ffeaa7 !important;}

/* Container cho c√°c ghi ch√∫ */
.notes-container{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);max-width:90%;display:flex;flex-direction:column;align-items:center;gap:1px;pointer-events:none;}

.payday-note{font-size:.6em;color:#e74c3c;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;text-align:center;}

.job-date-note{font-size:.6em;color:#f57c00;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;text-align:center;}

/* Summary + n√∫t m√°y t√≠nh (n√∫t ·ªü gi·ªØa d√≤ng cu·ªëi) */

.summary{position:sticky;bottom:0;margin-top:20px;background:#ecf9ff;padding:10px;border-radius:5px;z-index:100;box-shadow:0 -2px 10px rgba(0,0,0,0.1)}

.summary .notice{color:#e74c3c;font-style:italic;display:none;margin-bottom:4px}

#totalHours{font-weight:bold;color:#2ecc71;font-size:1.1em}

.summary .green-unit{color:#2ecc71;font-weight:bold}

#totalPay{font-weight:bold;color:#e74c3c;font-size:1.1em}

.summary .red-unit{color:#e74c3c;font-weight:bold}

.calc-open-btn{

    position: static;

    display: block;

    margin: 12px auto 0;

    background:#8e44ad; color:#fff; border:none; border-radius:6px; padding:10px 14px; cursor:pointer;

    font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,.15);

}

/* Modal chung */

.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:1000;}

.modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:420px}

.modal-content input[type="text"], .modal-content input[type="date"], .modal-content input[type="number"], .modal-content select{width:100%;padding:8px;margin:5px 0;border:1px solid #ccc;border-radius:5px;box-sizing:border-box;}

.button-group{display:flex;justify-content:space-between;align-items:center}

.modal-content button{margin-top:15px;padding:8px 12px;border:none;border-radius:5px;cursor:pointer}

.save{background:#3498db;color:#fff}

.cancel{background:#ccc}

.delete{background:#e74c3c;color:#fff}

/* T√πy ch·ªânh Calendar v√† Input L∆∞∆°ng/gi·ªù */

table th:first-child{background:#e74c3c;color:#fff}

table tr td:first-child{background-color:#fcecec}

table tr td:first-child span{color:#c0392b !important}

table tr td:empty{background-color:#dddddd;cursor:default}

.header input#rate{min-width:60px;width:60px;transition:width .2s ease-in-out;text-align:right}

.time-input-group{display:flex;align-items:center;margin-bottom:10px}

.time-input-group label{font-weight:bold;width:40px;text-align:left;margin-right:10px}

.time-input-group input[type="time"]{flex-grow:1;padding:8px;border:1px solid #ccc;border-radius:5px;box-sizing:border-box;width:auto}

/* Modal m√°y t√≠nh */

.calc-content{max-width:320px}

.calc-display{

    width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;

    font-size:1.2em; text-align:right; box-sizing:border-box; margin-bottom:10px;

}

.calc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}

.calc-grid button{padding:12px;font-size:1em;border:none;border-radius:6px;cursor:pointer;background:#f1f1f1}

.calc-grid button.op{background:#e8f0fe}

.calc-grid button.equals{background:#2ecc71;color:#fff}

.calc-grid button.clear{background:#e74c3c;color:#fff}

.calc-grid button.back{background:#f39c12;color:#fff}

/* Media query cho mobile */
@media (max-width: 768px) {
    .container {
        margin: 10px auto;
        padding: 12px;
    }
    
    .top-controls {
        padding-bottom: 8px;
        margin-bottom: 5px;
    }
    
    #jobCarousel {
        padding: 8px;
        margin-bottom: 12px;
    }
    
    .header {
        padding-bottom: 8px;
    }
    
    .summary {
        padding: 8px;
        margin-top: 15px;
    }
    
    .modal-content {
        padding: 15px;
    }
    
    th, td {
        padding: 3px;
        font-size: 0.8em;
    }
    
    .day {
        height: 70px;
        padding-top: 15px;
    }
}

</style>

</head>

<body>

<div class="container">

    <div class="top-controls">

        <div class="control-group">

            <button class="add-job-btn" id="openJobModal" data-i18n="manage_jobs">‚ûï Th√™m N∆°i l√†m vi·ªác</button>

            <button class="auto-checkin-btn" id="openAutoCheckinModal">Auto</button>

        </div>

        <button class="lang-toggle-btn" id="langToggle">üá∞üá∑ Korean</button>

    </div>

    

    <div id="jobCarousel"></div>

    <div class="header"> 

        <div class="month-nav">

            <span class="arrow" id="prevMonth">‚óÄÔ∏è</span>

            <span id="monthYear"></span>

            <span class="arrow" id="nextMonth">‚ñ∂Ô∏è</span>

        </div>

        <div>

            <span data-i18n="rate_per_hour">üí∞ L∆∞∆°ng/gi·ªù:</span>

            <input type="text" id="rate" value="10.000">

            <span id="currencyUnit">VND</span>

        </div>

    </div>

    

    <div id="calendarTable"> 

        <table>

            <thead>

                <tr id="calendarHeaders">

                    <th>CN</th><th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th>

                </tr>

            </thead>

            <tbody id="calendar"></tbody>

        </table>

    </div>

    <div class="summary">

        <div id="paydayNotice" class="notice" data-i18n="payday_notice">H√£y nh·∫≠p ng√†y tr·∫£ l∆∞∆°ng ƒë·ªÉ c√≥ thu nh·∫≠p ch√≠nh x√°c</div>

        ‚úÖ <span id="totalHoursLabel">T·ªïng gi·ªù th√°ng 00:</span> <span id="totalHours">0</span><br>

        üíµ <span id="totalPayLabel">Thu nh·∫≠p th√°ng 00:</span> <span id="totalPay">0</span> <span class="red-unit" data-i18n="unit_vnd">VND</span>

        <button class="calc-open-btn" id="openCalc" data-i18n="calculator_button">üßÆ M√°y t√≠nh</button>

    </div>

</div>

<div class="modal" id="timeModal">

    <div class="modal-content">

        <h3 data-i18n="modal_time_title">Nh·∫≠p gi·ªù c√¥ng - <span id="modalDate"></span></h3>

        <div class="time-input-group">

            <label for="timeIn" data-i18n="time_in">V√†o:</label>

            <input type="time" id="timeIn" value="09:00">

        </div>

        <div class="time-input-group">

            <label for="timeOut" data-i18n="time_out">Ra:</label>

            <input type="time" id="timeOut" value="18:00">

        </div>

        <div class="button-group">

            <div style="display:flex;gap:10px;margin-left:auto;">

                <button class="delete" id="deleteTime" data-i18n="delete">X√≥a</button>

                <button class="cancel" id="cancelTime" data-i18n="cancel">H·ªßy</button>

                <button class="save" id="saveTime" data-i18n="save">L∆∞u</button>

            </div>

        </div>

    </div>

</div>

<div class="modal" id="jobModal">

    <div class="modal-content">

        <h3 id="jobModalTitle" data-i18n="modal_job_add_title">Th√™m N∆°i l√†m vi·ªác m·ªõi</h3>

        <div class="input-group">

            <label for="jobName" data-i18n="job_name">T√™n N∆°i l√†m vi·ªác:</label>

            <input type="text" id="jobName" data-i18n-placeholder="job_name_placeholder" placeholder="T√™n c√¥ng ty/D·ª± √°n..." required>

        </div>

        <div class="input-group">

            <label for="jobAddress" data-i18n="job_address">ƒê·ªãa ch·ªâ:</label>

            <input type="text" id="jobAddress" data-i18n-placeholder="job_address_placeholder" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ch√≠nh x√°c ƒë·ªÉ t√¨m GPS cho ch·∫•m c√¥ng t·ª± ƒë·ªông">

        </div>

        <div class="input-group">

            <label for="jobStartDate" data-i18n="job_start_date">Ng√†y B·∫Øt ƒë·∫ßu:</label>

            <input type="date" id="jobStartDate" required>

        </div>

        <div class="input-group">

            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                <label for="jobEndDate" data-i18n="job_end_date" style="margin:0;">Ng√†y ngh·ªâ vi·ªác:</label>
                <label style="display:flex;align-items:center;margin:0;cursor:pointer;">
                    <input type="checkbox" id="jobIsCurrent" data-i18n-placeholder="job_is_current" style="margin-right:5px;"> 
                    <span data-i18n="job_is_current">ƒêang l√†m</span>
                </label>
            </div>

            <input type="date" id="jobEndDate">

        </div>

        <div class="input-group">

            <label for="jobPayday" data-i18n="job_payday_label">Ng√†y tr·∫£ l∆∞∆°ng (1-31):</label>

            <input type="number" id="jobPayday" min="1" max="31" data-i18n-placeholder="job_payday_placeholder" placeholder="VD: 10">

        </div>

        <div class="input-group">

            <label data-i18n="gps_location">üìç V·ªã tr√≠ GPS (cho ch·∫•m c√¥ng t·ª± ƒë·ªông):</label>

            <div style="margin-bottom:10px;">

                <button type="button" id="searchAddressBtn" style="width:100%;padding:12px;background:#2ecc71;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:1em;box-shadow:0 2px 5px rgba(0,0,0,.2);transition:all 0.3s;" data-i18n="search_address" onmouseover="this.style.background='#27ae60';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(0,0,0,.3)'" onmouseout="this.style.background='#2ecc71';this.style.transform='translateY(0)';this.style.boxShadow='0 2px 5px rgba(0,0,0,.2)'">üîç T√¨m ki·∫øm v·ªã tr√≠ ƒë√£ nh·∫≠p</button>

            </div>

            <div id="locationAddressDisplay" style="margin-top:10px;padding:15px;background:#f0f8ff;border-radius:8px;border-left:4px solid #3498db;display:none;">

                <div style="font-weight:bold;color:#2980b9;margin-bottom:8px;font-size:1.05em;" data-i18n="location_address_label">üìç ƒê·ªãa ch·ªâ:</div>

                <div id="locationAddressText" style="color:#555;font-size:1em;line-height:1.6;word-wrap:break-word;"></div>

            </div>

            <!-- ·∫®n c√°c input ƒë·ªÉ l∆∞u t·ªça ƒë·ªô (kh√¥ng hi·ªÉn th·ªã cho ng∆∞·ªùi d√πng) -->

            <input type="hidden" id="jobLat" step="any">

            <input type="hidden" id="jobLng" step="any">

            <input type="hidden" id="jobRadius" value="100">

        </div>

        <div class="job-button-group" style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">

            <button class="delete" id="deleteJob" data-i18n="delete">X√≥a</button>

            <div class="right-buttons">

                <button class="cancel" id="cancelJob" data-i18n="cancel">H·ªßy</button>

                <button class="save" id="saveJob" data-i18n="save">L∆∞u</button>

            </div>

        </div>

    </div>

</div>

<!-- Modal Ch·∫•m c√¥ng t·ª± ƒë·ªông -->

<div class="modal" id="autoCheckinModal">

    <div class="modal-content" style="max-width:450px;">

        <h3 data-i18n="auto_checkin_modal_title">‚öôÔ∏è Ch·∫•m c√¥ng t·ª± ƒë·ªông</h3>

        <div style="margin-bottom:20px;">

            <p style="color:#555;line-height:1.6;margin-bottom:15px;" data-i18n="auto_checkin_description">

                ƒê√¢y l√† t√≠nh nƒÉng ch·∫•m c√¥ng t·ª± ƒë·ªông s·ª≠ d·ª•ng GPS. Khi b·∫≠t, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra v·ªã tr√≠ c·ªßa b·∫°n v√† ch·∫•m c√¥ng v√†o/ra khi b·∫°n ƒë·∫øn ho·∫∑c r·ªùi kh·ªèi n∆°i l√†m vi·ªác.

            </p>

        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">

            <button class="cancel" id="autoCheckinOff" data-i18n="auto_checkin_off">‚úó T·∫Øt</button>

            <button class="save" id="autoCheckinOn" data-i18n="auto_checkin_on">‚úì B·∫≠t</button>

        </div>

    </div>

</div>

<!-- Modal X√°c nh·∫≠n ch·∫•m c√¥ng t·ª± ƒë·ªông -->

<div class="modal" id="confirmCheckinModal">

    <div class="modal-content" style="max-width:420px;">

        <h3 data-i18n="confirm_checkin_title">‚úÖ X√°c nh·∫≠n ch·∫•m c√¥ng t·ª± ƒë·ªông</h3>

        <div style="margin-bottom:20px;">

            <p style="color:#555;line-height:1.6;margin-bottom:15px;" id="confirmCheckinMessage">

                ƒê√£ t·ª± ƒë·ªông ch·∫•m c√¥ng v√†o l√∫c <strong id="confirmCheckinTime"></strong>

            </p>

            <div style="background:#f0f8ff;padding:15px;border-radius:8px;border-left:4px solid #3498db;">

                <div style="margin-bottom:10px;">

                    <strong data-i18n="checkin_date_label">Ng√†y:</strong> <span id="confirmCheckinDate"></span>

                </div>

                <div style="margin-bottom:8px;">

                    <strong data-i18n="checkin_type">Lo·∫°i:</strong> <span id="confirmCheckinType"></span>

                </div>

                <div style="margin-bottom:8px;">

                    <strong data-i18n="checkin_time_label">Gi·ªù v√†o:</strong> <span id="confirmCheckinTimeDetail"></span>

                </div>

                <div id="confirmCheckinOutTime" style="display:none;margin-bottom:8px;">

                    <strong data-i18n="checkout_time_label">Gi·ªù ra:</strong> <span id="confirmCheckoutTimeDetail"></span>

                </div>

                <div id="confirmCheckinHours" style="display:none;">

                    <strong data-i18n="total_hours_label">T·ªïng gi·ªù:</strong> <span id="confirmTotalHoursDetail"></span>

                </div>

            </div>

            <p style="color:#888;font-size:0.9em;margin-top:10px;" data-i18n="confirm_checkin_hint">

                Vui l√≤ng ki·ªÉm tra th√¥ng tin tr√™n. N·∫øu c√≥ sai s√≥t, nh·∫•n "S·ª≠a l·∫°i" ƒë·ªÉ ch·ªânh s·ª≠a.

            </p>

        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">

            <button class="cancel" id="editCheckinBtn" data-i18n="edit_checkin">‚úèÔ∏è S·ª≠a l·∫°i</button>

            <button class="save" id="confirmCheckinOkBtn" data-i18n="ok_button">‚úì OK</button>

        </div>

    </div>

</div>

<!-- Modal M√°y t√≠nh -->

<div class="modal" id="calcModal">

    <div class="modal-content calc-content">

        <h3 data-i18n="calculator_title">M√°y t√≠nh</h3>

        <input id="calcDisplay" class="calc-display" type="text" value="" readonly>

        <div class="calc-grid">

            <button data-val="7">7</button>

            <button data-val="8">8</button>

            <button data-val="9">9</button>

            <button class="op" data-val="/">/</button>

            <button data-val="4">4</button>

            <button data-val="5">5</button>

            <button data-val="6">6</button>

            <button class="op" data-val="*">*</button>

            <button data-val="1">1</button>

            <button data-val="2">2</button>

            <button data-val="3">3</button>

            <button class="op" data-val="-">-</button>

            <button data-val="0">0</button>

            <button data-val=".">.</button>

            <button class="equals" data-action="equals">=</button>

            <button class="op" data-val="+">+</button>

            <button class="clear" data-action="clear">C</button>

            <button class="back" data-action="back">‚Üê</button>

            <button class="cancel" id="closeCalc" style="grid-column: span 2;" data-i18n="close">ƒê√≥ng</button>

        </div>

    </div>

</div>

<script>

// Tr·∫°ng th√°i

let currentMonth = new Date().getMonth();

let currentYear = new Date().getFullYear();

let workData = JSON.parse(localStorage.getItem('workData') || '{}');

let appSettings = JSON.parse(localStorage.getItem('appSettings') || '{}');

let jobs = JSON.parse(localStorage.getItem('jobs') || '[]');

let editingJobId = null;

let currentLang = localStorage.getItem('currentLang') || 'vi';

// Elements

const rateInput = document.getElementById('rate');

const jobModal = document.getElementById('jobModal');

const timeModal = document.getElementById('timeModal');

const jobCarouselDiv = document.getElementById('jobCarousel');

const langToggleBtn = document.getElementById('langToggle');

const calendarTable = document.getElementById('calendarTable');

const currencyUnitSpan = document.getElementById('currencyUnit');

const paydayNotice = document.getElementById('paydayNotice');

// D·ªãch

const translations = {

    vi: {

        days: ['CN','T2','T3','T4','T5','T6','T7'],

        currency: 'VND',

        manage_jobs: '‚ûï Th√™m N∆°i l√†m vi·ªác',

        rate_per_hour: 'üí∞ L∆∞∆°ng/gi·ªù:',

        modal_time_title: 'Nh·∫≠p gi·ªù c√¥ng -',

        time_in: 'V√†o:',

        time_out: 'Ra:',

        delete: 'X√≥a',

        cancel: 'H·ªßy',

        save: 'L∆∞u',

        modal_job_add_title: 'Th√™m N∆°i l√†m vi·ªác m·ªõi',

        modal_job_edit_title: 'Ch·ªânh s·ª≠a N∆°i l√†m vi·ªác',

        job_name: 'T√™n N∆°i l√†m vi·ªác:',

        job_address: 'ƒê·ªãa ch·ªâ:',

        job_start_date: 'Ng√†y B·∫Øt ƒë·∫ßu:',

        job_end_date: 'Ng√†y ngh·ªâ vi·ªác:',

        job_is_current: 'ƒêang l√†m',

        alert_job_required: 'T√™n v√† Ng√†y B·∫Øt ƒë·∫ßu l√† b·∫Øt bu·ªôc.',

        alert_date_invalid: 'Ng√†y ngh·ªâ vi·ªác ph·∫£i sau ho·∫∑c b·∫±ng Ng√†y B·∫Øt ƒë·∫ßu.',

        alert_delete_confirm: (name) => `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a n∆°i l√†m vi·ªác ${name} kh√¥ng? Vi·ªác n√†y s·∫Ω x√≥a t·∫•t c·∫£ gi·ªù c√¥ng li√™n quan!`,

        alert_time_job_required: 'Vui l√≤ng th√™m N∆°i l√†m vi·ªác tr∆∞·ªõc khi ch·∫•m c√¥ng.',

        alert_delete_time_confirm: (jobName) => `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a gi·ªù c√¥ng c·ªßa ng√†y n√†y cho ${jobName} kh√¥ng?`,

        job_date_current: 'ƒêang l√†m',

        job_date_from: 'T·ª´',

        job_date_to: 'ƒë·∫øn',

        unit_vnd: 'VND',

        payday_note: 'Tr·∫£ l∆∞∆°ng',

        payday_label: 'üí¥ Ng√†y TL:',

        job_start_date_note: 'B·∫Øt ƒë·∫ßu',

        job_end_date_note: 'Ngh·ªâ vi·ªác',

        job_payday_label: 'Ng√†y tr·∫£ l∆∞∆°ng (1-31):',

        job_name_placeholder: 'T√™n c√¥ng ty/D·ª± √°n...',

        job_address_placeholder: 'Nh·∫≠p ƒë·ªãa ch·ªâ ch√≠nh x√°c ƒë·ªÉ t√¨m GPS cho ch·∫•m c√¥ng t·ª± ƒë·ªông',

        job_payday_placeholder: 'VD: 10',

        calculator_title: 'M√°y t√≠nh',

        calculator_button: 'M√°y t√≠nh',

        close: 'ƒê√≥ng',

        payday_notice: 'H√£y nh·∫≠p ng√†y tr·∫£ l∆∞∆°ng ƒë·ªÉ c√≥ thu nh·∫≠p ch√≠nh x√°c',

        hours_unit: 'GI·ªú',

        hour: 'gi·ªù',

        minute: 'ph√∫t',

        auto_checkin: 'üìç Ch·∫•m c√¥ng t·ª± ƒë·ªông',

        gps_location: 'üìç V·ªã tr√≠ GPS (cho ch·∫•m c√¥ng t·ª± ƒë·ªông):',

        gps_lat_placeholder: 'Vƒ© ƒë·ªô (Lat)',

        gps_lng_placeholder: 'Kinh ƒë·ªô (Lng)',

        get_location: 'üìç L·∫•y v·ªã tr√≠ hi·ªán t·∫°i',

        location_address_label: 'üìç ƒê·ªãa ch·ªâ:',

        search_address: 'üîç T√¨m ki·∫øm v·ªã tr√≠ ƒë√£ nh·∫≠p',

        notification_checkin: '‚úÖ ƒê√£ t·ª± ƒë·ªông ch·∫•m c√¥ng v√†o',

        notification_checkout: '‚úÖ ƒê√£ t·ª± ƒë·ªông ch·∫•m c√¥ng ra',

        notification_welcome: 'Ch√†o m·ª´ng b·∫°n! Ch·∫•m c√¥ng t·ª± ƒë·ªông ƒëang ho·∫°t ƒë·ªông.',

        auto_checkin_on: '‚úì B·∫≠t',

        auto_checkin_off: '‚úó T·∫Øt',

        auto_checkin_modal_title: '‚öôÔ∏è Ch·∫•m c√¥ng t·ª± ƒë·ªông',

        auto_checkin_description: 'ƒê√¢y l√† t√≠nh nƒÉng ch·∫•m c√¥ng t·ª± ƒë·ªông s·ª≠ d·ª•ng GPS. Khi b·∫≠t, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra v·ªã tr√≠ c·ªßa b·∫°n v√† ch·∫•m c√¥ng v√†o/ra khi b·∫°n ƒë·∫øn ho·∫∑c r·ªùi kh·ªèi n∆°i l√†m vi·ªác.',

        confirm_checkin_title: '‚úÖ X√°c nh·∫≠n ch·∫•m c√¥ng t·ª± ƒë·ªông',

        checkin_type: 'Lo·∫°i:',

        checkin_date_label: 'Ng√†y:',

        checkin_time_label: 'Gi·ªù v√†o:',

        checkout_time_label: 'Gi·ªù ra:',

        total_hours_label: 'T·ªïng gi·ªù:',

        confirm_checkin_hint: 'Vui l√≤ng ki·ªÉm tra th√¥ng tin tr√™n. N·∫øu c√≥ sai s√≥t, nh·∫•n "S·ª≠a l·∫°i" ƒë·ªÉ ch·ªânh s·ª≠a.',

        edit_checkin: '‚úèÔ∏è S·ª≠a l·∫°i',

        ok_button: '‚úì OK',

        checkin_type_in: 'Ch·∫•m c√¥ng v√†o',

        checkin_type_out: 'Ch·∫•m c√¥ng ra'

    },

    ko: {

        days: ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'],

        currency: 'KRW',

        manage_jobs: '‚ûï ÏßÅÏû• Ï∂îÍ∞Ä',

        rate_per_hour: 'üí∞ ÏãúÍ∏â:',

        modal_time_title: 'Í∑ºÎ¨¥ ÏãúÍ∞Ñ ÏûÖÎ†• -',

        time_in: 'Ï∂úÍ∑º:',

        time_out: 'Ìá¥Í∑º:',

        delete: 'ÏÇ≠Ï†ú',

        cancel: 'Ï∑®ÏÜå',

        save: 'Ï†ÄÏû•',

        modal_job_add_title: 'ÏÉà ÏßÅÏû• Ï∂îÍ∞Ä',

        modal_job_edit_title: 'ÏßÅÏû• ÏàòÏ†ï',

        job_name: 'ÏßÅÏû• Ïù¥Î¶Ñ:',

        job_address: 'Ï£ºÏÜå:',

        job_start_date: 'ÏãúÏûëÏùº:',

        job_end_date: 'Ìá¥ÏßÅÏùº:',

        job_is_current: 'Ïû¨ÏßÅ Ï§ë',

        alert_job_required: 'Ïù¥Î¶ÑÍ≥º ÏãúÏûëÏùºÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.',

        alert_date_invalid: 'Ìá¥ÏßÅÏùºÏùÄ ÏãúÏûëÏùºÍ≥º Í∞ôÍ±∞ÎÇò Í∑∏ Ïù¥ÌõÑÏó¨Ïïº Ìï©ÎãàÎã§.',

        alert_delete_confirm: (name) => `Ï†ïÎßêÎ°ú ${name} ÏßÅÏû•ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Í¥ÄÎ†® Í∑ºÎ¨¥ ÏãúÍ∞ÑÏù¥ Î™®Îëê ÏÇ≠Ï†úÎê©ÎãàÎã§!`,

        alert_time_job_required: 'Ï∂úÌá¥Í∑º Í∏∞Î°ù Ï†ÑÏóê ÏßÅÏû•ÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.',

        alert_delete_time_confirm: (jobName) => `Ïù¥ ÎÇ†ÏßúÏùò ${jobName} Í∑ºÎ¨¥ ÏãúÍ∞ÑÏùÑ Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`,

        job_date_current: 'Ïû¨ÏßÅ Ï§ë',

        job_date_from: '',

        job_date_to: 'ÍπåÏßÄ',

        unit_vnd: 'KRW',

        payday_note: 'Í∏âÏó¨Ïùº',

        payday_label: 'üí¥ Í∏âÏó¨Ïùº:',

        job_start_date_note: 'ÏãúÏûëÏùº',

        job_end_date_note: 'Ìá¥ÏßÅÏùº',

        job_payday_label: 'Í∏âÏó¨Ïùº (1-31):',

        job_name_placeholder: 'ÌöåÏÇ¨Î™Ö/ÌîÑÎ°úÏ†ùÌä∏Î™Ö...',

        job_address_placeholder: 'Ï†ïÌôïÌïú Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏó¨ ÏûêÎèô Ï∂úÌá¥Í∑ºÏö© GPS Í≤ÄÏÉâ',

        job_payday_placeholder: 'Ïòà: 10',

        calculator_title: 'Í≥ÑÏÇ∞Í∏∞',

        calculator_button: 'Í≥ÑÏÇ∞Í∏∞',

        close: 'Îã´Í∏∞',

        payday_notice: 'Ï†ïÌôïÌïú ÏàòÏûÖÏùÑ ÏúÑÌï¥ Í∏âÏó¨ÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî',

        hours_unit: 'ÏãúÍ∞Ñ',

        hour: 'ÏãúÍ∞Ñ',

        minute: 'Î∂Ñ',

        auto_checkin: 'üìç ÏûêÎèô Ï∂úÌá¥Í∑º',

        gps_location: 'üìç GPS ÏúÑÏπò (ÏûêÎèô Ï∂úÌá¥Í∑ºÏö©):',

        gps_lat_placeholder: 'ÏúÑÎèÑ (Lat)',

        gps_lng_placeholder: 'Í≤ΩÎèÑ (Lng)',

        get_location: 'üìç ÌòÑÏû¨ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞',

        location_address_label: 'üìç Ï£ºÏÜå:',

        search_address: 'üîç ÏûÖÎ†•Ìïú ÏúÑÏπò Í≤ÄÏÉâ',

        notification_checkin: '‚úÖ ÏûêÎèô Ï∂úÍ∑º Í∏∞Î°ùÎê®',

        notification_checkout: '‚úÖ ÏûêÎèô Ìá¥Í∑º Í∏∞Î°ùÎê®',

        notification_welcome: 'ÌôòÏòÅÌï©ÎãàÎã§! ÏûêÎèô Ï∂úÌá¥Í∑ºÏù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§.',

        auto_checkin_on: '‚úì ÏºúÍ∏∞',

        auto_checkin_off: '‚úó ÎÅÑÍ∏∞',

        auto_checkin_modal_title: '‚öôÔ∏è ÏûêÎèô Ï∂úÌá¥Í∑º',

        auto_checkin_description: 'Ïù¥Í≤ÉÏùÄ GPSÎ•º ÏÇ¨Ïö©ÌïòÎäî ÏûêÎèô Ï∂úÌá¥Í∑º Í∏∞Îä•ÏûÖÎãàÎã§. ÌôúÏÑ±ÌôîÌïòÎ©¥ ÏãúÏä§ÌÖúÏù¥ Í∑ÄÌïòÏùò ÏúÑÏπòÎ•º ÏûêÎèôÏúºÎ°ú ÌôïÏù∏ÌïòÍ≥† ÏßÅÏû•Ïóê ÎèÑÏ∞©ÌïòÍ±∞ÎÇò Îñ†ÎÇ† Îïå ÏûêÎèôÏúºÎ°ú Ï∂úÌá¥Í∑ºÏùÑ Í∏∞Î°ùÌï©ÎãàÎã§.',

        confirm_checkin_title: '‚úÖ ÏûêÎèô Ï∂úÌá¥Í∑º ÌôïÏù∏',

        checkin_type: 'Ïú†Ìòï:',

        checkin_date_label: 'ÎÇ†Ïßú:',

        checkin_time_label: 'Ï∂úÍ∑º ÏãúÍ∞Ñ:',

        checkout_time_label: 'Ìá¥Í∑º ÏãúÍ∞Ñ:',

        total_hours_label: 'Ï¥ù ÏãúÍ∞Ñ:',

        confirm_checkin_hint: 'ÏúÑ Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. Ïò§Î•òÍ∞Ä ÏûàÏúºÎ©¥ "ÏàòÏ†ï"ÏùÑ ÎàåÎü¨ Ìé∏ÏßëÌïòÏÑ∏Ïöî.',

        edit_checkin: '‚úèÔ∏è ÏàòÏ†ï',

        ok_button: '‚úì ÌôïÏù∏',

        checkin_type_in: 'Ï∂úÍ∑º',

        checkin_type_out: 'Ìá¥Í∑º'

    }

};

// Helpers

const pad = (n) => (n < 10 ? '0' + n : '' + n);

const getDayKey = (y,m,d) => `${y}-${pad(m+1)}-${pad(d)}`;

const daysInMonth = (y,m) => new Date(y,m+1,0).getDate();

function formatHoursToTime(hours) {
    const h = Math.floor(hours);
    const minutes = Math.round((hours - h) * 60);
    const m = minutes % 60;
    const finalHours = h + Math.floor(minutes / 60);
    return `${finalHours}:${pad(m)}`;
}

function formatHoursToText(hours) {
    const h = Math.floor(hours);
    const minutes = Math.round((hours - h) * 60);
    const m = minutes % 60;
    const finalHours = h + Math.floor(minutes / 60);
    
    const hourText = getTranslation('hour');
    const minuteText = getTranslation('minute');
    
    if (m === 0) {
        return `${finalHours} ${hourText}`;
    }
    return `${finalHours} ${hourText} ${m} ${minuteText}`;
}

function formatHoursToWorkTime(hours) {
    const h = Math.floor(hours);
    const minutes = Math.round((hours - h) * 60);
    const m = minutes % 60;
    const finalHours = h + Math.floor(minutes / 60);
    if (m === 0) {
        return `${finalHours}h`;
    }
    return `${finalHours}h${pad(m)}`;
}

function formatPayAmount(amount, locale) {
    const truncated = Math.floor(amount);
    return truncated.toLocaleString(locale);
}

function getTranslation(key, ...args){ const t = translations[currentLang][key]; return typeof t === 'function' ? t(...args) : (t ?? key); }

// Rate helpers

function getRateDigits(){

    return String(rateInput.value).replace(/\D/g,'');

}

function getRateValue(){

    return Number(getRateDigits() || 0);

}

function formatRateInputDisplay(){

    const digits = getRateDigits();

    rateInput.value = Number(digits || 0).toLocaleString(currentLang === 'vi' ? 'vi-VN' : 'ko-KR');

}

function adjustRateInputWidth(){

    const length = getRateDigits().length;

    let newWidth = 60 + Math.max(0, Math.min(12, length) - 4) * 8;

    if (length < 4) newWidth = 60;

    rateInput.style.width = `${newWidth}px`;

}

// Ng√¥n ng·ªØ

function setLanguage(lang){

    currentLang = lang;

    localStorage.setItem('currentLang', lang);

    document.querySelectorAll('[data-i18n]').forEach(el => {

        const key = el.getAttribute('data-i18n');

        if (el.querySelector && el.querySelector('#modalDate')) {

            const currentDate = el.querySelector('#modalDate')?.textContent || '';

            el.innerHTML = `${getTranslation(key)} <span id="modalDate">${currentDate}</span>`;

        } else {

            el.textContent = getTranslation(key);

        }

    });

    // X·ª≠ l√Ω placeholder cho input
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {

        const key = el.getAttribute('data-i18n-placeholder');

        if (el.tagName === 'INPUT') {

            el.placeholder = getTranslation(key);

        } else if (el.tagName === 'LABEL') {

            el.title = getTranslation(key);

        }

    });

    const headers = document.getElementById('calendarHeaders').children;

    translations[currentLang].days.forEach((d,i)=>headers[i].textContent=d);

    currencyUnitSpan.textContent = translations[currentLang].currency;

    document.querySelector('.summary .red-unit').textContent = translations[currentLang].unit_vnd;

    langToggleBtn.textContent = lang === 'vi' ? 'üá∞üá∑ Korean' : 'üáªüá≥ Ti·∫øng Vi·ªát';

    renderCalendar();

    renderJobList();

}

langToggleBtn.onclick = () => setLanguage(currentLang === 'vi' ? 'ko' : 'vi');

// Jobs

function ensureJobs(){

    jobs = JSON.parse(localStorage.getItem('jobs') || '[]');

    if (jobs.length === 0){

        jobs.push({

            id: Date.now().toString(),

            name: 'C√¥ng vi·ªác Ch√≠nh',

            address: 'VƒÉn ph√≤ng/Remote',

            startDate: new Date().toISOString().split('T')[0],

            endDate: '',

            isCurrent: true,

            payday: null

        });

        localStorage.setItem('jobs', JSON.stringify(jobs));

    }

}

function saveJobs(){

    localStorage.setItem('jobs', JSON.stringify(jobs));

    ensureJobs();

    renderJobList();

}

function openJobModal(jobId = null){

    editingJobId = jobId;

    jobModal.style.display = 'flex';

    const titleKey = jobId ? 'modal_job_edit_title' : 'modal_job_add_title';

    const titleEl = document.getElementById('jobModalTitle');

    titleEl.setAttribute('data-i18n', titleKey);

    titleEl.textContent = getTranslation(titleKey);

    document.getElementById('deleteJob').style.display = jobId ? 'inline-block' : 'none';

    const set = (id,v)=>document.getElementById(id).value = v ?? '';

    if (jobId){

        const job = jobs.find(j=>j.id===jobId) || {};

        set('jobName', job.name);

        set('jobAddress', job.address);

        set('jobStartDate', job.startDate);

        set('jobEndDate', job.endDate);

        document.getElementById('jobIsCurrent').checked = !!job.isCurrent;

        document.getElementById('jobEndDate').disabled = !!job.isCurrent;

        document.getElementById('jobPayday').value = (job.payday ?? '');

        set('jobLat', job.lat);

        set('jobLng', job.lng);

        set('jobRadius', job.radius || 100);

        // Hi·ªÉn th·ªã ƒë·ªãa ch·ªâ GPS n·∫øu c√≥ GPS location

        if (job.lat && job.lng) {

            getAddressFromCoordinates(parseFloat(job.lat), parseFloat(job.lng));

        } else {

            document.getElementById('locationAddressDisplay').style.display = 'none';

        }

    } else {

        set('jobName',''); set('jobAddress','');

        set('jobStartDate', new Date().toISOString().split('T')[0]);

        set('jobEndDate','');

        document.getElementById('jobIsCurrent').checked = true;

        document.getElementById('jobEndDate').disabled = true;

        document.getElementById('jobPayday').value = '';

        set('jobLat',''); set('jobLng','');

        set('jobRadius', 100);

        // ·∫®n ƒë·ªãa ch·ªâ GPS khi t·∫°o m·ªõi

        document.getElementById('locationAddressDisplay').style.display = 'none';

    }

}

document.getElementById('saveJob').onclick = () => {

    const name = document.getElementById('jobName').value.trim();

    const address = document.getElementById('jobAddress').value.trim();

    const startDate = document.getElementById('jobStartDate').value;

    const endDate = document.getElementById('jobEndDate').value;

    const isCurrent = document.getElementById('jobIsCurrent').checked;

    const paydayRaw = document.getElementById('jobPayday').value.trim();

    const payday = paydayRaw ? Math.max(1, Math.min(31, parseInt(paydayRaw,10))) : null;

    const latRaw = document.getElementById('jobLat').value.trim();

    const lngRaw = document.getElementById('jobLng').value.trim();

    const lat = latRaw ? parseFloat(latRaw) : null;

    const lng = lngRaw ? parseFloat(lngRaw) : null;

    // B√°n k√≠nh m·∫∑c ƒë·ªãnh 100m (·∫©n kh·ªèi giao di·ªán)

    const radius = 100;

    if (!name || !startDate) return alert(getTranslation('alert_job_required'));

    if (!isCurrent && endDate && new Date(startDate) > new Date(endDate)) return alert(getTranslation('alert_date_invalid'));

    if (editingJobId){

        const i = jobs.findIndex(j=>j.id===editingJobId);

        if (i !== -1) jobs[i] = { id: editingJobId, name, address, startDate, endDate, isCurrent, payday, lat, lng, radius };

    } else {

        jobs.push({ id: Date.now().toString(), name, address, startDate, endDate, isCurrent, payday, lat, lng, radius });

    }

    jobModal.style.display = 'none';

    saveJobs();

    // T·ª± ƒë·ªông b·∫≠t ch·∫•m c√¥ng t·ª± ƒë·ªông n·∫øu job c√≥ GPS location

    if (lat && lng) {

        const savedJobId = editingJobId || jobs[jobs.length - 1]?.id;

        const savedJob = jobs.find(j => j.id === savedJobId);

        if (savedJob && savedJob.lat && savedJob.lng) {

            if (!autoCheckinEnabled) {

                autoCheckinEnabled = true;

                localStorage.setItem('autoCheckinEnabled', JSON.stringify(true));

                toggleAutoCheckinBtn.classList.add('active');

                if (Notification.permission === 'default') {

                    Notification.requestPermission();

                }

                startGPSTracking();

            }

        }

    }

    renderCalendar();

};

document.getElementById('deleteJob').onclick = () => {

    if (!editingJobId) return;

    const job = jobs.find(j=>j.id===editingJobId);

    if (!confirm(getTranslation('alert_delete_confirm', job?.name || ''))) return;

    jobs = jobs.filter(j=>j.id!==editingJobId);

    for (const dateKey in workData){

        if (workData[dateKey]?.[editingJobId]){

            delete workData[dateKey][editingJobId];

            if (Object.keys(workData[dateKey]).length === 0) delete workData[dateKey];

        }

    }

    jobModal.style.display = 'none';

    saveJobs();

    renderCalendar();

};

document.getElementById('cancelJob').onclick = () => jobModal.style.display = 'none';

document.getElementById('jobIsCurrent').onchange = (e) => {

    const dis = e.target.checked;

    const endInput = document.getElementById('jobEndDate');

    endInput.disabled = dis;

    if (dis) endInput.value = '';

};

// Carousel select job

function getCurrentJobId(){

    ensureJobs();

    if (jobs.length === 0) return null;

    const scrollPos = jobCarouselDiv.scrollLeft;

    const widthPerItem = jobCarouselDiv.clientWidth || 1;

    let selectedIndex = Math.round(scrollPos / widthPerItem);

    if (selectedIndex >= jobs.length) selectedIndex = jobs.length - 1;

    if (selectedIndex < 0) selectedIndex = 0;

    const items = jobCarouselDiv.querySelectorAll('.job-item');

    items.forEach((item,i)=>item.classList.toggle('selected', i===selectedIndex));

    return jobs[selectedIndex]?.id || null;

}

jobCarouselDiv.addEventListener('scroll', () => {

    clearTimeout(jobCarouselDiv.scrollTimeout);

    jobCarouselDiv.scrollTimeout = setTimeout(() => {

        // T·ª± ƒë·ªông b·∫≠t ch·∫•m c√¥ng t·ª± ƒë·ªông khi chuy·ªÉn job c√≥ GPS location

        const currentJobId = getCurrentJobId();

        if (currentJobId) {

            const job = jobs.find(j => j.id === currentJobId);

            if (job && job.lat && job.lng && !autoCheckinEnabled) {

                autoCheckinEnabled = true;

                localStorage.setItem('autoCheckinEnabled', JSON.stringify(true));

                toggleAutoCheckinBtn.classList.add('active');

                if (Notification.permission === 'default') {

                    Notification.requestPermission();

                }

                startGPSTracking();

            }

        }

        renderCalendar();

    }, 100);

});

function renderJobList(){

    ensureJobs();

    jobCarouselDiv.innerHTML = '';

    if (jobs.length === 0){

        jobCarouselDiv.innerHTML = `<div style="color:#999;font-size:0.9em; min-width: 100%; text-align: center; padding: 15px;">${getTranslation('job_name')} (${getTranslation('modal_job_add_title').toLowerCase()})</div>`;

        jobCarouselDiv.style.border='1px dashed #ccc';

        jobCarouselDiv.style.boxShadow='none';

        jobCarouselDiv.style.background='none';

        return;

    }

    jobCarouselDiv.style.border='1px solid #e0e0e0';

    jobCarouselDiv.style.boxShadow='inset 0 0 5px rgba(0,0,0,.05)';

    jobCarouselDiv.style.background='#f7f7f7';

    jobs.forEach((job, index)=>{

        const item = document.createElement('div');

        item.className = 'job-item';

        item.dataset.id = job.id;

        const jobNumber = jobs.length > 1 ? `${index + 1}. ` : '';

        const dateStr = job.isCurrent

            ? `${getTranslation('job_date_from')} ${job.startDate.split('-').reverse().join('/')} - ${getTranslation('job_date_current')}`

            : `${getTranslation('job_date_from')} ${job.startDate.split('-').reverse().join('/')} ${getTranslation('job_date_to')} ${(job.endDate||'').split('-').reverse().join('/')}`;

        const paydayStr = job.payday ? ` | ${getTranslation('payday_label')} ${job.payday}` : '';

        const addressLabel = getTranslation('job_address');
        const addressHtml = job.address ? `<span>üìç ${addressLabel}: ${job.address}${paydayStr}</span>` : `<span>${paydayStr ? paydayStr.slice(3) : ''}</span>`;

        item.innerHTML = `<strong>${jobNumber}${job.name}</strong><span>${dateStr}</span>${addressHtml}`;

        item.onclick = (e) => { if (e.target.closest('.job-item') === item) openJobModal(job.id); };

        jobCarouselDiv.appendChild(item);

    });

    getCurrentJobId();

}

// T·ªïng theo th√°ng ho·∫∑c theo chu k·ª≥ tr·∫£ l∆∞∆°ng

function computeCycleRange(payday){

    // tr·∫£ v·ªÅ {startDate, endDate} (inclusive) theo chu k·ª≥: (payday+1) c·ªßa th√°ng tr∆∞·ªõc -> payday c·ªßa th√°ng n√†y

    const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;

    const prevYear  = currentMonth === 0 ? currentYear - 1 : currentYear;

    const prevMaxDay = daysInMonth(prevYear, prevMonth);

    const currMaxDay = daysInMonth(currentYear, currentMonth);

    const startDay = Math.min(prevMaxDay, payday) + 1; // ng√†y sau ng√†y TL th√°ng tr∆∞·ªõc

    const endDay   = Math.min(currMaxDay, payday);      // ƒë·∫øn ng√†y TL th√°ng n√†y

    const startDate = new Date(prevYear, prevMonth, startDay);

    const endDate   = new Date(currentYear, currentMonth, endDay);

    return { startDate, endDate, endDay };

}

function updateSummary(){

    const rate = getRateValue();

    const locale = currentLang === 'vi' ? 'vi-VN' : 'ko-KR';

    const currentJobId = getCurrentJobId();

    const monthKey = `${currentYear}-${pad(currentMonth + 1)}`;

    const job = jobs.find(j=>j.id===currentJobId);

    const payday = job?.payday || null;

    let totalHours = 0;

    if (payday){ // T√≠nh theo chu k·ª≥

        const { startDate, endDate } = computeCycleRange(payday);

        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate()+1)){

            const key = getDayKey(d.getFullYear(), d.getMonth(), d.getDate());

            if (workData[key]?.[currentJobId]){

                totalHours += workData[key][currentJobId].hours || 0;

            }

        }

        paydayNotice.style.display = 'none';

    } else { // Kh√¥ng c√≥ payday: t√≠nh trong th√°ng hi·ªán t·∫°i

        for (const k in workData){

            if (k.startsWith(monthKey) && workData[k]?.[currentJobId]){

                totalHours += workData[k][currentJobId].hours || 0;

            }

        }

        paydayNotice.style.display = 'block';

    }

    document.getElementById('totalHours').textContent = formatHoursToText(totalHours);

    const totalPayAmount = totalHours * rate;
    document.getElementById('totalPay').textContent = formatPayAmount(totalPayAmount, locale);

    const mm = pad(currentMonth + 1);

    if (currentLang === 'vi') {

        document.getElementById('totalHoursLabel').textContent = `T·ªïng gi·ªù th√°ng ${mm}:`;

        document.getElementById('totalPayLabel').textContent = `Thu nh·∫≠p th√°ng ${mm}:`;

    } else {

        document.getElementById('totalHoursLabel').textContent = `${mm}Ïõî Ï¥ù ÏãúÍ∞Ñ:`;

        document.getElementById('totalPayLabel').textContent = `${mm}Ïõî ÏòàÏÉÅ ÏàòÏûÖ:`;

    }

}

// Render l·ªãch

function renderCalendar(){

    const tbl = document.getElementById('calendar');

    tbl.innerHTML = '';

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();

    const totalDays = daysInMonth(currentYear, currentMonth);

    document.getElementById('monthYear').textContent = `${pad(currentMonth + 1)}/${currentYear}`;

    let day = 1;

    const rate = getRateValue();

    const locale = currentLang === 'vi' ? 'vi-VN' : 'ko-KR';

    const currencyCode = translations[currentLang].unit_vnd;

    const currentJobId = getCurrentJobId();

    const job = jobs.find(j=>j.id===currentJobId);

    const payday = job?.payday || null;

    const jobIndex = job ? jobs.findIndex(j=>j.id===currentJobId) : -1;

    const jobNumber = (jobs.length > 1 && jobIndex >= 0) ? `${jobIndex + 1}. ` : '';

    // T√≠nh to√°n ph·∫°m vi job ƒë·ªÉ ki·ªÉm tra ng√†y tr·∫£ l∆∞∆°ng
    let jobStartDate = null;
    let jobEndDate = null;
    if (job) {
        jobStartDate = new Date(job.startDate);
        jobStartDate.setHours(0, 0, 0, 0);
        jobEndDate = job.isCurrent ? new Date() : (job.endDate ? new Date(job.endDate) : null);
        if (jobEndDate) jobEndDate.setHours(23, 59, 59, 999);
    }

    // H√†m ki·ªÉm tra ng√†y c√≥ ph·∫£i ng√†y tr·∫£ l∆∞∆°ng v√† n·∫±m trong ph·∫°m vi job
    function isPaydayInRange(dayNum) {
        if (!payday || !job) return false;
        const actualPayday = Math.min(payday, daysInMonth(currentYear, currentMonth));
        if (dayNum !== actualPayday) return false;
        
        const checkDate = new Date(currentYear, currentMonth, dayNum);
        checkDate.setHours(0, 0, 0, 0);
        
        if (checkDate < jobStartDate) return false;
        if (jobEndDate && checkDate > jobEndDate) return false;
        
        return true;
    }

    // H√†m ki·ªÉm tra ng√†y c√≥ ph·∫£i ng√†y b·∫Øt ƒë·∫ßu ho·∫∑c k·∫øt th√∫c c·ªßa job
    function isJobDateInRange(dayNum) {
        if (!job) return null;
        const checkDate = new Date(currentYear, currentMonth, dayNum);
        checkDate.setHours(0, 0, 0, 0);
        
        const startDate = new Date(job.startDate);
        startDate.setHours(0, 0, 0, 0);
        
        const endDate = job.endDate ? new Date(job.endDate) : null;
        if (endDate) endDate.setHours(0, 0, 0, 0);
        
        // Ki·ªÉm tra ng√†y b·∫Øt ƒë·∫ßu
        if (checkDate.getTime() === startDate.getTime()) {
            return 'start';
        }
        
        // Ki·ªÉm tra ng√†y k·∫øt th√∫c
        if (endDate && checkDate.getTime() === endDate.getTime()) {
            return 'end';
        }
        
        return null;
    }

    for (let r=0;r<6;r++){

        const tr = document.createElement('tr');

        for (let c=0;c<7;c++){

            const td = document.createElement('td');

            if ((r===0 && c<firstDay) || day>totalDays){

                td.innerHTML = '';

            } else {

                const dkey = getDayKey(currentYear, currentMonth, day);

                const dayData = workData[dkey] || {};

                const info = currentJobId ? (dayData[currentJobId] || {}) : {};

                const hours = info.hours || 0;

                // Ki·ªÉm tra xem c√≥ ph·∫£i ng√†y hi·ªán t·∫°i kh√¥ng
                const today = new Date();
                today.setHours(0, 0, 0, 0); // ƒê·∫∑t v·ªÅ 00:00:00 ƒë·ªÉ so s√°nh ch√≠nh x√°c
                const checkDate = new Date(currentYear, currentMonth, day);
                checkDate.setHours(0, 0, 0, 0);
                const isToday = checkDate.getTime() === today.getTime();

                let contentHTML = `<span>${day}</span>`;
                
                if (isToday) {
                    contentHTML += `<div class="today-dot"></div>`;
                }

                if (hours > 0){

                    const pay = hours * rate;

                    contentHTML += `

                        <div class="hours-display">${formatHoursToWorkTime(hours)}</div>

                        <div class="pay-display">${formatPayAmount(pay, locale)} ${currencyCode}</div>

                    `;

                }

                td.className = 'day';

                // Thu th·∫≠p t·∫•t c·∫£ c√°c ghi ch√∫ c·∫ßn hi·ªÉn th·ªã
                const notes = [];
                
                // Ki·ªÉm tra ng√†y tr·∫£ l∆∞∆°ng cho t·ª´ng ng√†y trong th√°ng
                if (isPaydayInRange(day)){
                    td.classList.add('payday-cell');
                    notes.push(`<div class="payday-note">${jobNumber}${getTranslation('payday_note')}</div>`);
                }

                // Ki·ªÉm tra ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c c·ªßa job
                const jobDateType = isJobDateInRange(day);
                if (jobDateType === 'start') {
                    td.classList.add('job-date-cell');
                    notes.push(`<div class="job-date-note">${jobNumber}${getTranslation('job_start_date_note')}</div>`);
                } else if (jobDateType === 'end') {
                    td.classList.add('job-date-cell');
                    notes.push(`<div class="job-date-note">${jobNumber}${getTranslation('job_end_date_note')}</div>`);
                }

                // Hi·ªÉn th·ªã t·∫•t c·∫£ ghi ch√∫ trong container n·∫øu c√≥
                if (notes.length > 0) {
                    contentHTML += `<div class="notes-container">${notes.join('')}</div>`;
                }

                td.innerHTML = contentHTML;

                td.dataset.key = dkey;

                td.onclick = (e)=>{ if (e.currentTarget.innerHTML !== '') openModal(dkey); };

                day++;

            }

            tr.appendChild(td);

        }

        tbl.appendChild(tr);

        if (day > totalDays) break;

    }

    updateSummary();
    
    // Th√™m hi·ªáu ·ª©ng fade-in cho calendar m·ªõi
    const ct = document.getElementById('calendarTable');
    if (ct) {
        const table = ct.querySelector('table');
        if (table) {
            table.classList.add('fade-in');
            setTimeout(() => table.classList.remove('fade-in'), 250);
        }
    }

}

// Modal th·ªùi gian

function openModal(key){

    timeModal.style.display = 'flex';

    timeModal.dataset.key = key;

    const [year, month, day] = key.split('-');

    const dateText = `${day}/${month}`;

    document.getElementById('modalDate').textContent = dateText;

    const currentJobId = getCurrentJobId();

    if (!currentJobId){

        alert(getTranslation('alert_time_job_required'));

        timeModal.style.display = 'none';

        return;

    }

    const info = (workData[key] && workData[key][currentJobId]) || {};

    document.getElementById('timeIn').value = info.in || '09:00';

    document.getElementById('timeOut').value = info.out || '18:00';

    document.getElementById('deleteTime').style.display = info.hours ? 'inline-block' : 'none';

}

document.getElementById('saveTime').onclick = () => {

    const key = timeModal.dataset.key;

    const currentJobId = getCurrentJobId();

    if (!currentJobId) return alert(getTranslation('alert_time_job_required'));

    const tin = document.getElementById('timeIn').value;

    const tout = document.getElementById('timeOut').value;

    const [y,m,d] = key.split('-').map(Number);

    const timeIn = new Date(y, m-1, d, ...tin.split(':').map(Number));

    let timeOut = new Date(y, m-1, d, ...tout.split(':').map(Number));

    if (timeOut <= timeIn) timeOut.setDate(timeOut.getDate() + 1);

    const hrs = (timeOut - timeIn) / 36e5;

    if (hrs <= 0){

        if (workData[key]?.[currentJobId]) delete workData[key][currentJobId];

        if (workData[key] && Object.keys(workData[key]).length === 0) delete workData[key];

    } else {

        workData[key] = workData[key] || {};

        workData[key][currentJobId] = { in: tin, out: tout, hours: hrs };

    }

    localStorage.setItem('workData', JSON.stringify(workData));

    timeModal.style.display = 'none';

    renderCalendar();

};

document.getElementById('deleteTime').onclick = () => {

    const key = timeModal.dataset.key;

    const currentJobId = getCurrentJobId();

    const jobName = jobs.find(j=>j.id===currentJobId)?.name || '';

    if (!confirm(getTranslation('alert_delete_time_confirm', jobName))) return;

    if (workData[key]?.[currentJobId]){

        delete workData[key][currentJobId];

        if (Object.keys(workData[key]).length === 0) delete workData[key];

    }

    localStorage.setItem('workData', JSON.stringify(workData));

    timeModal.style.display = 'none';

    renderCalendar();

};

document.getElementById('cancelTime').onclick = () => (timeModal.style.display = 'none');

// C√†i ƒë·∫∑t

function updateSettings(){

    appSettings.rate = getRateValue();

    localStorage.setItem('appSettings', JSON.stringify(appSettings));

    renderCalendar();

}

// ƒêi·ªÅu h∆∞·ªõng th√°ng

function goToNextMonth(){ 
    const ct = document.getElementById('calendarTable');
    if (ct) {
        ct.classList.add('flipping-left');
        setTimeout(() => {
            currentMonth++; 
            if (currentMonth > 11){ currentMonth = 0; currentYear++; } 
            renderCalendar();
            setTimeout(() => ct.classList.remove('flipping-left'), 10);
        }, 150);
    } else {
        currentMonth++; 
        if (currentMonth > 11){ currentMonth = 0; currentYear++; } 
        renderCalendar();
    }
}

function goToPrevMonth(){ 
    const ct = document.getElementById('calendarTable');
    if (ct) {
        ct.classList.add('flipping-right');
        setTimeout(() => {
            currentMonth--; 
            if (currentMonth < 0){ currentMonth = 11; currentYear--; } 
            renderCalendar();
            setTimeout(() => ct.classList.remove('flipping-right'), 10);
        }, 150);
    } else {
        currentMonth--; 
        if (currentMonth < 0){ currentMonth = 11; currentYear--; } 
        renderCalendar();
    }
}

document.getElementById('prevMonth').onclick = goToPrevMonth;

document.getElementById('nextMonth').onclick = goToNextMonth;

// Rate events

rateInput.oninput = () => { formatRateInputDisplay(); adjustRateInputWidth(); };

rateInput.onchange = () => { formatRateInputDisplay(); updateSettings(); };

// N√∫t m√°y t√≠nh

const calcModal = document.getElementById('calcModal');

const calcDisplay = document.getElementById('calcDisplay');

function openCalc(){ calcDisplay.value = calcDisplay.value || ''; calcModal.style.display = 'flex'; }

function closeCalc(){ calcModal.style.display = 'none'; }

document.getElementById('openCalc').onclick = openCalc;

document.getElementById('closeCalc')?.addEventListener('click', closeCalc);

calcModal.addEventListener('click', (e)=>{ if (e.target === calcModal) closeCalc(); });

document.querySelector('#calcModal .calc-grid').addEventListener('click', (e)=>{

    const btn = e.target.closest('button'); if (!btn || btn.id === 'closeCalc') return;

    const action = btn.getAttribute('data-action'); const val = btn.getAttribute('data-val');

    if (action === 'clear'){ calcDisplay.value = ''; return; }

    if (action === 'back'){ calcDisplay.value = calcDisplay.value.slice(0,-1); return; }

    if (action === 'equals'){

        const expr = (calcDisplay.value || '').replace(/[^0-9+\-*/().]/g,'');

        if (!expr) return;

        try{

            if (/[*+/)]\s*[*+/)]/.test(expr)) throw new Error('Bad');

            const result = Function(`"use strict";return (${expr})`)();

            calcDisplay.value = (result ?? '').toString();

        }catch{

            calcDisplay.value = 'L·ªói'; setTimeout(()=>{ if (calcDisplay.value === 'L·ªói') calcDisplay.value = ''; },800);

        }

        return;

    }

    if (val){

        if (val === '.'){

            const parts = calcDisplay.value.split(/[*+\-/()]/);

            const last = parts[parts.length-1] || '';

            if (last.includes('.')) return;

        }

        calcDisplay.value += val;

    }

});

// Open job modal

document.getElementById('openJobModal').onclick = () => openJobModal();

// Click v√†o th√°ng/nƒÉm ƒë·ªÉ quay v·ªÅ th√°ng hi·ªán t·∫°i
document.getElementById('monthYear').onclick = () => {
    const today = new Date();
    currentMonth = today.getMonth();
    currentYear = today.getFullYear();
    renderCalendar();
};

// GPS Auto Check-in

let autoCheckinEnabled = JSON.parse(localStorage.getItem('autoCheckinEnabled') || 'false');

let autoCheckOnOpenEnabled = JSON.parse(localStorage.getItem('autoCheckOnOpenEnabled') || 'true'); // M·∫∑c ƒë·ªãnh b·∫≠t

let gpsWatchId = null;

let lastCheckinStatus = null; // 'in' or 'out' or null

// T√≠nh kho·∫£ng c√°ch gi·ªØa 2 ƒëi·ªÉm GPS (Haversine formula)

function getDistance(lat1, lng1, lat2, lng2) {

    const R = 6371000; // B√°n k√≠nh Tr√°i ƒê·∫•t (m√©t)

    const dLat = (lat2 - lat1) * Math.PI / 180;

    const dLng = (lng2 - lng1) * Math.PI / 180;

    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +

              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *

              Math.sin(dLng/2) * Math.sin(dLng/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; // Kho·∫£ng c√°ch (m√©t)

}

// Ki·ªÉm tra v√† t·ª± ƒë·ªông ch·∫•m c√¥ng (khi m·ªü ·ª©ng d·ª•ng - m·ªôt l·∫ßn)

function checkLocationOnOpen(position) {

    const currentJobId = getCurrentJobId();

    if (!currentJobId) return;

    const job = jobs.find(j => j.id === currentJobId);

    if (!job || !job.lat || !job.lng) return;

    const distance = getDistance(position.coords.latitude, position.coords.longitude, job.lat, job.lng);

    const radius = job.radius || 100;

    const isInRange = distance <= radius;

    const today = new Date();

    const todayKey = getDayKey(today.getFullYear(), today.getMonth(), today.getDate());

    const todayData = workData[todayKey] || {};

    const todayJobData = todayData[currentJobId] || {};

    const now = new Date();

    const currentHour = now.getHours();

    const currentMinute = now.getMinutes();

    const currentTime = `${pad(currentHour)}:${pad(currentMinute)}`;

    // N·∫øu ƒëang ·ªü trong ph·∫°m vi v√† ch∆∞a ch·∫•m c√¥ng v√†o h√¥m nay

    if (isInRange && !todayJobData.in) {

        workData[todayKey] = workData[todayKey] || {};

        workData[todayKey][currentJobId] = {

            in: currentTime,

            out: '',

            hours: 0

        };

        localStorage.setItem('workData', JSON.stringify(workData));

        // Hi·ªÉn th·ªã popup x√°c nh·∫≠n

        showConfirmCheckinModal('in', currentTime, '', 0, todayKey);

        showNotification(getTranslation('notification_checkin'));

        renderCalendar();

    }

    // N·∫øu ƒë√£ ch·∫•m c√¥ng v√†o nh∆∞ng ƒëang ·ªü ngo√†i ph·∫°m vi v√† ch∆∞a ch·∫•m c√¥ng ra

    else if (!isInRange && todayJobData.in && !todayJobData.out) {

        const [y, m, d] = todayKey.split('-').map(Number);

        const timeIn = new Date(y, m-1, d, ...todayJobData.in.split(':').map(Number));

        const timeOut = new Date(y, m-1, d, currentHour, currentMinute);

        if (timeOut <= timeIn) timeOut.setDate(timeOut.getDate() + 1);

        const hrs = (timeOut - timeIn) / 36e5;

        workData[todayKey][currentJobId] = {

            in: todayJobData.in,

            out: currentTime,

            hours: hrs

        };

        localStorage.setItem('workData', JSON.stringify(workData));

        // Hi·ªÉn th·ªã popup x√°c nh·∫≠n

        showConfirmCheckinModal('out', todayJobData.in, currentTime, hrs, todayKey);

        showNotification(getTranslation('notification_checkout'));

        renderCalendar();

    }

}

// Ki·ªÉm tra v√† t·ª± ƒë·ªông ch·∫•m c√¥ng (theo d√µi li√™n t·ª•c - khi b·∫≠t auto check-in)

function checkAutoCheckin(position) {

    if (!autoCheckinEnabled) return;

    const currentJobId = getCurrentJobId();

    if (!currentJobId) return;

    const job = jobs.find(j => j.id === currentJobId);

    if (!job || !job.lat || !job.lng) return;

    const distance = getDistance(position.coords.latitude, position.coords.longitude, job.lat, job.lng);

    const radius = job.radius || 100;

    const isInRange = distance <= radius;

    const today = new Date();

    const todayKey = getDayKey(today.getFullYear(), today.getMonth(), today.getDate());

    const todayData = workData[todayKey] || {};

    const todayJobData = todayData[currentJobId] || {};

    const now = new Date();

    const currentHour = now.getHours();

    const currentMinute = now.getMinutes();

    const currentTime = `${pad(currentHour)}:${pad(currentMinute)}`;

    if (isInRange && lastCheckinStatus !== 'in') {

        // T·ª± ƒë·ªông ch·∫•m c√¥ng v√†o

        if (!todayJobData.in || todayJobData.out) {

            workData[todayKey] = workData[todayKey] || {};

            workData[todayKey][currentJobId] = {

                in: currentTime,

                out: '',

                hours: 0

            };

            localStorage.setItem('workData', JSON.stringify(workData));

            lastCheckinStatus = 'in';

            // Hi·ªÉn th·ªã popup x√°c nh·∫≠n

            showConfirmCheckinModal('in', currentTime, '', 0, todayKey);

            showNotification(getTranslation('notification_checkin'));

            renderCalendar();

        }

    } else if (!isInRange && lastCheckinStatus === 'in' && todayJobData.in && !todayJobData.out) {

        // T·ª± ƒë·ªông ch·∫•m c√¥ng ra

        const [y, m, d] = todayKey.split('-').map(Number);

        const timeIn = new Date(y, m-1, d, ...todayJobData.in.split(':').map(Number));

        const timeOut = new Date(y, m-1, d, currentHour, currentMinute);

        if (timeOut <= timeIn) timeOut.setDate(timeOut.getDate() + 1);

        const hrs = (timeOut - timeIn) / 36e5;

        workData[todayKey][currentJobId] = {

            in: todayJobData.in,

            out: currentTime,

            hours: hrs

        };

        localStorage.setItem('workData', JSON.stringify(workData));

        lastCheckinStatus = 'out';

        // Hi·ªÉn th·ªã popup x√°c nh·∫≠n

        showConfirmCheckinModal('out', todayJobData.in, currentTime, hrs, todayKey);

        showNotification(getTranslation('notification_checkout'));

        renderCalendar();

    } else if (!isInRange) {

        lastCheckinStatus = 'out';

    }

}

// B·∫Øt ƒë·∫ßu theo d√µi GPS

function startGPSTracking() {

    if (!navigator.geolocation) {

        alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ GPS');

        return;

    }

    const options = {

        enableHighAccuracy: true,

        timeout: 10000,

        maximumAge: 60000

    };

    gpsWatchId = navigator.geolocation.watchPosition(

        (position) => checkAutoCheckin(position),

        (error) => console.error('GPS Error:', error),

        options

    );

    // Ki·ªÉm tra ngay l·∫≠p t·ª©c

    navigator.geolocation.getCurrentPosition(

        (position) => checkAutoCheckin(position),

        (error) => console.error('GPS Error:', error),

        options

    );

}

// D·ª´ng theo d√µi GPS

function stopGPSTracking() {

    if (gpsWatchId !== null) {

        navigator.geolocation.clearWatch(gpsWatchId);

        gpsWatchId = null;

    }

}

// Hi·ªÉn th·ªã th√¥ng b√°o

function showNotification(message) {

    if ('Notification' in window && Notification.permission === 'granted') {

        new Notification(message);

    } else if ('Notification' in window && Notification.permission !== 'denied') {

        Notification.requestPermission().then(permission => {

            if (permission === 'granted') {

                new Notification(message);

            }

        });

    }

    // Fallback: hi·ªÉn th·ªã alert n·∫øu kh√¥ng c√≥ notification

    console.log(message);

}

// Hi·ªÉn th·ªã popup x√°c nh·∫≠n ch·∫•m c√¥ng t·ª± ƒë·ªông

function showConfirmCheckinModal(type, timeIn, timeOut, hours, dateKey) {

    const confirmModal = document.getElementById('confirmCheckinModal');

    const confirmMessage = document.getElementById('confirmCheckinMessage');

    const confirmTime = document.getElementById('confirmCheckinTime');

    const confirmType = document.getElementById('confirmCheckinType');

    const confirmTimeDetail = document.getElementById('confirmCheckinTimeDetail');

    const confirmOutTimeDiv = document.getElementById('confirmCheckinOutTime');

    const confirmOutTimeDetail = document.getElementById('confirmCheckoutTimeDetail');

    const confirmHoursDiv = document.getElementById('confirmCheckinHours');

    const confirmTotalHoursDetail = document.getElementById('confirmTotalHoursDetail');

    const confirmDate = document.getElementById('confirmCheckinDate');

    // L·∫•y th√¥ng tin ng√†y t·ª´ dateKey

    const [y, m, d] = dateKey.split('-').map(Number);

    const dateStr = `${pad(d)}/${pad(m)}/${y}`;

    confirmDate.textContent = dateStr;

    // Thi·∫øt l·∫≠p th√¥ng tin

    if (type === 'in') {

        confirmMessage.innerHTML = `ƒê√£ t·ª± ƒë·ªông ch·∫•m c√¥ng v√†o l√∫c <strong>${timeIn}</strong> ng√†y ${dateStr}`;

        confirmTime.textContent = timeIn;

        confirmType.textContent = getTranslation('checkin_type_in');

        confirmTimeDetail.textContent = timeIn;

        confirmOutTimeDiv.style.display = 'none';

        confirmHoursDiv.style.display = 'none';

    } else if (type === 'out') {

        confirmMessage.innerHTML = `ƒê√£ t·ª± ƒë·ªông ch·∫•m c√¥ng ra l√∫c <strong>${timeOut}</strong> ng√†y ${dateStr}`;

        confirmTime.textContent = timeOut;

        confirmType.textContent = getTranslation('checkin_type_out');

        confirmTimeDetail.textContent = timeIn;

        confirmOutTimeDiv.style.display = 'block';

        confirmOutTimeDetail.textContent = timeOut;

        confirmHoursDiv.style.display = 'block';

        confirmTotalHoursDetail.textContent = formatHoursToText(hours);

    }

    // Hi·ªÉn th·ªã modal

    confirmModal.style.display = 'flex';

    // L∆∞u th√¥ng tin ƒë·ªÉ x·ª≠ l√Ω khi s·ª≠a

    confirmModal.dataset.dateKey = dateKey;

    confirmModal.dataset.type = type;

}

// Modal Ch·∫•m c√¥ng t·ª± ƒë·ªông

const autoCheckinModal = document.getElementById('autoCheckinModal');

const openAutoCheckinModalBtn = document.getElementById('openAutoCheckinModal');

const autoCheckinOnBtn = document.getElementById('autoCheckinOn');

const autoCheckinOffBtn = document.getElementById('autoCheckinOff');

// M·ªü modal

openAutoCheckinModalBtn.onclick = () => {

    autoCheckinModal.style.display = 'flex';

};

// ƒê√≥ng modal khi click ra ngo√†i

autoCheckinModal.addEventListener('click', (e) => {

    if (e.target === autoCheckinModal) {

        autoCheckinModal.style.display = 'none';

    }

});

// N√∫t B·∫≠t

autoCheckinOnBtn.onclick = () => {

    autoCheckOnOpenEnabled = true;

    localStorage.setItem('autoCheckOnOpenEnabled', JSON.stringify(true));

    autoCheckinEnabled = true;

    localStorage.setItem('autoCheckinEnabled', JSON.stringify(true));

    openAutoCheckinModalBtn.classList.add('active');

    autoCheckinModal.style.display = 'none';

    // Ki·ªÉm tra h·ªó tr·ª£ GPS

    if (!navigator.geolocation) {

        alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ GPS. Vui l√≤ng s·ª≠ d·ª•ng tr√¨nh duy·ªát kh√°c ho·∫∑c c·∫≠p nh·∫≠t tr√¨nh duy·ªát.');

        return;

    }

    // Y√™u c·∫ßu quy·ªÅn GPS ngay l·∫≠p t·ª©c

    const options = {

        enableHighAccuracy: true,

        timeout: 15000,

        maximumAge: 0

    };

    // Y√™u c·∫ßu quy·ªÅn GPS v√† b·∫≠t tracking

    navigator.geolocation.getCurrentPosition(

        (position) => {

            // GPS ƒë√£ ƒë∆∞·ª£c b·∫≠t th√†nh c√¥ng

            console.log('GPS ƒë√£ ƒë∆∞·ª£c b·∫≠t:', position.coords.latitude, position.coords.longitude);

            // B·∫≠t theo d√µi li√™n t·ª•c

            startGPSTracking();

            // Ki·ªÉm tra v√† ch·∫•m c√¥ng n·∫øu c√≥ GPS location trong job

            const currentJobId = getCurrentJobId();

            if (currentJobId) {

                const job = jobs.find(j => j.id === currentJobId);

                if (job && job.lat && job.lng) {

                    checkLocationOnOpen(position);

                }

            }

            // Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o

            if (Notification.permission === 'default') {

                Notification.requestPermission().then(permission => {

                    if (permission === 'granted') {

                        showNotification('Ch·∫•m c√¥ng t·ª± ƒë·ªông ƒë√£ ƒë∆∞·ª£c b·∫≠t th√†nh c√¥ng!');

                    }

                });

            } else if (Notification.permission === 'granted') {

                showNotification('Ch·∫•m c√¥ng t·ª± ƒë·ªông ƒë√£ ƒë∆∞·ª£c b·∫≠t th√†nh c√¥ng!');

            }

        },

        (error) => {

            // X·ª≠ l√Ω l·ªói GPS

            let errorMsg = 'Kh√¥ng th·ªÉ truy c·∫≠p GPS: ';

            switch(error.code) {

                case error.PERMISSION_DENIED:

                    errorMsg += 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠. Vui l√≤ng b·∫≠t GPS v√† cho ph√©p tr√¨nh duy·ªát truy c·∫≠p v·ªã tr√≠ trong c√†i ƒë·∫∑t.';

                    break;

                case error.POSITION_UNAVAILABLE:

                    errorMsg += 'Th√¥ng tin v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng. Vui l√≤ng b·∫≠t GPS tr√™n thi·∫øt b·ªã.';

                    break;

                case error.TIMEOUT:

                    errorMsg += 'Y√™u c·∫ßu v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian ch·ªù. Vui l√≤ng th·ª≠ l·∫°i v√† ƒë·∫£m b·∫£o GPS ƒë√£ b·∫≠t.';

                    break;

                default:

                    errorMsg += 'L·ªói kh√¥ng x√°c ƒë·ªãnh: ' + error.message;

                    break;

            }

            alert(errorMsg);

            console.error('GPS Error:', error);

        },

        options

    );

};

// N√∫t T·∫Øt

autoCheckinOffBtn.onclick = () => {

    autoCheckOnOpenEnabled = false;

    localStorage.setItem('autoCheckOnOpenEnabled', JSON.stringify(false));

    autoCheckinEnabled = false;

    localStorage.setItem('autoCheckinEnabled', JSON.stringify(false));

    openAutoCheckinModalBtn.classList.remove('active');

    autoCheckinModal.style.display = 'none';

    // D·ª´ng ho√†n to√†n GPS tracking

    stopGPSTracking();

    lastCheckinStatus = null;

    console.log('Ch·∫•m c√¥ng t·ª± ƒë·ªông ƒë√£ ƒë∆∞·ª£c t·∫Øt');

};

// Modal X√°c nh·∫≠n ch·∫•m c√¥ng

const confirmCheckinModal = document.getElementById('confirmCheckinModal');

const confirmCheckinOkBtn = document.getElementById('confirmCheckinOkBtn');

const editCheckinBtn = document.getElementById('editCheckinBtn');

// N√∫t OK - X√°c nh·∫≠n v√† ƒë√≥ng modal

confirmCheckinOkBtn.onclick = () => {

    confirmCheckinModal.style.display = 'none';

};

// N√∫t S·ª≠a l·∫°i - M·ªü modal ch·ªânh s·ª≠a gi·ªù

editCheckinBtn.onclick = () => {

    const dateKey = confirmCheckinModal.dataset.dateKey;

    if (dateKey) {

        // ƒê√≥ng modal x√°c nh·∫≠n

        confirmCheckinModal.style.display = 'none';

        // M·ªü modal ch·ªânh s·ª≠a gi·ªù

        openModal(dateKey);

    }

};

// ƒê√≥ng modal x√°c nh·∫≠n khi click ra ngo√†i

confirmCheckinModal.addEventListener('click', (e) => {

    if (e.target === confirmCheckinModal) {

        confirmCheckinModal.style.display = 'none';

    }

});

// L·∫•y ƒë·ªãa ch·ªâ t·ª´ t·ªça ƒë·ªô GPS (Reverse Geocoding)

function getAddressFromCoordinates(lat, lng) {

    const addressDisplay = document.getElementById('locationAddressDisplay');

    const addressText = document.getElementById('locationAddressText');

    addressText.textContent = 'ƒêang t·∫£i ƒë·ªãa ch·ªâ...';

    addressDisplay.style.display = 'block';

    // S·ª≠ d·ª•ng Nominatim API (OpenStreetMap) - mi·ªÖn ph√≠

    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ko`, {

        headers: {

            'User-Agent': 'ChamCongApp/1.0'

        }

    })

    .then(response => response.json())

    .then(data => {

        if (data && data.address) {

            const addr = data.address;

            let addressParts = [];

            // X√¢y d·ª±ng ƒë·ªãa ch·ªâ t·ª´ c√°c th√†nh ph·∫ßn

            if (addr.road || addr.street) addressParts.push(addr.road || addr.street);

            if (addr.house_number) addressParts.push(addr.house_number);

            if (addr.ward || addr.suburb) addressParts.push(addr.ward || addr.suburb);

            if (addr.district || addr.city_district) addressParts.push(addr.district || addr.city_district);

            if (addr.city || addr.town || addr.village) addressParts.push(addr.city || addr.town || addr.village);

            if (addr.state || addr.province) addressParts.push(addr.state || addr.province);

            if (addr.country) {

                const countryName = addr.country === 'Vi·ªát Nam' || addr.country === 'Vietnam' ? 'Vi·ªát Nam' : addr.country;

                addressParts.push(countryName);

            }

            const fullAddress = addressParts.length > 0 ? addressParts.join(', ') : data.display_name || 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ƒë·ªãa ch·ªâ';

            addressText.textContent = fullAddress;

        } else {

            addressText.textContent = 'Kh√¥ng th·ªÉ l·∫•y ƒë·ªãa ch·ªâ. Vƒ© ƒë·ªô: ' + lat + ', Kinh ƒë·ªô: ' + lng;

        }

    })

    .catch(error => {

        console.error('L·ªói khi l·∫•y ƒë·ªãa ch·ªâ:', error);

        addressText.textContent = 'Kh√¥ng th·ªÉ l·∫•y ƒë·ªãa ch·ªâ. Vƒ© ƒë·ªô: ' + lat + ', Kinh ƒë·ªô: ' + lng;

    });

}

// T√¨m ki·∫øm ƒë·ªãa ch·ªâ v√† chuy·ªÉn ƒë·ªïi th√†nh t·ªça ƒë·ªô GPS (Geocoding)

function getCoordinatesFromAddress(address) {

    if (!address || !address.trim()) {

        alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ c·∫ßn t√¨m ki·∫øm.');

        return;

    }

    const addressDisplay = document.getElementById('locationAddressDisplay');

    const addressText = document.getElementById('locationAddressText');

    const searchBtn = document.getElementById('searchAddressBtn');

    const originalText = searchBtn.textContent;

    addressText.textContent = 'ƒêang t√¨m ki·∫øm ƒë·ªãa ch·ªâ...';

    addressDisplay.style.display = 'block';

    searchBtn.textContent = 'ƒêang t√¨m...';

    searchBtn.disabled = true;

    // S·ª≠ d·ª•ng Nominatim API (OpenStreetMap) - Geocoding

    const encodedAddress = encodeURIComponent(address.trim());

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1&addressdetails=1&accept-language=ko`, {

        headers: {

            'User-Agent': 'ChamCongApp/1.0'

        }

    })

    .then(response => response.json())

    .then(data => {

        searchBtn.textContent = originalText;

        searchBtn.disabled = false;

        if (data && data.length > 0) {

            const result = data[0];

            const lat = parseFloat(result.lat);

            const lng = parseFloat(result.lon);

            // L∆∞u t·ªça ƒë·ªô v√†o hidden inputs

            document.getElementById('jobLat').value = lat.toFixed(6);

            document.getElementById('jobLng').value = lng.toFixed(6);

            // Hi·ªÉn th·ªã ƒë·ªãa ch·ªâ ƒë√£ t√¨m th·∫•y

            const displayName = result.display_name || address;

            addressText.textContent = displayName;

            console.log('ƒê√£ t√¨m th·∫•y ƒë·ªãa ch·ªâ:', displayName, 'T·ªça ƒë·ªô:', lat, lng);

        } else {

            addressText.textContent = 'Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ. Vui l√≤ng th·ª≠ l·∫°i v·ªõi ƒë·ªãa ch·ªâ kh√°c.';

            console.log('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ cho:', address);

        }

    })

    .catch(error => {

        console.error('L·ªói khi t√¨m ki·∫øm ƒë·ªãa ch·ªâ:', error);

        searchBtn.textContent = originalText;

        searchBtn.disabled = false;

        addressText.textContent = 'L·ªói khi t√¨m ki·∫øm ƒë·ªãa ch·ªâ. Vui l√≤ng th·ª≠ l·∫°i.';

    });

}

// N√∫t t√¨m ki·∫øm ƒë·ªãa ch·ªâ (s·ª≠ d·ª•ng √¥ ƒê·ªãa ch·ªâ ch√≠nh)

document.getElementById('searchAddressBtn').onclick = () => {

    const addressInput = document.getElementById('jobAddress');

    const address = addressInput.value.trim();

    if (!address) {

        alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ v√†o √¥ "ƒê·ªãa ch·ªâ" ·ªü tr√™n tr∆∞·ªõc khi t√¨m ki·∫øm.');

        return;

    }

    getCoordinatesFromAddress(address);

};

// Cho ph√©p nh·∫•n Enter trong √¥ ƒê·ªãa ch·ªâ ƒë·ªÉ t√¨m ki·∫øm

document.getElementById('jobAddress').addEventListener('keypress', (e) => {

    if (e.key === 'Enter') {

        e.preventDefault();

        document.getElementById('searchAddressBtn').click();

    }

});

// C√°c input t·ªça ƒë·ªô ƒë√£ ƒë∆∞·ª£c ·∫©n, kh√¥ng c·∫ßn logic t·ª± ƒë·ªông c·∫≠p nh·∫≠t t·ª´ input n·ªØa

// Kh·ªüi t·∫°o

function initApp(){

    const storedSettings = JSON.parse(localStorage.getItem('appSettings') || '{}');

    appSettings = storedSettings;

    const initialRate = typeof storedSettings.rate === 'number' ? storedSettings.rate : 10000;

    rateInput.value = initialRate.toLocaleString(currentLang === 'vi' ? 'vi-VN' : 'ko-KR');

    ensureJobs();

    setLanguage(currentLang);

    renderJobList();

    renderCalendar();

    formatRateInputDisplay();

    adjustRateInputWidth();

    // Kh·ªüi t·∫°o ch·∫•m c√¥ng t·ª± ƒë·ªông

    // T·ª± ƒë·ªông b·∫≠t n·∫øu ƒë√£ c√≥ GPS location ƒë∆∞·ª£c c·∫•u h√¨nh

    const currentJobId = getCurrentJobId();

    if (currentJobId) {

        const job = jobs.find(j => j.id === currentJobId);

        if (job && job.lat && job.lng && !autoCheckinEnabled) {

            // T·ª± ƒë·ªông b·∫≠t n·∫øu c√≥ GPS location

            autoCheckinEnabled = true;

            localStorage.setItem('autoCheckinEnabled', JSON.stringify(true));

        }

    }

    // Kh·ªüi t·∫°o tr·∫°ng th√°i n√∫t Auto

    if (autoCheckOnOpenEnabled || autoCheckinEnabled) {

        openAutoCheckinModalBtn.classList.add('active');

        // B·∫≠t GPS tracking n·∫øu ƒë√£ ƒë∆∞·ª£c b·∫≠t tr∆∞·ªõc ƒë√≥

        if (autoCheckinEnabled && navigator.geolocation) {

            // Y√™u c·∫ßu quy·ªÅn GPS v√† b·∫≠t tracking

            navigator.geolocation.getCurrentPosition(

                (position) => {

                    console.log('GPS ƒë√£ ƒë∆∞·ª£c b·∫≠t khi kh·ªüi ƒë·ªông:', position.coords.latitude, position.coords.longitude);

                    startGPSTracking();

                    // Ki·ªÉm tra v√† ch·∫•m c√¥ng n·∫øu c√≥ GPS location trong job

                    const currentJobId = getCurrentJobId();

                    if (currentJobId) {

                        const job = jobs.find(j => j.id === currentJobId);

                        if (job && job.lat && job.lng) {

                            checkLocationOnOpen(position);

                        }

                    }

                },

                (error) => {

                    console.error('GPS kh√¥ng kh·∫£ d·ª•ng khi kh·ªüi ƒë·ªông:', error.message);

                    // V·∫´n th·ª≠ b·∫≠t tracking, c√≥ th·ªÉ GPS s·∫Ω ƒë∆∞·ª£c b·∫≠t sau

                    if (autoCheckinEnabled) {

                        startGPSTracking();

                    }

                },

                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }

            );

            // Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o

            if (Notification.permission === 'default') {

                Notification.requestPermission();

            }

        } else if (autoCheckOnOpenEnabled && navigator.geolocation) {

            // Ch·ªâ ki·ªÉm tra khi m·ªü ·ª©ng d·ª•ng (kh√¥ng theo d√µi li√™n t·ª•c)

            const currentJobId = getCurrentJobId();

            if (currentJobId) {

                const job = jobs.find(j => j.id === currentJobId);

                if (job && job.lat && job.lng) {

                    navigator.geolocation.getCurrentPosition(

                        (position) => checkLocationOnOpen(position),

                        (error) => console.log('GPS kh√¥ng kh·∫£ d·ª•ng:', error.message),

                        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }

                    );

                }

            }

        }

    } else {

        openAutoCheckinModalBtn.classList.remove('active');

    }

    // Vu·ªët th√°ng ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω qua document.addEventListener

}

initApp();

// Vu·ªët th√°ng - Gi·ªõi h·∫°n trong khu v·ª±c b·∫£ng l·ªãch
let sx = 0, sy = 0;
let touchInCalendar = false;

document.addEventListener('touchstart', function(e) {
    // Ki·ªÉm tra xem touch c√≥ trong calendarTable kh√¥ng
    const ct = document.getElementById('calendarTable');
    if (ct && ct.contains(e.target)) {
        touchInCalendar = true;
        sx = e.touches[0].clientX;
        sy = e.touches[0].clientY;
    } else {
        touchInCalendar = false;
    }
});

document.addEventListener('touchend', function(e) {
    // Ch·ªâ x·ª≠ l√Ω n·∫øu touch b·∫Øt ƒë·∫ßu trong calendarTable
    if (!touchInCalendar || !sx || !sy || !e.changedTouches || !e.changedTouches[0]) {
        sx = 0; sy = 0;
        touchInCalendar = false;
        return;
    }
    
    const ex = e.changedTouches[0].clientX;
    const ey = e.changedTouches[0].clientY;
    const dx = ex - sx;
    const dy = ey - sy;
    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) {
        if (dx > 0) goToPrevMonth();
        else goToNextMonth();
    }
    sx = 0; sy = 0;
    touchInCalendar = false;
});

</script>

</body>

</html>
