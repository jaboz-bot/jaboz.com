<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>B·∫£ng Ch·∫•m C√¥ng C√° Nh√¢n</title>
<style>
/* --- PH·∫¶N CSS HO√ÄN CH·ªàNH --- */
html,body{height:100%;margin:0;font-family:Arial,sans-serif;background:#f6f8f9}
.container{max-width:900px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.1)}

/* ƒê·ªãnh d·∫°ng khu v·ª±c n√∫t v√† danh s√°ch c√¥ng vi·ªác */
.top-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    margin-bottom: 5px; 
    border-bottom: 1px solid #ddd;
}
.control-group {
    display: flex;
    gap: 10px;
}
.add-job-btn, .lang-toggle-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
    white-space: nowrap; 
}
.add-job-btn {
    background: #2ecc71;
    color: #fff;
}
.lang-toggle-btn {
    background: #f1c40f; 
    color: #333;
    font-size: 0.9em;
    padding: 8px 12px;
}

/* CSS CHO CAROUSEL */
#jobCarousel {
    display: flex; 
    overflow-x: auto; 
    scroll-snap-type: x mandatory; 
    scroll-behavior: smooth; 
    -webkit-overflow-scrolling: touch; 
    margin-bottom: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 10px;
    background: #f7f7f7;
    box-shadow: inset 0 0 5px rgba(0,0,0,.05);
}
.job-item {
    min-width: 100%; 
    flex-shrink: 0; 
    padding: 5px;
    font-size: 0.9em;
    color: #333;
    cursor: pointer;
    scroll-snap-align: start; 
    box-sizing: border-box;
}
.job-item.selected {
    background-color: #d7e8f5; 
    border: 1px solid #2980b9;
    border-radius: 5px;
}
.job-item strong { 
    color: #2980b9; 
    display: block;
    font-size: 1.1em;
}
.job-item span { 
    color: #7f8c8d; 
    display: block;
    margin-top: 3px;
    font-size: 0.85em;
}
.job-item:hover { 
    background-color: #eaf2f8; 
}


/* CSS CHUNG B·∫¢NG L·ªäCH */
.header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #3498db;padding-bottom:10px}
.month-nav{display:flex;align-items:center;gap:8px;font-weight:bold;color:#27ae60}
.arrow{cursor:pointer;user-select:none;font-size:1.3em}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    table-layout: fixed; 
}
th,td{border:1px solid #ccc;text-align:center;padding:5px;font-size:.85em}
th{background:#eaf2f8}

/* ƒê·ªãnh d·∫°ng √¥ ng√†y */
.day{position:relative;height:80px;vertical-align:top;cursor:pointer; padding-top: 20px;} 
.day span{position:absolute;top:3px;left:5px;font-weight:bold;color:#2980b9}

/* CƒÇN GI·ªÆA GI·ªú C√îNG V√Ä TI·ªÄN */
.day div {
    /* ƒê·∫£m b·∫£o c·∫£ 2 DIV gi·ªù v√† ti·ªÅn ƒë·ªÅu cƒÉn gi·ªØa */
    width: 100%; 
    margin-top: 5px; 
    text-align: center; 
    line-height: 1.2;
}

/* ƒê·ªãnh d·∫°ng Gi·ªù C√¥ng */
.day .hours-display {
    font-weight: bold;
    color: #2ecc71; /* Xanh l√° c√¢y */
    font-size: 0.9em;
}

/* ƒê·ªãnh d·∫°ng S·ªë Ti·ªÅn */
.day .pay-display {
    color: #e74c3c; /* M√ÄU ƒê·ªé */
    font-size: 0.8em;
    font-weight: normal;
    margin-top: 2px;
}

.summary{margin-top:20px;background:#ecf9ff;padding:10px;border-radius:5px}

/* ƒêI·ªÄU CH·ªàNH T·ªîNG GI·ªú C√îNG V√Ä ƒê∆†N V·ªä T√çNH */
#totalHours {
    font-weight: bold;
    color: #2ecc71; 
    font-size: 1.1em;
}
.summary .green-unit {
    color: #2ecc71; /* XANH L√Å C√ÇY */
    font-weight: bold;
}

/* ƒêI·ªÄU CH·ªàNH T·ªîNG THU NH·∫¨P V√Ä ƒê∆†N V·ªä T√çNH */
#totalPay {
    font-weight: bold;
    color: #e74c3c; 
    font-size: 1.1em;
}
.summary .red-unit {
    color: #e74c3c; /* M√ÄU ƒê·ªé */
    font-weight: bold;
}

/* CSS CHO MODAL CHUNG (Kh√¥ng ƒë·ªïi) */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:1000;}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:400px}
.modal-content input[type="text"], .modal-content input[type="date"], .modal-content select{width:100%;padding:8px;margin:5px 0;border:1px solid #ccc;border-radius:5px;box-sizing:border-box;}

/* ƒêi·ªÅu ch·ªânh cho 3 n√∫t: X√≥a n·∫±m b√™n tr√°i, H·ªßy v√† L∆∞u n·∫±m b√™n ph·∫£i */
.button-group{
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-content button{margin-top:15px;padding:8px 12px;border:none;border-radius:5px;cursor:pointer}
.save{background:#3498db;color:#fff}
.cancel{background:#ccc}
.delete{background:#e74c3c;color:#fff} 


/* T√πy ch·ªânh Calendar v√† Input L∆∞∆°ng/gi·ªù */
table th:first-child { background: #e74c3c; color: #fff; }
table tr td:first-child { background-color: #fcecec; }
table tr td:first-child span { color: #c0392b !important; }
table tr td:empty { background-color: #dddddd; cursor: default; }
.header input#rate { min-width: 70px; width: 70px; transition: width 0.2s ease-in-out; text-align: right; }

.time-input-group { display: flex; align-items: center; margin-bottom: 10px; }
.time-input-group label { font-weight: bold; width: 40px; text-align: left; margin-right: 10px; }
.time-input-group input[type="time"] { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; width: auto; }
</style>
</head>
<body>
<div class="container">
    <div class="top-controls">
        <div class="control-group">
            <button class="add-job-btn" id="openJobModal" data-i18n="manage_jobs">‚ûï Qu·∫£n l√Ω N∆°i l√†m vi·ªác</button>
        </div>
        <button class="lang-toggle-btn" id="langToggle">üá∞üá∑ Korean</button>
    </div>
    
    <div id="jobCarousel">
        </div>
    <div class="header" id="calendarHeader"> <div class="month-nav">
            <span class="arrow" id="prevMonth">‚óÄ</span>
            <span id="monthYear"></span>
            <span class="arrow" id="nextMonth">‚ñ∂</span>
        </div>
        <div>
            <span data-i18n="rate_per_hour">üí∞ L∆∞∆°ng/gi·ªù:</span> <input type="number" id="rate" value="100000"> <span id="currencyUnit">VND</span>
        </div>
    </div>
    
    <table>
        <thead>
            <tr id="calendarHeaders">
                <th>CN</th><th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th>
            </tr>
        </thead>
        <tbody id="calendar"></tbody>
    </table>

    <div class="summary">
        ‚úÖ <span data-i18n="total_hours_label">T·ªïng gi·ªù c√¥ng vi·ªác hi·ªán t·∫°i:</span> <span id="totalHours">0</span> <span class="green-unit" data-i18n="unit_hours">gi·ªù</span><br>
        üíµ <span data-i18n="estimated_pay_label">Thu nh·∫≠p ∆∞·ªõc t√≠nh:</span> <span id="totalPay">0</span> <span class="red-unit" data-i18n="unit_vnd">VND</span>
    </div>
</div>

<div class="modal" id="timeModal">
    <div class="modal-content">
        <h3 data-i18n="modal_time_title">Nh·∫≠p gi·ªù c√¥ng - <span id="modalDate"></span></h3>
        
        <div class="input-group">
            <label for="jobSelect" data-i18n="job_label">N∆°i l√†m vi·ªác:</label>
            <select id="jobSelect"></select>
        </div>
        <div class="time-input-group">
            <label for="timeIn" data-i18n="time_in">V√†o:</label>
            <input type="time" id="timeIn" value="09:00">
        </div>
        
        <div class="time-input-group">
            <label for="timeOut" data-i18n="time_out">Ra:</label>
            <input type="time" id="timeOut" value="18:00">
        </div>
        
        <div class="button-group">
            <button class="delete" id="deleteTime" data-i18n="delete">X√≥a</button>
            <div>
                <button class="cancel" id="cancelTime" data-i18n="cancel">H·ªßy</button>
                <button class="save" id="saveTime" data-i18n="save">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="jobModal">
    <div class="modal-content">
        <h3 id="jobModalTitle" data-i18n="modal_job_add_title">Th√™m N∆°i l√†m vi·ªác m·ªõi</h3>
        
        <div class="input-group">
            <label for="jobName" data-i18n="job_name">T√™n N∆°i l√†m vi·ªác:</label>
            <input type="text" id="jobName" placeholder="T√™n c√¥ng ty/D·ª± √°n..." required>
        </div>

        <div class="input-group">
            <label for="jobAddress" data-i18n="job_address">ƒê·ªãa ch·ªâ:</label>
            <input type="text" id="jobAddress" placeholder="ƒê·ªãa ch·ªâ n∆°i l√†m vi·ªác (VD: 123 ƒë∆∞·ªùng ABC)">
        </div>

        <div class="input-group">
            <label for="jobStartDate" data-i18n="job_start_date">Ng√†y B·∫Øt ƒë·∫ßu:</label>
            <input type="date" id="jobStartDate" required>
        </div>

        <div class="input-group">
            <label for="jobEndDate" data-i18n="job_end_date">Ng√†y K·∫øt th√∫c:</label>
            <input type="date" id="jobEndDate">
            <input type="checkbox" id="jobIsCurrent" data-i18n-placeholder="job_is_current"> ƒêang l√†m
        </div>
        
        <div class="job-button-group">
            <button class="delete" id="deleteJob" data-i18n="delete">X√≥a</button>
            <div class="right-buttons">
                <button class="cancel" id="cancelJob" data-i18n="cancel">H·ªßy</button>
                <button class="save" id="saveJob" data-i18n="save">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- PH·∫¶N JAVASCRIPT HO√ÄN CH·ªàNH (ƒê√É TH√äM T√çNH NƒÇNG CHUY·ªÇN ƒê·ªîI TI·ªÄN T·ªÜ) ---
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let workData = JSON.parse(localStorage.getItem('workData') || '{}'); 
let appSettings = JSON.parse(localStorage.getItem('appSettings') || '{}'); 
let jobs = JSON.parse(localStorage.getItem('jobs') || '[]'); 
let editingJobId = null; 
let currentLang = localStorage.getItem('currentLang') || 'vi'; 
let startX = 0; // Bi·∫øn l∆∞u v·ªã tr√≠ X khi b·∫Øt ƒë·∫ßu ch·∫°m (cho t√≠nh nƒÉng vu·ªët)

const rateInput = document.getElementById('rate');
const jobModal = document.getElementById('jobModal');
const jobCarouselDiv = document.getElementById('jobCarousel'); 
const jobSelect = document.getElementById('jobSelect'); 
const langToggleBtn = document.getElementById('langToggle');
const calendarHeader = document.getElementById('calendarHeader'); 
const currencyUnitSpan = document.getElementById('currencyUnit'); // ƒê∆°n v·ªã ti·ªÅn t·ªá

// D·ªØ li·ªáu d·ªãch thu·∫≠t
const translations = {
    'vi': {
        days: ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'],
        months: ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6', 'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'],
        currency: 'VND', // Th√™m ƒë∆°n v·ªã ti·ªÅn t·ªá cho Vi·ªát Nam
        manage_jobs: '‚ûï Qu·∫£n l√Ω N∆°i l√†m vi·ªác',
        rate_per_hour: 'üí∞ L∆∞∆°ng/gi·ªù:',
        total_hours_label: 'T·ªïng gi·ªù c√¥ng vi·ªác hi·ªán t·∫°i:',
        estimated_pay_label: 'Thu nh·∫≠p ∆∞·ªõc t√≠nh:',
        unit_hours: 'gi·ªù',
        unit_vnd: 'VND', // Gi·ªØ nguy√™n VND ·ªü t·ªïng k·∫øt
        modal_time_title: 'Nh·∫≠p gi·ªù c√¥ng -',
        time_in: 'V√†o:',
        time_out: 'Ra:',
        job_label: 'N∆°i l√†m vi·ªác:',
        delete: 'X√≥a',
        cancel: 'H·ªßy',
        save: 'L∆∞u',
        modal_job_add_title: 'Th√™m N∆°i l√†m vi·ªác m·ªõi',
        modal_job_edit_title: 'Ch·ªânh s·ª≠a N∆°i l√†m vi·ªác',
        job_name: 'T√™n N∆°i l√†m vi·ªác:',
        job_address: 'ƒê·ªãa ch·ªâ:',
        job_start_date: 'Ng√†y B·∫Øt ƒë·∫ßu:',
        job_end_date: 'Ng√†y K·∫øt th√∫c:',
        job_is_current: 'ƒêang l√†m',
        alert_job_required: 'T√™n v√† Ng√†y B·∫Øt ƒë·∫ßu l√† b·∫Øt bu·ªôc.',
        alert_date_invalid: 'Ng√†y K·∫øt th√∫c ph·∫£i sau ho·∫∑c b·∫±ng Ng√†y B·∫Øt ƒë·∫ßu.',
        alert_delete_confirm: (name) => `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a n∆°i l√†m vi·ªác ${name} kh√¥ng? Vi·ªác n√†y s·∫Ω x√≥a t·∫•t c·∫£ gi·ªù c√¥ng li√™n quan!`,
        alert_time_job_required: 'Vui l√≤ng th√™m N∆°i l√†m vi·ªác tr∆∞·ªõc khi ch·∫•m c√¥ng.',
        alert_delete_time_confirm: (jobName) => `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a gi·ªù c√¥ng c·ªßa ng√†y n√†y cho ${jobName} kh√¥ng?`,
        job_date_current: 'ƒêang l√†m',
        job_date_from: 'T·ª´',
        job_date_to: 'ƒë·∫øn'
    },
    'ko': {
        days: ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'],
        months: ['1Ïõî', '2Ïõî', '3Ïõî', '4Ïõî', '5Ïõî', '6Ïõî', '7Ïõî', '8Ïõî', '9Ïõî', '10Ïõî', '11Ïõî', '12Ïõî'],
        currency: 'KRW', // Th√™m ƒë∆°n v·ªã ti·ªÅn t·ªá cho H√†n Qu·ªëc
        manage_jobs: '‚ûï ÏßÅÏû• Í¥ÄÎ¶¨',
        rate_per_hour: 'üí∞ ÏãúÍ∏â:',
        total_hours_label: 'Ï¥ù Í∑ºÎ¨¥ ÏãúÍ∞Ñ:',
        estimated_pay_label: 'ÏòàÏÉÅ ÏàòÏûÖ:',
        unit_hours: 'ÏãúÍ∞Ñ',
        unit_vnd: 'KRW', // Gi·ªØ nguy√™n ƒë∆°n v·ªã ti·ªÅn t·ªá cho H√†n Qu·ªëc ·ªü t·ªïng k·∫øt
        modal_time_title: 'Í∑ºÎ¨¥ ÏãúÍ∞Ñ ÏûÖÎ†• -',
        time_in: 'Ï∂úÍ∑º:',
        time_out: 'Ìá¥Í∑º:',
        job_label: 'ÏßÅÏû•:',
        delete: 'ÏÇ≠Ï†ú',
        cancel: 'Ï∑®ÏÜå',
        save: 'Ï†ÄÏû•',
        modal_job_add_title: 'ÏÉà ÏßÅÏû• Ï∂îÍ∞Ä',
        modal_job_edit_title: 'ÏßÅÏû• ÏàòÏ†ï',
        job_name: 'ÏßÅÏû• Ïù¥Î¶Ñ:',
        job_address: 'Ï£ºÏÜå:',
        job_start_date: 'ÏãúÏûëÏùº:',
        job_end_date: 'Ï¢ÖÎ£åÏùº:',
        job_is_current: 'Ïû¨ÏßÅ Ï§ë',
        alert_job_required: 'Ïù¥Î¶ÑÍ≥º ÏãúÏûëÏùºÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.',
        alert_date_invalid: 'Ï¢ÖÎ£åÏùºÏùÄ ÏãúÏûëÏùºÍ≥º Í∞ôÍ±∞ÎÇò Í∑∏ Ïù¥ÌõÑÏó¨Ïïº Ìï©ÎãàÎã§.',
        alert_delete_confirm: (name) => `Ï†ïÎßêÎ°ú ${name} ÏßÅÏû•ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Í¥ÄÎ†® Í∑ºÎ¨¥ ÏãúÍ∞ÑÏù¥ Î™®Îëê ÏÇ≠Ï†úÎê©ÎãàÎã§!`,
        alert_time_job_required: 'Ï∂úÌá¥Í∑º Í∏∞Î°ù Ï†ÑÏóê ÏßÅÏû•ÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.',
        alert_delete_time_confirm: (jobName) => `Ïù¥ ÎÇ†ÏßúÏùò ${jobName} Í∑ºÎ¨¥ ÏãúÍ∞ÑÏùÑ Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`,
        job_date_current: 'Ïû¨ÏßÅ Ï§ë',
        job_date_from: '',
        job_date_to: 'ÍπåÏßÄ'
    }
};

// --- H√ÄM ƒêA NG√îN NG·ªÆ ---

function getTranslation(key, ...args) {
    const text = translations[currentLang][key];
    if (typeof text === 'function') {
        return text(...args);
    }
    return text || translations['vi'][key] || key;
}

function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('currentLang', lang);

    const t = translations[lang];

    // C·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ data-i18n
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = getTranslation(key);
    });
    
    // C·∫≠p nh·∫≠t c√°c placeholder (ch√∫ th√≠ch)
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (key && t[key]) {
             // ƒê·ªëi v·ªõi checkbox, n√≥ l√† label ƒëi k√®m
             el.nextSibling.textContent = ' ' + t[key];
        }
    });

    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ modal
    document.getElementById('jobModalTitle').setAttribute('data-i18n', editingJobId ? 'modal_job_edit_title' : 'modal_job_add_title');
    document.getElementById('jobModalTitle').textContent = getTranslation(editingJobId ? 'modal_job_edit_title' : 'modal_job_add_title');

    // C·∫≠p nh·∫≠t Header L·ªãch
    const headers = document.getElementById('calendarHeaders').children;
    t.days.forEach((day, index) => {
        headers[index].textContent = day;
    });

    // C·∫≠p nh·∫≠t ƒê∆°n v·ªã ti·ªÅn t·ªá
    currencyUnitSpan.textContent = t.currency;

    // C·∫≠p nh·∫≠t ƒê∆°n v·ªã ti·ªÅn t·ªá trong T·ªïng k·∫øt
    document.querySelector('.summary .red-unit').textContent = t.unit_vnd;

    // C·∫≠p nh·∫≠t n√∫t chuy·ªÉn ƒë·ªïi
    langToggleBtn.textContent = lang === 'vi' ? 'üá∞üá∑ Korean' : 'üáªüá≥ Ti·∫øng Vi·ªát';

    // Render l·∫°i l·ªãch ƒë·ªÉ c·∫≠p nh·∫≠t c√°c n·ªôi dung ƒë·ªông
    renderCalendar();
    renderJobList(); 
}

langToggleBtn.onclick = () => {
    const newLang = currentLang === 'vi' ? 'ko' : 'vi';
    setLanguage(newLang);
};

// --- H√ÄM CHUNG & QU·∫¢N L√ù C√îNG VI·ªÜC ---
function daysInMonth(y,m){return new Date(y,m+1,0).getDate();}

function saveJobs() {
    localStorage.setItem('jobs', JSON.stringify(jobs));
    renderJobList();
    renderJobSelectOptions(); 
}

// H√†m format ng√†y (YYYY-MM-DD sang DD/MM/YYYY)
function formatDate(dateString) {
    if (!dateString) return '';
    const parts = dateString.split('-');
    return `${parts[2]}/${parts[1]}/${parts[0]}`;
}


// --- LOGIC MODAL QU·∫¢N L√ù C√îNG VI·ªÜC ---
function openJobModal(jobId = null) {
    editingJobId = jobId;
    jobModal.style.display = 'flex';
    
    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ modal theo ng√¥n ng·ªØ
    const titleKey = jobId ? 'modal_job_edit_title' : 'modal_job_add_title';
    document.getElementById('jobModalTitle').setAttribute('data-i18n', titleKey);
    document.getElementById('jobModalTitle').textContent = getTranslation(titleKey);

    document.getElementById('deleteJob').style.display = jobId ? 'inline-block' : 'none';

    if (jobId) {
        const job = jobs.find(j => j.id === jobId);
        if (job) {
            document.getElementById('jobName').value = job.name || '';
            document.getElementById('jobAddress').value = job.address || '';
            document.getElementById('jobStartDate').value = job.startDate || '';
            document.getElementById('jobEndDate').value = job.endDate || '';
            document.getElementById('jobIsCurrent').checked = job.isCurrent || false;
            document.getElementById('jobEndDate').disabled = job.isCurrent;
        }
    } else {
        document.getElementById('jobName').value = '';
        document.getElementById('jobAddress').value = '';
        document.getElementById('jobStartDate').value = new Date().toISOString().split('T')[0]; 
        document.getElementById('jobEndDate').value = '';
        document.getElementById('jobIsCurrent').checked = true;
        document.getElementById('jobEndDate').disabled = true;
    }
}

document.getElementById('saveJob').onclick = () => {
    const name = document.getElementById('jobName').value.trim();
    const address = document.getElementById('jobAddress').value.trim();
    const startDate = document.getElementById('jobStartDate').value;
    const endDate = document.getElementById('jobEndDate').value;
    const isCurrent = document.getElementById('jobIsCurrent').checked;

    if (!name || !startDate) {
        alert(getTranslation('alert_job_required'));
        return;
    }
    
    if (!isCurrent && endDate && new Date(startDate) > new Date(endDate)) {
        alert(getTranslation('alert_date_invalid'));
        return;
    }

    if (editingJobId) {
        const index = jobs.findIndex(j => j.id === editingJobId);
        if (index !== -1) {
            jobs[index] = { id: editingJobId, name, address, startDate, endDate, isCurrent };
        }
    } else {
        const newId = Date.now().toString(); 
        jobs.push({ id: newId, name, address, startDate, endDate, isCurrent });
    }

    jobModal.style.display = 'none';
    saveJobs();
    renderCalendar();
};

document.getElementById('deleteJob').onclick = () => {
    const job = jobs.find(j => j.id === editingJobId);
    if (editingJobId && confirm(getTranslation('alert_delete_confirm', job.name))) {
        jobs = jobs.filter(j => j.id !== editingJobId);
        
        for (const dateKey in workData) {
            if (workData[dateKey] && workData[dateKey][editingJobId]) {
                delete workData[dateKey][editingJobId];
                if (Object.keys(workData[dateKey]).length === 0) {
                    delete workData[dateKey];
                }
            }
        }
        
        jobModal.style.display = 'none';
        saveJobs();
        renderCalendar(); 
    }
};

document.getElementById('cancelJob').onclick = () => jobModal.style.display = 'none';

document.getElementById('jobIsCurrent').onchange = (e) => {
    document.getElementById('jobEndDate').disabled = e.target.checked;
    if (e.target.checked) {
        document.getElementById('jobEndDate').value = '';
    }
};


// L·∫•y ID c√¥ng vi·ªác ƒëang ƒë∆∞·ª£c ch·ªçn 
function getCurrentJobId() {
    if (jobs.length === 0) return null;
    
    const scrollPos = jobCarouselDiv.scrollLeft;
    const widthPerItem = jobCarouselDiv.clientWidth;
    let selectedIndex = Math.round(scrollPos / widthPerItem);
    
    if (selectedIndex >= jobs.length) selectedIndex = jobs.length - 1;
    if (selectedIndex < 0) selectedIndex = 0;

    const items = jobCarouselDiv.querySelectorAll('.job-item');
    
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedIndex);
    });
    
    return jobs[selectedIndex] ? jobs[selectedIndex].id : null;
}

// X·ª≠ l√Ω s·ª± ki·ªán cu·ªôn
jobCarouselDiv.addEventListener('scroll', () => {
    clearTimeout(jobCarouselDiv.scrollTimeout);
    jobCarouselDiv.scrollTimeout = setTimeout(() => {
        renderCalendar(); 
    }, 100); 
});


function renderJobList() {
    jobCarouselDiv.innerHTML = '';
    
    if (jobs.length === 0) {
        jobCarouselDiv.innerHTML = `<div style="color:#999;font-size:0.9em; min-width: 100%; text-align: center; padding: 15px;">${getTranslation('job_name')} (${getTranslation('modal_job_add_title').toLowerCase()})</div>`;
        jobCarouselDiv.style.border = '1px dashed #ccc'; 
        jobCarouselDiv.style.boxShadow = 'none';
        jobCarouselDiv.style.background = 'none';
        return;
    }
    
    jobCarouselDiv.style.border = '1px solid #e0e0e0';
    jobCarouselDiv.style.boxShadow = 'inset 0 0 5px rgba(0,0,0,.05)';
    jobCarouselDiv.style.background = '#f7f7f7';

    jobs.forEach(job => {
        const item = document.createElement('div');
        item.className = 'job-item';
        item.dataset.id = job.id;

        let dateStr;
        if (job.isCurrent) {
            dateStr = `${getTranslation('job_date_from')} ${formatDate(job.startDate)} - ${getTranslation('job_date_current')}`;
        } else {
            dateStr = `${getTranslation('job_date_from')} ${formatDate(job.startDate)} ${getTranslation('job_date_to')} ${formatDate(job.endDate)}`;
        }
        
        const addressHtml = job.address ? `<span>üìç ${job.address}</span>` : '';

        item.innerHTML = `
            <strong>${job.name}</strong> 
            <span>${dateStr}</span>
            ${addressHtml}
        `;
        item.onclick = (e) => {
            if (e.target.closest('.job-item') === item) {
                openJobModal(job.id);
            }
        }; 
        jobCarouselDiv.appendChild(item);
    });
    getCurrentJobId(); 
}


// --- LOGIC MODAL NH·∫¨P GI·ªú & L·ªäCH ---

function renderJobSelectOptions() {
    jobSelect.innerHTML = '';
    if (jobs.length === 0) {
        jobSelect.innerHTML = `<option value="">(${getTranslation('job_label').replace(':', '')})</option>`;
        return;
    }
    jobs.forEach(job => {
        const option = document.createElement('option');
        option.value = job.id;
        option.textContent = job.name;
        jobSelect.appendChild(option);
    });
}

function updateSummary(){
    const rate = parseFloat(rateInput.value) || 0; 
    let totalH = 0;
    const currentJobId = getCurrentJobId(); 
    
    for(const k in workData) {
        if (workData[k] && workData[k][currentJobId]) {
            totalH += workData[k][currentJobId].hours || 0;
        }
    }
    
    // L·∫•y ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá v√† ƒë∆°n v·ªã t∆∞∆°ng ·ª©ng
    const currencyLocale = currentLang === 'vi' ? 'vi-VN' : 'ko-KR';
    const currencyCode = translations[currentLang].unit_vnd; 
    
    document.getElementById('totalHours').textContent=totalH.toFixed(2);
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªïng ti·ªÅn theo ng√¥n ng·ªØ (VND: .toLocaleString('vi-VN') vs KRW: .toLocaleString('ko-KR'))
    document.getElementById('totalPay').textContent=(totalH*rate).toLocaleString(currencyLocale); 
    
    localStorage.setItem('workData',JSON.stringify(workData));
}

function renderCalendar(){
    const tbl=document.getElementById('calendar');
    tbl.innerHTML='';
    const firstDay=new Date(currentYear,currentMonth,1).getDay();
    const totalDays=daysInMonth(currentYear,currentMonth);
    
    // Ch·ªâ hi·ªÉn th·ªã s·ªë th√°ng v√† nƒÉm
    document.getElementById('monthYear').textContent=`${currentMonth + 1}/${currentYear}`;
    
    let day=1; 

    const currentJobId = getCurrentJobId(); 
    const rate = parseFloat(rateInput.value) || 0; 
    const currencyCode = translations[currentLang].unit_vnd; 
    
    for(let r=0;r<6;r++){
        const tr=document.createElement('tr');
        for(let c=0;c<7;c++){
            const td=document.createElement('td');
            if(r===0&&c<firstDay||day>totalDays){
                td.innerHTML='';
            } else {
                const dkey=`${currentYear}-${currentMonth+1}-${day}`;
                const dayData = workData[dkey] || {};
                const info = dayData[currentJobId] || {}; 
                const hours = info.hours || 0;
                
                // --- LOGIC HI·ªÇN TH·ªä TI·ªÄN V√Ä GI·ªú ---
                let contentHTML = `<span>${day}</span>`;
                if(hours > 0){
                    const pay = hours * rate;
                    // Format ti·ªÅn theo ng√¥n ng·ªØ hi·ªán t·∫°i
                    const payDisplay = pay.toLocaleString(currentLang === 'vi' ? 'vi-VN' : 'ko-KR'); 

                    contentHTML += `
                        <div class="hours-display">${hours.toFixed(1)}h</div>
                        <div class="pay-display">${payDisplay} ${currencyCode}</div>
                    `;
                }
                // ------------------------------------

                td.className='day'; 
                td.innerHTML=contentHTML;
                td.onclick=()=>openModal(dkey);
                day++;
            }
            tr.appendChild(td);
        } 
        tbl.appendChild(tr);
        if(day>totalDays)break;
    }
    updateSummary();
}

function openModal(key){
    const m=document.getElementById('timeModal');
    m.style.display='flex';
    const dateParts=key.split('-');
    
    // C·∫≠p nh·∫≠t ng√†y th√°ng trong modal theo ng√¥n ng·ªØ
    document.getElementById('modalDate').textContent=`${dateParts[2]}/${dateParts[1]}`;
    document.getElementById('timeModal').querySelector('h3').textContent = `${getTranslation('modal_time_title')} ${dateParts[2]}/${dateParts[1]}`;
    
    m.dataset.key=key;
    
    const dayData = workData[key] || {};
    const defaultJobId = getCurrentJobId();
    
    renderJobSelectOptions();
    let selectedJobId = defaultJobId; 
    
    if (Object.keys(dayData).length > 0) {
        if (dayData[defaultJobId]) {
            selectedJobId = defaultJobId;
        } else {
            selectedJobId = Object.keys(dayData)[0];
        }
    }
    
    if (selectedJobId) {
        jobSelect.value = selectedJobId;
    }

    const updateTimeInputs = (jobId) => {
        const info = dayData[jobId] || {};
        document.getElementById('timeIn').value=info.in||'09:00';
        document.getElementById('timeOut').value=info.out||'18:00';
        document.getElementById('deleteTime').style.display = info.hours ? 'inline-block' : 'none';
    };

    updateTimeInputs(selectedJobId); 

    jobSelect.onchange = () => updateTimeInputs(jobSelect.value);
}

document.getElementById('saveTime').onclick=()=>{
    const key=document.getElementById('timeModal').dataset.key;
    const selectedJobId = jobSelect.value; 
    
    if (!selectedJobId) {
        alert(getTranslation('alert_time_job_required'));
        return;
    }

    const tin=document.getElementById('timeIn').value;
    const tout=document.getElementById('timeOut').value;
    const [hi,mi]=tin.split(':').map(Number);const [ho,mo]=tout.split(':').map(Number);
    let hrs=(ho+mo/60)-(hi+mi/60);
    if(hrs < 0) { hrs += 24; } 
    
    if (!workData[key]) {
        workData[key] = {};
    }

    workData[key][selectedJobId] = { in:tin, out:tout, hours:hrs };

    document.getElementById('timeModal').style.display='none';
    renderCalendar();
};

document.getElementById('deleteTime').onclick=()=>{
    const key=document.getElementById('timeModal').dataset.key;
    const selectedJobId = jobSelect.value;
    const jobName = jobSelect.options[jobSelect.selectedIndex].text;
    
    if(confirm(getTranslation('alert_delete_time_confirm', jobName))) {
        if (workData[key] && workData[key][selectedJobId]) {
            delete workData[key][selectedJobId];
            
            if (Object.keys(workData[key]).length === 0) {
                delete workData[key];
            }
        }
        document.getElementById('timeModal').style.display='none';
        renderCalendar();
    }
};

document.getElementById('cancelTime').onclick=()=>document.getElementById('timeModal').style.display='none';

function updateSettings() {
    appSettings.rate = parseFloat(rateInput.value) || 0;
    localStorage.setItem('appSettings', JSON.stringify(appSettings));
    renderCalendar(); 
}

function adjustRateInputWidth() {
    const val = String(rateInput.value).replace(/[^0-9]/g, '');
    const length = val.length;
    let newWidth = 70; 
    const pixelPerChar = 10; 
    if (length >= 4) { newWidth = 70 + (length - 4) * pixelPerChar; }
    if (length > 12) { newWidth = 70 + (12 - 4) * pixelPerChar; }
    rateInput.style.width = `${newWidth}px`;
}

function goToNextMonth() {
    currentMonth++;
    if(currentMonth > 11){
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar();
}

function goToPrevMonth() {
    currentMonth--;
    if(currentMonth < 0){
        currentMonth = 11;
        currentYear--;
    }
    renderCalendar();
}

document.getElementById('prevMonth').onclick = goToPrevMonth;
document.getElementById('nextMonth').onclick = goToNextMonth;

// --- LOGIC VU·ªêT (SWIPE) ---

// B·∫Øt ƒë·∫ßu ch·∫°m
calendarHeader.addEventListener('touchstart', (e) => {
    // Ch·ªâ quan t√¢m ƒë·∫øn l·∫ßn ch·∫°m ƒë·∫ßu ti√™n
    startX = e.touches[0].clientX;
});

// K·∫øt th√∫c ch·∫°m
calendarHeader.addEventListener('touchend', (e) => {
    // L·∫•y v·ªã tr√≠ X khi k·∫øt th√∫c ch·∫°m
    const endX = e.changedTouches[0].clientX;
    // T√≠nh kho·∫£ng c√°ch di chuy·ªÉn (theo tr·ª•c X)
    const diffX = endX - startX;
    
    // Ng∆∞·ª°ng vu·ªët t·ªëi thi·ªÉu (v√≠ d·ª•: 50 pixel)
    const swipeThreshold = 50;

    if (Math.abs(diffX) > swipeThreshold) {
        if (diffX > 0) {
            // Vu·ªët sang ph·∫£i (chuy·ªÉn sang th√°ng tr∆∞·ªõc)
            goToPrevMonth();
        } else {
            // Vu·ªët sang tr√°i (chuy·ªÉn sang th√°ng sau)
            goToNextMonth();
        }
    }
    // Reset startX
    startX = 0;
});

// ---------------------------

rateInput.oninput = adjustRateInputWidth; 
rateInput.onchange = updateSettings; 

document.getElementById('openJobModal').onclick = () => openJobModal();


// --- KH·ªûI T·∫†O ·ª®NG D·ª§NG ---
function initApp() {
    const storedSettings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    appSettings = storedSettings;

    const initialRate = storedSettings.rate !== undefined ? storedSettings.rate : 100000;
    rateInput.value = initialRate;

    jobs = JSON.parse(localStorage.getItem('jobs') || '[]');
    if (jobs.length === 0) {
        const defaultJobId = Date.now().toString();
        jobs.push({ id: defaultJobId, name: 'C√¥ng vi·ªác Ch√≠nh', address: 'VƒÉn ph√≤ng/Remote', startDate: new Date().toISOString().split('T')[0], endDate: '', isCurrent: true });
        saveJobs();
    }
    
    // Kh·ªüi t·∫°o ng√¥n ng·ªØ v√† c·∫≠p nh·∫≠t ƒë∆°n v·ªã ti·ªÅn t·ªá ban ƒë·∫ßu
    setLanguage(currentLang); 
    
    renderJobList(); 
    renderJobSelectOptions();
    renderCalendar();
    adjustRateInputWidth(); 
}

initApp(); 
</script>
</body>
</html>
