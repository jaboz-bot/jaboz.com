<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ªù Caro Responsive</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
    <div class="app">
        <div class="app-container">
            <h2 class="title">C·ªù Caro (Gomoku)</h2>
        </div>
        <div class="board">
            <div class="status" id="status">Ng∆∞·ªùi ch∆°i: X</div>
            <div class="list-button">
                <button class="button" id="restart-btn">
                    <i class="bi bi-arrow-counterclockwise"></i> Ch∆°i l·∫°i
                </button>
                <button class="button" id="single-player-toggle">&#x1F477; M√°y</button>
                <button class="button" id="dimension-button">10x10</button>
            </div>
        </div>
        <div id="board" class="game"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dimensionButton = document.getElementById('dimension-button');
            const statusElement = document.getElementById('status');
            const restartButton = document.getElementById('restart-btn');
            const singlePlayerToggle = document.getElementById('single-player-toggle');
            const boardElement = document.getElementById('board');
            
            // --- C·∫•u h√¨nh tr√≤ ch∆°i ---
            const dimensions = [10, 12, 16, 20];
            let dimensionIndex = 0;
            let dimension = dimensions[dimensionIndex]; 
            
            let singlePlayerMode = false;
            let squares; // Kh·ªüi t·∫°o trong restartGame
            let xIsNext; // Ng∆∞·ªùi ch∆°i hi·ªán t·∫°i (true = X, false = O)
            let theWinner = null;
            let winningLine = [];

            // C·∫≠p nh·∫≠t text n√∫t k√≠ch th∆∞·ªõc ban ƒë·∫ßu
            dimensionButton.textContent = `${dimension}x${dimension}`;

            // --- X·ª≠ l√Ω s·ª± ki·ªán ---
            dimensionButton.addEventListener('click', function () {
                dimensionIndex = (dimensionIndex + 1) % dimensions.length;
                dimension = dimensions[dimensionIndex];
                dimensionButton.textContent = `${dimension}x${dimension}`;
                restartGame();
            });

            restartButton.addEventListener('click', restartGame);

            singlePlayerToggle.addEventListener('click', function () {
                toggleSinglePlayerMode();
                restartGame();
            });

            // --- Logic Tr√≤ ch∆°i ---

            function handleClick(row, col) {
                // Tho√°t n·∫øu ƒë√£ c√≥ ng∆∞·ªùi th·∫Øng ho·∫∑c √¥ ƒë√£ ƒë∆∞·ª£c ƒë√°nh
                if (theWinner || squares[row][col]) {
                    return;
                }

                // T·∫°o b·∫£n sao c·ªßa m·∫£ng squares (quan tr·ªçng!)
                const newSquares = squares.map(arr => [...arr]); 
                newSquares[row][col] = xIsNext ? 'X' : 'O';
                squares = newSquares;
                xIsNext = !xIsNext; // Chuy·ªÉn l∆∞·ª£t

                const winner = calculateWinner(newSquares, row, col);
                if (winner) {
                    theWinner = winner;
                    winningLine = findWinningLine(newSquares, row, col, winner);
                }

                renderBoard();
                updateStatus();

                // N·∫øu l√† ch·∫ø ƒë·ªô ch∆°i ƒë∆°n v√† ch∆∞a c√≥ ng∆∞·ªùi th·∫Øng v√† ƒë·∫øn l∆∞·ª£t m√°y (O)
                if (singlePlayerMode && !theWinner && !xIsNext) {
                    // D√πng setTimeout ƒë·ªÉ t·∫°o ƒë·ªô tr·ªÖ, gi√∫p tr√≤ ch∆°i tr√¥ng t·ª± nhi√™n h∆°n
                    setTimeout(makeComputerMove, 500); 
                }
            }

            function calculateWinner(currentSquares, row, col) {
                const currentPlayer = currentSquares[row][col];
                if (!currentPlayer) return null;
                const winCondition = 5;

                // H√†m ki·ªÉm tra theo 4 h∆∞·ªõng (ngang, d·ªçc, 2 ch√©o)
                function checkDirection(dRow, dCol) {
                    let count = 1;
                    let r, c;

                    // Ki·ªÉm tra m·ªôt ph√≠a
                    r = row + dRow;
                    c = col + dCol;
                    while (r >= 0 && r < dimension && c >= 0 && c < dimension && currentSquares[r][c] === currentPlayer) {
                        count++;
                        r += dRow;
                        c += dCol;
                    }

                    // Ki·ªÉm tra ph√≠a ng∆∞·ª£c l·∫°i
                    r = row - dRow;
                    c = col - dCol;
                    while (r >= 0 && r < dimension && c >= 0 && c < dimension && currentSquares[r][c] === currentPlayer) {
                        count++;
                        r -= dRow;
                        c -= dCol;
                    }
                    return count;
                }

                // 4 h∆∞·ªõng: [dRow, dCol]
                const directions = [
                    [0, 1],   // Ngang
                    [1, 0],   // D·ªçc
                    [1, 1],   // Ch√©o ch√≠nh
                    [1, -1]   // Ch√©o ph·ª•
                ];

                for (const [dRow, dCol] of directions) {
                    if (checkDirection(dRow, dCol) >= winCondition) {
                        return currentPlayer;
                    }
                }
                return null;
            }

            function findWinningLine(currentSquares, row, col, winner) {
                const currentPlayer = currentSquares[row][col];
                const winCondition = 5;

                // H√†m t√¨m ƒë∆∞·ªùng th·∫Øng theo m·ªôt h∆∞·ªõng
                function findLine(dRow, dCol) {
                    const line = [];
                    let r, c;

                    // L√πi v·ªÅ ƒëi·ªÉm b·∫Øt ƒë·∫ßu c·ªßa chu·ªói 5
                    let startR = row, startC = col;
                    r = row - dRow;
                    c = col - dCol;
                    while (r >= 0 && r < dimension && c >= 0 && c < dimension && currentSquares[r][c] === currentPlayer) {
                        startR = r; startC = c;
                        r -= dRow; c -= dCol;
                    }

                    // Ti·∫øn t·ª´ ƒëi·ªÉm b·∫Øt ƒë·∫ßu ƒë·ªÉ l·∫•y 5 √¥
                    for (let i = 0; i < dimension; i++) {
                        r = startR + i * dRow;
                        c = startC + i * dCol;
                        if (r < 0 || r >= dimension || c < 0 || c >= dimension || currentSquares[r][c] !== currentPlayer) {
                            break;
                        }
                        line.push([r, c]);
                        if (line.length >= winCondition) {
                            // Ki·ªÉm tra xem 5 √¥ cu·ªëi c√πng c√≥ ƒë·ªß 5 √¥ li√™n ti·∫øp kh√¥ng
                            if (line.slice(-winCondition).length === winCondition) {
                                return line.slice(-winCondition);
                            }
                        }
                    }
                    return [];
                }

                // 4 h∆∞·ªõng: [dRow, dCol]
                const directions = [
                    [0, 1],   // Ngang
                    [1, 0],   // D·ªçc
                    [1, 1],   // Ch√©o ch√≠nh
                    [1, -1]   // Ch√©o ph·ª•
                ];

                for (const [dRow, dCol] of directions) {
                    const line = findLine(dRow, dCol);
                    if (line.length >= winCondition) {
                        return line;
                    }
                }
                return [];
            }


            function renderBoard() {
                boardElement.innerHTML = '';
                // Th√™m CSS class d·ª±a tr√™n k√≠ch th∆∞·ªõc
                boardElement.className = `game board-${dimension}x${dimension}`; 

                for (let row = 0; row < dimension; row++) {
                    const rowElement = document.createElement('div');
                    rowElement.className = 'board-row';

                    for (let col = 0; col < dimension; col++) {
                        const value = squares[row][col];
                        // Ki·ªÉm tra √¥ c√≥ n·∫±m trong ƒë∆∞·ªùng th·∫Øng kh√¥ng
                        const isWinningSquare = winningLine.some(([winRow, winCol]) => winRow === row && winCol === col);

                        const squareButton = document.createElement('button');
                        squareButton.className = 'square';
                        // D√πng m√†u v√†ng s√°ng cho √¥ th·∫Øng
                        squareButton.style.backgroundColor = isWinningSquare ? '#ffeb3b' : 'white'; 
                        
                        // ƒê·∫∑t data-value ƒë·ªÉ CSS x·ª≠ l√Ω m√†u ch·ªØ (X=blue, O=red)
                        if (value) {
                            squareButton.setAttribute('data-value', value);
                        }
                        // Gi·ªØ l·∫°i font bold cho √¥ th·∫Øng
                        if (isWinningSquare) {
                            squareButton.style.fontWeight = 'bold';
                        }
                        
                        squareButton.textContent = value;
                        squareButton.addEventListener('click', () => {
                            // Cho ph√©p ng∆∞·ªùi ch∆°i X click khi ch∆°i ƒë∆°n (lu√¥n l√† ng∆∞·ªùi ƒëi tr∆∞·ªõc)
                            if (!singlePlayerMode || (singlePlayerMode && xIsNext)) { 
                                handleClick(row, col);
                            }
                        });

                        rowElement.appendChild(squareButton);
                    }
                    boardElement.appendChild(rowElement);
                }
            }

            function updateStatus() {
                if (theWinner) {
                    statusElement.textContent = `üéâ ${theWinner} ƒë√£ chi·∫øn th·∫Øng! üéâ`;
                    statusElement.style.color = theWinner === 'X' ? 'blue' : 'red';
                } else if (squares.flat().every(val => val !== null)) { // Ki·ªÉm tra h√≤a
                    statusElement.textContent = 'H√≤a c·ªù!';
                    statusElement.style.color = '#333';
                } else {
                    statusElement.textContent = `Ng∆∞·ªùi ch∆°i: ${xIsNext ? 'X' : 'O'}`;
                    statusElement.style.color = xIsNext ? 'blue' : 'red';
                }
            }

            function restartGame() {
                // KH·∫ÆC PH·ª§C: S·ª≠ d·ª•ng Array.from ƒë·ªÉ t·∫°o m·∫£ng con ƒë·ªôc l·∫≠p cho m·ªói h√†ng
                squares = Array.from({ length: dimension }, () => Array(dimension).fill(null));
                
                xIsNext = Math.random() < 0.5; // Ch·ªçn ng·∫´u nhi√™n ng∆∞·ªùi ƒëi tr∆∞·ªõc
                theWinner = null;
                winningLine = [];
                updateStatus();
                renderBoard();
                
                // N·∫øu ch·∫ø ƒë·ªô ch∆°i ƒë∆°n ƒë√£ b·∫≠t v√† ƒë·∫øn l∆∞·ª£t m√°y (O), m√°y ƒëi n∆∞·ªõc ƒë·∫ßu ti√™n
                if (singlePlayerMode && !xIsNext) {
                    setTimeout(makeComputerMove, 500); 
                }
            }

            function toggleSinglePlayerMode() {
                singlePlayerMode = !singlePlayerMode;
                if (singlePlayerMode) {
                    singlePlayerToggle.innerHTML = '&#x1F4BB; M√°y'; // Bi·ªÉu t∆∞·ª£ng m√°y t√≠nh
                    singlePlayerToggle.style.backgroundColor = '#28a745';
                } else {
                    singlePlayerToggle.innerHTML = '&#x1F477; 2 Ng∆∞·ªùi'; // Bi·ªÉu t∆∞·ª£ng 2 ng∆∞·ªùi
                    singlePlayerToggle.style.backgroundColor = '#007bff';
                }
            }

            // --- Logic AI (C∆° b·∫£n) ---
            function makeComputerMove() {
                if (!singlePlayerMode || theWinner) return;

                const availableMoves = [];
                const humanPlayer = 'X';
                const computerPlayer = 'O';

                squares.forEach((row, rowIndex) => {
                    row.forEach((col, colIndex) => {
                        if (col === null) {
                            availableMoves.push([rowIndex, colIndex]);
                        }
                    });
                });

                if (availableMoves.length === 0) return;

                // 1. Chi·∫øn th·∫Øng: Ki·ªÉm tra xem m√°y c√≥ th·ªÉ th·∫Øng ngay kh√¥ng
                for (const [row, col] of availableMoves) {
                    const tempSquares = squares.map(arr => [...arr]);
                    tempSquares[row][col] = computerPlayer;
                    if (calculateWinner(tempSquares, row, col) === computerPlayer) {
                        handleClick(row, col);
                        return;
                    }
                }

                // 2. Ph√≤ng th·ªß: Ki·ªÉm tra xem ng∆∞·ªùi ch∆°i c√≥ th·ªÉ th·∫Øng ngay kh√¥ng
                for (const [row, col] of availableMoves) {
                    const tempSquares = squares.map(arr => [...arr]);
                    tempSquares[row][col] = humanPlayer;
                    if (calculateWinner(tempSquares, row, col) === humanPlayer) {
                        handleClick(row, col);
                        return;
                    }
                }

                // 3. ƒê√°nh ·ªü gi·ªØa n·∫øu c√≤n tr·ªëng (∆Øu ti√™n cho b√†n c·ªù nh·ªè)
                const center = Math.floor(dimension / 2);
                if (squares[center][center] === null) {
                    handleClick(center, center);
                    return;
                }

                // 4. Di chuy·ªÉn ng·∫´u nhi√™n
                const randomIndex = Math.floor(Math.random() * availableMoves.length);
                const [row, col] = availableMoves[randomIndex];
                handleClick(row, col);
            }

            // Kh·ªüi t·∫°o tr√≤ ch∆°i l·∫ßn ƒë·∫ßu
            restartGame(); 
            toggleSinglePlayerMode(); // ƒê·∫∑t tr·∫°ng th√°i ban ƒë·∫ßu l√† 2 Ng∆∞·ªùi
        });
    </script>
</body>
</html>
